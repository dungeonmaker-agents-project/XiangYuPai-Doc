# 用户身份信息编辑功能增强

## 概述
为用户个人资料管理页面添加了完整的身份认证信息编辑功能，管理员可以通过操作列的"编辑"按钮来管理用户的身份认证信息。

## 更新日期
2025-11-12

## 修改文件清单

### 前端文件

#### 1. `XiangYuPai-Admin/src/views/xypai/user-profile/index.vue`
**新增功能：**
- 添加了"身份认证"标签页（identity tab）到编辑对话框
- 包含以下编辑字段：

**实名认证部分：**
- 真实姓名（realName）
- 身份证后4位（idCardLast4）
- 实名认证状态开关（isRealVerified）
- 认证时间选择器（realVerifiedTime）

**认证标签部分：**
- 大神认证开关（isGodVerified）
- 组局达人开关（isActivityExpert）
- 人气用户开关（isPopular）
- VIP用户开关（isVip）
- VIP等级输入（vipLevel，0-10）
- VIP过期时间选择器（vipExpireTime）
- 认证标签多选（certificationTags）

#### 2. `XiangYuPai-Admin/src/api/xypai/user-profile/types.ts`
**更新内容：**
- 在 `UserProfileForm` 接口中添加了以下字段：
  ```typescript
  realName?: string;
  idCardLast4?: string;
  isRealVerified?: boolean;
  realVerifiedTime?: string;
  isGodVerified?: boolean;
  isActivityExpert?: boolean;
  isPopular?: boolean;
  isVip?: boolean;
  vipLevel?: number;
  vipExpireTime?: string;
  certificationTags?: string[];
  ```

### 后端文件

#### 3. `RuoYi-Cloud-Plus/xypai-user/src/main/java/com/xypai/user/domain/dto/UserUpdateDTO.java`
**新增字段：**
- 添加了身份认证信息部分，包含：
  - `realName` - 真实姓名（最多50字符）
  - `idCardLast4` - 身份证后4位（必须是4位数字）
  - `isRealVerified` - 是否实名认证
  - `realVerifiedTime` - 实名认证时间
  - `isGodVerified` - 是否大神认证
  - `isActivityExpert` - 是否组局达人
  - `isPopular` - 是否人气用户
  - `isVip` - 是否VIP用户
  - `vipLevel` - VIP等级（0-10）
  - `vipExpireTime` - VIP过期时间
  - `certificationTags` - 认证标签数组

**验证规则：**
- 真实姓名：最多50字符
- 身份证后4位：必须是4位数字（正则：`^\d{4}$`）
- VIP等级：0-10之间

## 功能特性

### 1. 编辑入口
用户可以通过以下方式进入编辑模式：
- 点击表格操作列的"编辑"按钮
- 选中单个用户后点击顶部的"修改"按钮

### 2. 表单组织
编辑对话框采用标签页（Tabs）组织，包含：
- **基础信息** - 昵称、性别、年龄等
- **位置信息** - 国家、省份、城市、经纬度等
- **体征与教育** - 身高、体重、学历、公司等
- **社交联系** - 微信号、微信二维码等
- **身份认证** - ⭐ 新增：实名认证、认证标签、VIP信息
- **隐私与通知** - 隐私设置、通知设置等

### 3. 权限控制
- 编辑功能需要 `xypai:user:edit` 权限
- 使用 `@SaCheckPermission` 注解进行权限验证
- 前端使用 `v-hasPermi` 指令控制按钮显示

### 4. 数据验证
**前端验证：**
- 身份证后4位：限制4位字符
- VIP等级：0-10范围限制
- 日期时间格式：YYYY-MM-DD HH:mm:ss

**后端验证：**
- 使用 Jakarta Validation 注解
- 身份证后4位必须是4位数字
- VIP等级范围验证（@Min, @Max）
- 字符串长度限制（@Size）

### 5. 用户体验优化
- 使用 `el-switch` 开关组件，直观显示认证状态
- 使用 `el-date-picker` 日期时间选择器
- 使用 `el-input-number` 数字输入框，防止非法输入
- 使用 `el-select` 多选组件，支持自定义标签（allow-create）
- 表单字段分组清晰，使用分割线（el-divider）

## API 接口

### 更新用户信息
**端点：** `PUT /xypai-user/api/v1/user/{userId}`

**请求体示例：**
```json
{
  "userId": 1001,
  "nickname": "张三",
  "realName": "张三",
  "idCardLast4": "1234",
  "isRealVerified": true,
  "realVerifiedTime": "2025-11-12 10:30:00",
  "isGodVerified": true,
  "isActivityExpert": false,
  "isPopular": true,
  "isVip": true,
  "vipLevel": 3,
  "vipExpireTime": "2026-11-12 23:59:59",
  "certificationTags": ["实名认证", "大神认证", "人气用户"],
  "version": 0
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

## 技术栈遵循

### 前端
- ✅ Vue 3 Composition API
- ✅ Element Plus UI组件
- ✅ TypeScript类型定义
- ✅ 响应式表单验证

### 后端
- ✅ Spring Boot 3.2.0
- ✅ Jakarta Validation验证
- ✅ Swagger/OpenAPI 3.0文档
- ✅ 乐观锁版本控制（version字段）

## 测试建议

### 功能测试
1. 测试编辑按钮是否正常打开对话框
2. 测试身份认证标签页是否显示
3. 测试所有字段的输入和保存
4. 测试表单验证规则
5. 测试开关组件的状态切换
6. 测试日期时间选择器
7. 测试多选标签的添加和删除

### 权限测试
1. 无权限用户不应看到编辑按钮
2. 无权限用户调用API应返回403

### 数据验证测试
1. 身份证后4位输入非数字应提示错误
2. VIP等级超出范围应提示错误
3. 真实姓名超过50字符应提示错误

## 注意事项

1. **数据安全**：
   - 真实姓名和身份证信息属于敏感数据
   - 后端应使用 `@Sensitive` 注解进行脱敏处理
   - 身份证完整号码应加密存储（AES-256）

2. **乐观锁**：
   - 使用 `version` 字段防止并发更新冲突
   - 更新失败时提示用户刷新后重试

3. **日志记录**：
   - 使用 `@Log` 注解记录身份信息的修改操作
   - 记录操作人、操作时间、修改内容

4. **审计追踪**：
   - 建议在数据库中记录身份认证的审计日志
   - 包括认证时间、认证人、认证方式等

## 后续优化建议

1. **身份证验证**：
   - 添加身份证号码完整性验证（18位）
   - 添加身份证校验码验证算法
   - 支持上传身份证照片

2. **认证流程**：
   - 添加实名认证审核流程
   - 支持认证材料上传和审核
   - 添加认证失败原因记录

3. **VIP管理**：
   - 添加VIP自动续费功能
   - 添加VIP到期提醒
   - 添加VIP权益管理

4. **批量操作**：
   - 支持批量设置认证状态
   - 支持批量导入认证信息

## 参考文档
- [技术栈规范](./AAAAAA_TECH_STACK_REQUIREMENTS.md)
- [后端目录结构](./backend-tree.mdc)
- [前端目录结构](./frontend-admin.mdc)
