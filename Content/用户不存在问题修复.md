# ç”¨æˆ·ç¼–è¾‘æ—¶"ç”¨æˆ·ä¸å­˜åœ¨"é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨ä¸­çš„"ç¼–è¾‘"æŒ‰é’®æ—¶ï¼Œç³»ç»ŸæŠ¥é”™ï¼š
```
ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤
```

ä½†å®é™…ä¸Šç”¨æˆ·åœ¨åˆ—è¡¨ä¸­å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼Œè¯´æ˜ç”¨æˆ·ç¡®å®å­˜åœ¨äºç³»ç»Ÿä¸­ã€‚

## é—®é¢˜åŸå› 

### æ¶æ„èƒŒæ™¯
ç³»ç»Ÿé‡‡ç”¨åŒè¡¨è®¾è®¡ï¼š
1. **`sys_user` è¡¨**ï¼ˆruoyi-system æ¨¡å—ï¼‰
   - å­˜å‚¨è®¤è¯ä¿¡æ¯ï¼šusername, mobile, email, status
   - ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º

2. **`user` è¡¨**ï¼ˆxypai-user æ¨¡å—ï¼‰
   - å­˜å‚¨ä¸šåŠ¡ä¿¡æ¯ï¼šnickname, avatar, bio, city, è®¤è¯çŠ¶æ€ç­‰
   - éœ€è¦æ‰‹åŠ¨åˆ›å»ºæˆ–é¦–æ¬¡ç¼–è¾‘æ—¶åˆ›å»º

### é—®é¢˜æ ¹æº
å½“ç”¨æˆ·é€šè¿‡ç³»ç»Ÿæ³¨å†Œåï¼š
- âœ… `sys_user` è¡¨æœ‰è®°å½•ï¼ˆç”¨æˆ·å¯ä»¥ç™»å½•ï¼‰
- âŒ `user` è¡¨æ— è®°å½•ï¼ˆä¸šåŠ¡èµ„æ–™æœªåˆå§‹åŒ–ï¼‰

åœ¨åˆ—è¡¨æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. ä» `sys_user` è·å–ç”¨æˆ·åˆ—è¡¨
2. ä» `user` è¡¨æ‰¹é‡æŸ¥è¯¢ä¸šåŠ¡æ•°æ®
3. å¦‚æœ `user` è¡¨æ— æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼ï¼ˆå¦‚é»˜è®¤å¤´åƒã€é»˜è®¤æ˜µç§°ï¼‰

ä½†åœ¨ç¼–è¾‘æ—¶ï¼ŒåŸä»£ç ç›´æ¥æŸ¥è¯¢ `user` è¡¨ï¼š
```java
User user = userMapper.selectOne(
    Wrappers.lambdaQuery(User.class)
        .eq(User::getUserId, userId)
);

if (user == null) {
    throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤");  // âŒ ç›´æ¥æŠ›å¼‚å¸¸
}
```

## è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹ç­–ç•¥
å½“ `user` è¡¨æ— è®°å½•æ—¶ï¼Œä¸å†æŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯ï¼š
1. ä» `sys_user` è·å–åŸºç¡€ä¿¡æ¯
2. è‡ªåŠ¨åˆ›å»ºé»˜è®¤ç”¨æˆ·èµ„æ–™
3. è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ä¾›ç¼–è¾‘

### ä»£ç ä¿®æ”¹

**æ–‡ä»¶ï¼š** `RuoYi-Cloud-Plus/xypai-user/src/main/java/com/xypai/user/service/impl/UserServiceImpl.java`

**ä¿®æ”¹å†…å®¹ï¼š**
```java
@Override
public UserVO selectUserById(Long userId) {
    if (userId == null) {
        throw new ServiceException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
    }

    // æŸ¥è¯¢ xypai-user è¡¨
    User user = userMapper.selectOne(
        Wrappers.lambdaQuery(User.class)
            .eq(User::getUserId, userId)
    );

    UserVO userVO;
    
    if (user == null) {
        // ğŸ¯ ç”¨æˆ·åœ¨ xypai-user è¡¨ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™
        log.warn("âš ï¸ ç”¨æˆ· {} åœ¨ xypai-user è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™", userId);
        
        try {
            // ä» ruoyi-system è·å–ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯
            List<RemoteUserVo> sysUsers = remoteUserService.selectListByIds(List.of(userId));
            
            if (CollUtil.isEmpty(sysUsers)) {
                throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤");
            }
            
            RemoteUserVo sysUser = sysUsers.get(0);
            
            // åˆ›å»ºé»˜è®¤ç”¨æˆ·èµ„æ–™
            User newUser = User.builder()
                .userId(userId)
                .nickname(sysUser.getUserName())  // ä½¿ç”¨ç³»ç»Ÿç”¨æˆ·åä½œä¸ºé»˜è®¤æ˜µç§°
                .avatar("https://oss.xypai.com/default/avatar_male.png")
                .avatarThumbnail("https://oss.xypai.com/default/avatar_male.png")
                .gender(0)  // æœªè®¾ç½®
                .bio("è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~")
                .countryCode("CN")
                .isRealVerified(false)
                .isGodVerified(false)
                .isActivityExpert(false)
                .isVip(false)
                .isPopular(false)
                .vipLevel(0)
                .wechatUnlockCondition(0)
                .onlineStatus(0)
                .profileCompleteness(10)
                .profileVisible(true)
                .locationVisible(true)
                .onlineStatusVisible(true)
                .allowStrangerMessage(true)
                .notifyFollower(true)
                .notifyLike(true)
                .notifyComment(true)
                .notifyMessage(true)
                .notifyActivity(true)
                .themeMode("auto")
                .createdAt(LocalDateTime.now())
                .updatedAt(LocalDateTime.now())
                .version(0)
                .build();
            
            // æ’å…¥æ•°æ®åº“
            userMapper.insert(newUser);
            log.info("âœ… å·²ä¸ºç”¨æˆ· {} è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™", userId);
            
            // è½¬æ¢ä¸ºVO
            userVO = BeanUtil.copyProperties(newUser, UserVO.class);
            userVO.setUsername(sysUser.getUserName());
            userVO.setMobile(sysUser.getPhonenumber());
            userVO.setEmail(sysUser.getEmail());
            userVO.setStatus(sysUser.getStatus());
            userVO.setStatusText(convertStatusText(sysUser.getStatus()));
            
        } catch (Exception e) {
            log.error("âŒ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥: userId={}", userId, e);
            throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤");
        }
    } else {
        // è½¬æ¢ä¸ºVO
        userVO = BeanUtil.copyProperties(user, UserVO.class);
    }

    // è¡¥å……æ–‡æœ¬å­—æ®µ
    enrichUserVO(userVO);

    return userVO;
}
```

## åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨åˆå§‹åŒ–
- é¦–æ¬¡ç¼–è¾‘ç”¨æˆ·æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™
- ä½¿ç”¨ç³»ç»Ÿç”¨æˆ·åä½œä¸ºé»˜è®¤æ˜µç§°
- è®¾ç½®é»˜è®¤å¤´åƒå’Œä¸ªäººç®€ä»‹
- åˆå§‹åŒ–æ‰€æœ‰å¿…éœ€å­—æ®µ

### 2. é»˜è®¤å€¼è®¾ç½®
| å­—æ®µ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| nickname | ç³»ç»Ÿç”¨æˆ·å | ä» sys_user.username è·å– |
| avatar | default/avatar_male.png | é»˜è®¤ç”·æ€§å¤´åƒ |
| gender | 0 | æœªè®¾ç½® |
| bio | "è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~" | é»˜è®¤ä¸ªäººç®€ä»‹ |
| countryCode | CN | ä¸­å›½ |
| profileCompleteness | 10 | 10%å®Œæ•´åº¦ |
| æ‰€æœ‰è®¤è¯æ ‡å¿— | false | æœªè®¤è¯ |
| æ‰€æœ‰é€šçŸ¥å¼€å…³ | true | é»˜è®¤å¼€å¯ |

### 3. å®¹é”™å¤„ç†
- å¦‚æœ Dubbo è°ƒç”¨å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
- å¦‚æœ sys_user ä¹Ÿä¸å­˜åœ¨ï¼ŒæŠ›å‡º"ç”¨æˆ·ä¸å­˜åœ¨"å¼‚å¸¸
- å¦‚æœæ•°æ®åº“æ’å…¥å¤±è´¥ï¼Œè®°å½•æ—¥å¿—å¹¶æŠ›å‡ºå¼‚å¸¸

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šæ–°æ³¨å†Œç”¨æˆ·
1. åœ¨ç³»ç»Ÿä¸­æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆåªåˆ›å»º sys_user è®°å½•ï¼‰
2. åœ¨ç®¡ç†åå°ç”¨æˆ·åˆ—è¡¨ä¸­æ‰¾åˆ°è¯¥ç”¨æˆ·
3. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
4. **é¢„æœŸç»“æœ**ï¼š
   - âœ… æˆåŠŸæ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
   - âœ… æ˜¾ç¤ºé»˜è®¤æ˜µç§°ï¼ˆç”¨æˆ·åï¼‰
   - âœ… æ˜¾ç¤ºé»˜è®¤å¤´åƒ
   - âœ… æ‰€æœ‰å­—æ®µå¯ç¼–è¾‘
   - âœ… æ•°æ®åº“ `user` è¡¨è‡ªåŠ¨åˆ›å»ºè®°å½•

### æµ‹è¯•åœºæ™¯2ï¼šå·²æœ‰èµ„æ–™ç”¨æˆ·
1. é€‰æ‹©å·²æœ‰å®Œæ•´èµ„æ–™çš„ç”¨æˆ·
2. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
3. **é¢„æœŸç»“æœ**ï¼š
   - âœ… æ˜¾ç¤ºç”¨æˆ·å®é™…èµ„æ–™
   - âœ… ä¸ä¼šé‡å¤åˆ›å»ºè®°å½•

### æµ‹è¯•åœºæ™¯3ï¼šä¸å­˜åœ¨çš„ç”¨æˆ·
1. æ‰‹åŠ¨è°ƒç”¨ APIï¼š`GET /api/v1/user/999999999`
2. **é¢„æœŸç»“æœ**ï¼š
   - âœ… è¿”å›é”™è¯¯ï¼š"ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤"

## æ—¥å¿—è¾“å‡º

### æˆåŠŸåˆ›å»ºé»˜è®¤èµ„æ–™
```
âš ï¸ ç”¨æˆ· 1987741160776421378 åœ¨ xypai-user è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™
âœ… å·²ä¸ºç”¨æˆ· 1987741160776421378 è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™
```

### ç”¨æˆ·çœŸçš„ä¸å­˜åœ¨
```
âš ï¸ ç”¨æˆ· 999999999 åœ¨ xypai-user è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™
âŒ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥: userId=999999999
```

## ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- âœ… æ— éœ€æ‰‹åŠ¨åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™
- âœ… é¦–æ¬¡ç¼–è¾‘å³å¯ä½¿ç”¨
- âœ… é¿å…"ç”¨æˆ·ä¸å­˜åœ¨"çš„å›°æƒ‘

### 2. æ•°æ®ä¸€è‡´æ€§
- âœ… ç¡®ä¿ sys_user å’Œ user è¡¨æ•°æ®åŒæ­¥
- âœ… è‡ªåŠ¨å¡«å……å¿…éœ€å­—æ®µ
- âœ… ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§

### 3. å¼€å‘å‹å¥½
- âœ… å‡å°‘æ‰‹åŠ¨æ•°æ®åˆå§‹åŒ–å·¥ä½œ
- âœ… é™ä½æµ‹è¯•ç¯å¢ƒé…ç½®å¤æ‚åº¦
- âœ… æ¸…æ™°çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

## æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘
- é¦–æ¬¡ç¼–è¾‘ä¼šå¢åŠ ä¸€æ¬¡ Dubbo è°ƒç”¨å’Œä¸€æ¬¡æ•°æ®åº“æ’å…¥
- åç»­ç¼–è¾‘ä¸å—å½±å“
- å»ºè®®åœ¨ç”¨æˆ·æ³¨å†Œæ—¶å°±åˆ›å»ºé»˜è®¤èµ„æ–™ï¼ˆæ›´ä¼˜æ–¹æ¡ˆï¼‰

### 2. å¹¶å‘é—®é¢˜
- ä½¿ç”¨ MyBatis Plus çš„ `insert` æ–¹æ³•
- å¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶åˆ›å»ºï¼Œå¯èƒ½å‡ºç°ä¸»é”®å†²çª
- å»ºè®®åœ¨ `user` è¡¨çš„ `user_id` å­—æ®µæ·»åŠ å”¯ä¸€ç´¢å¼•

### 3. æ•°æ®è¿ç§»
å¦‚æœç³»ç»Ÿå·²æœ‰å¤§é‡ç”¨æˆ·ï¼Œå»ºè®®æ‰§è¡Œæ‰¹é‡åˆå§‹åŒ–è„šæœ¬ï¼š
```sql
INSERT INTO user (user_id, nickname, avatar, avatar_thumbnail, gender, bio, country_code, 
                  is_real_verified, is_god_verified, is_activity_expert, is_vip, is_popular,
                  vip_level, wechat_unlock_condition, online_status, profile_completeness,
                  profile_visible, location_visible, online_status_visible, allow_stranger_message,
                  notify_follower, notify_like, notify_comment, notify_message, notify_activity,
                  theme_mode, created_at, updated_at, version)
SELECT u.user_id, u.user_name, 'https://oss.xypai.com/default/avatar_male.png', 
       'https://oss.xypai.com/default/avatar_male.png', 0, 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~', 'CN',
       0, 0, 0, 0, 0, 0, 0, 0, 10,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 'auto', NOW(), NOW(), 0
FROM sys_user u
WHERE NOT EXISTS (SELECT 1 FROM user WHERE user_id = u.user_id);
```

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ³¨å†Œæ—¶åˆå§‹åŒ–
åœ¨ç”¨æˆ·æ³¨å†Œæ¥å£ä¸­ï¼ŒåŒæ—¶åˆ›å»º `sys_user` å’Œ `user` è®°å½•ï¼š
```java
@Transactional(rollbackFor = Exception.class)
public void register(RegisterDTO dto) {
    // 1. åˆ›å»ºç³»ç»Ÿç”¨æˆ·
    Long userId = sysUserService.register(dto);
    
    // 2. åˆ›å»ºä¸šåŠ¡èµ„æ–™
    userService.createDefaultProfile(userId, dto.getUsername());
}
```

### 2. å¼‚æ­¥åˆå§‹åŒ–
ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åˆ›å»ºç”¨æˆ·èµ„æ–™ï¼š
```java
// æ³¨å†ŒæˆåŠŸåå‘é€æ¶ˆæ¯
rabbitTemplate.convertAndSend("user.register.queue", userId);

// æ¶ˆè´¹è€…åˆ›å»ºé»˜è®¤èµ„æ–™
@RabbitListener(queues = "user.register.queue")
public void createProfile(Long userId) {
    userService.createDefaultProfile(userId);
}
```

### 3. æ‰¹é‡åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡
å®šæœŸæ£€æŸ¥å¹¶åˆå§‹åŒ–ç¼ºå¤±çš„ç”¨æˆ·èµ„æ–™ï¼š
```java
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void initMissingProfiles() {
    List<Long> userIds = findUsersWithoutProfile();
    userIds.forEach(this::createDefaultProfile);
}
```

## ç›¸å…³æ–‡æ¡£
- [ç”¨æˆ·èº«ä»½ä¿¡æ¯ç¼–è¾‘åŠŸèƒ½å¢å¼º](./ç”¨æˆ·èº«ä»½ä¿¡æ¯ç¼–è¾‘åŠŸèƒ½å¢å¼º.md)
- [æŠ€æœ¯æ ˆè§„èŒƒ](./AAAAAA_TECH_STACK_REQUIREMENTS.md)
