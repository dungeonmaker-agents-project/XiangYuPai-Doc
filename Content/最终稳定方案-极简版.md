# æœ€ç»ˆç¨³å®šæ–¹æ¡ˆ - æç®€ç‰ˆ

## âš ï¸ é—®é¢˜æ€»ç»“

æˆ‘ä»¬ä¹‹å‰çŠ¯çš„é”™è¯¯ï¼š
1. **è¿‡åº¦è®¾è®¡** - å†™äº†å¤ªå¤š"ç”Ÿäº§çº§"çš„å¤æ‚ä»£ç 
2. **æ²¡æœ‰å…ˆæµ‹è¯•** - åº”è¯¥å…ˆæ‰¾åˆ°æ ¹æœ¬åŸå› ï¼ˆ@TableLogicé…ç½®ï¼‰
3. **é‡å¤ä»£ç ** - selectUserById å’Œ updateUser éƒ½å†™äº†åˆ›å»ºé€»è¾‘
4. **ä¸å¿…è¦çš„æ–‡æ¡£** - å†™äº†å¤§é‡æ–‡æ¡£è€Œä¸æ˜¯è§£å†³æ ¸å¿ƒé—®é¢˜

## âœ… æ ¸å¿ƒé—®é¢˜

**å”¯ä¸€çš„é—®é¢˜ï¼š** `@TableLogic` é…ç½®é”™è¯¯å¯¼è‡´æŸ¥è¯¢å¤±è´¥

```sql
-- é”™è¯¯æŸ¥è¯¢ï¼ˆå¤±è´¥ï¼‰
WHERE deleted_at = 0  -- DATETIMEå­—æ®µæ— æ³• = 0

-- æ­£ç¡®æŸ¥è¯¢ï¼ˆæˆåŠŸï¼‰  
WHERE deleted_at IS NULL  -- æ­£ç¡®
```

## ğŸ¯ æœ€å°åŒ–è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤å®ä½“é…ç½®ï¼ˆå¿…é¡»ï¼‰

```java
// User.java
@TableLogic(value = "NULL", delval = "now()")
private LocalDateTime deletedAt;
```

### 2. ç»Ÿä¸€çš„åˆ›å»ºæ–¹æ³•ï¼ˆ20è¡Œï¼‰

```java
// UserServiceImpl.java
private User getOrCreateUser(Long userId) {
    // 1. æŸ¥è¯¢
    User user = userMapper.selectById(userId);
    if (user != null) {
        return user;
    }
    
    // 2. è·å–ç³»ç»Ÿç”¨æˆ·
    List<RemoteUserVo> sysUsers = remoteUserService.selectListByIds(List.of(userId));
    if (CollUtil.isEmpty(sysUsers)) {
        throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // 3. åˆ›å»º
    User newUser = buildDefaultUserProfile(userId, sysUsers.get(0));
    try {
        userMapper.insert(newUser);
        return newUser;
    } catch (DuplicateKeyException e) {
        return userMapper.selectById(userId); // å¹¶å‘æƒ…å†µ
    }
}

private User buildDefaultUserProfile(Long userId, RemoteUserVo sysUser) {
    return User.builder()
        .userId(userId)
        .nickname(sysUser.getUserName())
        .avatar("https://oss.xypai.com/default/avatar_male.png")
        .avatarThumbnail("https://oss.xypai.com/default/avatar_male.png")
        .gender(0)
        .bio("è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~")
        .countryCode("CN")
        .isRealVerified(false)
        .isGodVerified(false)
        .isActivityExpert(false)
        .isVip(false)
        .isPopular(false)
        .vipLevel(0)
        .wechatUnlockCondition(0)
        .onlineStatus(0)
        .profileCompleteness(10)
        .profileVisible(true)
        .locationVisible(true)
        .onlineStatusVisible(true)
        .allowStrangerMessage(true)
        .notifyFollower(true)
        .notifyLike(true)
        .notifyComment(true)
        .notifyMessage(true)
        .notifyActivity(true)
        .themeMode("auto")
        .createdAt(LocalDateTime.now())
        .updatedAt(LocalDateTime.now())
        .version(0)
        .build();
}
```

### 3. ä½¿ç”¨æ–¹æ³•ï¼ˆ2å¤„ï¼‰

```java
// selectUserById - ç®€åŒ–ä¸º3è¡Œ
@Override
public UserVO selectUserById(Long userId) {
    User user = getOrCreateUser(userId);
    UserVO userVO = BeanUtil.copyProperties(user, UserVO.class);
    enrichUserVO(userVO);
    return userVO;
}

// updateUser - å¼€å¤´åŠ 1è¡Œ
@Override
public boolean updateUser(UserUpdateDTO dto) {
    User existUser = getOrCreateUser(dto.getUserId());
    // ... ç»§ç»­æ›´æ–°é€»è¾‘
}
```

## ğŸ“Š å¯¹æ¯”

| æŒ‡æ ‡ | ä¹‹å‰ï¼ˆå¤æ‚ç‰ˆï¼‰ | ç°åœ¨ï¼ˆæç®€ç‰ˆï¼‰ | æ”¹è¿› |
|------|--------------|--------------|-----|
| ä»£ç è¡Œæ•° | ~200è¡Œ | ~60è¡Œ | -70% |
| æ–¹æ³•æ•°é‡ | 4ä¸ªæ–¹æ³• | 2ä¸ªæ–¹æ³• | -50% |
| å¼‚å¸¸å¤„ç†å±‚çº§ | 3å±‚åµŒå¥— | 1å±‚ | -67% |
| æ–‡æ¡£é¡µæ•° | 5é¡µ | 1é¡µ | -80% |
| å¯è¯»æ€§ | å¤æ‚ | ç®€å• | âœ… |

## âŒ åº”è¯¥åˆ é™¤çš„å†…å®¹

### åˆ é™¤è¿‡åº¦è®¾è®¡çš„æ–‡æ¡£
- `ç”Ÿäº§çº§è§£å†³æ–¹æ¡ˆ-ç”¨æˆ·èµ„æ–™è‡ªåŠ¨åˆå§‹åŒ–.md` - å¤ªé•¿ï¼Œæ²¡å¿…è¦
- å¤§é‡çš„æ—¥å¿—å’Œæ³¨é‡Š - ä»£ç æœ¬èº«åº”è¯¥è¶³å¤Ÿæ¸…æ™°

### ç®€åŒ–ä»£ç 
- åˆ é™¤å¤šä½™çš„æ—¥å¿—ï¼ˆä¿ç•™å…³é”®çš„å³å¯ï¼‰
- åˆ é™¤é‡å¤çš„å¼‚å¸¸å¤„ç†
- åˆå¹¶é‡å¤ä»£ç 

## âœ… æ­£ç¡®çš„å¼€å‘æµç¨‹

### åº”è¯¥è¿™æ ·åšï¼š

1. **å‘ç°é—®é¢˜**
   ```
   ç”¨æˆ·ä¸å­˜åœ¨é”™è¯¯
   ```

2. **æµ‹è¯•æŸ¥è¯¢**
   ```sql
   SELECT * FROM user WHERE user_id = ? AND deleted_at = 0;
   -- ç»“æœï¼šæ— æ•°æ®ï¼ˆä½†ç”¨æˆ·ç¡®å®å­˜åœ¨ï¼‰
   ```

3. **æ‰¾åˆ°æ ¹æœ¬åŸå› **
   ```
   deleted_at æ˜¯ DATETIMEï¼Œä¸èƒ½ç”¨ =0
   éœ€è¦ç”¨ IS NULL
   ```

4. **ä¿®å¤é…ç½®**
   ```java
   @TableLogic(value = "NULL", delval = "now()")
   ```

5. **å†™æœ€å°ä»£ç **
   ```java
   getOrCreateUser() - 20è¡Œæå®š
   ```

6. **æµ‹è¯•éªŒè¯**
   ```
   âœ… å·¥ä½œæ­£å¸¸
   ```

**æ€»è€—æ—¶ï¼š10åˆ†é’Ÿ**

### æˆ‘ä»¬å®é™…åšçš„ï¼š

1. å‘ç°é—®é¢˜
2. å†™å¤æ‚è§£å†³æ–¹æ¡ˆï¼ˆ100è¡Œï¼‰âŒ
3. è¿˜æ˜¯ä¸å·¥ä½œ
4. å†™æ›´å¤æ‚çš„æ–¹æ¡ˆï¼ˆ150è¡Œï¼‰âŒ
5. å‘ç°é…ç½®é—®é¢˜
6. ä¿®å¤é…ç½® âœ…
7. ä»£ç è¿˜æ˜¯å¾ˆå¤æ‚ âŒ
8. ç®€åŒ–ä»£ç  âœ…

**å®é™…è€—æ—¶ï¼š2å°æ—¶**

## ğŸ’¡ ç»éªŒæ•™è®­

### DOï¼ˆåº”è¯¥åšçš„ï¼‰
1. âœ… **å…ˆæ‰¾æ ¹æœ¬åŸå› **ï¼Œä¸è¦æ€¥ç€å†™ä»£ç 
2. âœ… **å†™æœ€å°‘çš„ä»£ç **è§£å†³é—®é¢˜
3. âœ… **æµ‹è¯•é©±åŠ¨**ï¼šå…ˆæµ‹è¯•ï¼Œå†å†™ä»£ç 
4. âœ… **ä¿¡ä»»æ•°æ®åº“**ï¼šç”¨å”¯ä¸€çº¦æŸï¼Œä¸ç”¨å¤æ‚é”
5. âœ… **ä»£ç å³æ–‡æ¡£**ï¼šå¥½ä»£ç ä¸éœ€è¦é•¿æ–‡æ¡£

### DON'Tï¼ˆä¸åº”è¯¥åšçš„ï¼‰
1. âŒ ä¸è¦è¿‡åº¦è®¾è®¡"ç”Ÿäº§çº§"æ–¹æ¡ˆ
2. âŒ ä¸è¦åµŒå¥—3å±‚ä»¥ä¸Šçš„try-catch
3. âŒ ä¸è¦é‡å¤ä»£ç 
4. âŒ ä¸è¦å†™è¶…è¿‡å¿…è¦çš„æ³¨é‡Š
5. âŒ ä¸è¦åœ¨æ²¡æ‰¾åˆ°åŸå› å‰å°±å†™å¤æ‚ä»£ç 

## ğŸ“ æœ€é‡è¦çš„åŸåˆ™

> **Keep It Simple, Stupid (KISS)**
> 
> æœ€å¥½çš„ä»£ç æ˜¯æœ€å°‘çš„ä»£ç 
> æœ€å¥½çš„æ–‡æ¡£æ˜¯æ¸…æ™°çš„ä»£ç 
> æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆ

## ğŸ“ æ£€æŸ¥æ¸…å•

åœ¨å†™ä»£ç å‰é—®è‡ªå·±ï¼š

- [ ] æˆ‘çœŸçš„ç†è§£é—®é¢˜çš„æ ¹æœ¬åŸå› äº†å—ï¼Ÿ
- [ ] è¿™æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ
- [ ] æˆ‘èƒ½ç”¨æ›´å°‘çš„ä»£ç å®ç°å—ï¼Ÿ
- [ ] æ•°æ®åº“çº¦æŸèƒ½è§£å†³è¿™ä¸ªé—®é¢˜å—ï¼Ÿ
- [ ] æˆ‘çœŸçš„éœ€è¦è¿™ä¹ˆå¤šå¼‚å¸¸å¤„ç†å—ï¼Ÿ
- [ ] è¿™æ®µä»£ç 3ä¸ªæœˆåæˆ‘è¿˜èƒ½çœ‹æ‡‚å—ï¼Ÿ

**å¦‚æœä»»ä½•ä¸€ä¸ªç­”æ¡ˆæ˜¯"ä¸ç¡®å®š"ï¼Œåœä¸‹æ¥é‡æ–°æ€è€ƒã€‚**

## âœ… æœ€ç»ˆä»£ç ï¼ˆå®Œæ•´ç‰ˆï¼‰

```java
// 1. User.java - ä¿®å¤é…ç½®
@TableLogic(value = "NULL", delval = "now()")
private LocalDateTime deletedAt;

// 2. UserServiceImpl.java - æ·»åŠ æ–¹æ³•
private User getOrCreateUser(Long userId) {
    User user = userMapper.selectById(userId);
    if (user != null) return user;
    
    List<RemoteUserVo> sysUsers = remoteUserService.selectListByIds(List.of(userId));
    if (CollUtil.isEmpty(sysUsers)) throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨");
    
    User newUser = buildDefaultUserProfile(userId, sysUsers.get(0));
    try {
        userMapper.insert(newUser);
        return newUser;
    } catch (DuplicateKeyException e) {
        return userMapper.selectById(userId);
    }
}

// 3. ä½¿ç”¨å®ƒ
public UserVO selectUserById(Long userId) {
    User user = getOrCreateUser(userId);
    UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
    enrichUserVO(vo);
    return vo;
}

public boolean updateUser(UserUpdateDTO dto) {
    User user = getOrCreateUser(dto.getUserId());
    // ... æ›´æ–°é€»è¾‘
}
```

**æ€»å…±ï¼šçº¦60è¡Œä»£ç ï¼Œæå®šæ‰€æœ‰é—®é¢˜ã€‚**

---

**ç»“è®ºï¼šå°‘å³æ˜¯å¤šã€‚ç®€å•å³æ˜¯ç¾ã€‚**
