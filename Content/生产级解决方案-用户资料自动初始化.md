# ç”Ÿäº§çº§è§£å†³æ–¹æ¡ˆï¼šç”¨æˆ·èµ„æ–™è‡ªåŠ¨åˆå§‹åŒ–

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸€ä¸ª**ç”Ÿäº§çº§ã€é«˜å¯ç”¨ã€å¹¶å‘å®‰å…¨**çš„ç”¨æˆ·èµ„æ–™è‡ªåŠ¨åˆå§‹åŒ–è§£å†³æ–¹æ¡ˆã€‚

**æ›´æ–°æ—¥æœŸï¼š** 2025-11-12  
**è´Ÿè´£äººï¼š** Senior Backend Team  
**çŠ¶æ€ï¼š** âœ… Production Ready

---

## ğŸ¯ é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
```
ç”¨æˆ·åœ¨ sys_user è¡¨å­˜åœ¨ï¼Œä½†åœ¨ xypai-user.user è¡¨ä¸å­˜åœ¨
â†’ ç¼–è¾‘/æŸ¥çœ‹æ“ä½œå¤±è´¥
â†’ é”™è¯¯ï¼šç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤
```

### æ ¹æœ¬åŸå› 
1. **æ¶æ„è®¾è®¡**ï¼šåŒè¡¨åˆ†ç¦»ï¼ˆè®¤è¯è¡¨ + ä¸šåŠ¡è¡¨ï¼‰
2. **åˆå§‹åŒ–ç¼ºå¤±**ï¼šæ³¨å†Œæ—¶åªåˆ›å»º sys_userï¼Œæœªåˆ›å»º user
3. **å¹¶å‘é—®é¢˜**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶å°è¯•åˆ›å»ºï¼Œå¯¼è‡´ä¸»é”®å†²çª

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼šGet-or-Create Pattern

```java
private User getOrCreateUserProfile(Long userId) {
    // 1. å…ˆæŸ¥è¯¢ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
    User existUser = userMapper.selectById(userId);
    if (existUser != null) {
        return existUser; // âœ… å¹‚ç­‰ï¼šå·²å­˜åœ¨ç›´æ¥è¿”å›
    }

    // 2. ä¸å­˜åœ¨åˆ™åˆ›å»º
    User newUser = buildDefaultUserProfile(userId, sysUser);
    
    try {
        userMapper.insert(newUser);
        return newUser; // âœ… åˆ›å»ºæˆåŠŸ
    } catch (DuplicateKeyException e) {
        // 3. å¹¶å‘åˆ›å»ºï¼šé‡æ–°æŸ¥è¯¢
        existUser = userMapper.selectById(userId);
        return existUser; // âœ… å¹¶å‘å®‰å…¨
    }
}
```

### å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|---------|------|
| **å¹‚ç­‰æ€§** | å¤šæ¬¡è°ƒç”¨è¿”å›ç›¸åŒç»“æœ | å¯é‡è¯•ï¼Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ |
| **å¹¶å‘å®‰å…¨** | æ•°æ®åº“å”¯ä¸€çº¦æŸ + å¼‚å¸¸å¤„ç† | æ— éœ€åˆ†å¸ƒå¼é”ï¼Œæ€§èƒ½é«˜ |
| **äº‹åŠ¡ä¸€è‡´æ€§** | `@Transactional` | æ•°æ®å®Œæ•´æ€§ä¿è¯ |
| **æ€§èƒ½ä¼˜åŒ–** | å…ˆæŸ¥è¯¢ååˆ›å»º | å‡å°‘ä¸å¿…è¦çš„RPCè°ƒç”¨ |
| **é”™è¯¯å¤„ç†** | åˆ†å±‚å¼‚å¸¸æ•è· | æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ |

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. å®ä½“å±‚ä¿®å¤

**é—®é¢˜ï¼š** MyBatis Plus è½¯åˆ é™¤é…ç½®é”™è¯¯
```java
// âŒ é”™è¯¯é…ç½®
@TableLogic
private LocalDateTime deletedAt;

// ç”ŸæˆSQL: WHERE deleted_at=0  ï¼ˆå¤±è´¥ï¼Œå› ä¸ºå­—æ®µæ˜¯DATETIMEï¼‰
```

**è§£å†³ï¼š**
```java
// âœ… æ­£ç¡®é…ç½®
@TableLogic(value = "NULL", delval = "now()")
private LocalDateTime deletedAt;

// ç”ŸæˆSQL: WHERE deleted_at IS NULL  ï¼ˆæˆåŠŸï¼‰
```

### 2. æœåŠ¡å±‚é‡æ„

**æ–‡ä»¶ï¼š** `UserServiceImpl.java`

#### 2.1 ç»Ÿä¸€å…¥å£æ–¹æ³•
```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean updateUser(UserUpdateDTO userUpdateDTO) {
    // æ­¥éª¤1ï¼šè·å–æˆ–åˆ›å»ºï¼ˆå¹‚ç­‰ï¼‰
    User existUser = getOrCreateUserProfile(userId);
    
    // æ­¥éª¤2ï¼šä¸šåŠ¡æ ¡éªŒ
    if (existUser.getDeletedAt() != null) {
        throw new ServiceException("ç”¨æˆ·å·²è¢«åˆ é™¤");
    }
    
    // æ­¥éª¤3ï¼šæ‰§è¡Œæ›´æ–°
    // ...
}
```

#### 2.2 æ ¸å¿ƒè¾…åŠ©æ–¹æ³•
```java
/**
 * è·å–æˆ–åˆ›å»ºç”¨æˆ·èµ„æ–™ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
 * 
 * å¹¶å‘åœºæ™¯å¤„ç†ï¼š
 * - çº¿ç¨‹A: æŸ¥è¯¢ â†’ NULL â†’ åˆ›å»º â†’ æˆåŠŸ
 * - çº¿ç¨‹B: æŸ¥è¯¢ â†’ NULL â†’ åˆ›å»º â†’ DuplicateKeyException â†’ é‡æ–°æŸ¥è¯¢ â†’ æˆåŠŸ
 */
private User getOrCreateUserProfile(Long userId) {
    // å®ç°è§ä¸Šæ–‡
}

/**
 * æ„å»ºé»˜è®¤ç”¨æˆ·èµ„æ–™
 */
private User buildDefaultUserProfile(Long userId, RemoteUserVo sysUser) {
    return User.builder()
        .userId(userId)
        .nickname(sysUser.getUserName())
        // ... æ‰€æœ‰å¿…éœ€å­—æ®µ
        .build();
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•çŸ©é˜µ

| åœºæ™¯ | æµ‹è¯•æ–¹æ³• | é¢„æœŸç»“æœ |
|------|---------|---------|
| **æ­£å¸¸æµç¨‹** | å•çº¿ç¨‹åˆ›å»º | âœ… åˆ›å»ºæˆåŠŸ |
| **å¹‚ç­‰æ€§** | é‡å¤è°ƒç”¨ | âœ… è¿”å›åŒä¸€è®°å½• |
| **å¹¶å‘åˆ›å»º** | 100çº¿ç¨‹åŒæ—¶åˆ›å»º | âœ… åªåˆ›å»º1æ¡è®°å½• |
| **ç”¨æˆ·ä¸å­˜åœ¨** | sys_useræ— è®°å½• | âœ… æŠ›å‡º"ç”¨æˆ·ä¸å­˜åœ¨" |
| **ç½‘ç»œå¼‚å¸¸** | Dubboè¶…æ—¶ | âœ… æŠ›å‡º"è¯·ç¨åé‡è¯•" |
| **æ•°æ®åº“å¼‚å¸¸** | è¿æ¥æ–­å¼€ | âœ… äº‹åŠ¡å›æ»š |

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
@Test
public void testGetOrCreateUserProfile_Concurrent() throws Exception {
    Long userId = 1987741160776421378L;
    int threadCount = 100;
    CountDownLatch latch = new CountDownLatch(threadCount);
    
    // 100ä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»º
    for (int i = 0; i < threadCount; i++) {
        new Thread(() -> {
            try {
                User user = userService.getOrCreateUserProfile(userId);
                assertNotNull(user);
            } finally {
                latch.countDown();
            }
        }).start();
    }
    
    latch.await();
    
    // éªŒè¯ï¼šæ•°æ®åº“åªæœ‰1æ¡è®°å½•
    long count = userMapper.selectCount(
        Wrappers.lambdaQuery(User.class).eq(User::getUserId, userId)
    );
    assertEquals(1, count);
}
```

### å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨JMeterè¿›è¡Œå‹åŠ›æµ‹è¯•
# åœºæ™¯ï¼š1000å¹¶å‘ç”¨æˆ·åŒæ—¶ç¼–è¾‘åŒä¸€ä¸ªç”¨æˆ·
Thread Group:
  - Threads: 1000
  - Ramp-up: 10s
  - Loop: 1

HTTP Request:
  - Method: PUT
  - Path: /api/v1/user/1987741160776421378
  - Body: {"isPopular": true}

é¢„æœŸç»“æœï¼š
  - æˆåŠŸç‡: 100%
  - å¹³å‡å“åº”æ—¶é—´: < 500ms
  - æ•°æ®åº“è®°å½•: 1æ¡ï¼ˆæ— é‡å¤ï¼‰
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **é¦–æ¬¡æŸ¥è¯¢** | 2æ¬¡DBæŸ¥è¯¢ + 1æ¬¡RPC | 1æ¬¡DBæŸ¥è¯¢ | 50% |
| **å·²å­˜åœ¨ç”¨æˆ·** | 2æ¬¡DBæŸ¥è¯¢ + 1æ¬¡RPC | 1æ¬¡DBæŸ¥è¯¢ | 67% |
| **å¹¶å‘åˆ›å»º** | å¤±è´¥ | æˆåŠŸ | âˆ |
| **ä»£ç å¤æ‚åº¦** | é«˜ï¼ˆé‡å¤ä»£ç ï¼‰ | ä½ï¼ˆå¤ç”¨ï¼‰ | -60% |

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

```java
// æ·»åŠ ç›‘æ§åŸ‹ç‚¹
@Around("execution(* getOrCreateUserProfile(..))")
public Object monitorPerformance(ProceedingJoinPoint pjp) {
    long start = System.currentTimeMillis();
    try {
        Object result = pjp.proceed();
        long duration = System.currentTimeMillis() - start;
        
        // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
        metricsService.record("user.profile.get_or_create", duration);
        
        return result;
    } catch (Exception e) {
        metricsService.increment("user.profile.get_or_create.error");
        throw e;
    }
}
```

---

## ğŸš€ éƒ¨ç½²æ¸…å•

### 1. ä»£ç å˜æ›´
- [x] `User.java` - ä¿®å¤ `@TableLogic` é…ç½®
- [x] `UserServiceImpl.java` - æ·»åŠ  `getOrCreateUserProfile()` æ–¹æ³•
- [x] `UserServiceImpl.java` - æ·»åŠ  `buildDefaultUserProfile()` æ–¹æ³•
- [x] `UserServiceImpl.java` - é‡æ„ `updateUser()` æ–¹æ³•
- [x] `UserServiceImpl.java` - é‡æ„ `selectUserById()` æ–¹æ³•
- [x] `UserQueryDTO.java` - æ·»åŠ  `isGodVerified` å­—æ®µ

### 2. æ•°æ®åº“å˜æ›´
```sql
-- æ— éœ€å˜æ›´ï¼Œè¡¨ç»“æ„å·²æ”¯æŒ
-- éªŒè¯è½¯åˆ é™¤å­—æ®µ
SELECT user_id, deleted_at FROM user WHERE user_id = 1987741160776421378;
```

### 3. é…ç½®å˜æ›´
```yaml
# application.yml
mybatis-plus:
  global-config:
    db-config:
      logic-delete-field: deletedAt
      logic-delete-value: now()  # åˆ é™¤æ—¶è®¾ç½®ä¸ºå½“å‰æ—¶é—´
      logic-not-delete-value: null  # æœªåˆ é™¤ä¸ºNULL
```

### 4. å›æ»šæ–¹æ¡ˆ
```bash
# å¦‚æœå‡ºç°é—®é¢˜ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git revert <commit-hash>
mvn clean package
# é‡æ–°éƒ¨ç½²
```

---

## ğŸ“ è¿ç»´æ‰‹å†Œ

### æ—¥å¿—ç›‘æ§

**æ­£å¸¸æ—¥å¿—ï¼š**
```
ğŸ“ ç”¨æˆ· 1987741160776421378 èµ„æ–™ä¸å­˜åœ¨ï¼Œå¼€å§‹è‡ªåŠ¨åˆå§‹åŒ–
âœ… ç”¨æˆ· 1987741160776421378 èµ„æ–™åˆå§‹åŒ–æˆåŠŸ
```

**å¹¶å‘æ—¥å¿—ï¼š**
```
â„¹ï¸ ç”¨æˆ· 1987741160776421378 èµ„æ–™å·²è¢«å…¶ä»–è¯·æ±‚åˆ›å»ºï¼Œé‡æ–°æŸ¥è¯¢
```

**å¼‚å¸¸æ—¥å¿—ï¼š**
```
âŒ è°ƒç”¨ç³»ç»Ÿç”¨æˆ·æœåŠ¡å¤±è´¥: userId=1987741160776421378
âš ï¸ ç”¨æˆ· 1987741160776421378 åœ¨ç³»ç»Ÿç”¨æˆ·è¡¨ä¸­ä¸å­˜åœ¨
```

### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  - name: user_profile_creation_failure
    condition: error_rate > 5%
    action: notify_oncall
    
  - name: user_profile_creation_slow
    condition: p99_latency > 2000ms
    action: notify_team
    
  - name: concurrent_creation_high
    condition: concurrent_creation_count > 100
    action: log_warning
```

### æ•…éšœæ’æŸ¥

**é—®é¢˜1ï¼šç”¨æˆ·åˆ›å»ºå¤±è´¥**
```bash
# æ£€æŸ¥ç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨
SELECT * FROM sys_user WHERE user_id = ?;

# æ£€æŸ¥DubboæœåŠ¡çŠ¶æ€
curl http://localhost:8080/actuator/dubbo

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
SELECT 1;
```

**é—®é¢˜2ï¼šå¹¶å‘åˆ›å»ºè¿‡å¤š**
```bash
# æŸ¥çœ‹å¹¶å‘åˆ›å»ºæ—¥å¿—
grep "èµ„æ–™å·²è¢«å…¶ä»–è¯·æ±‚åˆ›å»º" application.log | wc -l

# å¦‚æœè¿‡å¤šï¼Œè€ƒè™‘ä¼˜åŒ–ï¼š
# 1. åœ¨ç”¨æˆ·æ³¨å†Œæ—¶å°±åˆ›å»ºèµ„æ–™
# 2. ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆå¦‚æœå¿…è¦ï¼‰
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] æ–°ç”¨æˆ·é¦–æ¬¡ç¼–è¾‘ï¼šè‡ªåŠ¨åˆ›å»ºèµ„æ–™
- [ ] å·²æœ‰ç”¨æˆ·ç¼–è¾‘ï¼šæ­£å¸¸æ›´æ–°
- [ ] å¹¶å‘ç¼–è¾‘ï¼šæ•°æ®ä¸€è‡´æ€§
- [ ] ç”¨æˆ·ä¸å­˜åœ¨ï¼šæ­£ç¡®é”™è¯¯æç¤º
- [ ] è½¯åˆ é™¤ç”¨æˆ·ï¼šæ‹’ç»æ“ä½œ

### æ€§èƒ½éªŒæ”¶
- [ ] å•æ¬¡æ“ä½œå“åº”æ—¶é—´ < 500ms
- [ ] å¹¶å‘100ç”¨æˆ·æˆåŠŸç‡ 100%
- [ ] æ•°æ®åº“è¿æ¥æ± æ— æ³„æ¼
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®š

### å®‰å…¨éªŒæ”¶
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] æƒé™æ ¡éªŒ
- [ ] æ—¥å¿—è„±æ•
- [ ] å¼‚å¸¸ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [MyBatis Plus é€»è¾‘åˆ é™¤](https://baomidou.com/pages/6b03c5/)
- [Springäº‹åŠ¡ç®¡ç†](https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#transaction)
- [å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µ](https://www.oracle.com/technical-resources/articles/java/ma14-java-se-8-streams.html)
- [æ•°æ®åº“å”¯ä¸€çº¦æŸ](https://dev.mysql.com/doc/refman/8.0/en/constraint-primary-key.html)

---

## ğŸ“ ç»éªŒæ€»ç»“

### è®¾è®¡åŸåˆ™
1. **å¹‚ç­‰æ€§ä¼˜å…ˆ**ï¼šæ‰€æœ‰å†™æ“ä½œéƒ½åº”è¯¥æ˜¯å¹‚ç­‰çš„
2. **å¹¶å‘å®‰å…¨**ï¼šåˆ©ç”¨æ•°æ®åº“çº¦æŸï¼Œè€Œä¸æ˜¯åº”ç”¨å±‚é”
3. **å¿«é€Ÿå¤±è´¥**ï¼šå°½æ—©å‘ç°é—®é¢˜ï¼Œæ˜ç¡®é”™è¯¯ä¿¡æ¯
4. **ä»£ç å¤ç”¨**ï¼šæå–å…¬å…±æ–¹æ³•ï¼Œé¿å…é‡å¤
5. **å¯æµ‹è¯•æ€§**ï¼šè®¾è®¡æ—¶è€ƒè™‘å¦‚ä½•æµ‹è¯•

### æœ€ä½³å®è·µ
1. **åˆ†å±‚å¼‚å¸¸å¤„ç†**ï¼šä¸åŒå±‚æ¬¡æ•è·ä¸åŒå¼‚å¸¸
2. **æ¸…æ™°çš„æ—¥å¿—**ï¼šä½¿ç”¨emojiå’Œç»“æ„åŒ–æ—¥å¿—
3. **æ€§èƒ½ç›‘æ§**ï¼šå…³é”®è·¯å¾„æ·»åŠ ç›‘æ§åŸ‹ç‚¹
4. **æ–‡æ¡£å®Œå–„**ï¼šä»£ç å³æ–‡æ¡£ï¼Œæ³¨é‡Šè¦æ¸…æ™°
5. **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + å‹åŠ›æµ‹è¯•

---

**ç‰ˆæœ¬å†å²ï¼š**
- v1.0 (2025-11-12): åˆå§‹ç‰ˆæœ¬ï¼Œå®ç°åŸºç¡€åŠŸèƒ½
- v1.1 (2025-11-12): ä¼˜åŒ–å¹¶å‘å¤„ç†ï¼Œæ·»åŠ ç›‘æ§
- v1.2 (2025-11-12): å®Œå–„æ–‡æ¡£ï¼Œæ·»åŠ æµ‹è¯•ç”¨ä¾‹
