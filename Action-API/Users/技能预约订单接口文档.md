# 技能预约订单接口文档

## 概述
本文档定义技能服务预约和订单确认的所有接口,包括技能详情查看、订单创建和支付流程的接口调用时机和参数要求。

---

## 一、查看技能服务详情

### 用户操作
1. 用户从技能列表或用户主页点击某个技能卡片
2. **进入技能详情页** → 触发接口加载数据

### 接口定义
**接口:** `GET /api/skills/{skillId}/booking-detail`

**路径参数:**
```typescript
{
  skillId: string;  // 技能ID,从上一页传入
}
```

**查询参数:**
```typescript
{
  userId?: string;  // 可选,技能发布者的用户ID(如从用户主页进入)
}
```

**响应数据:**
```typescript
{
  code: 200,
  message: "获取成功",
  data: {
    skillId: string;           // 技能ID
    skillName: string;         // 技能名称,如"王者荣耀"
    skillCover: string;        // 技能封面图URL

    // 发布者信息
    provider: {
      userId: string;          // 发布者ID
      nickname: string;        // 昵称,如"昵称123"
      avatar: string;          // 头像URL
      gender: number;          // 性别图标(19=女性)
      isRealNameVerified: boolean;  // 是否实名认证
      rank: string;            // 段位,如"大神"
      tags: string[];          // 标签,如["荣耀王者","巅峰1800+"]
      region: string;          // 区服,如"微信区"
    },

    // 服务信息
    serviceType: string;       // 服务类型,如"王者荣耀"
    price: number;             // 单价(金币)
    priceUnit: string;         // 计价单位,如"金币/局"

    // 评价统计
    rating: {
      score: number;           // 评分,如4.5
      total: number;           // 总评价数,如100
      goodRate: number;        // 好评率,如99%(0-100)
    },

    // 详细信息
    description: string;       // 技能描述
    serviceIntro: string;      // 服务介绍
    skillHighlights: string[]; // 技能亮点

    // 评价列表(前几条)
    reviews: Array<{
      reviewId: string;
      userId: string;
      nickname: string;
      avatar: string;
      rating: number;          // 评分1-5星
      content: string;         // 评价内容
      images: string[];        // 评价图片
      createTime: string;      // 时间,如"2025-14-49"
    }>,

    // 可预约信息
    isBookable: boolean;       // 是否可预约
    availableSlots: string[];  // 可预约时间段,如["1小时30分钟后","2小时后"]
    minSessions: number;       // 最少预约场次
    maxSessions: number;       // 最多预约场次

    // 互动状态
    isFollowed: boolean;       // 当前用户是否已关注发布者
    canMessage: boolean;       // 是否可以发私信
  }
}
```

### 前端验证
- 必须提供有效的 `skillId`
- 需要登录状态(查看详情需要权限)

### 前端行为
- 成功后:
  - 渲染技能详情页面所有内容
  - 显示发布者信息、评分、评价列表
  - 根据 `isBookable` 显示/禁用"下单"按钮
  - 根据 `canMessage` 显示/禁用"私信"按钮
- 失败后:
  - (404) 显示"技能不存在或已下架"
  - (403) 显示"该技能仅特定用户可见"

---

## 二、查看完整评价列表

### 用户操作
1. 在技能详情页
2. **点击"评价(100+)"或"查看全部"** → 触发接口加载完整评价

### 接口定义
**接口:** `GET /api/skills/{skillId}/reviews`

**路径参数:**
```typescript
{
  skillId: string;  // 技能ID
}
```

**查询参数:**
```typescript
{
  page: number;     // 页码,从1开始
  pageSize: number; // 每页数量,建议20
  sortBy?: string;  // 排序方式: "time"(最新) | "rating"(评分) | "helpful"(最有用)
  filterRating?: number; // 筛选评分: 1-5星,不传则显示全部
}
```

**响应数据:**
```typescript
{
  code: 200,
  message: "获取成功",
  data: {
    total: number;    // 总评价数
    goodRate: number; // 好评率(%)
    list: Array<{
      reviewId: string;
      userId: string;
      nickname: string;
      avatar: string;
      rating: number;          // 1-5星
      content: string;         // 评价内容
      images: string[];        // 评价图片
      createTime: string;      // 发布时间
      helpfulCount: number;    // 有用数
      replyContent?: string;   // 发布者回复
      replyTime?: string;      // 回复时间
    }>
  }
}
```

### 前端验证
- 必须提供有效的 `skillId`
- `page` 必须 ≥ 1
- `pageSize` 建议10-50之间

### 前端行为
- 成功后:
  - 展示完整评价列表
  - 支持下拉刷新和上拉加载更多
  - 显示评分筛选器(全部/5星/4星/3星/2星/1星)
  - 显示好评率统计
- 失败后: 显示"加载失败,请重试"

---

## 三、发送私信

### 用户操作
1. 在技能详情页
2. **点击"私信"按钮** → 跳转到聊天页面(传递用户ID)

### 接口定义
**说明:** 此操作不直接触发接口,而是:
1. 前端跳转至聊天页面: `/chat?userId={providerId}`
2. 聊天页面会调用聊天模块的接口(详见"聊天功能接口文档")

**传递参数:**
```typescript
{
  userId: string;      // 技能发布者ID
  nickname: string;    // 发布者昵称(用于页面标题)
  avatar: string;      // 发布者头像(用于页面显示)
  context?: {          // 可选,聊天上下文
    type: "skill_inquiry",
    skillId: string;
    skillName: string;
  }
}
```

### 前端验证
- 必须登录
- 不能向自己发送私信
- 检查 `canMessage` 状态(对方是否允许接收私信)

### 前端行为
- 成功后: 跳转到与该用户的聊天页面
- 失败后:
  - 未登录: 跳转登录页
  - 对方禁止私信: 显示"该用户已关闭私信功能"
  - 自己给自己: 显示"不能给自己发私信"

---

## 四、点击下单按钮

### 用户操作
1. 在技能详情页
2. **点击"下单"按钮** → 跳转到订单确认页

### 接口定义
**说明:** 此操作为纯前端跳转,不触发接口调用。

**跳转路由:**
```
/order/confirm?skillId={skillId}
```

**传递参数:**
```typescript
{
  skillId: string;     // 技能ID
  providerId: string;  // 服务提供者ID
}
```

### 前端验证
- 必须登录
- 检查 `isBookable` 状态(技能是否可预约)
- 不能预约自己的技能

### 前端行为
- 成功后: 跳转到订单确认页,携带技能ID
- 失败后:
  - 未登录: 跳转登录页
  - 不可预约: 显示"该技能暂不可预约"
  - 预约自己的技能: 显示"不能预约自己的技能"

---

## 五、加载订单确认页数据

### 用户操作
1. 从技能详情页点击"下单"
2. **进入订单确认页** → 触发接口加载订单信息

### 接口定义
**接口:** `GET /api/orders/confirm-info/{skillId}`

**路径参数:**
```typescript
{
  skillId: string;  // 技能ID,从上一页传入
}
```

**响应数据:**
```typescript
{
  code: 200,
  message: "获取成功",
  data: {
    // 技能信息
    skill: {
      skillId: string;
      skillName: string;     // 如"王者荣耀"
      skillCover: string;    // 封面图
      serviceType: string;   // 服务类型
    },

    // 服务提供者信息
    provider: {
      userId: string;
      nickname: string;      // 如"昵称123"
      avatar: string;
      gender: number;        // 19=女性
      tags: string[];        // 如["荣耀王者","巅峰1800+"]
      rank: string;          // 如"大神"
      region: string;        // 如"微信区"
    },

    // 价格信息
    pricing: {
      price: number;         // 单价,如10
      currency: string;      // 货币类型,如"金币"
      unit: string;          // 计价单位,如"局"
      priceDisplay: string;  // 展示文本,如"10金币/局"
    },

    // 预约设置
    booking: {
      minSessions: number;   // 最少场次,默认1
      maxSessions: number;   // 最多场次,默认99
      defaultSessions: number; // 默认场次,默认1
      availableSlots: Array<{
        slotId: string;
        time: string;        // 时间描述,如"1小时30分钟后"
        timestamp: number;   // 具体时间戳
        isAvailable: boolean;
      }>,
      defaultSlotId: string; // 默认选中的时间段ID
    },

    // 用户余额
    userBalance: {
      coins: number;         // 当前金币余额
      isEnough: boolean;     // 余额是否足够(按默认场次计算)
    }
  }
}
```

### 前端验证
- 必须提供有效的 `skillId`
- 必须登录

### 前端行为
- 成功后:
  - 渲染订单确认页面
  - 显示技能信息、服务提供者信息
  - 初始化场次计数器(默认值)
  - 显示可预约时间列表
  - 计算并显示总价
  - 根据 `isEnough` 显示余额提示
- 失败后:
  - (404) 显示"技能不存在",返回上一页
  - (403) 显示"该技能不可预约"

---

## 六、调整预约场次

### 用户操作
1. 在订单确认页
2. **点击"+"或"-"按钮调整场次** → 纯前端计算,不触发接口

### 前端逻辑
```typescript
// 场次范围验证
const minSessions = 1;  // 从订单确认信息获取
const maxSessions = 99; // 从订单确认信息获取

// 点击"+"
function incrementSessions() {
  if (currentSessions < maxSessions) {
    currentSessions += 1;
    updateTotalPrice();
  } else {
    showToast("最多可预约{maxSessions}场次");
  }
}

// 点击"-"
function decrementSessions() {
  if (currentSessions > minSessions) {
    currentSessions -= 1;
    updateTotalPrice();
  } else {
    showToast("至少预约{minSessions}场次");
  }
}

// 更新总价
function updateTotalPrice() {
  totalPrice = unitPrice * currentSessions;
  // 更新页面显示: 共计: {totalPrice} 金币
}
```

### 前端验证
- 场次必须在 `minSessions` 和 `maxSessions` 之间
- 场次必须为正整数

### 前端行为
- 实时更新场次显示
- 实时更新总价显示: "共计: {totalPrice} 金币"
- 达到上下限时:
  - 最小值: 禁用"-"按钮或显示提示
  - 最大值: 禁用"+"按钮或显示提示

---

## 七、选择预约时间

### 用户操作
1. 在订单确认页
2. **点击"预约"时间栏** → 打开时间选择器(纯前端交互)

### 前端逻辑
- 打开时间选择器弹窗/底部面板
- 显示可预约时间列表(从订单确认信息获取)
- 用户选择后更新页面显示
- 不触发接口调用

**时间选择器数据来源:**
```typescript
{
  availableSlots: Array<{
    slotId: string;
    time: string;        // 显示文本,如"1小时30分钟后"
    timestamp: number;   // 实际时间戳
    isAvailable: boolean;
  }>
}
```

### 前端验证
- 只能选择 `isAvailable: true` 的时间段
- 必须选择一个时间段才能提交订单

### 前端行为
- 打开选择器: 显示可预约时间列表
- 选择时间:
  - 更新页面显示: "预约: {选中的时间描述}"
  - 保存 `slotId` 用于提交订单
- 如果所有时间段都不可用: 显示"暂无可预约时间"

---

## 八、创建订单并支付

### 用户操作
1. 在订单确认页确认所有信息
2. **点击"立即支付"按钮** → 触发接口创建订单并扣款

### 接口定义
**接口:** `POST /api/orders/create`

**请求参数:**
```typescript
{
  skillId: string;       // 技能ID
  providerId: string;    // 服务提供者ID
  sessions: number;      // 预约场次,如1
  slotId: string;        // 预约时间段ID
  totalAmount: number;   // 总金额(金币)
  paymentMethod: "coin"; // 支付方式,当前仅支持金币支付
}
```

**响应数据:**
```typescript
{
  code: 200,
  message: "支付成功",
  data: {
    orderId: string;       // 订单ID
    orderNo: string;       // 订单号,用于展示
    status: string;        // 订单状态: "paid"
    paidAmount: number;    // 实际支付金额
    paidAt: string;        // 支付时间

    // 订单详情
    skill: {
      skillId: string;
      skillName: string;
      skillCover: string;
    },
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
    },
    sessions: number;      // 预约场次
    bookingTime: string;   // 预约时间描述
    bookingTimestamp: number; // 预约时间戳

    // 用户剩余余额
    remainingBalance: number;
  }
}
```

### 前端验证
**提交前验证:**
- 必须登录
- 必须选择预约时间(`slotId` 不为空)
- 场次必须在有效范围内(minSessions - maxSessions)
- 总金额必须正确: `sessions × unitPrice`
- 余额必须充足

**验证失败提示:**
- 未选择时间: "请选择预约时间"
- 场次无效: "预约场次必须在{min}-{max}之间"
- 余额不足: "金币余额不足,请先充值"

### 前端行为
**提交时:**
- 显示loading状态
- 禁用"立即支付"按钮(防止重复提交)

**成功后:**
- 显示Toast: "支付成功"
- 跳转到订单详情页: `/order/detail/{orderId}`
- 或跳转到订单列表页并高亮新订单
- 更新全局金币余额

**失败后:**
- (400) 显示具体错误信息(如"预约场次超出限制")
- (402) 显示"余额不足,请充值" + 跳转充值页按钮
- (404) 显示"技能不存在或已下架"
- (409) 显示"该时间段已被预约,请选择其他时间"
- (500) 显示"支付失败,请重试" + 重试按钮

---

## 九、查看订单详情

### 用户操作
1. 支付成功后自动跳转
2. 或从订单列表点击进入
3. **进入订单详情页** → 触发接口加载订单详情

### 接口定义
**接口:** `GET /api/orders/{orderId}`

**路径参数:**
```typescript
{
  orderId: string;  // 订单ID
}
```

**响应数据:**
```typescript
{
  code: 200,
  message: "获取成功",
  data: {
    orderId: string;
    orderNo: string;       // 订单号
    status: string;        // 订单状态: "paid"|"in_progress"|"completed"|"cancelled"|"refunded"
    statusText: string;    // 状态文本: "已支付"|"进行中"|"已完成"|"已取消"|"已退款"

    // 技能信息
    skill: {
      skillId: string;
      skillName: string;
      skillCover: string;
      serviceType: string;
    },

    // 服务提供者
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
      phone?: string;      // 联系方式(仅支付后显示)
    },

    // 订单信息
    sessions: number;      // 场次
    unitPrice: number;     // 单价
    totalAmount: number;   // 总金额
    currency: string;      // 货币类型

    // 时间信息
    bookingTime: string;   // 预约时间描述
    bookingTimestamp: number; // 预约时间戳
    createdAt: string;     // 下单时间
    paidAt: string;        // 支付时间
    completedAt?: string;  // 完成时间

    // 可执行操作
    actions: {
      canCancel: boolean;   // 是否可以取消
      canContact: boolean;  // 是否可以联系
      canReview: boolean;   // 是否可以评价
      canRefund: boolean;   // 是否可以申请退款
    },

    // 评价信息(如已评价)
    review?: {
      reviewId: string;
      rating: number;
      content: string;
      createTime: string;
    }
  }
}
```

### 前端验证
- 必须提供有效的 `orderId`
- 必须登录
- 只能查看自己的订单(买家或卖家)

### 前端行为
- 成功后:
  - 显示完整订单信息
  - 根据订单状态显示不同操作按钮
  - 根据 `actions` 显示/隐藏操作按钮
  - 支持联系服务提供者(跳转聊天)
- 失败后:
  - (404) 显示"订单不存在"
  - (403) 显示"无权查看该订单"

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 查看技能详情 | 点击技能卡片 | `/api/skills/{skillId}/booking-detail` | GET |
| 2 | 查看完整评价 | 点击"评价"或"查看全部" | `/api/skills/{skillId}/reviews` | GET |
| 3 | 发送私信 | 点击"私信"按钮 | 跳转聊天页(详见聊天模块接口) | - |
| 4 | 点击下单 | 点击"下单"按钮 | 页面跳转(不触发接口) | - |
| 5 | 加载订单确认 | 进入订单确认页 | `/api/orders/confirm-info/{skillId}` | GET |
| 6 | 调整场次 | 点击"+"/"-"按钮 | 纯前端计算(不触发接口) | - |
| 7 | 选择时间 | 点击预约时间栏 | 打开选择器(不触发接口) | - |
| 8 | 创建订单支付 | 点击"立即支付" | `/api/orders/create` | POST |
| 9 | 查看订单详情 | 支付成功后跳转 | `/api/orders/{orderId}` | GET |

---

## 通用验证规则

### 登录状态
- 所有接口都需要登录状态
- 未登录时显示登录引导或跳转登录页
- 登录token在请求Header中传递: `Authorization: Bearer {token}`

### 技能ID
- 格式: 数字或UUID字符串
- 必须为有效的已发布技能
- 不存在时返回404错误

### 订单ID
- 格式: 数字或UUID字符串
- 必须为当前用户相关的订单(买家或卖家)
- 不存在或无权限时返回403/404错误

### 场次数量
- 必须为正整数
- 范围: 1-99(具体范围从订单确认信息获取)
- 超出范围时前端拦截或后端返回400错误

### 金额计算
- 总金额 = 单价 × 场次
- 前端展示和后端验证必须一致
- 金币不支持小数,如有需要向上取整

### 时间段选择
- 必须选择一个有效的时间段
- 时间段ID(`slotId`)必须存在于可预约列表中
- 过期或已被预约的时间段不可选

---

## 非接口操作

以下操作不触发接口调用(纯前端交互):

- **点击"取消"按钮** - 返回上一页,不保存订单信息
- **调整场次数量** - 实时计算总价,无需请求后端
- **打开时间选择器** - 显示可预约时间列表(数据已在订单确认信息中获取)
- **关闭时间选择器** - 不选择时间,关闭弹窗
- **总价计算** - 前端实时计算: `单价 × 场次`
- **字符计数** - 评价输入时实时显示字符数(如有评价功能)
- **余额检查** - 订单确认时前端预检查,提交时后端再次验证

---

## 数据传递

### 跨页面传递

**从技能详情页 → 订单确认页:**
- 传递: `skillId`(技能ID)、`providerId`(服务提供者ID)
- 方式: 路由参数 `/order/confirm?skillId={skillId}`

**从订单确认页 → 订单详情页:**
- 传递: `orderId`(订单ID,支付成功后从接口响应获取)
- 方式: 路由跳转 `/order/detail/{orderId}`

**从技能详情页 → 聊天页:**
- 传递: `userId`(服务提供者ID)、`nickname`、`avatar`、`context`(聊天上下文)
- 方式: 路由参数 + 全局状态

### 状态同步

**订单支付成功后需要同步:**
- 用户金币余额(全局状态)
- 订单列表(如已打开)
- 服务提供者的订单通知(通过WebSocket/推送)

**评价发布后需要同步:**
- 技能详情页的评价列表
- 技能详情页的评分统计
- 订单详情页的评价显示

---

## 异常处理

| 场景 | HTTP状态码 | 前端处理方式 |
|-----|-----------|------------|
| 未登录 | 401 | 跳转登录页,登录成功后返回当前页 |
| 权限不足 | 403 | 显示"无权查看该内容" |
| 技能不存在 | 404 | 显示"技能不存在或已下架",返回上一页 |
| 订单不存在 | 404 | 显示"订单不存在",返回订单列表 |
| 参数错误 | 400 | 显示具体错误信息(如"场次超出限制") |
| 余额不足 | 402 | 显示"金币余额不足,请先充值" + 充值按钮 |
| 时间段冲突 | 409 | 显示"该时间段已被预约,请选择其他时间" |
| 重复提交 | 409 | 显示"订单已存在,请勿重复提交" |
| 请求过快 | 429 | 显示"操作过于频繁,请稍后重试" |
| 网络错误 | - | 显示"网络异常,请检查网络连接" + 重试按钮 |
| 服务器错误 | 500 | 显示"服务异常,请稍后重试" + 重试按钮 |

### 错误恢复机制

**支付失败处理:**
1. 显示具体错误原因
2. 保留订单信息(不清空表单)
3. 提供重试按钮
4. 余额不足时提供充值入口

**网络超时处理:**
1. 订单创建超时:
   - 提示"支付请求超时,正在确认订单状态"
   - 自动查询订单状态(防止重复扣款)
   - 根据查询结果决定下一步操作

**并发冲突处理:**
1. 时间段被抢占:
   - 提示"该时间段已被预约"
   - 自动刷新可预约时间列表
   - 引导用户选择其他时间

---

## 性能优化建议

### 数据缓存
- **技能详情数据**: 缓存5分钟,减少重复加载
- **订单确认信息**: 不缓存,每次重新加载确保时效性
- **评价列表**: 缓存3分钟,支持下拉刷新

### 加载优化
- **图片懒加载**: 封面图、用户头像使用懒加载
- **分页加载**: 评价列表使用分页,每页20条
- **骨架屏**: 页面加载时显示骨架屏,提升用户体验

### 防抖节流
- **场次调整**: 节流处理,避免频繁计算
- **支付按钮**: 防抖处理,防止重复提交(点击后禁用3秒)
- **搜索输入**: 防抖300ms后触发搜索

---

## 安全性说明

### 防重复提交
- 前端: 点击"立即支付"后立即禁用按钮
- 后端: 使用订单幂等性验证(同一用户+技能+时间段 在短时间内不能重复创建)

### 金额验证
- 前端计算总金额: `sessions × unitPrice`
- 后端重新计算并验证,不信任前端传来的 `totalAmount`
- 金额不一致时返回400错误

### 权限验证
- 所有接口验证用户登录状态
- 订单查询验证当前用户是否为买家或卖家
- 私信功能验证对方是否允许接收消息

### 数据脱敏
- 服务提供者联系方式(手机号)仅在订单支付后显示
- 评价中的敏感信息自动过滤

---

## 测试用例

### 技能详情页测试
- [ ] 正常加载技能详情数据
- [ ] 技能不存在时显示404
- [ ] 已下架技能显示提示
- [ ] 未登录时跳转登录
- [ ] 评价列表正确分页加载
- [ ] 好评率计算正确

### 订单确认页测试
- [ ] 正常加载订单确认信息
- [ ] 场次增加/减少功能正常
- [ ] 场次达到上下限时正确提示
- [ ] 总价实时计算正确
- [ ] 时间选择器正常显示和选择
- [ ] 余额不足时正确提示

### 订单创建测试
- [ ] 正常创建订单并扣款
- [ ] 余额不足时返回402
- [ ] 未选择时间时前端拦截
- [ ] 场次超出范围时返回400
- [ ] 时间段冲突时返回409
- [ ] 重复提交时正确拦截
- [ ] 金额验证不通过时返回400

### 异常情况测试
- [ ] 网络超时时显示重试
- [ ] 订单创建超时后查询订单状态
- [ ] 支付失败时保留表单数据
- [ ] 服务器错误时显示友好提示
