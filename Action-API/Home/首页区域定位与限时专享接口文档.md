# 首页区域定位与限时专享接口文档

## 概述
本文档定义首页的区域选择、城市定位和限时专享功能的所有接口,包括用户操作触发时机和前端参数要求。

---

## 一、打开区域选择页面

### 用户操作
1. 用户在首页点击当前区域/位置按钮
2. **系统打开区域选择页面** → 触发接口

### 接口定义
**接口:** `GET /api/location/districts`

**参数:**
```typescript
{
  cityCode: string;  // 当前城市代码(从定位或用户选择获取)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    cityName: string;        // 城市名称(如:深圳)
    currentDistrict?: string; // 当前选中的区域代码(可选)
    districts: Array<{
      code: string;          // 区域代码(如:'all','nanshan','baoan')
      name: string;          // 区域名称(如:'全深圳','南山区','宝安区')
      isAll: boolean;        // 是否为"全部"选项
    }>;
  }
}
```

### 前端验证
- cityCode不能为空
- 必须是有效的城市代码

### 前端行为
- 显示当前城市的所有区域选项
- "全[城市名]"选项排在第一位
- 当前选中的区域显示紫色高亮背景
- 未选中的区域显示灰色背景
- 区域按钮以网格布局显示(每行3个)

---

## 二、选择区域

### 用户操作
1. 用户在区域选择页面点击某个区域
2. **系统应用区域选择并返回首页** → 触发接口

### 接口定义
**接口:** `POST /api/location/district/select`

**参数:**
```typescript
{
  cityCode: string;      // 城市代码
  districtCode: string;  // 区域代码('all'表示全城)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    success: boolean;
    selectedDistrict: {
      code: string;
      name: string;     // 显示用的区域名称
    };
  }
}
```

### 前端验证
- cityCode和districtCode不能为空

### 前端行为
- 成功后:
  - 关闭区域选择页面
  - 返回首页
  - 更新首页顶部显示的区域名称
  - 刷新首页Feed流(按新区域筛选)
  - 保存选择到本地缓存
- 失败后:
  - 显示错误提示
  - 保持在区域选择页面

---

## 三、打开城市定位页面

### 用户操作
1. 用户点击当前城市名称或定位按钮
2. **系统打开城市定位页面** → 触发接口

### 接口定义
**接口:** `GET /api/location/cities`

**参数:**
```typescript
{
  // 无参数
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    currentLocation?: {
      cityCode: string;
      cityName: string;     // 如:"深圳"
      province?: string;    // 省份(可选)
    };
    recentVisited: Array<{ // 最近访问的城市
      cityCode: string;
      cityName: string;
      visitTime: string;    // ISO时间戳
    }>;
    hotCities: Array<{      // 热门城市
      cityCode: string;
      cityName: string;
    }>;
    allCities: Array<{      // 所有城市(按首字母分组)
      letter: string;       // 首字母(A-Z)
      cities: Array<{
        cityCode: string;
        cityName: string;
        province?: string;
      }>;
    }>;
  }
}
```

### 前端行为
- 显示当前定位城市(如有)
- 显示最近访问的城市列表
- 显示热门城市(深圳、杭州、北京、上海等)
- 显示所有城市,按A-Z字母分组
- 右侧显示字母索引条(A-Z),支持快速滚动
- 支持搜索城市(前端过滤)

---

## 四、获取当前定位

### 用户操作
1. 用户打开城市定位页面
2. 用户点击"定位"按钮或允许自动定位
3. **系统获取当前GPS位置** → 触发接口

### 接口定义
**接口:** `POST /api/location/detect`

**参数:**
```typescript
{
  latitude: number;   // 纬度
  longitude: number;  // 经度
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    cityCode: string;
    cityName: string;
    district?: string;     // 区/县(可选)
    province: string;      // 省份
    formattedAddress: string;  // 格式化地址
  }
}
```

### 前端验证
- 必须获得用户位置授权
- latitude范围:-90 ~ 90
- longitude范围:-180 ~ 180

### 前端行为
- 请求用户授权位置权限
- 获取GPS坐标
- 调用接口解析城市信息
- 显示定位结果
- 如果定位失败:
  - 显示"定位失败,请手动选择城市"
  - 允许用户手动选择

---

## 五、选择城市

### 用户操作
1. 用户在城市列表中点击某个城市
2. **系统应用城市选择** → 触发接口

### 接口定义
**接口:** `POST /api/location/city/select`

**参数:**
```typescript
{
  cityCode: string;    // 城市代码
  cityName: string;    // 城市名称
  source: 'manual' | 'gps' | 'recent' | 'hot';  // 选择来源
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    success: boolean;
    selectedCity: {
      cityCode: string;
      cityName: string;
    };
    hasDistricts: boolean;  // 该城市是否有区域划分
  }
}
```

### 前端行为
- 成功后:
  - 保存城市选择到本地缓存
  - 记录到"最近访问"
  - 如果hasDistricts=true:
    - 跳转到区域选择页面
  - 否则:
    - 直接返回首页
    - 刷新首页Feed流(按新城市筛选)
    - 更新首页顶部显示的城市名称
- 失败后:
  - 显示错误提示
  - 保持在城市选择页面

---

## 六、打开限时专享页面

### 用户操作
1. 用户在首页点击"限时专享"入口
2. **系统打开限时专享列表页面** → 触发接口

### 接口定义
**接口:** `GET /api/home/limited-time/list`

**参数:**
```typescript
{
  cityCode?: string;      // 城市代码(可选,从当前定位获取)
  districtCode?: string;  // 区域代码(可选)
  pageNum: number;        // 页码(从1开始)
  pageSize: number;       // 每页数量(建议10)
  sortBy?: string;        // 排序方式:'recommend'(智能推荐),'price_asc','price_desc'等
  gender?: 'all' | 'male' | 'female';  // 性别筛选
  language?: string;      // 语言筛选
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    filters: {
      sortOptions: Array<{
        value: string;
        label: string;       // 如:'智能推荐','价格从低到高'
      }>;
      genderOptions: Array<{
        value: string;
        label: string;       // 如:'不限性别','男','女'
      }>;
      languageOptions: Array<{
        value: string;
        label: string;       // 如:'语话','普通话','粤语','英语'
      }>;
    };
    list: Array<{
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      distance: number;      // 距离(km)
      tags: Array<{
        text: string;        // 如:'可线上','2元'
        type: 'feature' | 'price' | 'skill';
        color?: string;      // 标签颜色
      }>;
      description: string;   // 描述文字
      price: {
        amount: number;      // 价格数值
        unit: 'per_order' | 'per_hour' | 'per_game';  // 单位
        displayText: string; // 显示文本(如:'10金币/单','200金币/小时')
      };
      promotionTag?: string; // 促销标签(如:'限时专享','特价')
      isOnline: boolean;     // 是否在线
      skillLevel?: string;   // 技能等级
    }>;
  }
}
```

### 前端验证
- pageNum ≥ 1
- pageSize 范围:5-20

### 前端行为
- 显示三个筛选下拉框(排序、性别、语言)
- 默认排序:"智能推荐"
- 默认性别:"不限性别"
- 默认语言:"语话"(表示不限)
- 列表垂直滚动显示
- 每个用户卡片显示:
  - 左侧:用户头像(正方形)
  - 右侧:用户信息
    - 昵称 + 性别图标 + 距离
    - 标签行(横向排列)
    - 描述文字(最多2行)
    - 价格(红色加粗显示)
- 支持上拉加载更多

---

## 七、限时专享筛选

### 用户操作
1. 用户点击顶部筛选下拉框(排序/性别/语言)
2. 用户选择筛选选项
3. **系统应用筛选并刷新列表** → 触发接口

### 接口定义
**接口:** `GET /api/home/limited-time/list`

**参数:**
```typescript
{
  // 同"打开限时专享页面"接口
  // 根据用户选择传入相应的筛选参数
  cityCode?: string;
  districtCode?: string;
  pageNum: number;        // 重置为1
  pageSize: number;
  sortBy?: string;        // 用户选择的排序方式
  gender?: string;        // 用户选择的性别
  language?: string;      // 用户选择的语言
}
```

**响应数据:**
```typescript
{
  // 同"打开限时专享页面"接口
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      // 用户列表
    }>;
  }
}
```

### 前端行为
- 点击下拉框显示选项列表
- 选择选项后:
  - 更新下拉框显示文本
  - 关闭下拉菜单
  - 清空当前列表
  - 重置pageNum=1
  - 调用接口获取筛选后的列表
  - 显示加载动画
- 可同时应用多个筛选条件
- 筛选条件保持,直到用户更改或离开页面

---

## 八、限时专享分页加载

### 用户操作
1. 用户在限时专享页面上拉滚动
2. **系统加载下一页数据** → 触发接口

### 接口定义
**接口:** `GET /api/home/limited-time/list`

**参数:**
```typescript
{
  // 同上,pageNum递增
  cityCode?: string;
  districtCode?: string;
  pageNum: number;        // 当前页码+1
  pageSize: number;
  sortBy?: string;
  gender?: string;
  language?: string;
}
```

**响应数据:**
```typescript
{
  // 同上
}
```

### 前端行为
- 滚动到底部触发加载
- pageNum递增
- 新数据追加到列表末尾
- 如果hasMore=false:显示"已经到底了~"
- 加载时显示加载动画

---

## 九、点击限时专享用户卡片

### 用户操作
1. 用户点击限时专享列表中的用户卡片
2. **系统跳转至用户主页** → 触发接口(接口在"用户主页模块"文档中定义)

### 前端行为
- 点击用户卡片跳转至该用户的主页
- 传递userId参数
- 可能需要传递来源标识(from:'limited-time')用于统计

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 获取区域列表 | 打开区域选择 | `/api/location/districts` | GET |
| 2 | 选择区域 | 点击区域选项 | `/api/location/district/select` | POST |
| 3 | 获取城市列表 | 打开城市定位 | `/api/location/cities` | GET |
| 4 | 获取当前定位 | 点击定位按钮 | `/api/location/detect` | POST |
| 5 | 选择城市 | 点击城市选项 | `/api/location/city/select` | POST |
| 6 | 限时专享列表 | 打开限时专享 | `/api/home/limited-time/list` | GET |
| 7 | 限时专享筛选 | 选择筛选条件 | `/api/home/limited-time/list` | GET |

---

## 通用验证规则

### 位置权限
- 使用定位功能需要用户授权位置权限
- 未授权时:提示"请授权位置权限以使用定位功能"
- 授权被拒绝:允许用户手动选择城市

### 城市和区域选择
- 城市代码和区域代码必须有效
- 选择保存到本地缓存
- 缓存有效期:30天
- 首次打开App需要选择城市

### 限时专享列表
- 基于当前定位的城市/区域
- 未选择城市时:提示"请先选择城市"
- 距离计算:基于用户当前位置(如有GPS权限)或城市中心点

### 分页加载
- 首屏:pageNum=1, pageSize=10
- 上拉加载:pageNum递增,追加列表
- 下拉刷新:重置pageNum=1,清空列表
- 无更多数据时:显示"已经到底了~"

---

## 非接口操作

以下操作不触发接口调用(纯前端交互):

### 区域选择页面
- **显示区域选项** - 渲染区域按钮网格
- **高亮选中区域** - 选中区域显示紫色背景
- **点击返回** - 返回首页,不保存选择

### 城市定位页面
- **显示城市列表** - 渲染热门城市和所有城市
- **字母索引滚动** - 点击右侧字母快速滚动到对应位置
- **城市搜索** - 前端过滤城市列表(不调用接口)
- **点击返回** - 返回首页,不保存选择

### 限时专享页面
- **下拉框展开/收起** - 点击下拉框显示/隐藏选项
- **用户卡片显示** - 渲染用户信息、标签、价格等
- **加载动画** - 显示加载中的骨架屏或动画
- **底部提示** - 显示"已经到底了~"
- **点击返回** - 返回首页

---

## 数据传递

### 区域选择 → 首页
**选择区域后传递:**
- cityCode(城市代码)
- districtCode(区域代码)
- 方式:全局状态管理 + 本地缓存

**首页更新:**
- 顶部显示区域名称
- Feed流按区域筛选
- 用户距离计算基于区域中心

### 城市选择 → 区域选择 → 首页
**选择城市后传递:**
- cityCode(城市代码)
- cityName(城市名称)
- hasDistricts(是否有区域)
- 方式:全局状态管理 + 本地缓存

**流程:**
1. 选择城市
2. 如果hasDistricts=true → 跳转区域选择
3. 选择区域 → 返回首页
4. 如果hasDistricts=false → 直接返回首页

### 限时专享 → 用户主页
**点击用户卡片传递:**
- userId(用户ID)
- from:'limited-time'(来源标识)
- 方式:路由参数

### 本地缓存
**需要缓存的数据:**
- 当前城市和区域选择 - 缓存30天
- 最近访问的城市 - 缓存最近5个,30天过期
- 热门城市列表 - 缓存24小时
- 限时专享筛选条件 - 会话级缓存,退出页面清除

---

## 异常处理

| 场景 | 前端处理方式 |
|-----|------------|
| 网络错误 | 显示:"网络异常,请稍后重试" + 重试按钮 |
| 服务器错误(500) | 显示:"服务异常,请稍后重试" |
| 接口超时 | 显示:"请求超时,请重试" |
| 城市代码无效 | 提示:"城市信息无效,请重新选择" |
| 定位失败 | 提示:"定位失败,请手动选择城市" + 显示手动选择入口 |
| 位置权限被拒绝 | 提示:"位置权限未授权,请在设置中开启" + 显示手动选择入口 |
| GPS坐标无效 | 提示:"无法获取位置信息,请手动选择城市" |
| 限时专享列表为空 | 显示:"暂无限时专享用户,请稍后再试" |
| 未选择城市 | 提示:"请先选择城市" + 跳转城市选择页面 |

---

## 区域选择页面详细说明

### 页面结构
- **顶部**: 返回按钮 + 标题"区域"
- **内容区**: 区域按钮网格(每行3个)
- **布局**: 响应式网格,自动换行

### 区域选项
- **"全[城市名]"**: 第一个选项,选中后显示全城用户
- **各区域**: 按城市实际区域显示(如:南山区、宝安区、福田区等)
- **样式**:
  - 选中:紫色渐变背景 + 白色文字
  - 未选中:浅灰色背景 + 黑色文字
  - 圆角矩形按钮

### 交互逻辑
- 单选:点击某个区域自动取消其他选择
- 点击已选中的区域:无操作,保持选中
- 点击未选中的区域:切换选中状态并立即应用

---

## 城市定位页面详细说明

### 页面结构
- **顶部**: 返回按钮 + 标题"定位"
- **定位/最近访问区**: 显示当前定位和最近访问的城市
- **热门城市区**: 显示热门城市(4-8个)
- **字母索引区**: 所有城市按A-Z分组
- **右侧**: A-Z快速索引条

### 定位/最近访问
- **当前定位**:
  - 显示定位图标 + 城市名称
  - 如果未定位:显示"点击定位"
  - 点击可触发定位
- **最近访问**:
  - 显示最近访问的1-3个城市
  - 按访问时间倒序排列
  - 样式:圆角矩形按钮

### 热门城市
- 显示4-8个热门城市
- 布局:每行4个
- 样式:圆角矩形按钮
- 示例:深圳、杭州、北京、上海

### 字母索引
- **左侧**: 所有城市按首字母分组(A-Z)
- **右侧**: 字母索引条(A-Z垂直排列)
- **交互**:
  - 点击字母索引:滚动到对应字母分组
  - 滑动字母索引:快速滚动
  - 滚动列表:右侧字母索引高亮当前位置

### 城市列表项
- 每个城市占一行
- 显示:城市名称 + 省份(可选)
- 点击跳转:选择该城市

---

## 限时专享页面详细说明

### 页面结构
- **顶部**: 返回按钮 + 标题"限时专享"
- **筛选栏**: 三个下拉框(智能推荐 | 不限性别 | 语话)
- **用户列表**: 垂直滚动的用户卡片列表

### 筛选下拉框
- **智能推荐**:
  - 选项:智能推荐、价格从低到高、价格从高到低、距离最近等
  - 默认:智能推荐
- **不限性别**:
  - 选项:不限性别、男、女
  - 默认:不限性别
- **语话**:
  - 选项:语话(不限)、普通话、粤语、英语等
  - 默认:语话
- **样式**: 白色背景 + 下拉箭头
- **交互**: 点击展开下拉菜单,选择后更新显示文本

### 用户卡片
**布局**:
- 左侧:用户头像(正方形,约80x80)
- 右侧:用户信息(占剩余宽度)

**用户信息**:
- **第一行**: 昵称 + 性别图标 + 距离
  - 昵称:黑色加粗
  - 性别图标:粉色(女) 或 蓝色(男)
  - 距离:灰色小字,右对齐(如:"3.2km")

- **第二行**: 标签行(横向排列,可滚动)
  - 标签样式:圆角矩形,不同颜色背景
  - 标签类型:
    - 特性标签(如:"可线上") - 绿色
    - 价格标签(如:"2元") - 橙色
    - 技能标签 - 蓝色

- **第三行**: 描述文字
  - 灰色正常字体
  - 最多显示2行,超出省略
  - 示例:"王者荣耀段位最高星耀!能玩各种英雄陪你带队助攻各种奇招绝杀胜出!"

- **第四行**: 价格(红色加粗)
  - 显示格式:"10 金币/单" 或 "200 金币/小时"
  - 右对齐

**促销标签**:
- 位置:头像左上角或右上角
- 样式:小标签,红色或橙色背景
- 文字:如"限时"、"特价"等

### 分页加载
- 上拉滚动到底部触发加载
- 显示加载动画
- 新数据追加到列表
- 无更多数据时显示"已经到底了~"

---

## 性能优化建议

### 定位功能
- 使用地理位置缓存,避免频繁请求GPS
- GPS定位超时时间:10秒
- 定位失败后提供手动选择入口

### 城市列表
- 热门城市列表:本地缓存24小时
- 所有城市列表:本地缓存7天
- 使用虚拟滚动优化长列表性能

### 限时专享列表
- 图片懒加载:仅加载可见区域的图片
- 图片压缩:头像使用缩略图
- 分页加载:每页10-15条,避免一次加载过多
- 骨架屏:加载时显示占位UI

### 状态管理
- 城市/区域选择:使用全局状态管理
- 限时专享筛选:使用页面级状态
- 本地缓存:合理使用缓存减少接口请求

---

## 业务规则说明

### 城市和区域选择
- 首次使用App:必须选择城市
- 未选择城市时:首页显示"请选择城市"提示
- 选择城市后:
  - 如果城市有区域划分 → 进入区域选择
  - 如果城市无区域划分 → 直接进入首页
- 区域选择可选可不选:
  - 选择"全[城市名]" → 显示全城用户
  - 选择具体区域 → 显示该区域用户

### 定位逻辑
- GPS定位优先级高于手动选择
- GPS定位成功后自动填充城市
- 用户可以随时手动更改城市
- 定位结果保存到"最近访问"

### 限时专享
- 基于当前城市/区域显示用户
- 距离计算:
  - 有GPS权限 → 基于实时位置
  - 无GPS权限 → 基于城市/区域中心点
- 价格单位:
  - 金币/单:一次服务
  - 金币/小时:按小时计费
  - 金币/局:按游戏局数计费
- 筛选条件可组合:
  - 排序 + 性别 + 语言
  - 使用"与"逻辑(AND)

### 用户可见性
- 限时专享用户:特定条件下的特价/促销用户
- 不同于普通Feed流用户
- 可能有时间限制:过期后不再显示

---

## 测试要点

### 区域选择功能
- [ ] 区域选择页面正常打开
- [ ] 显示当前城市的所有区域
- [ ] "全[城市名]"选项排在第一位
- [ ] 点击区域正确选中并应用
- [ ] 返回首页后区域显示正确
- [ ] 首页Feed流按区域筛选

### 城市定位功能
- [ ] 城市定位页面正常打开
- [ ] 当前定位正确显示
- [ ] GPS定位功能正常工作
- [ ] 定位失败时提供手动选择
- [ ] 热门城市正确显示
- [ ] 字母索引滚动正常
- [ ] 点击城市正确选中并应用
- [ ] 最近访问城市正确记录

### 限时专享功能
- [ ] 限时专享页面正常打开
- [ ] 用户列表正确显示
- [ ] 筛选下拉框正常工作
- [ ] 选择筛选条件后列表更新
- [ ] 分页加载正常
- [ ] 点击用户卡片跳转正确
- [ ] 距离显示正确
- [ ] 价格显示正确

### 边界测试
- [ ] 未授权位置权限时的处理
- [ ] GPS定位失败时的处理
- [ ] 城市代码无效时的提示
- [ ] 限时专享列表为空时的提示
- [ ] 网络异常时的错误处理
- [ ] 无更多数据时的提示

### 兼容性测试
- [ ] 不同城市的区域显示正确
- [ ] 城市切换后数据更新正确
- [ ] 定位和手动选择可正常切换
- [ ] 限时专享筛选条件组合正确工作

---
