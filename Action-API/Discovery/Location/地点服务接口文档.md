# 地点服务接口文档

## 概述
本文档定义地点服务接口的完整实现,包括获取附近地点、搜索地点的前端逻辑和API接口规范。地点服务是通用能力,可被多个模块调用(发布动态、签到、活动发布等)。

**调用模块:**
- 发布动态页面
- 活动发布页面
- 用户签到功能
- 同城动态筛选

**相关文档:**
- 发布动态页面文档
- 发现主页面文档(同城Tab)
- 活动发布接口文档

---

## 一、获取附近地点

### 用户操作
1. 进入地点选择页面
2. **授权位置权限** → 自动获取当前位置
3. **自动加载附近地点列表**

### 接口定义
**接口:** `GET /api/v1/location/nearby`

**触发时机:**
- 进入地点选择页面时
- 点击"自动定位"按钮时
- 下拉刷新时

**查询参数:**
```typescript
{
  latitude: number;    // 当前纬度,必填
  longitude: number;   // 当前经度,必填
  radius?: number;     // 搜索半径(km),默认5km,最大50km
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20,最大100
  category?: string;   // 地点分类筛选(可选)
                      // 可选值: restaurant(餐饮) / shopping(购物) / entertainment(娱乐) /
                      //         hotel(酒店) / scenic(景点) / all(全部,默认)
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    list: Location[];     // 地点列表
    total: number;        // 总数
    hasMore: boolean;     // 是否有更多
    currentLocation: {    // 当前定位信息
      latitude: number;
      longitude: number;
      address: string;    // 详细地址
      city: string;       // 城市
      district: string;   // 区县
    };
  } | null
}

interface Location {
  id: string;             // 地点ID
  name: string;           // 地点名称
  address: string;        // 详细地址
  latitude: number;       // 纬度
  longitude: number;      // 经度
  distance: number;       // 距离当前位置(米)
  category: string;       // 分类: restaurant/shopping/entertainment等
  categoryName: string;   // 分类中文名称
  rating?: number;        // 评分(0-5)
  reviewCount?: number;   // 评价数量
  phone?: string;         // 电话
  openHours?: string;     // 营业时间
  imageUrl?: string;      // 地点图片
  isVerified: boolean;    // 是否官方认证
}
```

### 前端验证
**位置权限:**
- 必须获取用户位置权限
- 未授权时: 显示引导授权提示
- 拒绝授权: 提示"无法获取位置,请在设置中开启位置权限"

**参数验证:**
- latitude: -90 到 90
- longitude: -180 到 180
- radius: 0.1 到 50 (km)
- page: >= 1
- pageSize: 1 到 100

### 前端行为
**进入地点选择页:**
1. 检查位置权限状态
2. 未授权: 显示引导授权UI
3. 已授权:
   - 显示加载状态
   - 获取当前位置
   - 调用附近地点接口
   - 显示地点列表

**获取位置失败:**
1. 显示错误提示:
   - 权限拒绝: "无法获取位置,请开启位置权限"
   - 定位超时: "定位超时,请重试"
   - 定位失败: "定位失败,请检查GPS设置"
2. 显示重试按钮
3. 允许手动搜索地点(不需要当前位置)

**加载成功:**
1. 显示当前定位信息
2. 在地图上标记当前位置(可选)
3. 显示附近地点列表
4. 按距离从近到远排序

**下拉刷新:**
1. 重新获取当前位置
2. 刷新附近地点列表
3. 成功后显示"刷新成功"Toast

**上拉加载更多:**
1. 滚动到底部时自动触发
2. page+1,加载下一页
3. 追加到列表末尾
4. hasMore=false时显示"没有更多了"

---

## 二、搜索地点

### 用户操作
1. 在地点选择页面
2. **点击搜索框** → 输入地点关键词
3. **输入关键词** → 自动搜索(防抖300ms)
4. 显示搜索结果列表

### 接口定义
**接口:** `GET /api/v1/location/search`

**触发时机:**
- 用户输入搜索关键词后(防抖300ms)
- 点击搜索按钮时
- 选择搜索历史时

**查询参数:**
```typescript
{
  keyword: string;       // 搜索关键词,必填,1-50字符
  latitude?: number;     // 当前纬度(可选,用于距离计算和结果排序)
  longitude?: number;    // 当前经度(可选,用于距离计算和结果排序)
  city?: string;         // 城市名称(可选,用于限制搜索范围)
  page: number;          // 页码,从1开始
  pageSize: number;      // 每页数量,默认20,最大100
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    list: Location[];    // 地点列表(同上Location结构)
    total: number;
    hasMore: boolean;
    suggestions: string[]; // 搜索建议关键词(可选)
  } | null
}
```

### 前端验证
**搜索关键词:**
- 长度: 1-50字符
- 不能为空
- 不能只包含空格
- 过滤特殊字符(可选)

**防抖设置:**
- 延迟: 300ms
- 最短关键词长度: 1字符

### 前端行为
**点击搜索框:**
1. 搜索框获得焦点
2. 显示搜索历史(如有)
3. 显示热门搜索(可选)
4. 弹出键盘

**输入关键词:**
1. 实时显示输入内容
2. 防抖300ms后触发搜索
3. 显示加载状态
4. 调用搜索接口

**搜索成功:**
1. 显示搜索结果列表
2. 如果有当前位置:
   - 显示距离信息
   - 按距离排序
3. 如果无当前位置:
   - 不显示距离
   - 按相关度排序
4. 保存到搜索历史

**搜索失败:**
1. 显示空状态页面
2. 提示: "未找到相关地点"
3. 显示搜索建议(如有)

**选择搜索历史:**
1. 点击历史记录项
2. 填充到搜索框
3. 自动触发搜索

**清空搜索:**
1. 点击搜索框右侧X按钮
2. 清空搜索内容
3. 返回附近地点列表

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 获取附近地点 | 进入地点选择页/自动定位 | `/api/v1/location/nearby` | GET |
| 2 | 搜索地点 | 输入搜索关键词 | `/api/v1/location/search` | GET |

---

## 通用验证规则

### 坐标验证
```typescript
const validateCoordinates = (latitude: number, longitude: number) => {
  if (latitude < -90 || latitude > 90) {
    return { valid: false, error: '纬度范围错误' };
  }

  if (longitude < -180 || longitude > 180) {
    return { valid: false, error: '经度范围错误' };
  }

  return { valid: true };
};
```

### 搜索关键词验证
```typescript
const validateKeyword = (keyword: string) => {
  if (!keyword || keyword.trim().length === 0) {
    return { valid: false, error: '请输入搜索关键词' };
  }

  if (keyword.length > 50) {
    return { valid: false, error: '搜索关键词不能超过50字符' };
  }

  return { valid: true };
};
```

### 半径验证
```typescript
const validateRadius = (radius: number) => {
  if (radius < 0.1 || radius > 50) {
    return { valid: false, error: '搜索半径范围错误(0.1-50km)' };
  }

  return { valid: true };
};
```

---

## 位置权限处理

### 请求位置权限
```typescript
const requestLocationPermission = async (): Promise<{
  granted: boolean;
  coords?: GeolocationCoordinates;
  error?: string;
}> => {
  try {
    // 检查浏览器是否支持
    if (!navigator.geolocation) {
      return {
        granted: false,
        error: '您的设备不支持定位功能'
      };
    }

    // 请求位置
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            granted: true,
            coords: position.coords
          });
        },
        (error) => {
          let errorMessage = '定位失败';

          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = '位置权限被拒绝,请在设置中开启';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = '无法获取位置信息';
              break;
            case error.TIMEOUT:
              errorMessage = '定位超时,请重试';
              break;
          }

          resolve({
            granted: false,
            error: errorMessage
          });
        },
        {
          enableHighAccuracy: true,  // 高精度模式
          timeout: 10000,            // 10秒超时
          maximumAge: 300000         // 最多使用5分钟内的缓存
        }
      );
    });
  } catch (error) {
    return {
      granted: false,
      error: '定位异常,请重试'
    };
  }
};
```

### 使用示例
```typescript
const handleGetNearbyLocations = async () => {
  // 请求位置权限
  const result = await requestLocationPermission();

  if (!result.granted) {
    showError(result.error || '无法获取位置');
    return;
  }

  // 获取附近地点
  try {
    const response = await fetchNearbyLocations({
      latitude: result.coords.latitude,
      longitude: result.coords.longitude,
      radius: 5,
      page: 1,
      pageSize: 20
    });

    if (response.code === 200) {
      setLocationList(response.data.list);
    }
  } catch (error) {
    showError('获取附近地点失败');
  }
};
```

---

## 距离计算

### 计算两点距离(Haversine公式)
```typescript
/**
 * 计算两个坐标点之间的距离
 * @param lat1 起点纬度
 * @param lon1 起点经度
 * @param lat2 终点纬度
 * @param lon2 终点经度
 * @returns 距离(米)
 */
const calculateDistance = (
  lat1: number,
  lon1: number,
  lat2: number,
  lon2: number
): number => {
  const R = 6371; // 地球半径(km)

  const dLat = toRadians(lat2 - lat1);
  const dLon = toRadians(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRadians(lat1)) *
      Math.cos(toRadians(lat2)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c * 1000; // 转换为米

  return Math.round(distance);
};

const toRadians = (degrees: number): number => {
  return (degrees * Math.PI) / 180;
};
```

### 距离格式化显示
```typescript
/**
 * 格式化距离显示
 * @param distance 距离(米)
 * @returns 格式化字符串
 */
const formatDistance = (distance: number): string => {
  if (distance < 1000) {
    return `${distance}m`;
  } else if (distance < 10000) {
    return `${(distance / 1000).toFixed(1)}km`;
  } else {
    return `${Math.round(distance / 1000)}km`;
  }
};

// 使用示例
formatDistance(350);    // "350m"
formatDistance(1500);   // "1.5km"
formatDistance(12800);  // "13km"
```

---

## 搜索历史管理

### 保存搜索历史
```typescript
const MAX_HISTORY_COUNT = 10; // 最多保存10条

const saveSearchHistory = (keyword: string) => {
  try {
    // 读取现有历史
    const history = getSearchHistory();

    // 移除重复项
    const filtered = history.filter(item => item !== keyword);

    // 添加到开头
    filtered.unshift(keyword);

    // 限制数量
    const limited = filtered.slice(0, MAX_HISTORY_COUNT);

    // 保存到本地存储
    localStorage.setItem('location_search_history', JSON.stringify(limited));
  } catch (error) {
    console.error('保存搜索历史失败:', error);
  }
};

const getSearchHistory = (): string[] => {
  try {
    const history = localStorage.getItem('location_search_history');
    return history ? JSON.parse(history) : [];
  } catch (error) {
    return [];
  }
};

const clearSearchHistory = () => {
  try {
    localStorage.removeItem('location_search_history');
  } catch (error) {
    console.error('清空搜索历史失败:', error);
  }
};
```

---

## 地图集成(可选)

### 地图显示
如果页面需要显示地图,可以集成第三方地图SDK:

**推荐地图服务:**
- 高德地图 (国内推荐)
- 百度地图 (国内)
- Google Maps (国际)
- Mapbox (国际)

**地图功能:**
- 显示当前位置标记
- 显示附近地点标记
- 点击标记显示详情
- 地图拖动更新附近地点
- 缩放地图调整搜索半径

**示例(高德地图):**
```typescript
import AMapLoader from '@amap/amap-jsapi-loader';

const initMap = async (
  latitude: number,
  longitude: number,
  locations: Location[]
) => {
  const AMap = await AMapLoader.load({
    key: 'YOUR_AMAP_KEY',
    version: '2.0',
  });

  const map = new AMap.Map('map-container', {
    zoom: 15,
    center: [longitude, latitude],
  });

  // 添加当前位置标记
  new AMap.Marker({
    position: [longitude, latitude],
    icon: new AMap.Icon({
      size: new AMap.Size(25, 34),
      image: 'current-location-icon.png',
    }),
    map: map,
  });

  // 添加附近地点标记
  locations.forEach((location) => {
    new AMap.Marker({
      position: [location.longitude, location.latitude],
      title: location.name,
      map: map,
    });
  });
};
```

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 位置权限拒绝 | - | 显示"请在设置中开启位置权限",提供设置跳转按钮 |
| 定位超时 | - | 显示"定位超时,请重试",提供重试按钮 |
| 定位失败 | - | 显示"定位失败,请检查GPS设置",允许手动搜索 |
| 搜索关键词为空 | 400 | 显示"请输入搜索关键词" |
| 搜索无结果 | 200 | 显示空状态"未找到相关地点",显示搜索建议 |
| 坐标参数错误 | 400 | 显示"位置参数错误,请重新定位" |
| 半径参数错误 | 400 | 显示"搜索范围错误" |
| 网络错误 | - | 显示"网络异常,请重试",提供重试按钮 |
| 服务器错误 | 500 | 显示"服务异常,请稍后重试" |

---

## 性能优化

### 1. 搜索防抖
- **延迟**: 300ms
- **目的**: 减少不必要的API请求
- **实现**: 使用debounce函数

```typescript
import { debounce } from 'lodash';

const handleSearch = debounce((keyword: string) => {
  searchLocations(keyword);
}, 300);
```

### 2. 位置缓存
- **缓存时间**: 5分钟
- **目的**: 避免频繁请求定位,节省电量
- **实现**: 使用maximumAge参数

```typescript
navigator.geolocation.getCurrentPosition(
  successCallback,
  errorCallback,
  { maximumAge: 300000 } // 5分钟缓存
);
```

### 3. 地点列表懒加载
- **触发距离**: 距底部200px
- **每页数量**: 20条
- **目的**: 减少初始加载量,提升首屏性能

### 4. 距离计算优化
- **前端计算**: 使用Haversine公式在前端计算距离
- **后端返回**: 或由后端直接返回计算好的距离
- **目的**: 减少计算负担,提升渲染性能

---

## TypeScript接口定义

```typescript
// 附近地点请求参数
interface NearbyLocationRequest {
  latitude: number;
  longitude: number;
  radius?: number;
  page: number;
  pageSize: number;
  category?: string;
}

// 搜索地点请求参数
interface SearchLocationRequest {
  keyword: string;
  latitude?: number;
  longitude?: number;
  city?: string;
  page: number;
  pageSize: number;
}

// 地点对象
interface Location {
  id: string;
  name: string;
  address: string;
  latitude: number;
  longitude: number;
  distance: number;
  category: string;
  categoryName: string;
  rating?: number;
  reviewCount?: number;
  phone?: string;
  openHours?: string;
  imageUrl?: string;
  isVerified: boolean;
}

// 附近地点响应
interface NearbyLocationResponse {
  code: number;
  message: string;
  data: {
    list: Location[];
    total: number;
    hasMore: boolean;
    currentLocation: {
      latitude: number;
      longitude: number;
      address: string;
      city: string;
      district: string;
    };
  } | null;
}

// 搜索地点响应
interface SearchLocationResponse {
  code: number;
  message: string;
  data: {
    list: Location[];
    total: number;
    hasMore: boolean;
    suggestions: string[];
  } | null;
}

// 位置权限结果
interface LocationPermissionResult {
  granted: boolean;
  coords?: {
    latitude: number;
    longitude: number;
    accuracy: number;
  };
  error?: string;
}
```

---

## 测试用例

### 功能测试
- [ ] 获取附近地点功能正常
- [ ] 搜索地点功能正常
- [ ] 位置权限请求正常
- [ ] 定位功能正常
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多功能正常
- [ ] 搜索历史保存和显示正常
- [ ] 距离计算正确

### 验证测试
- [ ] 坐标参数验证正确
- [ ] 搜索关键词验证正确
- [ ] 半径参数验证正确
- [ ] 位置权限验证正确

### 边界测试
- [ ] 位置权限拒绝处理
- [ ] 定位超时处理
- [ ] 定位失败处理
- [ ] 搜索无结果处理
- [ ] 网络异常处理
- [ ] 空关键词搜索处理

### 性能测试
- [ ] 搜索防抖生效
- [ ] 位置缓存生效
- [ ] 列表懒加载性能
- [ ] 距离计算性能

---

## 开发清单

### 必须实现
- [x] 获取附近地点接口
- [x] 搜索地点接口
- [x] 位置权限请求
- [x] 定位功能
- [x] 参数验证
- [x] 错误处理
- [x] 距离计算和显示

### 可选优化
- [ ] 地图显示
- [ ] 搜索历史
- [ ] 热门搜索
- [ ] 搜索建议
- [ ] 地点分类筛选
- [ ] 地点详情查看
- [ ] 地点收藏功能

---

## 相关文档

- **调用文档:**
  - 发布动态页面文档
  - 发现主页面文档(同城Tab)
  - 活动发布接口文档

- **技术文档:**
  - 高德地图API文档
  - 百度地图API文档
  - 位置服务最佳实践
  - 距离计算算法说明
