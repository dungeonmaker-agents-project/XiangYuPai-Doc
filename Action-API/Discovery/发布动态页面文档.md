# 发布动态页面文档

## 概述
本文档定义发布动态页面的完整实现,包括UI布局、交互行为、前端逻辑和API接口规范。发布动态页面是用户创建和分享内容的核心入口,支持文字、图片、视频、话题和地点等多种内容形式。

**相关文档:**
- 发现主页面文档
- 动态详情页面文档
- 话题选择页面文档
- 地点选择页面文档

**通用接口文档:**
- ../Media/媒体上传接口文档.md (图片、视频上传)
- ../Location/地点服务接口文档.md (附近地点、搜索地点)

**UI设计稿参考:**
- `UI页面/发现/发布动态/发布-动态.png`
- `UI页面/发现/发布动态/发布动态-选择话题.png`
- `UI页面/发现/发布动态/发布动态-选择地点.png`

---

## 一、发布动态

### 用户操作
1. 从发现主页点击发布按钮
2. 进入发布页面
3. 输入标题(可选)
4. 输入正文内容(必填)
5. 添加图片/视频(可选,最多9张图或1个视频)
6. 选择话题(可选,最多5个)
7. 选择地点(可选)
8. **点击"发布"按钮** → 触发发布接口

### 接口定义
**接口:** `POST /api/v1/content/publish`

**触发时机:** 用户点击发布按钮

**请求参数:**
```typescript
{
  // 基本信息
  type: number;              // 内容类型: 1=动态, 2=活动, 3=技能
  title?: string;            // 标题,可选,0-50字符
  content: string;           // 正文内容,必填,1-1000字符

  // 媒体资源
  mediaIds: string[];        // 媒体ID数组(图片/视频已上传后的ID)
                            // 图片: 最多9张
                            // 视频: 最多1个
                            // 不能同时上传图片和视频

  // 话题标签
  topicNames: string[];      // 话题名称数组,最多5个
                            // 每个话题名称1-20字符

  // 地理位置
  locationId?: string;       // 地点ID(从地点选择接口获取)
  locationName?: string;     // 地点名称
  locationAddress?: string;  // 详细地址
  longitude?: number;        // 经度
  latitude?: number;         // 纬度

  // 权限设置
  visibility?: number;       // 可见范围: 0=公开, 1=仅好友, 2=仅自己
                            // 默认: 0(公开)
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    feedId: string;       // 新创建的动态ID
    createdAt: number;    // 创建时间(毫秒)
  } | null
}
```

### 前端验证
**必填字段:**
- 正文内容不能为空
- 正文内容长度: 1-1000字符

**可选字段验证:**
- 标题长度: 0-50字符(如果填写)
- 话题数量: 最多5个
- 话题名称长度: 每个1-20字符
- 媒体数量:
  - 图片: 最多9张
  - 视频: 最多1个
  - 不能同时上传图片和视频

**发布按钮启用条件:**
- 正文内容不为空
- 正文内容长度符合要求
- 媒体上传完成(无正在上传的文件)

### 前端行为
**点击发布按钮:**
1. 验证所有必填字段
2. 验证所有可选字段格式
3. 验证通过后:
   - 按钮显示加载状态
   - 禁用所有输入
   - 调用发布接口
4. 成功后:
   - 显示"发布成功"Toast
   - 延迟200ms后:
     - 关闭发布页面
     - 返回发现主页
     - 新动态插入列表顶部(可选)
5. 失败后:
   - 恢复按钮状态
   - 启用所有输入
   - 显示错误提示:
     - 400: "内容格式不正确,请检查"
     - 413: "内容过大,请减少媒体文件"
     - 500: "发布失败,请稍后重试"
   - 保留已输入内容

**取消发布:**
1. 点击"取消"按钮
2. 检查是否有未保存内容
3. 有内容时弹出确认对话框:
   - 标题: "确认离开?"
   - 内容: "内容尚未发布,是否放弃?"
   - 按钮: "继续编辑" | "放弃"(红色)
4. 点击"放弃"后:
   - 清空所有内容
   - 返回上一页
5. 无内容时直接返回

---

## 二、上传图片

### 用户操作
1. 在发布页面
2. **点击"+"添加图片** → 打开图片选择器
3. 选择图片(最多9张)
4. 自动上传到服务器

### 接口定义
**详见:** `../Media/媒体上传接口文档.md` - **上传图片**

**接口:** `POST /api/v1/media/upload`

**参数:**
- file: 图片文件
- type: 'image' (固定值)
- quality: 压缩质量(可选,默认0.8)
- maxWidth/maxHeight: 最大尺寸(可选,默认1920px)

**验证规则:**
- 格式: jpg/jpeg/png/webp/heic
- 大小: ≤10MB
- 数量: 最多9张
- 自动压缩: >2MB时压缩到0.8质量

### 前端行为
详见媒体上传接口文档,包括:

---

## 三、上传视频

### 用户操作
1. 在发布页面
2. **点击"+"选择视频** → 打开视频选择器
3. 选择视频(最多1个)
4. 自动上传到服务器

### 接口定义
**详见:** `../Media/媒体上传接口文档.md` - **上传视频**

**接口:** `POST /api/v1/media/upload`

**参数:**
- file: 视频文件
- type: 'video' (固定值)

**验证规则:**
- 格式: mp4/mov/avi/flv
- 大小: ≤100MB
- 时长: 1-300秒(5分钟)
- 数量: 最多1个
- 限制: 不能同时上传图片和视频

### 前端行为
详见媒体上传接口文档,包括:

---

## 四、选择话题

### 用户操作
1. 在发布页面
2. **点击"# 选择话题"** → 进入话题选择页面
3. 浏览热门话题或搜索话题
4. 选择话题(最多5个)
5. **点击"完成"** → 返回发布页面

### 接口定义

#### 接口1: 获取热门话题
**接口:** `GET /api/v1/content/topics/hot`

**参数:**
- page: 页码(从1开始)
- pageSize: 每页数量(默认20)

#### 接口2: 搜索话题
**接口:** `GET /api/v1/content/topics/search`

**参数:**
- keyword: 搜索关键词(1-20字符)
- page: 页码
- pageSize: 每页数量

### 前端验证
- 选择数量: 最多5个
- 搜索关键词: 1-20字符,防抖300ms

### 前端行为
**进入话题选择页:**
1. 全屏页面,显示热门话题列表
2. 支持Tab切换(推荐/主要数据/关联数据等)
3. 支持搜索(防抖300ms)

**选择话题:**
1. 点击话题卡片 → 选中(紫色边框)
2. 最多5个,超过时提示"最多只能选择5个话题"
3. 再次点击取消选中

**完成选择:**
1. 点击"完成" → 返回发布页面
2. 显示已选话题标签(可删除)

---

## 五、选择地点

### 用户操作
1. 在发布页面
2. **点击"📍 选择地点"** → 进入地点选择页面
3. 查看当前定位或搜索地点
4. 选择某个地点
5. 自动返回发布页面

### 接口定义
**详见:** `../Location/地点服务接口文档.md`

#### 接口1: 获取附近地点
**接口:** `GET /api/v1/location/nearby`

**参数:**
- latitude/longitude: 当前位置(必填)
- radius: 搜索半径(默认5km)
- page/pageSize: 分页参数

#### 接口2: 搜索地点
**接口:** `GET /api/v1/location/search`

**参数:**
- keyword: 搜索关键词(1-50字符)
- latitude/longitude: 当前位置(可选,用于距离计算)
- page/pageSize: 分页参数

### 前端验证
- 位置权限: 需要获取用户位置权限(未授权可搜索但无距离)
- 搜索关键词: 1-50字符,防抖300ms

### 前端行为
**进入地点选择页:**
1. 全屏页面,请求位置权限
2. 显示当前定位和附近地点列表
3. 支持搜索

**选择地点:**
1. 点击某个地点 → 保存地点信息
2. 自动返回发布页面
3. 显示已选地点(可删除)

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 发布动态 | 点击发布按钮 | `/api/v1/content/publish` | POST |
| 2 | 上传图片 | 选择图片后 | `/api/v1/media/upload` | POST |
| 3 | 上传视频 | 选择视频后 | `/api/v1/media/upload` | POST |
| 4 | 获取热门话题 | 进入话题选择页 | `/api/v1/content/topics/hot` | GET |
| 5 | 搜索话题 | 输入搜索关键词 | `/api/v1/content/topics/search` | GET |
| 6 | 获取附近地点 | 进入地点选择页 | `/api/v1/location/nearby` | GET |
| 7 | 搜索地点 | 输入搜索关键词 | `/api/v1/location/search` | GET |

---

## 通用验证规则

### 内容验证
**标题(可选):**
- 长度: 0-50字符
- 可以为空
- 显示字符计数: "0/50"

**正文(必填):**
- 长度: 1-1000字符
- 不能为空
- 显示字符计数: "0/1000"
- 实时验证

### 媒体验证
**图片:**
- 格式: jpg, jpeg, png, webp, heic
- 大小: ≤ 10MB/张
- 数量: 最多9张
- 压缩: 大于2MB自动压缩

**视频:**
- 格式: mp4, mov, avi, flv
- 大小: ≤ 100MB
- 时长: 1-300秒
- 数量: 最多1个
- 限制: 不能同时上传图片和视频

### 话题验证
**话题数量:**
- 最多5个
- 已选5个时禁止继续选择

**话题名称:**
- 长度: 1-20字符
- 格式: 不包含特殊符号(#自动添加)

### 地点验证
**地点选择:**
- 最多1个
- 可以为空(可选)

### 发布验证
**必填项检查:**
- 正文内容不能为空
- 正文长度符合要求

**媒体检查:**
- 所有媒体上传完成
- 无上传失败的文件

**可选项检查:**
- 标题长度符合要求(如果填写)
- 话题数量不超过5个
- 话题名称长度符合要求

---

## 非接口操作

以下操作不触发接口调用(纯前端交互):

- **标题/正文输入** - 实时字符计数
- **字符计数显示** - "0/50", "0/1000"
- **输入框聚焦** - 弹出键盘
- **图片预览** - 点击缩略图查看大图
- **视频预览** - 点击封面播放视频
- **删除媒体** - 点击X删除缩略图
- **删除话题标签** - 点击标签X删除
- **删除地点** - 点击地点X清除
- **发布按钮状态** - 根据验证规则启用/禁用
- **取消确认** - 有内容时弹出确认对话框

---

## 页面布局

### 发布主页面

**顶部导航栏:**
```
┌─────────────────────────────────────┐
│ 取消              动态               │
└─────────────────────────────────────┘
```

**布局:**
- 高度: 56px
- 背景: 白色
- 左侧: "取消"按钮(黑色文字)
- 中间: "动态"标题(居中)
- 底部分割线: 1px浅灰色

**标题输入区:**
```
┌─────────────────────────────────────┐
│ 添加标题                             │
└─────────────────────────────────────┘
```

**样式:**
- 占位符: "添加标题"
- 字体: 18pt,加粗
- 颜色: 黑色
- 占位符颜色: 浅灰色 (#C0C0C0)
- 最大长度: 50字符
- 单行输入
- 内边距: 16px
- 底部分割线: 1px浅灰色

**正文输入区:**
```
┌─────────────────────────────────────┐
│ 添加正文                             │
│                                     │
│                                     │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

**样式:**
- 占位符: "添加正文"
- 字体: 16pt,常规
- 颜色: 黑色
- 占位符颜色: 浅灰色 (#C0C0C0)
- 最大长度: 1000字符
- 多行输入,自动扩展
- 最小高度: 200px
- 内边距: 16px
- 底部分割线: 1px浅灰色

**字符计数:**
- 位置: 右下角
- 文字: "0/1000"
- 字体: 13pt
- 颜色: 浅灰色 (#999)
- 超出限制时变红色

**媒体区域:**
```
┌─────────────────────────────────────┐
│ [图片1] [图片2] [+]                  │
│ [图片4] [图片5] [图片6]              │
└─────────────────────────────────────┘
```

**布局:**
- 网格布局: 3列
- 缩略图尺寸: 110x110px
- 间距: 8px
- 圆角: 8px
- 内边距: 16px

**缩略图样式:**
- 背景: 浅灰色
- 图片: 居中填充
- 删除按钮: 右上角,圆形背景,白色X
- 上传进度: 底部进度条

**添加按钮(+):**
- 尺寸: 110x110px
- 背景: 浅灰色 (#F5F5F5)
- 图标: + 号(灰色)
- 虚线边框(可选)

**话题选择区:**
```
┌─────────────────────────────────────┐
│ # 选择话题      # S10全球总决赛 ×    →│
└─────────────────────────────────────┘
```

**布局:**
- 高度: 56px
- 内边距: 16px
- 左侧: # 图标 + "选择话题"文字
- 右侧: 已选话题标签 + 箭头
- 可点击
- 底部分割线: 1px浅灰色

**话题标签样式:**
- 背景: 浅紫色 (#F3E8FF)
- 文字颜色: 紫色 (#8A2BE2)
- 内边距: 4px 12px
- 圆角: 12px
- 字体: 14pt
- 右侧X按钮: 删除标签

**地点选择区:**
```
┌─────────────────────────────────────┐
│ 📍 选择地点          深圳市南山区    →│
└─────────────────────────────────────┘
```

**布局:**
- 高度: 56px
- 内边距: 16px
- 左侧: 📍 图标 + "选择地点"文字
- 右侧: 已选地点名称 + 箭头
- 可点击
- 底部分割线: 1px浅灰色

**已选地点样式:**
- 文字颜色: 黑色
- 字体: 14pt
- 可点击删除(显示X)

**底部发布按钮:**
```
┌─────────────────────────────────────┐
│              发布                    │
└─────────────────────────────────────┘
```

**样式:**
- 宽度: 100% (左右边距24px)
- 高度: 52px
- 圆角: 26px
- 字体: 18pt,中等加粗
- 固定在底部(距底部安全区域24px)

**按钮状态:**
1. **启用状态:**
   - 背景: 紫色到蓝色渐变
     - 起始色: #b794f6
     - 结束色: #a5b4fc
   - 文字颜色: 白色

2. **禁用状态:**
   - 背景: 浅灰色 (#E0E0E0)
   - 文字颜色: 灰色 (#999)
   - 不可点击

3. **加载状态:**
   - 背景: 渐变色
   - 文字: "发布中..."
   - 显示加载动画
   - 不可点击

### 话题选择页面

**顶部导航:**
```
┌─────────────────────────────────────┐
│ 取消   [搜索话题__________]   完成   │
└─────────────────────────────────────┘
```

**Tab切换栏:**
```
┌─────────────────────────────────────┐
│ 推荐 主要数据 关联数据 国内话题 ...   │
└─────────────────────────────────────┘
```

**话题列表:**
```
┌─────────────────────────────────────┐
│ [封面] 话题精选线话题           [官方]│
│        参与人数 1254 · 帖子数 12545  │
├─────────────────────────────────────┤
│ [封面] 话题精选线话题           [热]  │
│        参与人数 1254 · 帖子数 12545  │
└─────────────────────────────────────┘
```

**话题卡片样式:**
- 高度: 72px
- 内边距: 12px
- 封面: 48x48px,圆角8px
- 话题名称: 16pt,加粗
- 统计信息: 13pt,灰色
- 选中边框: 2px紫色

### 地点选择页面

**顶部导航:**
```
┌─────────────────────────────────────┐
│ 取消      选择地点      自动定位     │
└─────────────────────────────────────┘
```

**地图区域:**
```
┌─────────────────────────────────────┐
│          [地图视图]                  │
│            📍                        │
└─────────────────────────────────────┘
```

**搜索框:**
```
┌─────────────────────────────────────┐
│ 🔍 搜索地址                          │
└─────────────────────────────────────┘
```

**当前定位:**
```
┌─────────────────────────────────────┐
│ 📍 某田在线闲聊                      │
│    深圳市南山区松坪山片区石岩大道11号3层│
└─────────────────────────────────────┘
```

**地点列表:**
```
┌─────────────────────────────────────┐
│ 📍 松坪山商业大厦                    │
│    深圳市南山区松坪山片区石岩大道11号  │
├─────────────────────────────────────┤
│ 📍 深圳华滋酒店                      │
│    深圳市南山区松坪山片区石岩大道11号...│
└─────────────────────────────────────┘
```

**地点项样式:**
- 高度: 64px
- 内边距: 16px
- 地点名称: 16pt,黑色
- 详细地址: 13pt,灰色
- 可点击

---

## 交互行为

### 1. 进入发布页面
**触发:** 从发现主页点击发布按钮

**行为:**
1. 检查登录状态
2. 未登录: 弹出登录提示
3. 已登录:
   - 打开发布页面(全屏)
   - 自动聚焦到正文输入框
   - 弹出键盘
   - 发布按钮初始为禁用状态

### 2. 输入内容
**标题输入:**
- 占位符: "添加标题"
- 单行输入
- 实时字符计数: "0/50"
- 达到50字符时禁止继续输入

**正文输入:**
- 占位符: "添加正文"
- 多行输入,自动扩展
- 实时字符计数: "0/1000"
- 达到1000字符时禁止继续输入
- 有内容时启用发布按钮

### 3. 添加图片
**点击"+"按钮:**
1. 检查已选图片数量
2. 已达到9张: 提示"最多只能上传9张图片"
3. 未达到限制:
   - 打开图片选择器
   - 支持多选
   - 支持相机拍照

**选择图片后:**
1. 验证格式和大小
2. 显示缩略图预览
3. 开始上传
4. 显示上传进度
5. 上传成功后保存mediaId

**删除图片:**
1. 点击缩略图右上角X
2. 从列表移除
3. 如果少于9张,重新显示"+"按钮

### 4. 添加视频
**点击"+"选择视频:**
1. 检查是否已选图片
2. 已选图片: 提示"视频和图片不能同时上传"
3. 未选图片:
   - 打开视频选择器
   - 选择视频

**选择视频后:**
1. 验证格式、大小、时长
2. 生成封面(第1帧)
3. 显示封面缩略图
4. 开始上传
5. 显示上传进度
6. 上传成功后保存mediaId

### 5. 选择话题
**点击"选择话题":**
1. 进入话题选择页面
2. 显示热门话题列表
3. 支持搜索话题

**选择话题:**
1. 点击话题卡片
2. 检查已选数量
3. 未达到5个: 选中话题
4. 已达到5个: 提示"最多只能选择5个话题"

**完成选择:**
1. 点击"完成"按钮
2. 返回发布页面
3. 显示已选话题标签

**删除话题:**
1. 点击标签右侧X
2. 从已选列表移除

### 6. 选择地点
**点击"选择地点":**
1. 进入地点选择页面
2. 请求位置权限
3. 显示当前定位和附近地点

**自动定位:**
1. 点击"自动定位"按钮
2. 获取当前位置
3. 更新地图中心
4. 刷新附近地点列表

**选择地点:**
1. 点击某个地点项
2. 保存地点信息
3. 自动返回发布页面
4. 显示已选地点

**删除地点:**
1. 点击地点右侧X或箭头
2. 清除已选地点

### 7. 发布动态
**点击"发布"按钮:**
1. 验证所有字段
2. 验证通过:
   - 按钮进入加载状态
   - 禁用所有输入
   - 调用发布接口
3. 成功后:
   - 显示"发布成功"Toast
   - 返回发现主页
   - 新动态显示在列表顶部
4. 失败后:
   - 显示错误提示
   - 恢复按钮状态
   - 保留已输入内容

### 8. 取消发布
**点击"取消"按钮:**
1. 检查是否有未保存内容
2. 有内容:
   - 弹出确认对话框
   - "确认离开?"
   - "内容尚未发布,是否放弃?"
   - "继续编辑" | "放弃"
3. 点击"放弃":
   - 清空所有内容
   - 返回上一页
4. 无内容: 直接返回

---

## 前端验证规则

### 内容验证
```typescript
const validateContent = (title: string, content: string) => {
  // 正文必填
  if (!content || content.trim().length === 0) {
    return { valid: false, error: '请输入正文内容' };
  }

  // 正文长度
  if (content.length > 1000) {
    return { valid: false, error: '正文内容不能超过1000字符' };
  }

  // 标题长度(如果填写)
  if (title && title.length > 50) {
    return { valid: false, error: '标题不能超过50字符' };
  }

  return { valid: true };
};
```

### 媒体验证
```typescript
const validateMedia = (mediaList: Media[]) => {
  const images = mediaList.filter(m => m.type === 'image');
  const videos = mediaList.filter(m => m.type === 'video');

  // 图片和视频不能同时存在
  if (images.length > 0 && videos.length > 0) {
    return { valid: false, error: '图片和视频不能同时上传' };
  }

  // 图片数量
  if (images.length > 9) {
    return { valid: false, error: '最多只能上传9张图片' };
  }

  // 视频数量
  if (videos.length > 1) {
    return { valid: false, error: '最多只能上传1个视频' };
  }

  // 检查是否有上传中或失败的媒体
  const uploading = mediaList.filter(m => m.status === 'uploading');
  const failed = mediaList.filter(m => m.status === 'failed');

  if (uploading.length > 0) {
    return { valid: false, error: '请等待媒体上传完成' };
  }

  if (failed.length > 0) {
    return { valid: false, error: '有媒体上传失败,请重新上传' };
  }

  return { valid: true };
};
```

### 话题验证
```typescript
const validateTopics = (topics: string[]) => {
  // 话题数量
  if (topics.length > 5) {
    return { valid: false, error: '最多只能选择5个话题' };
  }

  // 话题名称长度
  for (const topic of topics) {
    if (topic.length > 20) {
      return { valid: false, error: '话题名称不能超过20字符' };
    }
  }

  return { valid: true };
};
```

### 发布验证
```typescript
const canPublish = (state: PublishState) => {
  const contentValid = validateContent(state.title, state.content);
  if (!contentValid.valid) return contentValid;

  const mediaValid = validateMedia(state.mediaList);
  if (!mediaValid.valid) return mediaValid;

  const topicsValid = validateTopics(state.topics);
  if (!topicsValid.valid) return topicsValid;

  return { valid: true };
};
```

---

## 样式规范

### 颜色系统
```css
/* 主色调 */
--primary-purple: #8A2BE2;
--primary-blue: #3b82f6;

/* 渐变色 */
--gradient-start: #b794f6;
--gradient-end: #a5b4fc;

/* 文字颜色 */
--text-primary: #000000;
--text-secondary: #666666;
--text-placeholder: #C0C0C0;
--text-disabled: #999999;

/* 背景颜色 */
--bg-white: #FFFFFF;
--bg-gray: #F5F5F5;
--bg-tag: #F3E8FF;

/* 边框颜色 */
--border-light: #F0F0F0;
--border-selected: #8A2BE2;
```

### 间距系统
```css
--spacing-xs: 4px;
--spacing-sm: 8px;
--spacing-md: 12px;
--spacing-lg: 16px;
--spacing-xl: 24px;
```

### 字体系统
```css
--font-xs: 12pt;
--font-sm: 13pt;
--font-md: 14pt;
--font-base: 16pt;
--font-lg: 18pt;

--font-normal: 400;
--font-medium: 500;
--font-semibold: 600;
```

---

## 数据传递

### 跨页面传递
**从发布页 → 话题选择页:**
- 传递: 已选话题列表
- 方式: 路由参数或全局状态

**从话题选择页 → 发布页:**
- 传递: 新选择的话题列表
- 方式: 路由返回参数或全局状态更新

**从发布页 → 地点选择页:**
- 传递: 已选地点信息
- 方式: 路由参数或全局状态

**从地点选择页 → 发布页:**
- 传递: 新选择的地点信息
- 方式: 路由返回参数或全局状态更新

### 状态同步
**发布成功后需要同步到:**
- 发现主页列表(新动态插入顶部)
- 用户主页动态列表
- 全局动态计数

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 未登录发布 | 401 | 显示"请先登录",跳转登录页 |
| 内容违规 | 400 | 显示"内容违规,请修改" |
| 媒体格式错误 | 400 | 显示"媒体格式不支持" |
| 媒体过大 | 413 | 显示"文件过大,请选择小于XXM的文件" |
| 图片上传失败 | 500 | 显示"上传失败",提供重试按钮 |
| 视频上传失败 | 500 | 显示"上传失败",提供重试按钮 |
| 发布失败 | 500 | 显示"发布失败,请稍后重试",保留内容 |
| 网络错误 | - | 显示"网络异常,请检查网络设置" |
| 位置权限拒绝 | - | 显示"无法获取位置,请在设置中开启" |

---

## 性能优化

### 图片压缩
**压缩策略:**
- 大于2MB的图片自动压缩
- 压缩质量: 0.8
- 最大尺寸: 1920x1920px
- 使用WebP格式(支持时)

### 上传优化
**并发上传:**
- 最多3个文件并发上传
- 减少服务器压力
- 提升上传速度

**断点续传:**
- 大文件支持断点续传
- 网络中断后可恢复
- 避免重复上传

### 输入优化
**防抖处理:**
- 搜索话题: 300ms防抖
- 搜索地点: 300ms防抖
- 字符计数: 实时更新

### 数据缓存
**草稿保存:**
- 自动保存草稿到本地
- 5秒防抖保存
- 下次进入时恢复草稿

---

## 状态管理

### 页面状态
```typescript
interface PublishPageState {
  // 内容数据
  title: string;           // 标题
  content: string;         // 正文
  mediaList: Media[];      // 媒体列表
  topics: string[];        // 已选话题
  location: Location | null; // 已选地点

  // UI状态
  isPublishing: boolean;   // 是否正在发布
  uploadingCount: number;  // 正在上传的媒体数量

  // 草稿
  hasDraft: boolean;       // 是否有草稿
  draftTime: number;       // 草稿保存时间
}

interface Media {
  id: string;              // 本地ID
  type: 'image' | 'video'; // 媒体类型
  file: File;              // 原始文件
  url: string;             // 本地预览URL
  mediaId?: string;        // 上传后的服务器ID
  status: 'pending' | 'uploading' | 'success' | 'failed'; // 上传状态
  progress: number;        // 上传进度(0-100)
  thumbnailUrl?: string;   // 缩略图URL
}
```

### 初始状态
```typescript
const initialState: PublishPageState = {
  title: '',
  content: '',
  mediaList: [],
  topics: [],
  location: null,

  isPublishing: false,
  uploadingCount: 0,

  hasDraft: false,
  draftTime: 0,
};
```

---

## 测试用例

### 功能测试
- [ ] 输入标题和正文正常
- [ ] 字符计数显示正确
- [ ] 图片上传功能正常
- [ ] 视频上传功能正常
- [ ] 图片和视频互斥验证
- [ ] 话题选择功能正常
- [ ] 地点选择功能正常
- [ ] 发布功能正常
- [ ] 取消发布确认正常
- [ ] 草稿保存和恢复

### 边界测试
- [ ] 标题超长验证
- [ ] 正文超长验证
- [ ] 图片超过9张验证
- [ ] 视频超过1个验证
- [ ] 话题超过5个验证
- [ ] 图片格式验证
- [ ] 图片大小验证
- [ ] 视频格式验证
- [ ] 视频大小验证
- [ ] 视频时长验证
- [ ] 上传中断处理
- [ ] 网络异常处理

### 性能测试
- [ ] 大图上传性能
- [ ] 视频上传性能
- [ ] 并发上传稳定性
- [ ] 内存占用控制
- [ ] 草稿保存性能

### 兼容性测试
- [ ] iOS系统 (13+)
- [ ] Android系统 (8+)
- [ ] 不同屏幕尺寸
- [ ] 横屏模式
- [ ] 不同网络环境

---

## 开发清单

### 必须实现
- [x] 发布页面布局
- [x] 标题和正文输入
- [x] 字符计数显示
- [x] 图片上传功能
- [x] 视频上传功能
- [x] 话题选择功能
- [x] 地点选择功能
- [x] 发布接口调用
- [x] 内容验证
- [x] 媒体验证
- [x] 错误处理
- [x] 取消确认

### 可选优化
- [ ] 草稿自动保存
- [ ] 图片自动压缩
- [ ] 断点续传
- [ ] @提及用户
- [ ] 表情选择器
- [ ] 图片编辑(裁剪/滤镜)
- [ ] 视频编辑(裁剪/配音)
- [ ] 定时发布
- [ ] 可见范围设置

---

## 相关文档

- **设计稿:**
  - `UI页面/发现/发布动态/发布-动态.png`
  - `UI页面/发现/发布动态/发布动态-选择话题.png`
  - `UI页面/发现/发布动态/发布动态-选择地点.png`

- **相关页面文档:**
  - 发现主页面文档
  - 动态详情页面文档

- **技术文档:**
  - Discovery模块README
  - PublishPage组件文档
  - 媒体上传服务文档
  - API_USAGE_GUIDE_v7.1
