# 媒体上传接口文档

## 概述
本文档定义媒体上传接口的完整实现,包括图片上传、视频上传的前端逻辑和API接口规范。媒体上传服务是通用能力,可被多个模块调用(发布动态、个人资料、聊天消息等)。

**调用模块:**
- 发布动态页面
- 个人资料编辑
- 聊天消息发送
- 评论图片上传

**相关文档:**
- 发布动态页面文档
- 个人资料接口文档

---

## 一、上传图片

### 用户操作
1. 点击图片上传入口
2. **选择图片** → 打开图片选择器
3. 选择图片后自动上传到服务器

### 接口定义
**接口:** `POST /api/v1/media/upload`

**触发时机:** 用户选择图片后立即上传

**请求方式:** `multipart/form-data`

**请求参数:**
```typescript
{
  file: File;              // 图片文件
  type: 'image';           // 固定值: image

  // 可选压缩参数
  quality?: number;        // 压缩质量: 0.1-1.0, 默认0.8
  maxWidth?: number;       // 最大宽度: 默认1920px
  maxHeight?: number;      // 最大高度: 默认1920px
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    mediaId: string;       // 媒体ID(用于关联内容)
    url: string;           // 图片URL(完整访问地址)
    thumbnailUrl: string;  // 缩略图URL
    width: number;         // 原始宽度(px)
    height: number;        // 原始高度(px)
    size: number;          // 文件大小(字节)
    format: string;        // 图片格式: jpg/png/webp
  } | null
}
```

### 前端验证
**图片格式:**
- 支持: jpg, jpeg, png, webp, heic
- 不支持: gif, bmp, svg, tiff
- 格式不支持时: 显示"不支持的图片格式"

**图片大小:**
- 单张最大: 10MB
- 超过10MB: 显示"图片过大,请选择小于10MB的图片"
- 大于2MB时建议自动压缩

**图片尺寸:**
- 最小尺寸: 无限制
- 最大尺寸: 自动压缩到1920x1920px
- 保持原始宽高比

**压缩策略:**
- 触发条件: 文件大小 > 2MB
- 压缩质量: 0.8
- 最大宽度: 1920px
- 最大高度: 1920px
- 输出格式: WebP(支持时) 或 JPEG

### 前端行为
**选择图片:**
1. 打开系统图片选择器
2. 支持相册选择
3. 支持相机拍照
4. 可以单选或多选(根据业务场景)

**图片预处理:**
1. 读取图片文件
2. 验证格式和大小
3. 格式不支持:
   - 显示错误Toast
   - 跳过该图片
4. 大小超限:
   - 显示错误Toast
   - 或自动压缩

**压缩处理:**
1. 检查文件大小
2. 大于2MB时启用压缩:
   - 创建Canvas
   - 绘制图片
   - 按质量0.8导出
   - 限制最大尺寸1920x1920
3. 压缩后文件仍超过10MB:
   - 显示"图片过大,无法上传"

**上传中:**
1. 显示缩略图预览
2. 显示上传进度条(0-100%)
3. 显示"上传中..."状态文字
4. 显示取消按钮(可选)
5. 禁用相关操作(如发布按钮)

**上传成功:**
1. 隐藏进度条
2. 显示完整缩略图
3. 保存mediaId用于后续提交
4. 右上角显示删除按钮(X)
5. 启用相关操作

**上传失败:**
1. 显示错误状态图标
2. 显示"上传失败"提示
3. 显示重试按钮
4. 点击重试:
   - 重新上传该图片
   - 重置进度条

**取消上传:**
1. 点击取消按钮
2. 中止上传请求
3. 从预览列表移除
4. 释放资源

**删除已上传图片:**
1. 点击缩略图右上角X按钮
2. 从预览列表移除
3. 释放mediaId
4. 注意: 服务器端媒体文件不会立即删除,由后台定时清理未关联的媒体

---

## 二、上传视频

### 用户操作
1. 点击视频上传入口
2. **选择视频** → 打开视频选择器
3. 选择视频后自动上传到服务器

### 接口定义
**接口:** `POST /api/v1/media/upload`

**触发时机:** 用户选择视频后立即上传

**请求方式:** `multipart/form-data`

**请求参数:**
```typescript
{
  file: File;              // 视频文件
  type: 'video';           // 固定值: video
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    mediaId: string;       // 媒体ID(用于关联内容)
    url: string;           // 视频URL(完整访问地址)
    thumbnailUrl: string;  // 封面缩略图URL(自动生成第1帧)
    width: number;         // 视频宽度(px)
    height: number;        // 视频高度(px)
    duration: number;      // 视频时长(秒)
    size: number;          // 文件大小(字节)
    format: string;        // 视频格式: mp4/mov/avi
    bitrate?: number;      // 码率(kbps)
  } | null
}
```

### 前端验证
**视频格式:**
- 支持: mp4, mov, avi, flv, m4v
- 推荐: mp4 (H.264编码 + AAC音频)
- 不支持: wmv, mkv, webm
- 格式不支持时: 显示"不支持的视频格式,请选择MP4格式"

**视频大小:**
- 最大: 100MB
- 超过100MB: 显示"视频文件过大,请选择小于100MB的视频"

**视频时长:**
- 最短: 1秒
- 最长: 300秒(5分钟)
- 时长不符合:
  - 小于1秒: "视频时长过短"
  - 大于300秒: "视频时长不能超过5分钟"

**视频分辨率:**
- 最小: 无限制
- 最大: 4K (3840x2160)
- 超过4K: 建议提示用户但允许上传

### 前端行为
**选择视频:**
1. 打开系统视频选择器
2. 支持相册选择
3. 支持相机录制(如果支持)
4. 只能单选

**视频预处理:**
1. 读取视频文件
2. 验证格式和大小
3. 提取视频元数据:
   - 时长
   - 分辨率
   - 文件大小
4. 验证不通过:
   - 显示对应错误提示
   - 取消上传

**生成封面:**
1. 提取视频第1帧(或0.5秒处)
2. 生成缩略图(320x180px)
3. 显示在预览区域

**上传中:**
1. 显示视频封面缩略图
2. 显示上传进度条(0-100%)
3. 显示"上传中...X%"状态文字
4. 显示视频时长标签(右下角)
5. 显示取消按钮
6. 禁用相关操作
7. 上传时间较长,建议显示预估剩余时间

**上传成功:**
1. 隐藏进度条
2. 显示完整封面缩略图
3. 显示播放图标叠加层
4. 显示视频时长标签
5. 保存mediaId用于后续提交
6. 右上角显示删除按钮(X)
7. 启用相关操作

**上传失败:**
1. 显示错误状态图标
2. 显示"上传失败"提示
3. 显示重试按钮
4. 点击重试:
   - 重新上传该视频
   - 重置进度条

**取消上传:**
1. 点击取消按钮
2. 弹出确认对话框:
   - "确认取消上传?"
   - "已上传X%"
   - "取消" | "确定"(红色)
3. 确认后:
   - 中止上传请求
   - 从预览列表移除
   - 释放资源

**删除已上传视频:**
1. 点击缩略图右上角X按钮
2. 从预览列表移除
3. 释放mediaId
4. 注意: 服务器端媒体文件不会立即删除

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 上传图片 | 选择图片后 | `/api/v1/media/upload` (type=image) | POST |
| 2 | 上传视频 | 选择视频后 | `/api/v1/media/upload` (type=video) | POST |

---

## 通用验证规则

### 文件类型验证
```typescript
const IMAGE_FORMATS = ['jpg', 'jpeg', 'png', 'webp', 'heic'];
const VIDEO_FORMATS = ['mp4', 'mov', 'avi', 'flv', 'm4v'];

const validateFileType = (file: File, type: 'image' | 'video') => {
  const extension = file.name.split('.').pop()?.toLowerCase();

  if (type === 'image') {
    if (!IMAGE_FORMATS.includes(extension)) {
      return { valid: false, error: '不支持的图片格式' };
    }
  } else if (type === 'video') {
    if (!VIDEO_FORMATS.includes(extension)) {
      return { valid: false, error: '不支持的视频格式,请选择MP4格式' };
    }
  }

  return { valid: true };
};
```

### 文件大小验证
```typescript
const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB
const MAX_VIDEO_SIZE = 100 * 1024 * 1024; // 100MB

const validateFileSize = (file: File, type: 'image' | 'video') => {
  const maxSize = type === 'image' ? MAX_IMAGE_SIZE : MAX_VIDEO_SIZE;

  if (file.size > maxSize) {
    const sizeMB = maxSize / 1024 / 1024;
    return {
      valid: false,
      error: `${type === 'image' ? '图片' : '视频'}文件过大,请选择小于${sizeMB}MB的文件`
    };
  }

  return { valid: true };
};
```

### 视频时长验证
```typescript
const MIN_VIDEO_DURATION = 1; // 1秒
const MAX_VIDEO_DURATION = 300; // 5分钟

const validateVideoDuration = async (file: File) => {
  const duration = await getVideoDuration(file);

  if (duration < MIN_VIDEO_DURATION) {
    return { valid: false, error: '视频时长过短' };
  }

  if (duration > MAX_VIDEO_DURATION) {
    return { valid: false, error: '视频时长不能超过5分钟' };
  }

  return { valid: true, duration };
};
```

---

## 图片压缩实现

### 压缩策略
```typescript
const COMPRESS_THRESHOLD = 2 * 1024 * 1024; // 2MB
const COMPRESS_QUALITY = 0.8;
const MAX_WIDTH = 1920;
const MAX_HEIGHT = 1920;

const compressImage = async (file: File): Promise<File> => {
  // 小于2MB不压缩
  if (file.size < COMPRESS_THRESHOLD) {
    return file;
  }

  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      const img = new Image();

      img.onload = () => {
        // 计算压缩后尺寸
        let { width, height } = img;

        if (width > MAX_WIDTH || height > MAX_HEIGHT) {
          const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
          width = Math.floor(width * ratio);
          height = Math.floor(height * ratio);
        }

        // 创建Canvas
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // 导出压缩后图片
        canvas.toBlob(
          (blob) => {
            if (blob) {
              const compressedFile = new File(
                [blob],
                file.name.replace(/\.\w+$/, '.jpg'),
                { type: 'image/jpeg' }
              );
              resolve(compressedFile);
            } else {
              reject(new Error('压缩失败'));
            }
          },
          'image/jpeg',
          COMPRESS_QUALITY
        );
      };

      img.onerror = () => reject(new Error('图片加载失败'));
      img.src = e.target?.result as string;
    };

    reader.onerror = () => reject(new Error('文件读取失败'));
    reader.readAsDataURL(file);
  });
};
```

### 使用示例
```typescript
const handleImageUpload = async (file: File) => {
  try {
    // 验证格式
    const formatValid = validateFileType(file, 'image');
    if (!formatValid.valid) {
      showError(formatValid.error);
      return;
    }

    // 验证大小
    const sizeValid = validateFileSize(file, 'image');
    if (!sizeValid.valid) {
      showError(sizeValid.error);
      return;
    }

    // 压缩图片
    const compressedFile = await compressImage(file);

    // 上传
    const response = await uploadMedia(compressedFile, 'image');

    if (response.code === 200) {
      // 保存mediaId
      saveMediaId(response.data.mediaId);
      showSuccess('上传成功');
    }
  } catch (error) {
    showError('上传失败,请重试');
  }
};
```

---

## 上传进度处理

### 进度回调
```typescript
const uploadMedia = (
  file: File,
  type: 'image' | 'video',
  onProgress?: (progress: number) => void
): Promise<UploadResponse> => {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', type);

    const xhr = new XMLHttpRequest();

    // 监听上传进度
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const progress = Math.round((e.loaded / e.total) * 100);
        onProgress?.(progress);
      }
    };

    // 监听完成
    xhr.onload = () => {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        resolve(response);
      } else {
        reject(new Error('上传失败'));
      }
    };

    // 监听错误
    xhr.onerror = () => reject(new Error('网络错误'));

    // 发送请求
    xhr.open('POST', '/api/v1/media/upload');
    xhr.send(formData);
  });
};
```

### 使用示例
```typescript
const [uploadProgress, setUploadProgress] = useState(0);

const handleUpload = async (file: File) => {
  try {
    const response = await uploadMedia(
      file,
      'image',
      (progress) => {
        setUploadProgress(progress);
      }
    );

    if (response.code === 200) {
      console.log('上传成功:', response.data.mediaId);
    }
  } catch (error) {
    console.error('上传失败:', error);
  }
};
```

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 图片格式不支持 | 400 | 显示"不支持的图片格式" |
| 视频格式不支持 | 400 | 显示"不支持的视频格式,请选择MP4格式" |
| 图片过大 | 413 | 显示"图片过大,请选择小于10MB的图片" |
| 视频过大 | 413 | 显示"视频过大,请选择小于100MB的视频" |
| 视频时长过长 | 400 | 显示"视频时长不能超过5分钟" |
| 视频时长过短 | 400 | 显示"视频时长过短" |
| 网络错误 | - | 显示"网络异常,请重试",提供重试按钮 |
| 服务器错误 | 500 | 显示"上传失败,请稍后重试",提供重试按钮 |
| 存储空间不足 | 507 | 显示"服务器存储空间不足,请稍后重试" |

---

## 性能优化

### 1. 图片压缩优化
- **触发条件**: 文件大小 > 2MB
- **压缩质量**: 0.8 (80%)
- **最大尺寸**: 1920x1920px
- **格式转换**: 优先使用WebP(兼容时),否则JPEG
- **性能提升**: 减少50-70%文件大小,加快上传速度

### 2. 并发上传控制
- **最大并发数**: 3个文件
- **队列管理**: 超过3个文件时排队等待
- **优先级**: FIFO(先进先出)
- **性能提升**: 避免过多并发请求导致浏览器卡顿

### 3. 断点续传
- **适用场景**: 大文件(>20MB)上传
- **实现方式**:
  - 文件分片(每片5MB)
  - 记录已上传分片
  - 失败后从断点继续
- **性能提升**: 避免网络中断后重新上传

### 4. 预览图生成
- **图片预览**: 使用FileReader生成Data URL
- **视频预览**: 使用Video元素提取第1帧
- **缩略图**: 压缩到320x180px
- **性能提升**: 减少内存占用,提升渲染性能

---

## 安全考虑

### 1. 文件类型检查
- **MIME类型验证**: 检查file.type
- **扩展名验证**: 检查文件扩展名
- **魔数验证**: (后端)检查文件头魔数
- **防止**: 恶意文件伪装上传

### 2. 文件大小限制
- **前端限制**: 10MB(图片) / 100MB(视频)
- **后端限制**: 同前端限制
- **防止**: 恶意大文件消耗服务器资源

### 3. 内容安全检查
- **图片检查**: (后端)色情、暴力内容识别
- **视频检查**: (后端)视频内容审核
- **防止**: 违规内容上传

### 4. 上传频率限制
- **限制规则**: 同一用户1分钟内最多上传20个文件
- **实现方式**: (后端)Redis计数器
- **防止**: 恶意刷接口

---

## TypeScript接口定义

```typescript
// 上传请求参数
interface MediaUploadRequest {
  file: File;
  type: 'image' | 'video';
  quality?: number;
  maxWidth?: number;
  maxHeight?: number;
}

// 上传响应数据
interface MediaUploadResponse {
  code: number;
  message: string;
  data: {
    mediaId: string;
    url: string;
    thumbnailUrl: string;
    width: number;
    height: number;
    duration?: number;
    size: number;
    format: string;
    bitrate?: number;
  } | null;
}

// 媒体对象
interface Media {
  id: string;              // 本地ID
  type: 'image' | 'video';
  file: File;
  url: string;             // 预览URL
  mediaId?: string;        // 服务器mediaId
  status: 'pending' | 'uploading' | 'success' | 'failed';
  progress: number;        // 0-100
  error?: string;
  thumbnailUrl?: string;
  width?: number;
  height?: number;
  duration?: number;
}

// 上传配置
interface UploadConfig {
  maxImageSize: number;    // 图片最大大小(字节)
  maxVideoSize: number;    // 视频最大大小(字节)
  maxVideoDuration: number; // 视频最大时长(秒)
  compressThreshold: number; // 压缩阈值(字节)
  compressQuality: number;   // 压缩质量(0-1)
  maxConcurrent: number;     // 最大并发数
}
```

---

## 测试用例

### 功能测试
- [ ] 图片上传功能正常
- [ ] 视频上传功能正常
- [ ] 上传进度显示正确
- [ ] 上传成功返回mediaId
- [ ] 上传失败显示错误提示
- [ ] 重试功能正常
- [ ] 取消上传功能正常
- [ ] 删除已上传媒体功能正常

### 验证测试
- [ ] 图片格式验证正确
- [ ] 视频格式验证正确
- [ ] 图片大小验证正确
- [ ] 视频大小验证正确
- [ ] 视频时长验证正确

### 压缩测试
- [ ] 大图自动压缩
- [ ] 压缩质量符合预期
- [ ] 压缩后尺寸符合限制
- [ ] 小图不压缩

### 性能测试
- [ ] 大图上传速度
- [ ] 视频上传速度
- [ ] 并发上传稳定性
- [ ] 内存占用正常

### 边界测试
- [ ] 空文件处理
- [ ] 损坏文件处理
- [ ] 超大文件处理
- [ ] 网络中断处理
- [ ] 并发超限处理

---

## 开发清单

### 必须实现
- [x] 图片上传接口
- [x] 视频上传接口
- [x] 文件类型验证
- [x] 文件大小验证
- [x] 视频时长验证
- [x] 上传进度显示
- [x] 错误处理
- [x] 重试功能

### 可选优化
- [ ] 图片自动压缩
- [ ] 断点续传
- [ ] 并发控制
- [ ] 预览图生成
- [ ] 内容安全检查
- [ ] 上传频率限制

---

## 相关文档

- **调用文档:**
  - 发布动态页面文档
  - 个人资料接口文档
  - 聊天消息接口文档

- **技术文档:**
  - 文件上传最佳实践
  - 图片压缩算法说明
  - CDN配置文档
