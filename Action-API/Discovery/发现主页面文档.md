# 发现主页面文档

## 概述
本文档定义发现主页面的完整实现,包括UI布局、交互行为、前端逻辑和API接口规范。发现页面是用户浏览内容的核心页面,包含三个Tab(关注/热门/同城)和动态流列表展示。

**相关文档:**
- 动态详情页面文档
- 发布动态页面文档
- 话题详情页面文档

**通用接口文档:**
- ../Interaction/互动接口文档.md (点赞、收藏、分享)
- ../Users/用户关系接口文档.md (关注、取关)

**UI设计稿参考:**
- `UI页面/发现/发现-关注.png`
- `UI页面/发现/发现-热门.png`
- `UI页面/发现/发现-同城.png`

---

## 一、获取动态列表

### 用户操作
1. 进入发现页面
2. 切换Tab(关注/热门/同城)
3. **触发接口** → 自动加载对应Tab的动态列表
4. 下拉刷新 → 重新加载当前Tab数据
5. 滚动到底部 → 加载更多数据

### 接口定义
**接口:** `GET /api/v1/content/feed/{tabType}`

**触发时机:**
- 页面初始化时
- 切换Tab时
- 下拉刷新时
- 上拉加载更多时

**路径参数:**
```typescript
{
  tabType: 'follow' | 'hot' | 'local'  // follow=关注, hot=热门, local=同城
}
```

**查询参数:**
```typescript
{
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20

  // 同城Tab专用参数
  latitude?: number;   // 用户当前纬度(同城Tab必传)
  longitude?: number;  // 用户当前经度(同城Tab必传)
  radius?: number;     // 搜索半径(km),默认5km
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    list: Feed[];         // 动态列表
    total: number;        // 总数
    hasMore: boolean;     // 是否有更多数据
  } | null
}

// Feed数据结构
interface Feed {
  id: string;
  userId: string;

  // 内容信息
  type: number;              // 内容类型(1=动态,2=活动,3=技能)
  typeDesc: string;          // 类型描述
  title?: string;            // 标题(可选)
  summary?: string;          // 摘要
  content: string;           // 内容文本
  coverImage?: string;       // 封面图URL

  // 用户信息
  userInfo: {
    id: string;
    nickname: string;
    avatar: string;
    gender?: 'male' | 'female';
    age?: number;
    isFollowed: boolean;     // 当前用户是否已关注
    isRealVerified?: boolean; // 实名认证
    isGodVerified?: boolean;  // 大神认证
    isVip?: boolean;          // VIP用户
    isPopular?: boolean;      // 人气用户
  };

  // 媒体列表
  mediaList: Array<{
    id: string;
    type: 'image' | 'video';
    url: string;
    thumbnailUrl?: string;
    width: number;
    height: number;
    duration?: number;       // 视频时长(秒)
  }>;

  // 话题列表
  topicList: Array<{
    name: string;
    description?: string;
    participantCount: number;
    postCount: number;
  }>;

  // 地理位置(同城Tab返回)
  locationName?: string;     // 地点名称
  locationAddress?: string;  // 详细地址
  longitude?: number;        // 经度
  latitude?: number;         // 纬度
  distance?: number;         // 距离(km)
  cityId?: number;           // 城市ID

  // 互动数据
  likeCount: number;         // 点赞数
  commentCount: number;      // 评论数
  shareCount: number;        // 分享数
  collectCount: number;      // 收藏数
  viewCount: number;         // 浏览数

  // 用户互动状态
  isLiked: boolean;          // 当前用户是否已点赞
  isCollected: boolean;      // 当前用户是否已收藏

  // 时间戳
  createdAt: number;         // 创建时间(毫秒)
  updatedAt: number;         // 更新时间(毫秒)
}
```

### 前端验证
**关注Tab:**
- 需要用户登录状态
- 未登录时显示引导登录提示

**热门Tab:**
- 无需登录即可查看
- 点赞/收藏等互动操作需要登录

**同城Tab:**
- 需要获取用户位置权限
- 权限未授予时显示引导授权提示
- 位置获取失败时显示错误提示并允许重试

### 前端行为
**成功后:**
- 显示动态列表(瀑布流布局)
- 缓存数据到本地状态
- 首屏加载: 显示骨架屏
- 下拉刷新: 清空现有列表,显示新数据
- 上拉加载: 追加数据到列表末尾
- hasMore=false时隐藏"加载更多"提示

**失败后:**
- 显示错误提示Toast
- 首屏加载失败: 显示空状态页面,提供重试按钮
- 下拉刷新失败: 保留原有数据,显示错误Toast
- 上拉加载失败: 显示"加载失败,点击重试"

**空状态处理:**
- 关注Tab无数据: "暂无关注的人,去发现更多精彩内容"
- 热门Tab无数据: "暂无内容"
- 同城Tab无数据: "附近暂无动态"

---

## 二、点赞动态

### 用户操作
1. 浏览动态列表
2. **点击爱心图标** → 触发点赞接口
3. 再次点击 → 取消点赞

### 接口定义
**详见:** `../Interaction/互动接口文档.md` - **点赞/取消点赞**

**接口:** `POST /api/v1/interaction/like`

**参数:**
- targetType: 'feed' (固定值)
- targetId: 动态ID
- action: 'like' | 'unlike'

### 前端行为
**乐观更新(点击时立即响应):**
1. 立即切换图标状态(空心 ↔ 实心)
2. 立即更新点赞数(+1 或 -1)
3. 播放点赞动画(放大+心跳效果)
4. 调用接口
5. 成功: 保持UI状态
6. 失败: 回滚UI状态,显示错误Toast

---

## 三、收藏动态

### 用户操作
1. 浏览动态列表
2. **点击收藏图标** → 触发收藏接口
3. 再次点击 → 取消收藏

### 接口定义
**详见:** `../Interaction/互动接口文档.md` - **收藏/取消收藏**

**接口:** `POST /api/v1/interaction/collect`

**参数:**
- targetType: 'feed' (固定值)
- targetId: 动态ID
- action: 'collect' | 'uncollect'

### 前端行为
**乐观更新:**
1. 立即切换图标状态(空心 ↔ 实心)
2. 立即更新收藏数(+1 或 -1)
3. 播放收藏动画
4. 调用接口
5. 成功: 显示成功Toast,保持UI状态
6. 失败: 回滚UI状态,显示错误Toast

---

## 四、分享动态

### 用户操作
1. 浏览动态列表
2. **点击分享图标** → 打开分享面板
3. 选择分享方式

### 接口定义
**详见:** `../Interaction/互动接口文档.md` - **分享**

**接口:** `POST /api/v1/interaction/share`

**参数:**
- targetType: 'feed' (固定值)
- targetId: 动态ID
- shareChannel: 'wechat' | 'moments' | 'qq' | 'weibo' | 'copy_link'

### 前端行为
**点击分享按钮:**
1. 打开底部分享面板(Bottom Sheet)
2. 显示分享选项: 微信好友 / 朋友圈 / QQ / 微博 / 复制链接
3. 选择分享方式 → 调用接口获取分享链接
4. 调用对应平台SDK分享或复制到剪贴板
5. 成功: 更新分享数(+1),显示成功Toast
6. 失败: 显示错误Toast

---

## 五、评论动态

### 用户操作
1. 浏览动态列表
2. **点击评论图标** → 跳转到动态详情页
3. 在详情页发表评论

### 前端行为
**点击评论按钮:**
- 路由跳转到动态详情页面
- 传递参数: feedId
- 详情页自动聚焦评论输入框

**注意:**
- 主页面不直接提供评论输入
- 评论功能在详情页实现
- 详细接口见"动态详情页面文档"

---

## 六、关注/取关用户

### 用户操作
1. 浏览动态列表
2. **点击用户头像或昵称** → 跳转用户主页
3. 或直接点击"关注"按钮 → 快速关注

### 接口定义
**详见:** `../Users/用户关系接口文档.md` - **关注/取关用户**

**接口:** `POST /api/v1/user/follow`

**参数:**
- targetUserId: 目标用户ID
- action: 'follow' | 'unfollow'

### 前端行为
**乐观更新:**
1. 立即切换按钮状态: "关注" ↔ "已关注"
2. 调用接口
3. 成功: 显示成功Toast,更新userInfo.isFollowed
4. 失败: 回滚按钮状态,显示错误Toast

**注意:** 如果在关注Tab且取消关注,可选择从列表移除该动态

---

## 七、查看话题详情

### 用户操作
1. 浏览动态列表
2. **点击话题标签(#话题名#)** → 跳转话题详情页

### 前端行为
**点击话题标签:**
- 路由跳转到话题详情页面
- 传递参数: topicName
- 话题详情页展示:
  - 话题信息(参与人数、帖子数等)
  - 相关动态列表
- 详细接口见"话题详情页面文档"

---

## 八、查看用户主页

### 用户操作
1. 浏览动态列表
2. **点击用户头像或昵称** → 跳转用户主页

### 前端行为
**点击用户头像/昵称:**
- 路由跳转到用户主页
- 传递参数: userId
- 用户主页展示:
  - 用户资料
  - 用户动态列表
  - 技能列表等
- 详细接口见"用户主页接口文档"

---

## 九、查看动态详情

### 用户操作
1. 浏览动态列表
2. **点击动态卡片(内容区域)** → 跳转动态详情页

### 前端行为
**点击动态卡片:**
- 路由跳转到动态详情页面
- 传递参数: feedId
- 详情页展示:
  - 完整内容
  - 媒体列表
  - 评论列表
  - 互动功能
- 详细接口见"动态详情页面文档"

---

## 十、发布动态

### 用户操作
1. 在发现页面顶部
2. **点击搜索图标(右上角)** → 跳转发布动态页面

### 前端行为
**点击发布按钮:**
- 检查登录状态
- 未登录: 弹出登录提示
- 已登录: 跳转到发布动态页面
- 详细接口见"发布动态页面文档"

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 获取关注动态 | 进入/切换到关注Tab | `/api/v1/content/feed/follow` | GET |
| 2 | 获取热门动态 | 进入/切换到热门Tab | `/api/v1/content/feed/hot` | GET |
| 3 | 获取同城动态 | 进入/切换到同城Tab | `/api/v1/content/feed/local` | GET |
| 4 | 点赞动态 | 点击爱心图标 | `/api/v1/interaction/like` | POST |
| 5 | 取消点赞 | 再次点击爱心图标 | `/api/v1/interaction/like` | POST |
| 6 | 收藏动态 | 点击收藏图标 | `/api/v1/interaction/collect` | POST |
| 7 | 取消收藏 | 再次点击收藏图标 | `/api/v1/interaction/collect` | POST |
| 8 | 分享动态 | 选择分享方式 | `/api/v1/interaction/share` | POST |
| 9 | 关注用户 | 点击关注按钮 | `/api/v1/user/follow` | POST |
| 10 | 取消关注 | 点击已关注按钮 | `/api/v1/user/follow` | POST |

---

## 通用验证规则

### 登录状态
**需要登录的操作:**
- 关注Tab查看
- 点赞/取消点赞
- 收藏/取消收藏
- 关注/取消关注用户
- 发布动态

**未登录时:**
- 显示登录提示弹窗或Toast
- 提供"立即登录"按钮
- 点击后跳转登录页面

### 位置权限(同城Tab)
**权限状态:**
- 未请求: 显示引导授权提示
- 已拒绝: 显示引导手动开启提示
- 已授权: 正常加载数据

**位置获取失败:**
- 显示错误提示
- 提供重试按钮
- 允许手动输入城市

### 网络状态
**网络异常:**
- 显示"网络连接失败"提示
- 提供重试按钮
- 保留已加载的数据

### 数据刷新
**下拉刷新:**
- 显示刷新动画
- 清空当前列表
- 重新请求第1页数据
- 成功后显示新数据
- 失败后保留原数据

**上拉加载:**
- 显示"加载中..."提示
- 请求下一页数据
- 成功后追加到列表
- 失败后显示"加载失败,点击重试"
- hasMore=false时显示"没有更多了"

---

## 非接口操作

以下操作不触发接口调用(纯前端交互):

- **Tab切换动画** - 切换Tab时的滑动动画和指示器移动
- **列表滚动** - 用户滚动浏览列表内容
- **骨架屏显示** - 首次加载时的占位符动画
- **点赞动画** - 点击点赞时的心跳/放大动画
- **图片预览** - 点击图片查看大图(本地Modal)
- **视频播放** - 点击视频播放(如在列表中播放)
- **相对时间计算** - "刚刚"、"5分钟前"等时间显示
- **距离计算** - 同城Tab中"500m"、"2.3km"等距离显示

---

## 页面布局

### 顶部导航栏
```
┌─────────────────────────────────────┐
│  关注    热门    同城          🔍   │
└─────────────────────────────────────┘
```

**布局:**
- 高度: 56px
- 背景: 白色 (#FFFFFF)
- 底部分割线: 1px 浅灰色 (#F0F0F0)

**Tab切换器:**
- 三个Tab: 关注/热门/同城
- 默认Tab: 热门
- 选中状态:
  - 文字颜色: 紫色 (#8A2BE2)
  - 字体: 加粗
  - 下方指示器: 紫色横线(宽度40px,高度3px)
- 未选中状态:
  - 文字颜色: 深灰色 (#666666)
  - 字体: 常规

**搜索/发布按钮:**
- 位置: 右上角
- 图标: 搜索/加号图标
- 尺寸: 24x24px
- 颜色: 深灰色 (#333333)
- 点击区域: 44x44px

### 内容区域(瀑布流列表)

**动态卡片布局:**
```
┌─────────────────────────────────────┐
│ [头像] 昵称 [标签] [关注]           │
│                                     │
│ 动态文字内容...                     │
│                                     │
│ [图片1] [图片2]                     │
│ [图片3]                             │
│                                     │
│ #话题标签#                          │
│                                     │
│ 📍 地点名称 · 500m                  │
│                                     │
│ ♡ 123  💬 45  ⤴ 12  ⭐             │
│                                     │
│ 5分钟前                             │
└─────────────────────────────────────┘
```

**卡片样式:**
- 背景: 白色 (#FFFFFF)
- 圆角: 12px
- 内边距: 16px
- 卡片间距: 8px
- 阴影: 无或轻微阴影

**用户信息区:**
- 头像尺寸: 40x40px,圆形
- 昵称字体: 16pt,加粗,黑色
- 用户标签:
  - 实名认证: 蓝色V图标
  - 大神认证: 金色V图标
  - VIP: 金色皇冠图标
- 关注按钮:
  - 未关注: 紫色边框按钮,"关注"
  - 已关注: 灰色填充按钮,"已关注"
  - 尺寸: 60x28px
  - 圆角: 14px

**内容区:**
- 文字内容:
  - 字体: 15pt,常规
  - 颜色: 黑色 (#1a1a1a)
  - 行高: 1.5
  - 最大行数: 3行
  - 超出显示: "展开"链接
- 媒体展示:
  - 单图: 最大宽度100%,保持比例
  - 2-3图: 网格布局,间距4px
  - 4-9图: 3列网格布局
  - 图片圆角: 8px
  - 视频: 显示播放图标和时长

**话题标签:**
- 颜色: 紫色 (#8A2BE2)
- 字体: 14pt
- 可点击

**地理位置:**
- 图标: 📍定位图标
- 字体: 13pt
- 颜色: 灰色 (#999999)
- 显示: 地点名称 · 距离

**互动栏:**
- 点赞图标: ♡ (空心) / ♥ (实心红色)
- 评论图标: 💬
- 分享图标: ⤴
- 收藏图标: ⭐ (空心) / ⭐ (实心金色)
- 数字颜色: 灰色 (#999999)
- 字体: 13pt
- 间距: 每个图标+数字为独立单元,间距20px

**时间显示:**
- 字体: 12pt
- 颜色: 浅灰色 (#CCCCCC)
- 格式:
  - 1分钟内: "刚刚"
  - 1小时内: "X分钟前"
  - 24小时内: "X小时前"
  - 7天内: "X天前"
  - 超过7天: "MM-DD"

### 加载状态

**首屏加载:**
- 显示3-5个骨架屏卡片
- 骨架屏动画: 渐变闪烁效果

**下拉刷新:**
- 下拉时显示加载图标
- 释放时触发刷新
- 刷新中显示旋转动画
- 完成后自动收起

**上拉加载:**
- 显示"加载中..."文字+旋转图标
- 加载成功后自动隐藏
- 没有更多数据时显示"没有更多了"

**空状态:**
- 显示空状态插图
- 显示提示文字
- 提供操作按钮(如"去关注"等)

---

## 交互行为

### 1. Tab切换
**触发:** 点击Tab标签

**行为:**
1. Tab指示器滑动到选中位置(动画200ms)
2. 文字颜色和粗细变化
3. 切换内容区域:
   - 如果该Tab已有缓存数据: 直接显示
   - 如果该Tab无数据: 显示骨架屏,调用加载接口
4. 更新URL路由参数(可选)

**防抖:**
- 切换动画进行中时禁止再次切换

### 2. 下拉刷新
**触发:** 在列表顶部下拉

**行为:**
1. 下拉距离超过阈值(80px)时显示"释放刷新"提示
2. 释放后触发刷新
3. 显示刷新动画
4. 调用当前Tab的第1页数据接口
5. 成功后:
   - 清空现有列表
   - 显示新数据
   - 收起刷新动画
   - 显示"刷新成功"Toast
6. 失败后:
   - 保留现有数据
   - 收起刷新动画
   - 显示错误Toast

### 3. 上拉加载更多
**触发:** 滚动到列表底部

**行为:**
1. 距离底部200px时自动触发
2. 显示"加载中..."提示
3. 调用当前Tab的下一页数据接口
4. 成功后:
   - 追加新数据到列表末尾
   - 隐藏加载提示
5. 失败后:
   - 显示"加载失败,点击重试"
   - 点击后重新加载
6. 没有更多数据(hasMore=false):
   - 显示"没有更多了"
   - 禁止继续加载

**防重复加载:**
- 加载中时不触发新的加载请求
- 使用loading标志位控制

### 4. 点赞交互
**触发:** 点击爱心图标

**乐观更新流程:**
1. 立即切换图标状态(空心 ↔ 实心红色)
2. 立即更新点赞数(+1 或 -1)
3. 播放点赞动画:
   - 图标放大1.2倍(100ms)
   - 恢复原大小(100ms)
   - 粒子扩散效果(可选)
4. 调用点赞接口
5. 接口成功: 保持UI状态
6. 接口失败:
   - 回滚图标状态
   - 回滚点赞数
   - 显示错误Toast

**防抖:**
- 1秒内只允许一次接口调用
- 但UI立即响应

### 5. 收藏交互
**触发:** 点击收藏图标

**行为:** (同点赞交互)
1. 乐观更新UI
2. 播放收藏动画
3. 调用接口
4. 失败时回滚

### 6. 分享交互
**触发:** 点击分享图标

**行为:**
1. 打开底部分享面板(从底部滑入,动画300ms)
2. 显示分享选项网格:
   ```
   [微信好友] [朋友圈]  [QQ好友]
   [新浪微博] [复制链接] [取消]
   ```
3. 点击某个分享方式:
   - 调用分享接口获取链接
   - 调用对应平台SDK分享
   - 或复制链接到剪贴板
4. 分享成功:
   - 更新分享数(+1)
   - 显示"分享成功"Toast
   - 关闭分享面板
5. 分享失败:
   - 显示"分享失败"Toast
   - 关闭分享面板

### 7. 评论交互
**触发:** 点击评论图标

**行为:**
1. 跳转到动态详情页
2. 传递feedId参数
3. 详情页自动聚焦评论输入框

### 8. 关注交互
**触发:** 点击关注/已关注按钮

**行为:**
1. 检查登录状态
2. 未登录: 弹出登录提示
3. 已登录:
   - 乐观更新按钮状态
   - 调用关注接口
   - 成功: 显示"关注成功"Toast
   - 失败: 回滚按钮状态,显示错误Toast

### 9. 图片预览
**触发:** 点击图片

**行为:**
1. 打开全屏图片查看器
2. 显示当前图片
3. 支持左右滑动查看其他图片
4. 支持双击放大/缩小
5. 支持双指缩放
6. 显示图片序号(如: 1/3)
7. 提供下载/保存按钮(可选)
8. 点击空白区域或返回按钮关闭

### 10. 视频播放
**触发:** 点击视频封面

**行为:**
1. 在卡片内播放(小窗模式):
   - 显示播放控件
   - 自动播放
   - 其他视频自动暂停
2. 或跳转到全屏播放页面:
   - 显示完整播放控件
   - 支持清晰度切换
   - 支持播放速度调节

---

## 前端验证规则

### Tab切换验证
```typescript
// 关注Tab需要登录
const canViewFollowTab = () => {
  if (!isLoggedIn) {
    showLoginPrompt();
    return false;
  }
  return true;
};

// 同城Tab需要位置权限
const canViewLocalTab = async () => {
  const hasPermission = await checkLocationPermission();
  if (!hasPermission) {
    showLocationPermissionPrompt();
    return false;
  }
  return true;
};
```

### 互动操作验证
```typescript
// 点赞/收藏/关注需要登录
const canInteract = () => {
  if (!isLoggedIn) {
    showLoginPrompt();
    return false;
  }
  return true;
};
```

### 位置获取验证
```typescript
const getCurrentLocation = async () => {
  try {
    const location = await getLocation();
    return {
      latitude: location.coords.latitude,
      longitude: location.coords.longitude,
    };
  } catch (error) {
    if (error.code === 'PERMISSION_DENIED') {
      showLocationPermissionPrompt();
    } else {
      showErrorToast('位置获取失败,请重试');
    }
    return null;
  }
};
```

---

## 样式规范

### 颜色系统
```css
/* 主色调 */
--primary-purple: #8A2BE2;
--primary-light: #A855F7;
--primary-dark: #6B21A8;

/* 文字颜色 */
--text-primary: #000000;
--text-secondary: #666666;
--text-tertiary: #999999;
--text-quaternary: #CCCCCC;

/* 背景颜色 */
--bg-page: #F5F5F5;
--bg-card: #FFFFFF;
--bg-nav: #FFFFFF;

/* 功能颜色 */
--like-color: #FF0000;
--like-active: #FF4444;
--collect-color: #FFD700;
--share-color: #666666;
--comment-color: #666666;

/* 分割线 */
--divider: #F0F0F0;
--border: #E5E5E5;
```

### 间距系统
```css
--spacing-xs: 4px;
--spacing-sm: 8px;
--spacing-md: 12px;
--spacing-lg: 16px;
--spacing-xl: 24px;

--card-padding: 16px;
--card-margin: 8px;
```

### 字体系统
```css
--font-xs: 12pt;
--font-sm: 13pt;
--font-md: 14pt;
--font-base: 15pt;
--font-lg: 16pt;
--font-xl: 18pt;

--font-normal: 400;
--font-medium: 500;
--font-semibold: 600;
--font-bold: 700;
```

---

## 数据传递

### 跨页面传递
**从发现主页 → 动态详情:**
- 传递: `feedId`(动态ID)
- 方式: 路由参数

**从发现主页 → 用户主页:**
- 传递: `userId`(用户ID)
- 方式: 路由参数

**从发现主页 → 话题详情:**
- 传递: `topicName`(话题名称)
- 方式: 路由参数

### 状态同步
**互动操作成功后需要同步到:**
- 当前列表中的动态数据(点赞数、收藏数等)
- 全局用户关注列表(关注/取关操作)
- 详情页数据(如果详情页已打开)

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 未登录访问关注Tab | 401 | 显示"请先登录"提示,提供登录按钮 |
| 位置权限未授权 | - | 显示引导授权提示,提供设置按钮 |
| 网络错误 | - | 显示"网络异常,请稍后重试",提供重试按钮 |
| 服务器错误 | 500 | 显示"服务异常,请稍后重试",提供重试按钮 |
| 数据为空 | 200 | 显示空状态页面,提供引导操作 |
| 加载失败 | 400/500 | 显示"加载失败",提供重试按钮 |
| 互动操作失败 | 400/500 | 回滚UI状态,显示"操作失败,请重试" |

---

## 性能优化

### 列表优化
**虚拟滚动:**
- 使用虚拟列表技术(如react-window)
- 只渲染可见区域+缓冲区的卡片
- 提升大列表滚动性能

**图片懒加载:**
- 图片进入可视区域才加载
- 加载前显示占位符或模糊缩略图
- 支持渐进式加载

**数据缓存:**
- 切换Tab时缓存列表数据
- 再次进入Tab时优先显示缓存
- 后台静默刷新最新数据

### 网络优化
**接口防抖:**
- 上拉加载防止重复请求
- 互动操作1秒内只触发一次

**预加载:**
- 提前加载下一页数据(距底部阈值)
- 预加载用户头像和封面图

**请求合并:**
- 批量操作时合并请求
- 减少网络请求次数

### 动画优化
**使用CSS动画:**
- 优先使用transform和opacity
- 避免触发layout和paint

**降帧处理:**
- 低端设备降低动画帧率
- 或直接禁用非必要动画

---

## 状态管理

### 页面状态
```typescript
interface DiscoveryMainPageState {
  // UI状态
  activeTab: 'follow' | 'hot' | 'local';
  loading: boolean;
  refreshing: boolean;
  error: Error | null;

  // 数据状态
  feedData: {
    followFeeds: Feed[];
    hotFeeds: Feed[];
    localFeeds: Feed[];
    hasMore: {
      follow: boolean;
      hot: boolean;
      local: boolean;
    };
    page: {
      follow: number;
      hot: number;
      local: number;
    };
  };

  // 用户状态
  userLocation: {
    latitude: number;
    longitude: number;
  } | null;
}
```

### 初始状态
```typescript
const initialState: DiscoveryMainPageState = {
  activeTab: 'hot',
  loading: false,
  refreshing: false,
  error: null,

  feedData: {
    followFeeds: [],
    hotFeeds: [],
    localFeeds: [],
    hasMore: {
      follow: true,
      hot: true,
      local: true,
    },
    page: {
      follow: 1,
      hot: 1,
      local: 1,
    },
  },

  userLocation: null,
};
```

---

## 测试用例

### 功能测试
- [ ] Tab切换正常
- [ ] 关注Tab需要登录验证
- [ ] 同城Tab需要位置权限验证
- [ ] 首屏数据加载正常
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多正常
- [ ] 点赞/取消点赞功能正常
- [ ] 收藏/取消收藏功能正常
- [ ] 分享功能正常
- [ ] 关注/取关功能正常
- [ ] 评论跳转正常
- [ ] 用户主页跳转正常
- [ ] 话题详情跳转正常
- [ ] 动态详情跳转正常

### 边界测试
- [ ] 网络异常处理
- [ ] 数据为空处理
- [ ] 加载失败重试
- [ ] 互动操作失败回滚
- [ ] 快速切换Tab
- [ ] 快速重复点赞/收藏
- [ ] 滚动到底部边界
- [ ] 位置获取失败处理

### 性能测试
- [ ] 大列表滚动流畅性
- [ ] 图片加载性能
- [ ] 内存占用控制
- [ ] 动画流畅度

### 兼容性测试
- [ ] iOS系统 (13+)
- [ ] Android系统 (8+)
- [ ] 不同屏幕尺寸
- [ ] 横屏模式
- [ ] 深色模式(可选)

---

## 开发清单

### 必须实现
- [x] Tab切换功能
- [x] 三种动态列表(关注/热门/同城)
- [x] 下拉刷新
- [x] 上拉加载更多
- [x] 动态卡片展示
- [x] 点赞/收藏/分享功能
- [x] 关注/取关功能
- [x] 页面跳转功能
- [x] 登录状态验证
- [x] 位置权限获取
- [x] 错误处理
- [x] 空状态页面

### 可选优化
- [ ] 虚拟滚动优化
- [ ] 图片懒加载
- [ ] 数据预加载
- [ ] 动画效果优化
- [ ] 深色模式支持
- [ ] 无障碍支持
- [ ] 举报功能
- [ ] 内容过滤

---

## 相关文档

- **设计稿:**
  - `UI页面/发现/发现-关注.png`
  - `UI页面/发现/发现-热门.png`
  - `UI页面/发现/发现-同城.png`

- **相关页面文档:**
  - 动态详情页面文档
  - 发布动态页面文档
  - 话题详情页面文档
  - 用户主页接口文档

- **技术文档:**
  - Discovery模块README
  - UNIVERSAL_COMPONENT_ARCHITECTURE_CORE
  - API_USAGE_GUIDE_v7.1
