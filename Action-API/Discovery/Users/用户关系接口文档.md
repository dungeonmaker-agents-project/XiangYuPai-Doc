# 用户关系接口文档

## 概述
本文档定义用户关系接口的完整实现,包括关注/取关用户的前端逻辑和API接口规范。用户关系服务是通用能力,可被多个模块调用(发现页面、动态详情、用户主页等)。

**调用模块:**
- 发现主页面
- 动态详情页面
- 用户主页
- 关注列表页面
- 粉丝列表页面

**相关文档:**
- 发现主页面文档
- 动态详情页面文档
- 用户主页接口文档

---

## 一、关注/取关用户

### 用户操作
1. 浏览用户信息(动态列表/详情页/用户主页)
2. **点击"关注"按钮** → 触发关注接口
3. **点击"已关注"按钮** → 触发取关接口

### 接口定义
**接口:** `POST /api/v1/user/follow`

**触发时机:**
- 用户点击"关注"按钮
- 用户点击"已关注"按钮

**请求参数:**
```typescript
{
  targetUserId: string;         // 目标用户ID,必填
  action: 'follow' | 'unfollow' // follow=关注, unfollow=取消关注
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    success: boolean;     // 操作是否成功
    isFollowed: boolean;  // 当前关注状态(true=已关注, false=未关注)
    followerCount: number; // 目标用户的粉丝数
    followingCount: number; // 当前用户的关注数(可选)
  } | null
}
```

### 前端验证
**登录状态:**
- 必须登录才能关注/取关
- 未登录时: 弹出登录提示对话框

**用户验证:**
- 不能关注自己
- targetUserId不能为空
- targetUserId不能等于当前用户ID

**重复操作防止:**
- 1秒内重复点击只触发一次接口
- 使用防抖或节流处理

### 前端行为
**点击"关注"按钮:**
1. 检查登录状态
2. 未登录:
   - 弹出登录提示对话框
   - 标题: "请先登录"
   - 内容: "登录后可以关注用户"
   - 按钮: "取消" | "立即登录"
3. 已登录:
   - 乐观更新按钮状态:
     - "关注" → "已关注"
     - 按钮样式: 紫色边框 → 灰色填充
   - 调用接口(action='follow')

**接口成功:**
1. 保持UI状态(已经乐观更新)
2. 显示成功Toast: "关注成功"
3. 更新用户关注状态: isFollowed=true
4. 更新粉丝数: followerCount+1
5. 更新当前用户关注数: followingCount+1
6. 同步状态到其他页面:
   - 用户主页
   - 关注列表
   - 发现页面列表

**接口失败:**
1. 回滚UI状态:
   - "已关注" → "关注"
   - 按钮样式恢复
2. 显示错误Toast: "操作失败,请重试"
3. 保持原有关注状态

**点击"已关注"按钮(取关):**
1. 检查登录状态
2. 已登录:
   - 弹出确认对话框(可选):
     - 标题: "确认取消关注?"
     - 内容: "取消后将不再接收该用户的动态"
     - 按钮: "取消" | "确定"
   - 或直接取关(不弹窗)
3. 确认后:
   - 乐观更新按钮状态:
     - "已关注" → "关注"
     - 按钮样式: 灰色填充 → 紫色边框
   - 调用接口(action='unfollow')

**取关成功:**
1. 保持UI状态
2. 显示成功Toast: "已取消关注"
3. 更新用户关注状态: isFollowed=false
4. 更新粉丝数: followerCount-1
5. 更新当前用户关注数: followingCount-1
6. 如果在关注Tab:
   - 可选择从列表中移除该用户的动态
   - 或保留但标记为"已取关"

**取关失败:**
1. 回滚UI状态
2. 显示错误Toast: "操作失败,请重试"

---

## 二、获取关注列表

### 用户操作
1. 进入用户主页
2. **点击"关注"tab** → 查看关注列表
3. 滚动加载更多

### 接口定义
**接口:** `GET /api/v1/user/{userId}/following`

**触发时机:**
- 进入关注列表页面时
- 下拉刷新时
- 上拉加载更多时

**路径参数:**
```typescript
{
  userId: string;  // 用户ID,查看谁的关注列表
}
```

**查询参数:**
```typescript
{
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    list: UserFollow[];
    total: number;       // 总关注数
    hasMore: boolean;
  } | null
}

interface UserFollow {
  userId: string;
  nickname: string;
  avatar: string;
  gender?: 'male' | 'female';
  age?: number;
  bio?: string;              // 个人简介
  isFollowed: boolean;       // 当前用户是否已关注
  isMutualFollow: boolean;   // 是否互相关注
  isRealVerified?: boolean;
  isGodVerified?: boolean;
  isVip?: boolean;
  followerCount: number;     // 粉丝数
  feedCount: number;         // 动态数
}
```

### 前端行为
**进入关注列表:**
1. 显示加载状态
2. 调用接口
3. 显示关注列表
4. 每个用户显示:
   - 头像
   - 昵称
   - 个人简介
   - 粉丝数/动态数
   - 关注按钮

**空状态:**
- 自己的关注列表为空: "还没有关注任何人"
- 他人的关注列表为空: "TA还没有关注任何人"

---

## 三、获取粉丝列表

### 用户操作
1. 进入用户主页
2. **点击"粉丝"tab** → 查看粉丝列表
3. 滚动加载更多

### 接口定义
**接口:** `GET /api/v1/user/{userId}/followers`

**触发时机:**
- 进入粉丝列表页面时
- 下拉刷新时
- 上拉加载更多时

**路径参数:**
```typescript
{
  userId: string;  // 用户ID,查看谁的粉丝列表
}
```

**查询参数:**
```typescript
{
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    list: UserFollow[];  // 同上UserFollow结构
    total: number;       // 总粉丝数
    hasMore: boolean;
  } | null
}
```

### 前端行为
**进入粉丝列表:**
1. 显示加载状态
2. 调用接口
3. 显示粉丝列表
4. 每个用户显示:
   - 头像
   - 昵称
   - 个人简介
   - 粉丝数/动态数
   - 关注按钮(或"回关"按钮)

**空状态:**
- 自己的粉丝列表为空: "还没有粉丝"
- 他人的粉丝列表为空: "TA还没有粉丝"

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 关注用户 | 点击"关注"按钮 | `/api/v1/user/follow` (action=follow) | POST |
| 2 | 取关用户 | 点击"已关注"按钮 | `/api/v1/user/follow` (action=unfollow) | POST |
| 3 | 获取关注列表 | 进入关注列表页 | `/api/v1/user/{userId}/following` | GET |
| 4 | 获取粉丝列表 | 进入粉丝列表页 | `/api/v1/user/{userId}/followers` | GET |

---

## 通用验证规则

### 登录验证
```typescript
const checkLogin = () => {
  if (!isLoggedIn) {
    showLoginPrompt();
    return false;
  }
  return true;
};
```

### 目标用户验证
```typescript
const validateTargetUser = (targetUserId: string, currentUserId: string) => {
  if (!targetUserId) {
    return { valid: false, error: '用户ID不能为空' };
  }

  if (targetUserId === currentUserId) {
    return { valid: false, error: '不能关注自己' };
  }

  return { valid: true };
};
```

### 防重复操作
```typescript
import { throttle } from 'lodash';

const handleFollow = throttle(
  async (targetUserId: string, action: 'follow' | 'unfollow') => {
    // 执行关注/取关操作
    await followUser(targetUserId, action);
  },
  1000,
  { leading: true, trailing: false }
);
```

---

## 乐观更新实现

### 关注操作
```typescript
const handleFollowUser = async (targetUserId: string) => {
  // 1. 检查登录
  if (!checkLogin()) return;

  // 2. 验证用户
  const validation = validateTargetUser(targetUserId, currentUserId);
  if (!validation.valid) {
    showError(validation.error);
    return;
  }

  // 3. 乐观更新UI
  const originalState = {
    isFollowed: userState.isFollowed,
    followerCount: userState.followerCount
  };

  updateUserState({
    isFollowed: true,
    followerCount: userState.followerCount + 1
  });

  try {
    // 4. 调用接口
    const response = await followUser(targetUserId, 'follow');

    if (response.code === 200) {
      // 成功: 保持乐观更新的状态
      showSuccess('关注成功');

      // 同步状态到其他页面
      syncFollowState(targetUserId, true);
    } else {
      // 失败: 回滚状态
      updateUserState(originalState);
      showError(response.message || '操作失败,请重试');
    }
  } catch (error) {
    // 异常: 回滚状态
    updateUserState(originalState);
    showError('网络异常,请重试');
  }
};
```

### 取关操作
```typescript
const handleUnfollowUser = async (targetUserId: string) => {
  // 1. 可选: 显示确认对话框
  const confirmed = await showConfirmDialog({
    title: '确认取消关注?',
    message: '取消后将不再接收该用户的动态',
    confirmText: '确定',
    cancelText: '取消'
  });

  if (!confirmed) return;

  // 2. 乐观更新UI
  const originalState = {
    isFollowed: userState.isFollowed,
    followerCount: userState.followerCount
  };

  updateUserState({
    isFollowed: false,
    followerCount: userState.followerCount - 1
  });

  try {
    // 3. 调用接口
    const response = await followUser(targetUserId, 'unfollow');

    if (response.code === 200) {
      // 成功: 保持乐观更新的状态
      showSuccess('已取消关注');

      // 同步状态到其他页面
      syncFollowState(targetUserId, false);
    } else {
      // 失败: 回滚状态
      updateUserState(originalState);
      showError(response.message || '操作失败,请重试');
    }
  } catch (error) {
    // 异常: 回滚状态
    updateUserState(originalState);
    showError('网络异常,请重试');
  }
};
```

---

## 状态同步

### 全局状态管理
当用户关注/取关操作成功后,需要同步状态到所有相关页面:

```typescript
// 使用全局状态管理(如Redux, Zustand等)
const syncFollowState = (userId: string, isFollowed: boolean) => {
  // 1. 更新全局用户关注映射表
  updateFollowMap(userId, isFollowed);

  // 2. 触发相关页面更新
  // - 发现页面动态列表
  // - 动态详情页
  // - 用户主页
  // - 关注列表
  // - 粉丝列表

  // 3. 发送事件通知
  emitEvent('userFollowStateChanged', {
    userId,
    isFollowed
  });
};

// 监听关注状态变化
useEffect(() => {
  const handleFollowStateChange = (data: {
    userId: string;
    isFollowed: boolean;
  }) => {
    // 更新当前组件中的用户关注状态
    if (currentUser.id === data.userId) {
      setCurrentUser({
        ...currentUser,
        isFollowed: data.isFollowed
      });
    }
  };

  addEventListener('userFollowStateChanged', handleFollowStateChange);

  return () => {
    removeEventListener('userFollowStateChanged', handleFollowStateChange);
  };
}, [currentUser]);
```

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 未登录操作 | 401 | 显示"请先登录",弹出登录对话框 |
| 关注自己 | 400 | 显示"不能关注自己" |
| 用户不存在 | 404 | 显示"用户不存在" |
| 重复关注 | 400 | 显示"已经关注过了" |
| 重复取关 | 400 | 显示"还没有关注该用户" |
| 关注数达到上限 | 400 | 显示"关注数已达到上限(如5000)" |
| 被对方拉黑 | 403 | 显示"无法关注该用户" |
| 网络错误 | - | 显示"网络异常,请重试",回滚UI状态 |
| 服务器错误 | 500 | 显示"服务异常,请稍后重试",回滚UI状态 |

---

## 按钮状态样式

### 关注按钮状态

**1. 未关注状态:**
- 文字: "关注"
- 背景: 透明
- 边框: 2px 紫色 (#8A2BE2)
- 文字颜色: 紫色 (#8A2BE2)
- 尺寸: 60x28px(小) / 100x36px(大)
- 圆角: 14px / 18px

**2. 已关注状态:**
- 文字: "已关注"
- 背景: 浅灰色 (#F0F0F0)
- 边框: 无
- 文字颜色: 深灰色 (#666666)
- 尺寸: 60x28px(小) / 100x36px(大)
- 圆角: 14px / 18px

**3. 互相关注状态(可选):**
- 文字: "互相关注"
- 背景: 浅紫色 (#F3E8FF)
- 边框: 无
- 文字颜色: 紫色 (#8A2BE2)
- 尺寸: 72x28px(小) / 120x36px(大)
- 圆角: 14px / 18px

**4. 加载状态:**
- 文字: "关注中..." / "取关中..."
- 背景: 浅灰色 (#F0F0F0)
- 显示加载动画
- 禁用点击

**5. 自己(不显示按钮):**
- 不显示任何关注按钮
- 或显示"编辑资料"按钮(用户主页)

---

## TypeScript接口定义

```typescript
// 关注/取关请求参数
interface FollowRequest {
  targetUserId: string;
  action: 'follow' | 'unfollow';
}

// 关注/取关响应
interface FollowResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    isFollowed: boolean;
    followerCount: number;
    followingCount: number;
  } | null;
}

// 用户关注对象
interface UserFollow {
  userId: string;
  nickname: string;
  avatar: string;
  gender?: 'male' | 'female';
  age?: number;
  bio?: string;
  isFollowed: boolean;
  isMutualFollow: boolean;
  isRealVerified?: boolean;
  isGodVerified?: boolean;
  isVip?: boolean;
  followerCount: number;
  feedCount: number;
}

// 关注列表响应
interface FollowingListResponse {
  code: number;
  message: string;
  data: {
    list: UserFollow[];
    total: number;
    hasMore: boolean;
  } | null;
}

// 粉丝列表响应
interface FollowersListResponse {
  code: number;
  message: string;
  data: {
    list: UserFollow[];
    total: number;
    hasMore: boolean;
  } | null;
}

// 用户关注状态
interface UserFollowState {
  userId: string;
  isFollowed: boolean;
  isMutualFollow: boolean;
  followerCount: number;
  followingCount: number;
}
```

---

## 测试用例

### 功能测试
- [ ] 关注用户功能正常
- [ ] 取关用户功能正常
- [ ] 获取关注列表功能正常
- [ ] 获取粉丝列表功能正常
- [ ] 登录验证正常
- [ ] 按钮状态切换正常
- [ ] 乐观更新正常
- [ ] 状态同步正常

### 验证测试
- [ ] 不能关注自己
- [ ] 未登录不能关注
- [ ] 防重复操作生效
- [ ] 关注数上限验证

### 边界测试
- [ ] 重复关注处理
- [ ] 重复取关处理
- [ ] 用户不存在处理
- [ ] 网络异常处理
- [ ] 接口失败回滚UI

### 性能测试
- [ ] 乐观更新响应速度
- [ ] 列表滚动流畅
- [ ] 状态同步性能

---

## 开发清单

### 必须实现
- [x] 关注/取关接口
- [x] 获取关注列表接口
- [x] 获取粉丝列表接口
- [x] 登录验证
- [x] 乐观更新
- [x] 状态同步
- [x] 错误处理
- [x] 按钮状态样式

### 可选优化
- [ ] 取关确认对话框
- [ ] 互相关注标识
- [ ] 关注推荐
- [ ] 特别关注功能
- [ ] 关注分组
- [ ] 粉丝勋章

---

## 相关文档

- **调用文档:**
  - 发现主页面文档
  - 动态详情页面文档
  - 用户主页接口文档

- **技术文档:**
  - 用户关系数据库设计
  - 关注推荐算法说明
  - 状态管理最佳实践
