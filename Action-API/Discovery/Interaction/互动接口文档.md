# 互动接口文档

## 概述
本文档定义互动接口的完整实现,包括点赞、收藏、分享的前端逻辑和API接口规范。互动服务是通用能力,可被多个模块调用(发现页面、动态详情、评论列表等)。

**调用模块:**
- 发现主页面
- 动态详情页面
- 评论列表
- 用户主页
- 话题详情页

**相关文档:**
- 发现主页面文档
- 动态详情页面文档

---

## 一、点赞/取消点赞

### 用户操作
1. 浏览内容(动态/评论)
2. **点击点赞图标(爱心)** → 触发点赞接口
3. **再次点击** → 触发取消点赞接口

### 接口定义
**接口:** `POST /api/v1/interaction/like`

**触发时机:**
- 用户点击点赞按钮(爱心图标)
- 用户点击已点赞按钮(取消点赞)

**请求参数:**
```typescript
{
  targetType: string;      // 目标类型,必填
                          // 可选值: 'feed'(动态) | 'comment'(评论)

  targetId: string;        // 目标ID,必填
                          // feed: 动态ID
                          // comment: 评论ID

  action: string;          // 操作类型,必填
                          // 'like'=点赞, 'unlike'=取消点赞
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    success: boolean;     // 操作是否成功
    likeCount: number;    // 更新后的点赞数
    isLiked: boolean;     // 当前点赞状态(true=已点赞, false=未点赞)
  } | null
}
```

### 前端验证
**登录状态:**
- 必须登录才能点赞
- 未登录时: 弹出登录提示对话框

**参数验证:**
- targetType: 必须为 'feed' 或 'comment'
- targetId: 不能为空
- action: 必须为 'like' 或 'unlike'

**重复操作防止:**
- 1秒内重复点击只触发一次接口
- 使用防抖或节流处理
- UI立即响应,但接口调用限制

### 前端行为
**点击点赞(未点赞状态):**
1. 检查登录状态
2. 未登录:
   - 弹出登录提示对话框
   - 标题: "请先登录"
   - 内容: "登录后可以点赞"
   - 按钮: "取消" | "立即登录"
3. 已登录:
   - **乐观更新UI:**
     - 立即切换图标状态: 空心 → 实心红色
     - 立即更新点赞数: +1
     - 播放点赞动画(放大+心跳效果)
   - 调用接口(action='like')

**接口成功:**
1. 保持乐观更新的UI状态
2. 同步后端返回的准确点赞数(防止并发导致的数据不一致)
3. 更新本地状态: isLiked=true

**接口失败:**
1. 回滚UI状态:
   - 图标: 实心红色 → 空心
   - 点赞数: -1
2. 显示错误Toast: "操作失败,请重试"
3. 恢复原有点赞状态

**点击取消点赞(已点赞状态):**
1. 检查登录状态(理论上已登录)
2. **乐观更新UI:**
   - 立即切换图标状态: 实心红色 → 空心
   - 立即更新点赞数: -1
3. 调用接口(action='unlike')
4. 成功: 保持UI状态
5. 失败: 回滚UI状态,显示错误Toast

**防抖处理:**
```typescript
import { throttle } from 'lodash';

const handleLike = throttle(
  async (targetType: string, targetId: string, action: 'like' | 'unlike') => {
    // 调用点赞接口
    await likeContent(targetType, targetId, action);
  },
  1000,
  { leading: true, trailing: false }
);
```

---

## 二、收藏/取消收藏

### 用户操作
1. 浏览动态内容
2. **点击收藏图标(星星)** → 触发收藏接口
3. **再次点击** → 触发取消收藏接口

### 接口定义
**接口:** `POST /api/v1/interaction/collect`

**触发时机:**
- 用户点击收藏按钮
- 用户点击已收藏按钮(取消收藏)

**请求参数:**
```typescript
{
  targetType: string;      // 目标类型,必填
                          // 当前仅支持: 'feed'(动态)
                          // 未来可扩展: 'event'(活动), 'skill'(技能)

  targetId: string;        // 目标ID,必填(动态ID)

  action: string;          // 操作类型,必填
                          // 'collect'=收藏, 'uncollect'=取消收藏
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    success: boolean;     // 操作是否成功
    collectCount: number; // 更新后的收藏数
    isCollected: boolean; // 当前收藏状态(true=已收藏, false=未收藏)
  } | null
}
```

### 前端验证
**登录状态:**
- 必须登录才能收藏
- 未登录时: 弹出登录提示对话框

**参数验证:**
- targetType: 必须为 'feed'
- targetId: 不能为空
- action: 必须为 'collect' 或 'uncollect'

**重复操作防止:**
- 1秒内重复点击只触发一次接口

### 前端行为
**点击收藏(未收藏状态):**
1. 检查登录状态
2. 未登录: 弹出登录提示
3. 已登录:
   - **乐观更新UI:**
     - 立即切换图标状态: 空心 → 实心金色
     - 立即更新收藏数: +1
     - 播放收藏动画
   - 调用接口(action='collect')

**接口成功:**
1. 保持乐观更新的UI状态
2. 显示成功Toast: "收藏成功"
3. 更新本地状态: isCollected=true
4. 同步到收藏列表(如果用户在收藏列表页)

**接口失败:**
1. 回滚UI状态:
   - 图标: 实心金色 → 空心
   - 收藏数: -1
2. 显示错误Toast: "收藏失败,请重试"

**点击取消收藏(已收藏状态):**
1. **乐观更新UI:**
   - 立即切换图标状态: 实心金色 → 空心
   - 立即更新收藏数: -1
2. 调用接口(action='uncollect')
3. 成功: 显示Toast: "已取消收藏"
4. 失败: 回滚UI状态,显示错误Toast

---

## 三、分享

### 用户操作
1. 浏览动态内容
2. **点击分享图标** → 打开分享面板
3. **选择分享渠道** → 触发分享接口

### 接口定义
**接口:** `POST /api/v1/interaction/share`

**触发时机:** 用户选择分享渠道后

**请求参数:**
```typescript
{
  targetType: string;      // 目标类型,必填
                          // 当前仅支持: 'feed'(动态)

  targetId: string;        // 目标ID,必填(动态ID)

  shareChannel: string;    // 分享渠道,必填
                          // 可选值:
                          // 'wechat' = 微信好友
                          // 'moments' = 微信朋友圈
                          // 'qq' = QQ好友
                          // 'qzone' = QQ空间
                          // 'weibo' = 新浪微博
                          // 'copy_link' = 复制链接
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    shareUrl: string;     // 分享链接(完整URL)
    shareTitle: string;   // 分享标题
    shareDesc: string;    // 分享描述
    shareImage: string;   // 分享图片URL
    shareCount: number;   // 更新后的分享数
  } | null
}
```

### 前端验证
**登录状态:**
- 分享无需登录(但登录用户会记录分享行为)
- 未登录时仍可分享,但不记录到个人分享历史

**参数验证:**
- targetType: 必须为 'feed'
- targetId: 不能为空
- shareChannel: 必须为有效的分享渠道

**分享渠道验证:**
- 检查设备是否安装对应APP
- 未安装时提示用户安装或选择其他渠道

### 前端行为
**点击分享按钮:**
1. 打开底部分享面板(Bottom Sheet)
2. 从底部滑入动画(300ms)
3. 显示分享选项网格:
   ```
   ┌─────────────────────────────────────┐
   │ [微信好友] [朋友圈] [QQ好友]        │
   │ [QQ空间]   [微博]   [复制链接]      │
   │                                     │
   │ [取消]                              │
   └─────────────────────────────────────┘
   ```

**分享选项样式:**
- 每个选项:
  - 图标: 对应平台品牌图标
  - 文字: 平台名称
  - 尺寸: 64x64px图标 + 14pt文字
- 网格布局: 3列,间距24px
- 取消按钮: 底部,灰色,全宽

**选择分享渠道:**
1. 点击某个分享选项
2. 调用分享接口获取分享内容
3. 接口成功后:
   - 获取shareUrl、shareTitle、shareDesc、shareImage
   - 根据渠道调用对应分享方法

**调用平台SDK分享:**

**微信好友/朋友圈:**
```typescript
import * as WeChat from 'react-native-wechat-lib';

const shareToWechat = async (data: ShareData, scene: 'session' | 'timeline') => {
  try {
    await WeChat.shareWebpage({
      webpageUrl: data.shareUrl,
      title: data.shareTitle,
      description: data.shareDesc,
      thumbImageUrl: data.shareImage,
      scene: scene === 'timeline' ? 1 : 0  // 0=好友, 1=朋友圈
    });

    return { success: true };
  } catch (error) {
    return { success: false, error };
  }
};
```

**QQ好友/QQ空间:**
```typescript
import * as QQ from 'react-native-qq';

const shareToQQ = async (data: ShareData, type: 'qq' | 'qzone') => {
  try {
    await QQ.shareWebpage({
      webpageUrl: data.shareUrl,
      title: data.shareTitle,
      description: data.shareDesc,
      imageUrl: data.shareImage,
      type: type  // 'qq' or 'qzone'
    });

    return { success: true };
  } catch (error) {
    return { success: false, error };
  }
};
```

**新浪微博:**
```typescript
import * as Weibo from 'react-native-weibo';

const shareToWeibo = async (data: ShareData) => {
  try {
    await Weibo.shareWebpage({
      webpageUrl: data.shareUrl,
      title: data.shareTitle,
      description: data.shareDesc,
      thumbImageUrl: data.shareImage
    });

    return { success: true };
  } catch (error) {
    return { success: false, error };
  }
};
```

**复制链接:**
```typescript
import Clipboard from '@react-native-clipboard/clipboard';

const copyLink = (url: string) => {
  Clipboard.setString(url);
  showToast('链接已复制到剪贴板');
};
```

**分享成功:**
1. 更新分享数(+1)
2. 显示成功Toast: "分享成功"
3. 关闭分享面板
4. 记录分享行为(埋点)

**分享失败:**
1. 显示错误Toast:
   - APP未安装: "请先安装[平台名称]"
   - 用户取消: 不显示提示(静默处理)
   - 其他错误: "分享失败,请重试"
2. 不更新分享数
3. 关闭分享面板

**点击取消:**
1. 关闭分享面板(向下滑出动画)
2. 不调用任何接口

**点击空白区域:**
1. 关闭分享面板
2. 等同于点击取消

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 | 目标类型 |
|---|------|---------|------|------|---------|
| 1 | 点赞动态 | 点击爱心图标 | `/api/v1/interaction/like` | POST | feed |
| 2 | 取消点赞动态 | 再次点击爱心图标 | `/api/v1/interaction/like` | POST | feed |
| 3 | 点赞评论 | 点击评论点赞图标 | `/api/v1/interaction/like` | POST | comment |
| 4 | 取消点赞评论 | 再次点击评论点赞图标 | `/api/v1/interaction/like` | POST | comment |
| 5 | 收藏动态 | 点击收藏图标 | `/api/v1/interaction/collect` | POST | feed |
| 6 | 取消收藏动态 | 再次点击收藏图标 | `/api/v1/interaction/collect` | POST | feed |
| 7 | 分享动态 | 选择分享渠道 | `/api/v1/interaction/share` | POST | feed |

---

## 通用验证规则

### 登录验证
```typescript
const checkLogin = () => {
  if (!isLoggedIn) {
    showLoginPrompt({
      title: '请先登录',
      message: '登录后可以进行互动操作',
      confirmText: '立即登录',
      cancelText: '取消'
    });
    return false;
  }
  return true;
};
```

### 目标类型验证
```typescript
const VALID_TARGET_TYPES = {
  like: ['feed', 'comment'],
  collect: ['feed'],
  share: ['feed']
};

const validateTargetType = (
  action: 'like' | 'collect' | 'share',
  targetType: string
) => {
  if (!VALID_TARGET_TYPES[action].includes(targetType)) {
    return { valid: false, error: '目标类型不支持该操作' };
  }
  return { valid: true };
};
```

### 防重复操作
```typescript
import { throttle } from 'lodash';

// 通用的互动操作节流处理
const createInteractionHandler = (
  fn: Function,
  delay: number = 1000
) => {
  return throttle(fn, delay, {
    leading: true,   // 首次立即执行
    trailing: false  // 结尾不执行
  });
};

// 使用示例
const handleLike = createInteractionHandler(
  (targetType: string, targetId: string, action: string) => {
    likeContent(targetType, targetId, action);
  }
);
```

---

## 乐观更新实现

### 点赞乐观更新
```typescript
const handleLikeOptimistic = async (
  targetType: 'feed' | 'comment',
  targetId: string,
  currentState: { isLiked: boolean; likeCount: number }
) => {
  // 1. 保存原始状态(用于回滚)
  const originalState = { ...currentState };

  // 2. 乐观更新UI
  const newIsLiked = !currentState.isLiked;
  const newLikeCount = currentState.likeCount + (newIsLiked ? 1 : -1);

  updateUI({
    isLiked: newIsLiked,
    likeCount: newLikeCount
  });

  // 3. 播放动画
  if (newIsLiked) {
    playLikeAnimation();
  }

  try {
    // 4. 调用接口
    const response = await likeContent(
      targetType,
      targetId,
      newIsLiked ? 'like' : 'unlike'
    );

    if (response.code === 200) {
      // 成功: 同步后端返回的准确数据
      updateUI({
        isLiked: response.data.isLiked,
        likeCount: response.data.likeCount
      });
    } else {
      // 失败: 回滚状态
      updateUI(originalState);
      showToast(response.message || '操作失败,请重试');
    }
  } catch (error) {
    // 异常: 回滚状态
    updateUI(originalState);
    showToast('网络异常,请重试');
  }
};
```

### 收藏乐观更新
```typescript
const handleCollectOptimistic = async (
  targetId: string,
  currentState: { isCollected: boolean; collectCount: number }
) => {
  // 实现逻辑同点赞乐观更新
  const originalState = { ...currentState };

  const newIsCollected = !currentState.isCollected;
  const newCollectCount = currentState.collectCount + (newIsCollected ? 1 : -1);

  updateUI({
    isCollected: newIsCollected,
    collectCount: newCollectCount
  });

  try {
    const response = await collectContent(
      'feed',
      targetId,
      newIsCollected ? 'collect' : 'uncollect'
    );

    if (response.code === 200) {
      showToast(newIsCollected ? '收藏成功' : '已取消收藏');
      updateUI({
        isCollected: response.data.isCollected,
        collectCount: response.data.collectCount
      });
    } else {
      updateUI(originalState);
      showToast(response.message || '操作失败,请重试');
    }
  } catch (error) {
    updateUI(originalState);
    showToast('网络异常,请重试');
  }
};
```

---

## 状态同步

### 全局状态管理
当互动操作成功后,需要同步状态到所有相关页面:

```typescript
// 使用全局状态管理(如Redux, Zustand等)
const syncInteractionState = (
  targetType: string,
  targetId: string,
  updates: {
    isLiked?: boolean;
    likeCount?: number;
    isCollected?: boolean;
    collectCount?: number;
    shareCount?: number;
  }
) => {
  // 1. 更新全局互动状态映射表
  updateInteractionMap(targetType, targetId, updates);

  // 2. 触发相关页面更新
  // - 发现页面动态列表
  // - 动态详情页
  // - 用户主页
  // - 收藏列表

  // 3. 发送事件通知
  emitEvent('interactionStateChanged', {
    targetType,
    targetId,
    updates
  });
};

// 监听互动状态变化
useEffect(() => {
  const handleInteractionChange = (data: {
    targetType: string;
    targetId: string;
    updates: any;
  }) => {
    // 更新当前组件中的互动状态
    if (currentItem.id === data.targetId && currentItem.type === data.targetType) {
      setCurrentItem({
        ...currentItem,
        ...data.updates
      });
    }
  };

  addEventListener('interactionStateChanged', handleInteractionChange);

  return () => {
    removeEventListener('interactionStateChanged', handleInteractionChange);
  };
}, [currentItem]);
```

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 未登录操作 | 401 | 显示"请先登录",弹出登录对话框 |
| 目标不存在 | 404 | 显示"内容不存在或已删除" |
| 重复点赞 | 400 | 静默处理(已是点赞状态) |
| 重复收藏 | 400 | 静默处理(已是收藏状态) |
| 分享渠道错误 | 400 | 显示"分享渠道不支持" |
| APP未安装 | - | 显示"请先安装[平台名称]" |
| 网络错误 | - | 显示"网络异常,请重试",回滚UI状态 |
| 服务器错误 | 500 | 显示"服务异常,请稍后重试",回滚UI状态 |
| 操作过于频繁 | 429 | 显示"操作过于频繁,请稍后再试" |

---

## TypeScript接口定义

```typescript
// 点赞请求参数
interface LikeRequest {
  targetType: 'feed' | 'comment';
  targetId: string;
  action: 'like' | 'unlike';
}

// 点赞响应
interface LikeResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    likeCount: number;
    isLiked: boolean;
  } | null;
}

// 收藏请求参数
interface CollectRequest {
  targetType: 'feed';
  targetId: string;
  action: 'collect' | 'uncollect';
}

// 收藏响应
interface CollectResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    collectCount: number;
    isCollected: boolean;
  } | null;
}

// 分享请求参数
interface ShareRequest {
  targetType: 'feed';
  targetId: string;
  shareChannel: 'wechat' | 'moments' | 'qq' | 'qzone' | 'weibo' | 'copy_link';
}

// 分享响应
interface ShareResponse {
  code: number;
  message: string;
  data: {
    shareUrl: string;
    shareTitle: string;
    shareDesc: string;
    shareImage: string;
    shareCount: number;
  } | null;
}

// 互动状态
interface InteractionState {
  targetType: string;
  targetId: string;
  isLiked: boolean;
  likeCount: number;
  isCollected: boolean;
  collectCount: number;
  shareCount: number;
}
```

---

## 测试用例

### 功能测试
- [ ] 点赞动态功能正常
- [ ] 取消点赞动态功能正常
- [ ] 点赞评论功能正常
- [ ] 取消点赞评论功能正常
- [ ] 收藏动态功能正常
- [ ] 取消收藏动态功能正常
- [ ] 分享到微信功能正常
- [ ] 分享到QQ功能正常
- [ ] 分享到微博功能正常
- [ ] 复制链接功能正常

### 验证测试
- [ ] 未登录点赞提示登录
- [ ] 未登录收藏提示登录
- [ ] 目标类型验证正确
- [ ] 防重复操作生效
- [ ] 分享渠道验证正确

### 边界测试
- [ ] 重复点赞处理
- [ ] 重复收藏处理
- [ ] 内容不存在处理
- [ ] 网络异常处理
- [ ] 接口失败回滚UI
- [ ] APP未安装提示

### 性能测试
- [ ] 乐观更新响应速度
- [ ] 防抖节流生效
- [ ] 状态同步性能
- [ ] 动画流畅度

---

## 开发清单

### 必须实现
- [x] 点赞/取消点赞接口
- [x] 收藏/取消收藏接口
- [x] 分享接口
- [x] 登录验证
- [x] 乐观更新
- [x] 状态同步
- [x] 错误处理
- [x] 动画效果

### 可选优化
- [ ] 点赞动画优化(粒子效果)
- [ ] 收藏动画优化
- [ ] 分享面板样式优化
- [ ] 分享海报生成
- [ ] 分享统计分析
- [ ] 离线操作队列

---

## 相关文档

- **调用文档:**
  - 发现主页面文档
  - 动态详情页面文档
  - 评论列表组件文档

- **技术文档:**
  - 乐观更新最佳实践
  - 状态管理方案
  - 第三方SDK集成指南
  - 分享功能实现指南
