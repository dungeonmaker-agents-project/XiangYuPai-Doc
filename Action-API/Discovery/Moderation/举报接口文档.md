# 举报接口文档

## 概述
本文档定义举报接口的完整实现,包括举报动态、评论、用户的前端逻辑和API接口规范。举报功能是内容审核的重要入口,用于用户反馈违规内容,保障社区环境。

**调用模块:**
- 动态详情页面
- 评论列表
- 用户主页
- 聊天消息

**相关文档:**
- 动态详情页面文档
- 用户主页接口文档
- 内容审核系统文档

---

## 一、举报内容(动态/评论)

### 用户操作
1. 查看动态或评论
2. **点击"更多"按钮(...)**  → 打开操作菜单
3. **点击"举报"** → 进入举报页面
4. 选择举报类型(必选)
5. 填写举报描述(可选)
6. 上传举报证据图片(可选)
7. **点击"提交"** → 触发举报接口

### 接口定义
**接口:** `POST /api/v1/content/report`

**触发时机:** 用户点击提交按钮

**请求参数:**
```typescript
{
  targetType: string;      // 举报目标类型,必填
                          // 可选值: 'feed'(动态) | 'comment'(评论) | 'user'(用户)

  targetId: string;        // 目标ID,必填
                          // feed: 动态ID
                          // comment: 评论ID
                          // user: 用户ID

  reasonType: string;      // 举报类型,必填
                          // 可选值见下方举报类型定义

  description?: string;    // 举报描述,可选,0-200字符
                          // 建议用户填写,有助于审核

  evidenceImages?: string[]; // 举报证据图片URL数组,可选
                            // 最多3张,每张≤5MB
                            // 需要先调用媒体上传接口获取URL
}
```

**举报类型定义(reasonType):**
```typescript
const REPORT_REASONS = {
  // 1. 辱骂引战
  'harassment': {
    code: 'harassment',
    name: '辱骂引战',
    description: '辱骂他人、挑衅、引战、人身攻击'
  },

  // 2. 色情低俗
  'pornography': {
    code: 'pornography',
    name: '色情低俗',
    description: '色情、低俗、性暗示内容'
  },

  // 3. 诈骗
  'fraud': {
    code: 'fraud',
    name: '诈骗',
    description: '诈骗、欺诈、虚假交易'
  },

  // 4. 违法犯罪
  'illegal': {
    code: 'illegal',
    name: '违法犯罪',
    description: '违法、犯罪、危害国家安全'
  },

  // 5. 不实信息
  'false_info': {
    code: 'false_info',
    name: '不实信息',
    description: '虚假、谣言、误导性信息'
  },

  // 6. 未成年人相关
  'underage': {
    code: 'underage',
    name: '未成年人相关',
    description: '涉及未成年人的不当内容'
  },

  // 7. 内容引人不适
  'offensive': {
    code: 'offensive',
    name: '内容引人不适',
    description: '令人不适、恶心、恐怖的内容'
  },

  // 8. 其他
  'other': {
    code: 'other',
    name: '其他',
    description: '其他违规行为'
  }
};
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    reportId: string;     // 举报记录ID
    createdAt: number;    // 举报提交时间(毫秒)
    status: string;       // 举报状态: 'pending'(待审核)
  } | null
}
```

### 前端验证
**必填字段:**
- targetType: 必选,不能为空
- targetId: 必选,不能为空
- reasonType: 必选,不能为空

**可选字段:**
- description: 0-200字符
- evidenceImages: 最多3张,每张≤5MB

**提交按钮启用条件:**
- reasonType已选择
- description长度符合要求(如果填写)
- 图片上传完成(无正在上传的图片)

### 前端行为
**打开举报页面:**
1. 全屏页面
2. 顶部导航:
   - 左侧: "取消"按钮
   - 中间: "举报"标题
   - 右侧: "提交"按钮(初始禁用)
3. 内容区域:
   - 举报类型选择(必填,8个选项,2列网格)
   - 举报描述输入框(可选,多行文本)
   - 证据图片上传区域(可选,最多3张)

**选择举报类型:**
1. 显示8个举报类型卡片(2列网格布局)
2. 每个卡片显示:
   - 类型名称(大标题)
   - 类型描述(小字说明)
3. 点击某个类型:
   - 卡片边框变为紫色(2px)
   - 卡片背景变为浅紫色 (#F3E8FF)
   - 其他卡片取消选中
   - 启用"提交"按钮
4. 可以重新选择其他类型

**填写举报描述:**
1. 占位符: "请详细描述您举报的原因(选填)"
2. 多行文本框,最少4行,最多10行
3. 实时字符计数: "0/200"
4. 达到200字符时禁止继续输入
5. 颜色:
   - 正常: 灰色 (#999)
   - 超限: 红色 (#FF0000)

**上传证据图片:**
1. 显示图片上传区域(3个占位框,横向排列)
2. 点击占位框:
   - 打开相册选择器
   - 或打开相机拍照
3. 选择图片后:
   - 验证格式(jpg/png/webp)
   - 验证大小(≤5MB)
   - 显示上传进度
   - 上传成功后显示缩略图
   - 右上角显示删除按钮(X)
4. 图片格式/大小验证失败:
   - 显示错误Toast
   - 不上传该图片
5. 可上传最多3张

**提交举报:**
1. 验证必填字段:
   - 举报类型已选择
2. 验证可选字段:
   - 描述长度符合要求
   - 所有图片上传完成
3. 验证通过:
   - "提交"按钮显示加载状态
   - 禁用所有输入
   - 调用举报接口
4. 成功后:
   - 显示成功对话框:
     - 标题: "举报"
     - 内容: "已收到您的举报,我们会尽快处理"
     - 图标: 绿色勾(✓)
     - 按钮: "确定"(紫色)
   - 点击"确定":
     - 关闭对话框
     - 返回上一页(详情页)
5. 失败后:
   - 恢复按钮状态
   - 启用所有输入
   - 显示错误Toast:
     - 400: "举报信息有误,请检查"
     - 429: "举报过于频繁,请稍后再试"
     - 500: "提交失败,请稍后重试"
   - 保留已填写内容

**取消举报:**
1. 点击"取消"按钮
2. 检查是否有未提交内容
3. 有内容时弹出确认对话框:
   - 标题: "确认离开?"
   - 内容: "举报信息尚未提交,是否放弃?"
   - 按钮: "继续编辑" | "放弃"(红色)
4. 点击"放弃":
   - 清空所有内容
   - 返回上一页
5. 无内容时直接返回

---

## 二、举报用户

### 用户操作
1. 查看用户主页
2. **点击"更多"按钮(...)** → 打开操作菜单
3. **点击"举报"** → 进入举报页面
4. 选择举报类型
5. 填写举报描述(可选)
6. 上传举报证据图片(可选)
7. **点击"提交"** → 触发举报接口

### 接口定义
**接口:** `POST /api/v1/content/report`

**请求参数:**
```typescript
{
  targetType: 'user';      // 固定值: user
  targetId: string;        // 用户ID
  reasonType: string;      // 举报类型(同上)
  description?: string;    // 举报描述,0-200字符(可选)
  evidenceImages?: string[]; // 举报证据图片(可选,最多3张)
}
```

**响应数据:** 同上

### 前端行为
与举报动态/评论基本相同,区别:
- targetType固定为'user'
- targetId为用户ID
- 举报类型可能有所不同(如增加"恶意营销"等)

---

## 三、查看我的举报记录(可选)

### 用户操作
1. 进入个人中心
2. **点击"我的举报"** → 查看举报记录列表

### 接口定义
**接口:** `GET /api/v1/user/reports`

**触发时机:**
- 进入我的举报页面时
- 下拉刷新时
- 上拉加载更多时

**查询参数:**
```typescript
{
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20
  status?: string;     // 举报状态筛选(可选)
                      // 'pending'(待审核) | 'processing'(处理中) |
                      // 'approved'(通过) | 'rejected'(驳回)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    list: Report[];
    total: number;
    hasMore: boolean;
  } | null
}

interface Report {
  reportId: string;
  targetType: string;      // 'feed' | 'comment' | 'user'
  targetId: string;
  reasonType: string;
  reasonName: string;      // 举报类型中文名称
  description: string;
  evidenceImages: string[];
  status: string;          // 'pending' | 'processing' | 'approved' | 'rejected'
  statusName: string;      // 状态中文名称
  result?: string;         // 审核结果说明
  createdAt: number;       // 举报时间
  updatedAt: number;       // 最后更新时间
}
```

### 前端行为
**举报记录列表:**
1. 显示举报记录卡片列表
2. 每个卡片显示:
   - 举报对象类型和ID
   - 举报类型
   - 举报时间
   - 审核状态标签
   - 点击查看详情

**状态标签颜色:**
- 待审核(pending): 橙色 (#FF9800)
- 处理中(processing): 蓝色 (#2196F3)
- 通过(approved): 绿色 (#4CAF50)
- 驳回(rejected): 灰色 (#9E9E9E)

---

## 接口汇总

| # | 功能 | 用户操作 | 接口 | 方法 |
|---|------|---------|------|------|
| 1 | 举报动态 | 提交举报(targetType=feed) | `/api/v1/content/report` | POST |
| 2 | 举报评论 | 提交举报(targetType=comment) | `/api/v1/content/report` | POST |
| 3 | 举报用户 | 提交举报(targetType=user) | `/api/v1/content/report` | POST |
| 4 | 查看举报记录 | 进入我的举报页 | `/api/v1/user/reports` | GET |

---

## 通用验证规则

### 目标类型验证
```typescript
const VALID_TARGET_TYPES = ['feed', 'comment', 'user'];

const validateTargetType = (targetType: string) => {
  if (!VALID_TARGET_TYPES.includes(targetType)) {
    return { valid: false, error: '举报目标类型错误' };
  }
  return { valid: true };
};
```

### 举报类型验证
```typescript
const VALID_REASON_TYPES = [
  'harassment',
  'pornography',
  'fraud',
  'illegal',
  'false_info',
  'underage',
  'offensive',
  'other'
];

const validateReasonType = (reasonType: string) => {
  if (!reasonType) {
    return { valid: false, error: '请选择举报类型' };
  }

  if (!VALID_REASON_TYPES.includes(reasonType)) {
    return { valid: false, error: '举报类型错误' };
  }

  return { valid: true };
};
```

### 描述验证
```typescript
const validateDescription = (description?: string) => {
  if (!description) {
    return { valid: true }; // 可选
  }

  if (description.length > 200) {
    return { valid: false, error: '举报描述不能超过200字符' };
  }

  return { valid: true };
};
```

### 证据图片验证
```typescript
const validateEvidenceImages = (images?: string[]) => {
  if (!images || images.length === 0) {
    return { valid: true }; // 可选
  }

  if (images.length > 3) {
    return { valid: false, error: '最多只能上传3张证据图片' };
  }

  return { valid: true };
};
```

---

## 举报提交验证

```typescript
const validateReportSubmit = (data: {
  targetType: string;
  targetId: string;
  reasonType: string;
  description?: string;
  evidenceImages?: string[];
}) => {
  // 验证目标类型
  const targetTypeValid = validateTargetType(data.targetType);
  if (!targetTypeValid.valid) return targetTypeValid;

  // 验证目标ID
  if (!data.targetId) {
    return { valid: false, error: '目标ID不能为空' };
  }

  // 验证举报类型
  const reasonTypeValid = validateReasonType(data.reasonType);
  if (!reasonTypeValid.valid) return reasonTypeValid;

  // 验证描述
  const descriptionValid = validateDescription(data.description);
  if (!descriptionValid.valid) return descriptionValid;

  // 验证证据图片
  const imagesValid = validateEvidenceImages(data.evidenceImages);
  if (!imagesValid.valid) return imagesValid;

  return { valid: true };
};
```

---

## 异常处理

| 场景 | 错误码 | 前端处理方式 |
|-----|-------|------------|
| 未选择举报类型 | 400 | 显示"请选择举报类型" |
| 举报描述过长 | 400 | 显示"举报描述不能超过200字符" |
| 证据图片超过3张 | 400 | 显示"最多只能上传3张证据图片" |
| 证据图片过大 | 413 | 显示"图片过大,请选择小于5MB的图片" |
| 重复举报 | 400 | 显示"您已举报过该内容,请勿重复举报" |
| 举报过于频繁 | 429 | 显示"举报过于频繁,请稍后再试" |
| 目标不存在 | 404 | 显示"举报对象不存在" |
| 未登录 | 401 | 显示"请先登录",跳转登录页 |
| 网络错误 | - | 显示"网络异常,请重试" |
| 服务器错误 | 500 | 显示"提交失败,请稍后重试" |

---

## 防滥用机制

### 举报频率限制
**后端限制:**
- 同一用户1小时内最多举报10次
- 同一用户对同一目标24小时内只能举报1次
- 使用Redis计数器实现

**前端提示:**
- 达到限制时显示: "举报过于频繁,请稍后再试"
- 显示剩余时间(可选)

### 重复举报检测
**后端检测:**
- 检查用户是否已举报过相同目标
- 24小时内重复举报返回错误

**前端处理:**
- 显示: "您已举报过该内容,请勿重复举报"
- 或: "您的举报正在处理中,请耐心等待"

---

## TypeScript接口定义

```typescript
// 举报请求参数
interface ReportRequest {
  targetType: 'feed' | 'comment' | 'user';
  targetId: string;
  reasonType: string;
  description?: string;
  evidenceImages?: string[];
}

// 举报响应
interface ReportResponse {
  code: number;
  message: string;
  data: {
    reportId: string;
    createdAt: number;
    status: string;
  } | null;
}

// 举报类型
interface ReportReason {
  code: string;
  name: string;
  description: string;
}

// 举报记录
interface Report {
  reportId: string;
  targetType: string;
  targetId: string;
  reasonType: string;
  reasonName: string;
  description: string;
  evidenceImages: string[];
  status: string;
  statusName: string;
  result?: string;
  createdAt: number;
  updatedAt: number;
}

// 举报列表响应
interface ReportListResponse {
  code: number;
  message: string;
  data: {
    list: Report[];
    total: number;
    hasMore: boolean;
  } | null;
}
```

---

## 测试用例

### 功能测试
- [ ] 举报动态功能正常
- [ ] 举报评论功能正常
- [ ] 举报用户功能正常
- [ ] 选择举报类型正常
- [ ] 填写举报描述正常
- [ ] 上传证据图片正常
- [ ] 提交举报功能正常
- [ ] 查看举报记录功能正常

### 验证测试
- [ ] 举报类型必选验证
- [ ] 描述长度验证
- [ ] 图片数量验证
- [ ] 图片大小验证
- [ ] 重复举报检测

### 边界测试
- [ ] 未选择类型提交
- [ ] 描述超长提交
- [ ] 图片超过3张
- [ ] 图片过大提交
- [ ] 重复举报处理
- [ ] 频繁举报处理
- [ ] 网络异常处理

### UI测试
- [ ] 举报类型卡片选中状态
- [ ] 字符计数显示正确
- [ ] 提交按钮启用/禁用状态
- [ ] 成功对话框显示
- [ ] 取消确认对话框显示

---

## 开发清单

### 必须实现
- [x] 举报接口
- [x] 举报类型选择
- [x] 举报描述输入
- [x] 证据图片上传
- [x] 提交验证
- [x] 成功提示
- [x] 错误处理
- [x] 重复举报检测

### 可选优化
- [ ] 举报记录查询
- [ ] 举报状态通知
- [ ] 举报历史统计
- [ ] 举报原因推荐
- [ ] 快速举报(预设类型)

---

## 相关文档

- **调用文档:**
  - 动态详情页面文档
  - 用户主页接口文档
  - 评论列表组件文档

- **技术文档:**
  - 内容审核系统文档
  - 举报处理流程说明
  - 社区管理规范
