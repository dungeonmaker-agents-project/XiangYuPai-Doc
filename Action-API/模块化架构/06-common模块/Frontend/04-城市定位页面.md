# 04-城市定位页面

## 一、页面概述

### 页面信息
- **路由路径**: `/location/city`
- **页面名称**: 城市定位
- **用户角色**: 所有用户
- **页面类型**: 选择器页面

### 页面功能
城市定位页面允许用户选择或定位当前所在城市。用户可以:
1. 使用GPS定位当前城市
2. 查看最近访问的城市
3. 选择热门城市
4. 浏览所有城市(按A-Z字母分组)
5. 使用字母索引快速滚动
6. 搜索城市(前端过滤)

### 进入方式
- 从首页点击当前城市名称或定位按钮
- 首次使用App时强制进入
- 从区域选择页面返回

---

## 二、页面UI结构

### 2.1 顶部导航栏
```
[返回] | 定位 |
```

### 2.2 当前定位/最近访问区
```
+----------------------------------+
| 📍 当前定位                      |
| [深圳]                           |
|                                  |
| 最近访问                         |
| [北京] [上海] [杭州]             |
+----------------------------------+
```

### 2.3 热门城市区
```
+----------------------------------+
| 热门城市                         |
| [深圳] [杭州] [北京] [上海]      |
| [广州] [成都] [武汉] [西安]      |
+----------------------------------+
```

### 2.4 城市列表(按字母分组)
```
+----------------------------------+  [A]
| A                                |  [B]
| 安庆  合肥省                     |  [C]
|                                  |  [D]
| B                                |  ...
| 北京  河北省                     |  [Z]
| 保定  河北省                     |
+----------------------------------+
```

### 2.5 右侧字母索引条
```
[A-Z]垂直排列,点击快速滚动
```

---

## 三、接口列表

### 3.1 页面加载时调用

#### 1. 获取城市列表
**接口:** `GET /api/location/cities`

**调用时机:**
- 页面打开时

**请求参数:**
```typescript
{
  // 无参数
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    currentLocation?: {
      cityCode: string;
      cityName: string;
      province?: string;
    };
    recentVisited: Array<{
      cityCode: string;
      cityName: string;
      visitTime: string;
    }>;
    hotCities: Array<{
      cityCode: string;
      cityName: string;
    }>;
    allCities: Array<{
      letter: string;       // 首字母(A-Z)
      cities: Array<{
        cityCode: string;
        cityName: string;
        province?: string;
      }>;
    }>;
  }
}
```

**后续操作:**
- 渲染城市列表
- 显示当前定位(如有)
- 显示最近访问和热门城市

---

### 3.2 用户操作触发

#### 2. 获取当前定位
**接口:** `POST /api/location/detect`

**调用时机:**
- 用户点击"定位"按钮
- 页面打开时自动定位(可选)

**请求参数:**
```typescript
{
  latitude: number;
  longitude: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    cityCode: string;
    cityName: string;
    district?: string;
    province: string;
    formattedAddress: string;
  }
}
```

**后续操作:**
- 显示定位结果
- 如果定位失败,显示手动选择提示

---

#### 3. 选择城市
**接口:** `POST /api/location/city/select`

**调用时机:**
- 点击任意城市选项

**请求参数:**
```typescript
{
  cityCode: string;
  cityName: string;
  source: 'manual' | 'gps' | 'recent' | 'hot';
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    success: boolean;
    selectedCity: {
      cityCode: string;
      cityName: string;
    };
    hasDistricts: boolean;
  }
}
```

**后续操作:**
- 如果hasDistricts=true:跳转区域选择页
- 如果hasDistricts=false:直接返回首页
- 保存选择到本地缓存
- 记录到"最近访问"

---

## 四、数据流

### 4.1 页面打开流程
```
1. 用户打开城市定位页面
2. 调用GET /api/location/cities
3. 显示Loading骨架屏
4. 收到响应 → 渲染城市列表
5. (可选)自动触发GPS定位
```

### 4.2 GPS定位流程
```
1. 用户点击"定位"按钮
2. 请求位置权限
3. 获取GPS坐标
4. 调用POST /api/location/detect
5. 显示定位Loading
6. 成功:显示定位城市
7. 失败:提示手动选择
```

### 4.3 选择城市流程
```
1. 用户点击某个城市
2. 调用POST /api/location/city/select
3. 保存到本地缓存
4. 记录到最近访问
5. 判断hasDistricts:
   - true → 跳转区域选择
   - false → 返回首页并刷新
```

---

## 五、状态管理

### 5.1 页面级状态
```typescript
{
  currentLocation: {
    cityCode: string;
    cityName: string;
  } | null;
  recentVisited: City[];
  hotCities: City[];
  allCities: Array<{
    letter: string;
    cities: City[];
  }>;
  searchKeyword: string;
  filteredCities: City[];
  loading: boolean;
  locating: boolean;
  error: string | null;
}
```

### 5.2 本地缓存
```typescript
{
  selectedCity: {
    cityCode: string;
    cityName: string;
    timestamp: number;
  };
  recentVisited: Array<{
    cityCode: string;
    cityName: string;
    visitTime: number;
  }>;  // 最多5个,30天过期
}
```

---

## 六、路由参数

### 6.1 进入参数
```typescript
{
  // 通常无参数
  autoLocate?: boolean;  // 是否自动定位
}
```

### 6.2 跳转目标

#### 选择有区域的城市
```typescript
this.$router.push({
  path: '/location/district',
  query: {
    cityCode: selectedCity.cityCode,
    cityName: selectedCity.cityName
  }
});
```

#### 选择无区域的城市
```typescript
this.$router.replace({
  path: '/home',
  query: { refresh: true }
});
```

---

## 七、错误处理

### 7.1 位置权限被拒绝
```
显示: "位置权限未授权,请在设置中开启"
操作: 提供手动选择入口
```

### 7.2 GPS定位失败
```
显示: "定位失败,请手动选择城市"
操作: 允许用户浏览城市列表
```

### 7.3 GPS坐标无效
```
显示: "无法获取位置信息,请手动选择城市"
操作: 显示城市列表
```

### 7.4 网络错误
```
显示: "网络异常,请稍后重试"
操作: 提供"重试"按钮
```

---

## 八、测试要点

### 8.1 页面加载测试
- [ ] 城市列表正常加载
- [ ] 当前定位正确显示
- [ ] 最近访问城市正确显示
- [ ] 热门城市正确显示
- [ ] 字母分组正确

### 8.2 定位功能测试
- [ ] GPS定位功能正常
- [ ] 定位失败时提示正确
- [ ] 位置权限请求正常

### 8.3 选择功能测试
- [ ] 点击城市正确响应
- [ ] 有区域城市跳转正确
- [ ] 无区域城市直接返回首页
- [ ] 最近访问记录正确

### 8.4 交互测试
- [ ] 字母索引滚动正常
- [ ] 搜索功能正常(如有)
- [ ] 滚动性能良好

---

## 九、使用的后端服务

### LocationService
- `GET /api/location/cities` - 获取城市列表
- `POST /api/location/detect` - GPS定位
- `POST /api/location/city/select` - 选择城市

---

## 十、前端实现要点

### 组件结构
```
CitySelector/
├── index.vue                  // 页面主组件
├── components/
│   ├── CurrentLocation.vue    // 当前定位区
│   ├── RecentCities.vue       // 最近访问
│   ├── HotCities.vue          // 热门城市
│   ├── CityList.vue           // 城市列表
│   └── LetterIndex.vue        // 字母索引
└── hooks/
    ├── useCities.ts           // 城市数据管理
    └── useLocation.ts         // 定位功能
```

### 关键逻辑
1. **GPS定位**: 请求权限,获取坐标,解析城市
2. **城市列表**: 按字母分组,虚拟滚动优化
3. **字母索引**: 点击滚动到对应位置
4. **最近访问**: 本地缓存,最多5个
5. **城市搜索**: 前端过滤,支持拼音(可选)

---

**文档版本**: v1.0
**最后更新**: 2025-01-XX
**维护者**: 前端团队
