# LocationService - 位置服务接口文档

## 1. 服务概述

### 1.1 服务职责
LocationService是平台的地理位置服务,负责:
- 区域列表查询与选择
- 城市列表查询与选择
- GPS定位解析
- 距离计算
- 位置服务被其他服务远程调用(RPC)

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **地图API**: 高德地图API / 腾讯地图API
- **缓存**: Redis 7.0+ (城市/区域缓存)
- **数据库**: MySQL 8.0+ with SPATIAL INDEX

### 1.3 服务信息
- **服务名**: xypai-location
- **端口**: 9406
- **数据库**: xypai_location
- **RPC支持**: 可被远程调用

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 获取区域列表 | GET | `/api/location/districts` | 获取城市的区域列表 | 公开 |
| 选择区域 | POST | `/api/location/district/select` | 选择区域 | 公开 |
| 获取城市列表 | GET | `/api/location/cities` | 获取所有城市列表 | 公开 |
| GPS定位解析 | POST | `/api/location/detect` | 解析GPS坐标为城市 | 公开 |
| 选择城市 | POST | `/api/location/city/select` | 选择城市 | 公开 |

### 2.2 内部RPC (Feign)

| 接口名称 | 方法 | 路径 | 描述 | 调用方 |
|---------|------|------|------|--------|
| 计算距离 | POST | `/feign/location/distance` | 计算两点距离 | HomeService, ServiceService |
| 批量计算距离 | POST | `/feign/location/distance/batch` | 批量计算距离 | HomeService |
| 获取城市信息 | GET | `/feign/location/city/{code}` | 获取城市详情 | 所有服务 |
| 验证坐标 | POST | `/feign/location/validate` | 验证GPS坐标 | 所有服务 |

---

## 3. 接口详细定义

### 3.1 获取区域列表

#### 接口定义
```
GET /api/location/districts?cityCode=440300
```

#### 请求参数
```typescript
interface GetDistrictsRequest {
  cityCode: string;             // 城市代码
}
```

#### 响应数据
```typescript
interface GetDistrictsResponse {
  code: number;
  message: string;
  data: {
    cityName: string;
    currentDistrict?: string;
    districts: Array<{
      code: string;
      name: string;
      isAll: boolean;           // 是否为"全部"选项
    }>;
  };
}
```

#### 业务规则
1. cityCode必须有效
2. 返回城市所有区域
3. "全{城市名}"选项排第一位
4. 结果缓存30分钟

---

### 3.2 选择区域

#### 接口定义
```
POST /api/location/district/select
Content-Type: application/json
```

#### 请求参数
```typescript
interface SelectDistrictRequest {
  cityCode: string;
  districtCode: string;         // 'all'表示全城
}
```

#### 响应数据
```typescript
interface SelectDistrictResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    selectedDistrict: {
      code: string;
      name: string;
    };
  };
}
```

---

### 3.3 获取城市列表

#### 接口定义
```
GET /api/location/cities
```

#### 响应数据
```typescript
interface GetCitiesResponse {
  code: number;
  message: string;
  data: {
    currentLocation?: {
      cityCode: string;
      cityName: string;
      province?: string;
    };
    recentVisited: Array<{
      cityCode: string;
      cityName: string;
      visitTime: string;
    }>;
    hotCities: Array<{
      cityCode: string;
      cityName: string;
    }>;
    allCities: Array<{
      letter: string;           // 首字母A-Z
      cities: Array<{
        cityCode: string;
        cityName: string;
        province?: string;
      }>;
    }>;
  };
}
```

#### 业务规则
1. 热门城市由运营配置
2. 最近访问保存最近5个
3. 所有城市按拼音首字母分组
4. 结果缓存24小时

---

### 3.4 GPS定位解析

#### 接口定义
```
POST /api/location/detect
Content-Type: application/json
```

#### 请求参数
```typescript
interface DetectLocationRequest {
  latitude: number;             // 纬度 -90~90
  longitude: number;            // 经度 -180~180
}
```

#### 响应数据
```typescript
interface DetectLocationResponse {
  code: number;
  message: string;
  data: {
    cityCode: string;
    cityName: string;
    district?: string;
    province: string;
    formattedAddress: string;   // 格式化地址
  };
}
```

#### 业务规则
1. 调用高德/腾讯地图逆地理编码API
2. 坐标验证: lat∈[-90,90], lng∈[-180,180]
3. 解析失败返回默认城市
4. 结果不缓存(实时定位)

---

### 3.5 选择城市

#### 接口定义
```
POST /api/location/city/select
Content-Type: application/json
```

#### 请求参数
```typescript
interface SelectCityRequest {
  cityCode: string;
  cityName: string;
  source: 'manual' | 'gps' | 'recent' | 'hot';
}
```

#### 响应数据
```typescript
interface SelectCityResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    selectedCity: {
      cityCode: string;
      cityName: string;
    };
    hasDistricts: boolean;      // 是否有区域划分
  };
}
```

---

### 3.6 计算距离 (RPC)

#### 接口定义
```
POST /feign/location/distance
Content-Type: application/json
```

#### 请求参数
```typescript
interface CalculateDistanceRequest {
  fromLat: number;
  fromLng: number;
  toLat: number;
  toLng: number;
  unit?: 'km' | 'm';            // 单位(默认km)
}
```

#### 响应数据
```typescript
interface CalculateDistanceResponse {
  code: number;
  message: string;
  data: {
    distance: number;           // 距离
    unit: string;
    displayText: string;        // 如"3.2km"
  };
}
```

#### 业务规则
1. 使用Haversine公式计算球面距离
2. 精度: 小数点后1位
3. 超过100km显示">100km"

---

### 3.7 批量计算距离 (RPC)

#### 接口定义
```
POST /feign/location/distance/batch
Content-Type: application/json
```

#### 请求参数
```typescript
interface BatchCalculateDistanceRequest {
  fromLat: number;
  fromLng: number;
  targets: Array<{
    id: number;                 // 目标ID(用户ID/地点ID)
    lat: number;
    lng: number;
  }>;
  unit?: 'km' | 'm';
}
```

#### 响应数据
```typescript
interface BatchCalculateDistanceResponse {
  code: number;
  message: string;
  data: {
    distances: Array<{
      id: number;
      distance: number;
      displayText: string;
    }>;
  };
}
```

---

## 4. 数据模型

### 4.1 城市表 (city)

```sql
CREATE TABLE city (
  id BIGINT PRIMARY KEY,
  city_code VARCHAR(10) UNIQUE NOT NULL COMMENT '城市代码',
  city_name VARCHAR(50) NOT NULL COMMENT '城市名称',
  province VARCHAR(50) COMMENT '省份',
  pinyin VARCHAR(50) COMMENT '拼音',
  first_letter CHAR(1) COMMENT '首字母',
  center_point POINT NOT NULL COMMENT '城市中心点坐标',
  city_boundary POLYGON COMMENT '城市边界多边形',
  is_hot TINYINT DEFAULT 0 COMMENT '是否热门城市',
  has_districts TINYINT DEFAULT 0 COMMENT '是否有区域划分',
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  SPATIAL INDEX idx_center_point (center_point),
  SPATIAL INDEX idx_city_boundary (city_boundary),
  INDEX idx_first_letter (first_letter),
  INDEX idx_is_hot (is_hot)
) ENGINE=InnoDB COMMENT='城市表';
```

### 4.2 区域表 (district)

```sql
CREATE TABLE district (
  id BIGINT PRIMARY KEY,
  city_code VARCHAR(10) NOT NULL COMMENT '城市代码',
  district_code VARCHAR(20) UNIQUE NOT NULL COMMENT '区域代码',
  district_name VARCHAR(50) NOT NULL COMMENT '区域名称',
  center_point POINT NOT NULL COMMENT '区域中心点',
  district_boundary POLYGON COMMENT '区域边界',
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_city_code (city_code),
  SPATIAL INDEX idx_center_point (center_point),
  SPATIAL INDEX idx_district_boundary (district_boundary)
) ENGINE=InnoDB COMMENT='区域表';
```

### 4.3 用户位置偏好表 (user_location_preference)

```sql
CREATE TABLE user_location_preference (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  city_code VARCHAR(10) NOT NULL,
  district_code VARCHAR(20),
  last_location POINT COMMENT '最后定位点',
  select_source VARCHAR(20) COMMENT '选择来源: manual/gps',
  visit_count INT DEFAULT 1,
  last_visit_time DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_city (user_id, city_code),
  INDEX idx_user_id (user_id),
  SPATIAL INDEX idx_last_location (last_location)
) ENGINE=InnoDB COMMENT='用户位置偏好表';
```

---

## 5. 依赖服务

### 5.1 调用的外部服务
- **高德地图API**: 逆地理编码
- **腾讯地图API**: 备用地理编码

### 5.2 被调用的服务
- **HomeService**: 筛选/Feed流距离计算
- **ServiceService**: 服务列表距离计算
- **ActivityService**: 活动距离计算

---

## 6. 性能要求

### 6.1 QPS要求
- 城市列表: 200 QPS
- 距离计算(单次): 500 QPS
- 距离计算(批量): 100 QPS
- GPS定位: 100 QPS

### 6.2 响应时间
- 城市/区域查询: P95 < 50ms
- 距离计算: P95 < 20ms
- GPS定位: P95 < 200ms (依赖外部API)

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 城市列表缓存
```
Key: location:cities:all
Value: 城市列表JSON
TTL: 24小时
```

#### 区域列表缓存
```
Key: location:districts:{cityCode}
Value: 区域列表JSON
TTL: 30分钟
```

#### 热门城市缓存
```
Key: location:cities:hot
Value: 热门城市列表JSON
TTL: 24小时
```

---

## 8. 监控告警

### 8.1 关键指标
- **定位成功率**: > 95%
- **距离计算准确率**: 100%
- **平均响应时间**: < 100ms
- **外部API可用性**: > 99%

### 8.2 告警规则
1. 定位失败率 > 5% - P2
2. 外部API超时 > 1s - P2
3. 距离计算异常 - P1
