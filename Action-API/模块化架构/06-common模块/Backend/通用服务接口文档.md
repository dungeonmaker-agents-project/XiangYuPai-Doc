# CommonService - 通用服务接口文档

## 1. 服务概述

### 1.1 服务职责
CommonService是平台的基础设施服务,提供所有业务模块共用的基础功能:
- 文件上传管理(图片、视频)
- 系统配置管理
- 通用工具接口

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **文件存储**: 阿里云OSS / 腾讯云COS
- **缓存**: Redis 7.0+ (配置缓存)
- **数据库**: MySQL 8.0+ (配置存储)

### 1.3 服务信息
- **服务名**: xypai-common
- **端口**: 9405
- **数据库**: xypai_common

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 上传图片 | POST | `/api/common/upload/image` | 上传单个图片 | 需登录 |
| 上传视频 | POST | `/api/common/upload/video` | 上传单个视频 | 需登录 |
| 批量上传图片 | POST | `/api/common/upload/images` | 批量上传图片(最多9张) | 需登录 |
| 获取配置 | GET | `/api/common/config/{key}` | 获取系统配置 | 公开 |

### 2.2 内部RPC (Feign)

| 接口名称 | 方法 | 路径 | 描述 | 调用方 |
|---------|------|------|------|--------|
| 验证文件URL | GET | `/feign/common/file/validate` | 验证文件URL有效性 | 所有服务 |
| 获取批量配置 | POST | `/feign/common/config/batch` | 批量获取配置 | 所有服务 |
| 删除文件 | DELETE | `/feign/common/file/delete` | 删除OSS文件 | 所有服务 |

---

## 3. 接口详细定义

### 3.1 图片上传

#### 接口定义
```
POST /api/common/upload/image
Content-Type: multipart/form-data
```

#### 请求参数
```typescript
interface UploadImageRequest {
  file: File;                    // 图片文件
  type: 'avatar' | 'content' | 'activity' | 'service' | 'other';  // 上传类型
  compress?: boolean;            // 是否压缩(默认true)
  width?: number;                // 压缩宽度(默认1080)
  quality?: number;              // 压缩质量1-100(默认85)
}
```

#### 响应数据
```typescript
interface UploadImageResponse {
  code: number;
  message: string;
  data: {
    imageUrl: string;            // 原图URL
    thumbnailUrl: string;        // 缩略图URL
    width: number;               // 图片宽度
    height: number;              // 图片高度
    size: number;                // 文件大小(bytes)
    format: string;              // 图片格式
  };
}
```

#### 业务规则
1. 支持格式: JPG, JPEG, PNG, WEBP
2. 文件大小: ≤ 10MB
3. 自动生成缩略图(200x200)
4. 图片URL有效期: 永久(CDN加速)
5. 返回相对路径,前端拼接CDN域名

#### 错误码
- `40001`: 文件格式不支持
- `40002`: 文件大小超限
- `40003`: 文件上传失败
- `40004`: 文件类型验证失败

---

### 3.2 视频上传

#### 接口定义
```
POST /api/common/upload/video
Content-Type: multipart/form-data
```

#### 请求参数
```typescript
interface UploadVideoRequest {
  file: File;                    // 视频文件
  type: 'content' | 'activity' | 'other';  // 上传类型
  generateCover?: boolean;       // 是否生成封面(默认true)
  coverTime?: number;            // 封面截取时间秒数(默认3)
}
```

#### 响应数据
```typescript
interface UploadVideoResponse {
  code: number;
  message: string;
  data: {
    videoUrl: string;            // 视频URL
    coverUrl?: string;           // 视频封面URL
    duration: number;            // 视频时长(秒)
    width: number;               // 视频宽度
    height: number;              // 视频高度
    size: number;                // 文件大小(bytes)
    format: string;              // 视频格式
  };
}
```

#### 业务规则
1. 支持格式: MP4, MOV, AVI, FLV
2. 文件大小: ≤ 100MB
3. 时长限制: ≤ 300秒(5分钟)
4. 自动转码为MP4格式(H.264编码)
5. 自动生成视频封面
6. 支持断点续传

#### 错误码
- `40011`: 视频格式不支持
- `40012`: 视频大小超限
- `40013`: 视频时长超限
- `40014`: 视频上传失败

---

### 3.3 批量上传图片

#### 接口定义
```
POST /api/common/upload/images
Content-Type: multipart/form-data
```

#### 请求参数
```typescript
interface UploadImagesRequest {
  files: File[];                 // 图片文件数组(最多9张)
  type: string;                  // 上传类型
  compress?: boolean;            // 是否压缩
}
```

#### 响应数据
```typescript
interface UploadImagesResponse {
  code: number;
  message: string;
  data: {
    images: Array<{
      imageUrl: string;
      thumbnailUrl: string;
      index: number;             // 原始顺序索引
      success: boolean;          // 是否上传成功
      error?: string;            // 错误信息(如失败)
    }>;
    successCount: number;        // 成功数量
    failCount: number;           // 失败数量
  };
}
```

#### 业务规则
1. 最多同时上传9张图片
2. 并发上传,失败不影响其他图片
3. 返回结果保持原始顺序
4. 全部失败返回400错误
5. 部分失败返回200但标记失败项

---

### 3.4 获取配置 (RPC)

#### 接口定义
```
GET /api/common/config/{key}
```

#### 请求参数
```typescript
interface GetConfigRequest {
  key: string;                   // 配置key
}
```

#### 响应数据
```typescript
interface GetConfigResponse {
  code: number;
  message: string;
  data: {
    key: string;
    value: string;               // 配置值(JSON字符串)
    type: 'string' | 'number' | 'boolean' | 'json';
    description: string;
  };
}
```

#### 业务规则
1. 配置存储在MySQL
2. Redis缓存30分钟
3. 支持热更新
4. 配置不存在返回null

---

### 3.5 验证文件URL (RPC)

#### 接口定义
```
GET /feign/common/file/validate
```

#### 请求参数
```typescript
interface ValidateFileRequest {
  url: string;                   // 文件URL
  type?: 'image' | 'video';      // 文件类型(可选)
}
```

#### 响应数据
```typescript
interface ValidateFileResponse {
  code: number;
  message: string;
  data: {
    valid: boolean;              // 是否有效
    exists: boolean;             // 文件是否存在
    fileType: string;            // 文件类型
    size: number;                // 文件大小
  };
}
```

---

### 3.6 删除文件 (RPC)

#### 接口定义
```
DELETE /feign/common/file/delete
```

#### 请求参数
```typescript
interface DeleteFileRequest {
  url: string;                   // 文件URL
  deleteSource?: boolean;        // 是否删除OSS源文件(默认false,仅标记删除)
}
```

#### 响应数据
```typescript
interface DeleteFileResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    deletedUrl: string;
  };
}
```

---

## 4. 数据模型

### 4.1 上传记录表 (upload_record)

```sql
CREATE TABLE upload_record (
  id BIGINT PRIMARY KEY COMMENT '记录ID',
  user_id BIGINT NOT NULL COMMENT '上传用户ID',
  file_url VARCHAR(512) NOT NULL COMMENT '文件URL',
  file_type VARCHAR(20) NOT NULL COMMENT '文件类型: image/video',
  upload_type VARCHAR(50) COMMENT '上传类型: avatar/content/activity等',
  file_size BIGINT COMMENT '文件大小(bytes)',
  file_format VARCHAR(20) COMMENT '文件格式',
  width INT COMMENT '图片/视频宽度',
  height INT COMMENT '图片/视频高度',
  duration INT COMMENT '视频时长(秒)',
  storage_path VARCHAR(512) COMMENT 'OSS存储路径',
  status TINYINT DEFAULT 1 COMMENT '状态: 1正常 0已删除',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_upload_type (upload_type),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='文件上传记录表';
```

### 4.2 系统配置表 (system_config)

```sql
CREATE TABLE system_config (
  id BIGINT PRIMARY KEY COMMENT '配置ID',
  config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
  config_value TEXT NOT NULL COMMENT '配置值',
  value_type VARCHAR(20) NOT NULL COMMENT '值类型: string/number/boolean/json',
  category VARCHAR(50) COMMENT '配置分类',
  description VARCHAR(255) COMMENT '配置描述',
  is_public TINYINT DEFAULT 0 COMMENT '是否公开: 1是 0否',
  sort_order INT DEFAULT 0 COMMENT '排序',
  status TINYINT DEFAULT 1 COMMENT '状态: 1启用 0禁用',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_category (category),
  INDEX idx_is_public (is_public)
) ENGINE=InnoDB COMMENT='系统配置表';
```

---

## 5. 依赖服务

### 5.1 调用的外部服务
- **阿里云OSS**: 文件存储
- **阿里云CDN**: 文件加速
- **Auth Service**: 用户认证(token验证)

### 5.2 被调用的服务
- **所有业务服务**: 文件上传、配置读取

---

## 6. 性能要求

### 6.1 QPS要求
- 图片上传: 100 QPS
- 视频上传: 20 QPS
- 配置读取: 500 QPS (Redis缓存)

### 6.2 响应时间
- 图片上传: P95 < 1s, P99 < 2s
- 视频上传: P95 < 5s, P99 < 10s
- 配置读取: P95 < 50ms, P99 < 100ms

### 6.3 可用性
- SLA: 99.95%
- 上传失败率: < 0.1%

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 配置缓存
```
Key: common:config:{key}
Value: JSON字符串
TTL: 30分钟
更新策略: 配置修改时主动清除
```

#### 上传token缓存
```
Key: common:upload:token:{userId}
Value: 上传凭证
TTL: 1小时
更新策略: 过期自动刷新
```

### 7.2 本地缓存
- 使用Caffeine缓存配置信息
- 缓存容量: 1000条
- 过期时间: 10分钟

---

## 8. 监控告警

### 8.1 关键指标

#### 上传成功率
```
指标: upload_success_rate
计算: 成功数 / 总请求数
阈值: < 99% 告警
```

#### 平均上传时间
```
指标: upload_avg_duration
单位: 毫秒
阈值: 图片>2s, 视频>10s 告警
```

#### OSS存储用量
```
指标: oss_storage_usage
单位: GB
阈值: > 80% 告警
```

### 8.2 告警规则
1. 上传成功率低于99% - P1级别
2. 上传时间超过阈值 - P2级别
3. OSS存储空间不足 - P2级别
4. 服务不可用 - P0级别

---

## 9. 配置管理

### 9.1 常用配置项

```yaml
# OSS配置
oss:
  endpoint: oss-cn-shenzhen.aliyuncs.com
  bucket: xypai-files
  access-key-id: ${OSS_ACCESS_KEY}
  access-key-secret: ${OSS_SECRET_KEY}
  cdn-domain: https://cdn.xypai.com

# 上传限制
upload:
  image:
    max-size: 10485760  # 10MB
    formats: jpg,jpeg,png,webp
    compress:
      enabled: true
      width: 1080
      quality: 85
  video:
    max-size: 104857600  # 100MB
    max-duration: 300  # 5分钟
    formats: mp4,mov,avi,flv

# 缓存配置
cache:
  config:
    ttl: 1800  # 30分钟
  local:
    enabled: true
    max-size: 1000
    ttl: 600  # 10分钟
```

---

## 10. 安全措施

### 10.1 上传安全
1. 文件类型验证(MIME类型 + 文件头验证)
2. 文件大小限制
3. 文件名过滤(防止路径遍历)
4. 病毒扫描(集成ClamAV)
5. 限流控制(每用户每小时最多100次上传)

### 10.2 访问控制
1. 所有API需要JWT认证
2. RPC接口使用@InnerAuth注解
3. 敏感配置不对外暴露
4. 文件URL使用CDN防盗链

---

## 11. 部署说明

### 11.1 依赖服务
- MySQL 8.0+
- Redis 7.0+
- Nacos 2.x
- 阿里云OSS

### 11.2 环境变量
```bash
# 数据库
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=${DB_PASSWORD}

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=${REDIS_PASSWORD}

# OSS
OSS_ACCESS_KEY=${OSS_ACCESS_KEY}
OSS_SECRET_KEY=${OSS_SECRET_KEY}
```

### 11.3 启动命令
```bash
java -jar xypai-common.jar \
  --spring.profiles.active=prod \
  --server.port=9405
```
