# 07-技能预约订单页面

## 一、页面概述

- **路由路径**:
  - `/skills/{skillId}/booking` - 技能预约详情
  - `/orders/confirm/{skillId}` - 订单确认
  - `/orders/{orderId}` - 订单详情
- **页面功能**: 技能预约、订单确认、支付和订单管理
- **用户角色**: 已登录用户
- **页面类型**: 交易页面

## 二、页面1：技能预约详情页

### 2.1 顶部导航栏

```
[←]  技能详情
```

### 2.2 技能信息卡片

```
┌────────────────────────────────────────┐
│  [技能封面图]                          │
│                                         │
│  技能名称                               │
│  ⭐⭐⭐⭐⭐ 5.0  (128条评价)           │
│  💰 ¥99/局  或  ¥99/小时              │
└────────────────────────────────────────┘
```

### 2.3 服务者信息

```
┌────────────────────────────────────────┐
│  [头像] 昵称                    [关注]  │
│        接单率 98% | 平均响应 5分钟      │
└────────────────────────────────────────┘
```

**点击头像/昵称:**
- 跳转到服务者主页

### 2.4 技能详情

```
┌────────────────────────────────────────┐
│  技能介绍                               │
│  ────────────────────────────          │
│  详细的技能介绍内容...                  │
│                                         │
│  技能展示                               │
│  ────────────────────────────          │
│  [图1] [图2] [图3]                      │
│                                         │
│  服务承诺                               │
│  ────────────────────────────          │
│  ✓ 准时开始                            │
│  ✓ 耐心指导                            │
│  ✓ 友好交流                            │
└────────────────────────────────────────┘
```

### 2.5 用户评价

```
┌────────────────────────────────────────┐
│  用户评价 (128)              [查看全部] │
│  ────────────────────────────          │
│  [头像] 昵称           ⭐⭐⭐⭐⭐      │
│  评价内容...                            │
│  2024-01-15                             │
│  ────────────────────────────          │
│  [头像] 昵称           ⭐⭐⭐⭐⭐      │
│  评价内容...                            │
│  2024-01-14                             │
└────────────────────────────────────────┘
```

### 2.6 底部预约按钮

```
┌────────────────────────────────────────┐
│  ¥99/局                    [立即预约]   │
└────────────────────────────────────────┘
```

---

## 三、页面2：订单确认页

### 3.1 顶部导航栏

```
[←]  确认订单
```

### 3.2 技能信息

```
┌────────────────────────────────────────┐
│  [封面图] 技能名称                      │
│          ¥99/局                         │
└────────────────────────────────────────┘
```

### 3.3 服务者信息

```
┌────────────────────────────────────────┐
│  服务者                                 │
│  [头像] 昵称                            │
└────────────────────────────────────────┘
```

### 3.4 预约信息（线上技能）

```
┌────────────────────────────────────────┐
│  预约信息                               │
│  ────────────────────────────          │
│  服务时长    1.5小时/局                 │
│  预约数量    [- 1 +]                    │
│                                         │
│  预约时间                               │
│  [选择预约时间____________ 📅]          │
│                                         │
│  联系方式                               │
│  [请输入您的联系方式____________]       │
│                                         │
│  备注                                   │
│  [有什么需要告诉服务者的...             │
│   ___________________________]          │
└────────────────────────────────────────┘
```

### 3.5 预约信息（线下技能）

```
┌────────────────────────────────────────┐
│  预约信息                               │
│  ────────────────────────────          │
│  服务时长    1小时起                    │
│  预约时长    [- 1 +] 小时               │
│                                         │
│  预约时间                               │
│  [选择预约日期____________ 📅]          │
│  [选择预约时段____________ 🕐]          │
│                                         │
│  服务地点                               │
│  [广东省广州市天河区__________ 📍]      │
│                                         │
│  联系方式                               │
│  [请输入您的联系方式____________]       │
│                                         │
│  备注                                   │
│  [有什么需要告诉服务者的...             │
│   ___________________________]          │
└────────────────────────────────────────┘
```

### 3.6 费用明细

```
┌────────────────────────────────────────┐
│  费用明细                               │
│  ────────────────────────────          │
│  服务费用             ¥99.00            │
│  平台服务费            ¥9.90            │
│  ────────────────────────────          │
│  合计                ¥108.90            │
└────────────────────────────────────────┘
```

### 3.7 支付方式

```
┌────────────────────────────────────────┐
│  支付方式                               │
│  ────────────────────────────          │
│  ○ 余额支付 (余额: ¥500.00)            │
│  ○ 微信支付                            │
│  ○ 支付宝支付                          │
└────────────────────────────────────────┘
```

### 3.8 底部提交按钮

```
┌────────────────────────────────────────┐
│  实付款: ¥108.90         [提交订单]     │
└────────────────────────────────────────┘
```

---

## 四、页面3：订单详情页

### 4.1 顶部导航栏

```
[←]  订单详情
```

### 4.2 订单状态

```
┌────────────────────────────────────────┐
│           ✓                             │
│       支付成功                          │
│     等待服务者确认                      │
└────────────────────────────────────────┘
```

**订单状态类型:**
- 待支付：显示倒计时和"去支付"按钮
- 待确认：等待服务者确认
- 待服务：等待服务时间到达
- 服务中：服务进行中
- 待评价：服务完成，等待评价
- 已完成：已评价
- 已取消：订单取消
- 已退款：退款完成

### 4.3 订单信息

```
┌────────────────────────────────────────┐
│  订单信息                               │
│  ────────────────────────────          │
│  订单编号    20240115123456789          │
│  创建时间    2024-01-15 14:30:00        │
│  支付时间    2024-01-15 14:31:25        │
└────────────────────────────────────────┘
```

### 4.4 技能信息

```
┌────────────────────────────────────────┐
│  [封面图] 技能名称                      │
│          ¥99 × 1                        │
└────────────────────────────────────────┘
```

### 4.5 服务者信息

```
┌────────────────────────────────────────┐
│  服务者                                 │
│  [头像] 昵称                    [联系]  │
└────────────────────────────────────────┘
```

### 4.6 预约信息

```
┌────────────────────────────────────────┐
│  预约信息                               │
│  ────────────────────────────          │
│  预约时间    2024-01-16 19:00           │
│  服务时长    1.5小时                    │
│  联系方式    13147046323                │
│  备注        希望耐心指导                │
└────────────────────────────────────────┘
```

### 4.7 费用明细

```
┌────────────────────────────────────────┐
│  费用明细                               │
│  ────────────────────────────          │
│  服务费用             ¥99.00            │
│  平台服务费            ¥9.90            │
│  ────────────────────────────          │
│  实付款              ¥108.90            │
└────────────────────────────────────────┘
```

### 4.8 底部操作按钮

**根据订单状态显示不同按钮:**

- **待支付**: `[取消订单] [去支付]`
- **待确认**: `[申请退款] [联系服务者]`
- **待服务**: `[申请退款] [联系服务者]`
- **服务中**: `[联系服务者]`
- **待评价**: `[去评价]`
- **已完成**: `[再来一单] [删除订单]`
- **已取消/已退款**: `[删除订单]`

---

## 五、接口列表

### 5.1 获取技能预约详情

**接口:** `GET /api/skills/{skillId}/booking-detail`

**触发时机:** 进入技能预约详情页

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `skillId`: 技能ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skill: {
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      coverImage: string;
      images: string[];
      description: string;
      price: number;
      priceUnit: string;
      rating: number;
      reviewCount: number;
      // 线上技能
      serviceHours?: number;
      // 线下技能
      location?: string;
      availableTimes?: Array<{
        dayOfWeek: number;
        startTime: string;
        endTime: string;
      }>;
    };
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
      orderAcceptRate: number;  // 接单率
      avgResponseTime: number;   // 平均响应时间（分钟）
    };
    promises: string[];
  };
}
```

### 5.2 获取技能评价列表

**接口:** `GET /api/skills/{skillId}/reviews`

**触发时机:** 进入技能详情页、点击"查看全部"

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `skillId`: 技能ID

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    reviews: Array<{
      reviewId: string;
      user: {
        userId: string;
        nickname: string;
        avatar: string;
      };
      rating: number;        // 1-5星
      content: string;
      images?: string[];
      createdAt: string;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

### 5.3 获取订单确认信息

**接口:** `GET /api/orders/confirm-info/{skillId}`

**触发时机:** 进入订单确认页

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `skillId`: 技能ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skill: {
      skillId: string;
      skillName: string;
      coverImage: string;
      price: number;
      priceUnit: string;
      skillType: "online" | "offline";
      serviceHours?: number;  // 线上技能服务时长
    };
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
    };
    platformFeeRate: number;  // 平台服务费率（例如0.1表示10%）
    userBalance: number;      // 用户余额
  };
}
```

### 5.4 创建订单并支付

**接口:** `POST /api/orders/create`

**触发时机:** 点击"提交订单"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  skillId: string;
  quantity: number;          // 预约数量（线上技能）或时长（线下技能）
  appointmentTime: string;   // 预约时间 ISO8601格式
  contactInfo: string;       // 联系方式
  remark?: string;           // 备注
  // 线下技能特有
  serviceLocation?: {
    address: string;
    latitude: number;
    longitude: number;
  };
  // 支付信息
  paymentMethod: "balance" | "wechat" | "alipay";
  paymentPassword?: string;  // 余额支付时需要
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderStatus: "paid" | "pending_payment";
    // 如果选择第三方支付
    paymentInfo?: {
      paymentUrl: string;    // 支付链接
      qrCode: string;        // 支付二维码
    };
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 跳转到订单详情 |
| 400 | 参数错误 | 显示具体错误 |
| 402 | 余额不足 | "余额不足，请选择其他支付方式" |
| 409 | 时间冲突 | "该时间段已被预约，请选择其他时间" |
| 500 | 服务器错误 | "下单失败，请稍后重试" |

### 5.5 获取订单详情

**接口:** `GET /api/orders/{orderId}`

**触发时机:** 进入订单详情页

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `orderId`: 订单ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;         // 订单编号
    orderStatus: "pending_payment" | "pending_confirm" | "pending_service" |
                 "in_service" | "pending_review" | "completed" |
                 "cancelled" | "refunded";
    skill: {
      skillId: string;
      skillName: string;
      coverImage: string;
      price: number;
      quantity: number;
    };
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
    };
    appointmentInfo: {
      appointmentTime: string;
      serviceHours: number;
      contactInfo: string;
      remark?: string;
      serviceLocation?: string;
    };
    payment: {
      totalAmount: number;
      serviceAmount: number;
      platformFee: number;
      paymentMethod: string;
      paymentTime?: string;
    };
    timestamps: {
      createdAt: string;
      paidAt?: string;
      confirmedAt?: string;
      completedAt?: string;
      cancelledAt?: string;
    };
  };
}
```

---

## 六、数据流

### 技能预约流程
```
用户进入技能详情页
  ↓
GET /api/skills/{skillId}/booking-detail
  ↓
显示技能信息、服务者信息、评价
  ↓
用户点击"立即预约"
  ↓
跳转到订单确认页
```

### 订单创建流程
```
用户进入订单确认页
  ↓
GET /api/orders/confirm-info/{skillId}
  ↓
显示订单确认信息
  ↓
用户填写预约信息
  ↓
用户选择支付方式
  ↓
用户点击"提交订单"
  ↓
前端验证表单
  ├─ 验证失败: 显示错误提示
  └─ 验证成功:
      ↓
      POST /api/orders/create
      ↓
      成功:
        - 余额支付: 直接支付成功，跳转到订单详情
        - 第三方支付: 跳转到支付页面
      失败:
        - 显示错误提示
```

### 第三方支付流程
```
用户选择微信/支付宝支付
  ↓
创建订单，返回支付链接/二维码
  ↓
跳转到第三方支付页面
  ↓
用户完成支付
  ↓
支付回调
  ↓
跳转到订单详情页（已支付状态）
```

### 订单状态流转
```
待支付 (pending_payment)
  ↓ 用户支付
待确认 (pending_confirm)
  ↓ 服务者确认
待服务 (pending_service)
  ↓ 到达预约时间
服务中 (in_service)
  ↓ 服务完成
待评价 (pending_review)
  ↓ 用户评价
已完成 (completed)

任意状态可以:
  → 已取消 (cancelled)
  → 已退款 (refunded)
```

---

## 七、状态管理

```typescript
interface BookingPageState {
  // 技能详情
  skill: {
    data: SkillDetail | null;
    isLoading: boolean;
  };

  // 评价列表
  reviews: {
    data: Review[];
    page: number;
    hasMore: boolean;
    isLoading: boolean;
  };

  error?: string;
}

interface OrderConfirmPageState {
  // 确认信息
  confirmInfo: {
    data: OrderConfirmInfo | null;
    isLoading: boolean;
  };

  // 表单数据
  form: {
    quantity: number;
    appointmentTime: string;
    contactInfo: string;
    remark: string;
    serviceLocation?: Location;
    paymentMethod: "balance" | "wechat" | "alipay";
    paymentPassword: string;
  };

  // 表单验证
  errors: {
    [field: string]: string;
  };

  // UI状态
  isSubmitting: boolean;
  error?: string;
}

interface OrderDetailPageState {
  // 订单详情
  order: {
    data: OrderDetail | null;
    isLoading: boolean;
  };

  error?: string;
}
```

---

## 八、前端验证

### 预约数量验证
```typescript
const validateQuantity = (quantity: number, skillType: string) => {
  if (quantity < 1) {
    return { valid: false, error: '数量至少为1' };
  }

  if (skillType === 'offline' && quantity > 24) {
    return { valid: false, error: '线下技能单次预约不超过24小时' };
  }

  return { valid: true };
}
```

### 预约时间验证
```typescript
const validateAppointmentTime = (time: string) => {
  const appointmentDate = new Date(time);
  const now = new Date();

  // 预约时间必须在未来
  if (appointmentDate <= now) {
    return { valid: false, error: '预约时间必须晚于当前时间' };
  }

  // 预约时间必须在30天内
  const maxDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
  if (appointmentDate > maxDate) {
    return { valid: false, error: '预约时间不能超过30天' };
  }

  return { valid: true };
}
```

### 联系方式验证
```typescript
const validateContactInfo = (contact: string) => {
  // 手机号或微信号
  const phoneRegex = /^1[3-9]\d{9}$/;
  const wechatRegex = /^[a-zA-Z0-9_-]{6,20}$/;

  if (!phoneRegex.test(contact) && !wechatRegex.test(contact)) {
    return { valid: false, error: '请输入有效的手机号或微信号' };
  }

  return { valid: true };
}
```

### 支付密码验证
```typescript
const validatePaymentPassword = (password: string, method: string) => {
  if (method === 'balance') {
    if (!/^\d{6}$/.test(password)) {
      return { valid: false, error: '支付密码必须为6位数字' };
    }
  }

  return { valid: true };
}
```

---

## 九、交互行为

### 9.1 技能详情页交互

**点击立即预约:**
1. 检查登录状态
2. 未登录：跳转到登录页
3. 已登录：跳转到订单确认页

**点击服务者头像/昵称:**
1. 跳转到服务者主页

**点击查看全部评价:**
1. 跳转到评价列表页

### 9.2 订单确认页交互

**预约数量调整:**
- 点击"-"减少数量（最小1）
- 点击"+"增加数量
- 实时计算总价

**选择预约时间:**
- 线上技能：打开日期时间选择器
- 线下技能：先选日期，再选时段

**选择支付方式:**
- 余额支付：显示当前余额
  - 余额不足：禁用该选项
- 微信/支付宝支付：正常可选

**提交订单:**
1. 前端验证所有字段
2. 验证通过：显示加载状态
3. 余额支付：弹出支付密码输入框
4. 第三方支付：跳转到支付页面

### 9.3 订单详情页交互

**取消订单:**
1. 弹出确认对话框
2. 选择取消原因
3. 确认后调用取消接口
4. 成功：更新订单状态

**申请退款:**
1. 弹出退款申请表单
2. 填写退款原因
3. 上传凭证（可选）
4. 提交申请

**联系服务者:**
1. 跳转到聊天页面
2. 自动打开与服务者的对话

**去评价:**
1. 跳转到评价页面
2. 填写评分和评价内容
3. 提交评价

---

## 十、测试要点

### 功能测试
- [ ] 技能详情正确加载
- [ ] 评价列表正确显示
- [ ] 订单确认信息正确
- [ ] 订单创建成功
- [ ] 余额支付成功
- [ ] 第三方支付跳转正常
- [ ] 订单详情正确显示
- [ ] 订单状态更新正确

### 边界测试
- [ ] 预约数量验证
- [ ] 预约时间验证
- [ ] 余额不足处理
- [ ] 时间冲突处理
- [ ] 支付密码验证
- [ ] 网络异常处理

### 用户体验测试
- [ ] 表单填写流畅
- [ ] 价格计算准确
- [ ] 支付流程清晰
- [ ] 订单状态明确
- [ ] 操作按钮合理

---

## 十一、使用的后端服务

- **UserService** (用户服务)
  - `GET /api/skills/{skillId}/booking-detail` - 获取技能预约详情
  - `GET /api/skills/{skillId}/reviews` - 获取评价列表

- **OrderService** (订单服务)
  - `GET /api/orders/confirm-info/{skillId}` - 获取订单确认信息
  - `POST /api/orders/create` - 创建订单并支付
  - `GET /api/orders/{orderId}` - 获取订单详情

- **PaymentService** (支付服务)
  - 调用支付密码验证
  - 处理第三方支付回调

---

## 十二、相关页面

- [01-个人主页页面](./01-个人主页页面.md) - 个人主页
- [03-他人主页页面](./03-他人主页页面.md) - 服务者主页
- [06-技能管理页面](./06-技能管理页面.md) - 技能管理

---

**使用后端服务:** UserService + OrderService + PaymentService (user模块 + trade模块)
**最后更新:** 2025-11-14
