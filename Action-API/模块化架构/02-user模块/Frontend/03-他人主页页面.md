# 03-他人主页页面

## 一、页面概述

- **路由路径**: `/users/{userId}/profile`
- **页面功能**: 查看其他用户的个人主页，包括动态、技能、资料信息
- **用户角色**: 已登录用户（查看他人主页）
- **页面类型**: 用户展示页面

## 二、页面结构

### 2.1 顶部个人信息卡片

```
┌────────────────────────────────────────┐
│  [头像]   昵称              [关注] [•••]│
│          简介文字                       │
│          📍 居住地   📏 175cm   🌐 1.2km│
│                                         │
│  [关注 123]  [粉丝 456]  [获赞 789]   │
└────────────────────────────────────────┘
```

**头像区域:**
- 圆形头像，80x80px
- 点击可查看大图
- 右下角显示在线状态指示器（绿点/灰点）

**基本信息:**
- 昵称：粗体，18pt
- 简介：常规字体，14pt，灰色
- 居住地、身高、距离：图标 + 文字，12pt

**操作按钮:**
- **关注按钮**：
  - 未关注：紫色实心按钮，文字"关注"
  - 已关注：灰色边框按钮，文字"已关注"
  - 互相关注：紫色边框按钮，文字"互相关注"
- **更多按钮**（•••）：
  - 点击弹出操作菜单
  - 选项：举报、拉黑

**数据统计:**
- 三个可点击的统计项
- 关注数：点击查看TA的关注列表
- 粉丝数：点击查看TA的粉丝列表
- 获赞数：显示总获赞数

### 2.2 Tab导航栏

```
┌────────────────────────────────────────┐
│  [动态]  [技能]  [资料]                │
└────────────────────────────────────────┘
```

**Tab样式:**
- 3个Tab：动态、技能、资料
- 选中状态：紫色下划线，加粗
- 未选中：灰色文字
- 切换有滑动动画

**隐私控制:**
- 根据隐私设置显示或隐藏Tab
- 如果用户设置了不可查看动态，则不显示动态Tab
- 如果用户设置了不可查看技能，则不显示技能Tab

### 2.3 Tab 1: 动态列表

**内容卡片:**
```
┌────────────────────────────────────────┐
│  [头像] 昵称                   2小时前  │
│                                         │
│  动态文字内容...                        │
│                                         │
│  [图片1] [图片2] [图片3]               │
│                                         │
│  💬 12   ❤️ 234   ⭐ 56              │
└────────────────────────────────────────┘
```

**付费内容:**
```
┌────────────────────────────────────────┐
│  [头像] 昵称                   2小时前  │
│                                         │
│  动态文字内容...                        │
│                                         │
│  [模糊图片] [模糊图片]                 │
│  [🔒 解锁查看  ¥9.9]                   │
│                                         │
│  💬 12   ❤️ 234   ⭐ 56              │
└────────────────────────────────────────┘
```

**显示内容:**
- 用户发布的所有可见动态
- 按时间倒序排列
- 支持分页加载

**付费内容处理:**
- 未解锁：显示模糊图片和解锁按钮
- 已解锁：显示完整内容
- 点击解锁按钮：跳转到支付页面

**隐私提示:**
```
┌────────────────────────────────────────┐
│           🔒                            │
│      TA设置了动态隐私                   │
│      只有关注TA的人才能查看             │
└────────────────────────────────────────┘
```

**空状态:**
```
TA还没有发布任何动态
```

### 2.4 Tab 2: 技能列表

**技能卡片:**
```
┌────────────────────────────────────────┐
│  [技能封面图]                          │
│                                         │
│  技能名称                               │
│  ⭐⭐⭐⭐⭐ 5.0  (128条评价)           │
│  💰 ¥99/小时  或  ¥99/局              │
│                                         │
│  [立即预约]                             │
└────────────────────────────────────────┘
```

**显示内容:**
- 用户发布的所有上架技能
- 按创建时间或销量排序
- 支持分页加载

**技能类型标识:**
- 线上技能：显示"线上"标签，价格单位"/局"
- 线下技能：显示"线下"标签，价格单位"/小时"

**点击卡片:**
1. 跳转到技能详情页
2. 路由: `/skills/{skillId}`

**隐私提示:**
```
┌────────────────────────────────────────┐
│           🔒                            │
│      TA设置了技能隐私                   │
│      只有关注TA的人才能查看             │
└────────────────────────────────────────┘
```

**空状态:**
```
TA还没有发布任何技能
```

### 2.5 Tab 3: 资料信息

```
┌────────────────────────────────────────┐
│  基本资料                               │
│  ────────────────────────────          │
│  性别        男                         │
│  年龄        28岁                       │
│  居住地      广东省广州市               │
│  身高        175 cm                     │
│  体重        65 kg                      │
│  职业        软件工程师                 │
│                                         │
│  个性签名                               │
│  ────────────────────────────          │
│  这是TA的个性签名...                    │
└────────────────────────────────────────┘
```

**显示规则:**
- 显示用户选择公开的资料字段
- 未公开的字段不显示
- 年龄根据生日自动计算

**隐私提示:**
```
┌────────────────────────────────────────┐
│           🔒                            │
│      TA设置了资料隐私                   │
│      只有关注TA的人才能查看             │
└────────────────────────────────────────┘
```

---

## 三、接口列表

### 3.1 获取用户主页信息

**接口:** `GET /api/users/{userId}/profile`

**触发时机:** 页面加载时

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    bio?: string;
    residence?: string;
    height?: number;
    distance?: number;      // 距离，单位米
    isOnline: boolean;
    stats: {
      followingCount: number;
      fansCount: number;
      likesCount: number;
    };
    followStatus: "none" | "following" | "mutual";  // 关注状态
    privacy: {
      canViewProfile: boolean;   // 是否可查看资料
      canViewMoments: boolean;   // 是否可查看动态
      canViewSkills: boolean;    // 是否可查看技能
    };
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 正常显示 |
| 403 | 被拉黑 | "该用户不存在或已注销" |
| 404 | 用户不存在 | "该用户不存在" |
| 500 | 服务器错误 | "加载失败，请稍后重试" |

### 3.2 关注用户

**接口:** `POST /api/users/{userId}/follow`

**触发时机:** 点击"关注"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "following" | "mutual";
    fansCount: number;  // 对方的粉丝数
  };
}
```

### 3.3 取消关注

**接口:** `DELETE /api/users/{userId}/follow`

**触发时机:** 点击"已关注"或"互相关注"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "none";
    fansCount: number;  // 对方的粉丝数
  };
}
```

### 3.4 获取用户动态列表

**接口:** `GET /api/users/{userId}/moments`

**触发时机:** 点击"动态"Tab

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    moments: Array<{
      momentId: string;
      userId: string;
      nickname: string;
      avatar: string;
      content: string;
      images?: string[];
      video?: {
        url: string;
        coverUrl: string;
        duration: number;
      };
      isPaid: boolean;         // 是否付费内容
      price?: number;          // 付费金额
      isUnlocked?: boolean;    // 是否已解锁
      createdAt: string;
      stats: {
        commentsCount: number;
        likesCount: number;
        favoritesCount: number;
      };
      isLiked: boolean;
      isFavorited: boolean;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 正常显示 |
| 403 | 无权查看 | 显示隐私提示 |
| 500 | 服务器错误 | "加载失败，请稍后重试" |

### 3.5 点赞动态

**接口:** `POST /api/moments/{momentId}/like`

**触发时机:** 点击动态的点赞按钮

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `momentId`: 动态ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    isLiked: boolean;
    likesCount: number;
  };
}
```

### 3.6 取消点赞

**接口:** `DELETE /api/moments/{momentId}/like`

**触发时机:** 再次点击已点赞的动态

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `momentId`: 动态ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    isLiked: boolean;
    likesCount: number;
  };
}
```

### 3.7 解锁付费内容

**接口:** `POST /api/moments/{momentId}/unlock`

**触发时机:** 点击"解锁查看"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `momentId`: 动态ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    images: string[];        // 完整图片URL
    video?: {
      url: string;
      coverUrl: string;
      duration: number;
    };
    isUnlocked: boolean;
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 显示完整内容 |
| 402 | 余额不足 | "余额不足，请先充值" |
| 500 | 服务器错误 | "解锁失败，请稍后重试" |

### 3.8 获取用户技能列表

**接口:** `GET /api/users/{userId}/skills`

**触发时机:** 点击"技能"Tab

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skills: Array<{
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      coverImage: string;
      price: number;
      priceUnit: string;     // "局" or "小时"
      rating: number;        // 评分 0-5
      reviewCount: number;   // 评价数量
      isOnline: boolean;     // 是否上架
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 正常显示 |
| 403 | 无权查看 | 显示隐私提示 |
| 500 | 服务器错误 | "加载失败，请稍后重试" |

### 3.9 获取用户详细资料

**接口:** `GET /api/users/{userId}/profile-detail`

**触发时机:** 点击"资料"Tab

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    age?: number;          // 根据生日计算
    residence?: string;
    height?: number;
    weight?: number;
    occupation?: string;
    bio?: string;
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 正常显示 |
| 403 | 无权查看 | 显示隐私提示 |
| 500 | 服务器错误 | "加载失败，请稍后重试" |

### 3.10 举报用户

**接口:** `POST /api/users/{userId}/report`

**触发时机:** 点击"更多"→"举报"

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**请求参数:**
```typescript
{
  reason: string;         // 举报原因
  description?: string;   // 详细描述
  evidence?: string[];    // 证据图片URL
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.11 拉黑用户

**接口:** `POST /api/users/{userId}/block`

**触发时机:** 点击"更多"→"拉黑"

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `userId`: 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

---

## 四、数据流

### 页面加载流程
```
用户进入他人主页
  ↓
GET /api/users/{userId}/profile
  ↓
检查隐私权限 (privacy)
  ├─ canViewProfile = false: 显示"无权查看"提示
  └─ canViewProfile = true:
      ↓
      显示头部信息
      ↓
      默认选中第一个可见Tab
      ↓
      加载对应Tab内容
```

### 关注/取消关注流程
```
用户点击关注按钮
  ↓
检查当前关注状态
  ├─ none: POST /api/users/{userId}/follow
  └─ following/mutual: DELETE /api/users/{userId}/follow
  ↓
立即更新UI:
  - 按钮文字和样式
  - 粉丝数
  - 关注状态
  ↓
成功: 保持UI状态
失败: 恢复UI状态，显示错误提示
```

### 解锁付费内容流程
```
用户点击"解锁查看"按钮
  ↓
显示确认对话框: "解锁需要支付¥9.9，确认解锁？"
  ├─ 取消: 关闭对话框
  └─ 确认:
      ↓
      POST /api/moments/{momentId}/unlock
      ↓
      显示支付加载状态
      ↓
      成功:
        - 显示完整内容
        - 更新isUnlocked状态
        - 显示Toast "解锁成功"
      失败:
        - 显示错误提示
        - 余额不足: 引导去充值
```

### 举报流程
```
用户点击"举报"
  ↓
显示举报理由选择弹窗
  ↓
用户选择理由并填写描述
  ↓
POST /api/users/{userId}/report
  ↓
成功:
  - 显示Toast "举报成功，我们会尽快处理"
  - 关闭弹窗
失败:
  - 显示错误提示
```

### 拉黑流程
```
用户点击"拉黑"
  ↓
显示确认对话框: "拉黑后将无法查看对方信息，确认拉黑？"
  ├─ 取消: 关闭对话框
  └─ 确认:
      ↓
      POST /api/users/{userId}/block
      ↓
      成功:
        - 显示Toast "已拉黑"
        - 返回上一页或主页
      失败:
        - 显示错误提示
```

---

## 五、状态管理

```typescript
interface OtherUserProfilePageState {
  // 用户ID
  userId: string;

  // 头部信息
  profile: {
    userId: string;
    nickname: string;
    avatar: string;
    bio?: string;
    residence?: string;
    height?: number;
    distance?: number;
    isOnline: boolean;
    stats: {
      followingCount: number;
      fansCount: number;
      likesCount: number;
    };
    followStatus: "none" | "following" | "mutual";
    privacy: {
      canViewProfile: boolean;
      canViewMoments: boolean;
      canViewSkills: boolean;
    };
  } | null;

  // 当前Tab
  currentTab: 'moments' | 'skills' | 'detail';

  // 动态列表
  moments: {
    data: Moment[];
    page: number;
    hasMore: boolean;
    isLoading: boolean;
    total: number;
  };

  // 技能列表
  skills: {
    data: Skill[];
    page: number;
    hasMore: boolean;
    isLoading: boolean;
    total: number;
  };

  // 资料详情
  detail: {
    data: UserDetail | null;
    isLoading: boolean;
  };

  // UI状态
  isFollowing: boolean;  // 是否正在关注/取消关注
  isRefreshing: boolean;
  error?: string;
}

interface Moment {
  momentId: string;
  userId: string;
  nickname: string;
  avatar: string;
  content: string;
  images?: string[];
  video?: VideoInfo;
  isPaid: boolean;
  price?: number;
  isUnlocked?: boolean;
  createdAt: string;
  stats: {
    commentsCount: number;
    likesCount: number;
    favoritesCount: number;
  };
  isLiked: boolean;
  isFavorited: boolean;
}

interface Skill {
  skillId: string;
  skillName: string;
  skillType: "online" | "offline";
  coverImage: string;
  price: number;
  priceUnit: string;
  rating: number;
  reviewCount: number;
  isOnline: boolean;
}

interface UserDetail {
  userId: string;
  nickname: string;
  avatar: string;
  gender?: "male" | "female" | "other";
  age?: number;
  residence?: string;
  height?: number;
  weight?: number;
  occupation?: string;
  bio?: string;
}
```

---

## 六、前端验证

### 举报理由验证
```typescript
const validateReportReason = (reason: string, description?: string) => {
  if (!reason || reason.trim() === '') {
    return { valid: false, error: '请选择举报理由' };
  }

  if (description && description.length > 500) {
    return { valid: false, error: '描述不能超过500字符' };
  }

  return { valid: true };
}
```

---

## 七、交互行为

### 7.1 头部信息区交互

**点击头像:**
1. 显示头像大图
2. 支持左右滑动查看相册
3. 点击空白处关闭

**点击关注按钮:**
1. 根据当前状态执行操作：
   - none → 关注
   - following/mutual → 取消关注
2. 立即更新UI（乐观更新）
3. 调用接口
4. 成功：保持UI状态
5. 失败：恢复UI状态，显示错误

**点击更多按钮（•••）:**
1. 弹出底部操作菜单
2. 显示选项：
   - 举报
   - 拉黑
   - 取消
3. 点击选项执行对应操作

**点击统计数据:**
- 关注数：跳转到TA的关注列表
- 粉丝数：跳转到TA的粉丝列表
- 获赞数：不可点击

### 7.2 Tab切换交互

**点击Tab:**
1. 检查是否有权查看
2. 如果无权查看：显示隐私提示
3. 如果有权查看：
   - 切换Tab选中状态
   - 加载对应内容
   - 首次加载显示加载状态
   - 已加载过则显示缓存数据

### 7.3 动态Tab交互

**点赞/取消点赞:**
- 同个人主页的点赞操作

**点击付费内容的"解锁查看"按钮:**
1. 显示确认对话框
2. 显示解锁价格
3. 用户确认后调用解锁接口
4. 成功：显示完整内容
5. 失败：显示错误提示

**点击动态卡片:**
1. 跳转到动态详情页
2. 路由: `/moments/{momentId}`

### 7.4 技能Tab交互

**点击技能卡片:**
1. 跳转到技能详情页
2. 路由: `/skills/{skillId}`
3. 传递skillId和userId

**点击"立即预约"按钮:**
1. 跳转到技能预约页面
2. 路由: `/skills/{skillId}/booking`

### 7.5 举报交互

**点击"举报":**
1. 显示举报弹窗
2. 显示举报理由选项：
   - 色情低俗
   - 骚扰谩骂
   - 欺诈骗钱
   - 虚假信息
   - 其他
3. 如果选择"其他"，显示文本输入框
4. 可选：上传证据图片
5. 点击"提交"调用举报接口
6. 成功：显示Toast，关闭弹窗
7. 失败：显示错误提示

### 7.6 拉黑交互

**点击"拉黑":**
1. 显示确认对话框
2. 文字："拉黑后将无法查看对方信息，对方也无法查看您的信息，确认拉黑？"
3. 按钮："取消" / "确认拉黑"
4. 点击"确认拉黑"：
   - 调用拉黑接口
   - 成功：显示Toast "已拉黑"，返回上一页
   - 失败：显示错误提示

### 7.7 隐私控制

**无权查看整个主页:**
1. 显示占位图和文字
2. 文字："该用户设置了隐私，您无法查看TA的主页"
3. 只显示基本信息（头像、昵称、关注按钮）

**无权查看某个Tab:**
1. 该Tab显示为灰色或不显示
2. 点击时显示隐私提示
3. 提示引导关注后可查看

---

## 八、测试要点

### 功能测试
- [ ] 用户信息正确显示
- [ ] 关注/取消关注成功
- [ ] Tab切换正常
- [ ] 动态列表正确加载
- [ ] 技能列表正确加载
- [ ] 资料详情正确加载
- [ ] 点赞操作成功
- [ ] 付费内容解锁成功
- [ ] 举报功能正常
- [ ] 拉黑功能正常

### 边界测试
- [ ] 被拉黑用户处理
- [ ] 不存在用户处理
- [ ] 隐私权限正确控制
- [ ] 付费内容余额不足处理
- [ ] 网络异常处理
- [ ] Token过期处理
- [ ] 空列表显示正确

### 性能测试
- [ ] 列表滚动流畅
- [ ] Tab切换无卡顿
- [ ] 图片懒加载正常
- [ ] 缓存策略有效

### 用户体验测试
- [ ] 加载状态友好
- [ ] 错误提示清晰
- [ ] 隐私提示明确
- [ ] 关注操作反馈及时
- [ ] 解锁确认清晰
- [ ] 举报流程顺畅

---

## 九、使用的后端服务

- **UserService** (用户服务)
  - `GET /api/users/{userId}/profile` - 获取用户主页信息
  - `POST /api/users/{userId}/follow` - 关注用户
  - `DELETE /api/users/{userId}/follow` - 取消关注
  - `GET /api/users/{userId}/moments` - 获取用户动态列表
  - `GET /api/users/{userId}/skills` - 获取用户技能列表
  - `GET /api/users/{userId}/profile-detail` - 获取用户详细资料
  - `POST /api/users/{userId}/report` - 举报用户
  - `POST /api/users/{userId}/block` - 拉黑用户

- **ContentService** (内容服务)
  - `POST /api/moments/{momentId}/like` - 点赞动态
  - `DELETE /api/moments/{momentId}/like` - 取消点赞
  - `POST /api/moments/{momentId}/unlock` - 解锁付费内容

---

## 十、相关页面

- [01-个人主页页面](./01-个人主页页面.md) - 自己的主页
- [04-粉丝列表页面](./04-粉丝列表页面.md) - TA的粉丝
- [05-关注列表页面](./05-关注列表页面.md) - TA的关注

---

## 十一、隐私权限说明

### 隐私级别

**公开:**
- 所有人都可以查看

**仅关注我的人:**
- 只有关注了TA的用户可以查看
- 未关注显示隐私提示并引导关注

**私密:**
- 只有TA自己可以查看
- 其他人完全无法查看

### 可设置隐私的内容

1. **整个主页**: canViewProfile
2. **动态列表**: canViewMoments
3. **技能列表**: canViewSkills

### 前端处理

```typescript
// 检查是否可以查看
if (!profile.privacy.canViewProfile) {
  // 显示无权查看提示
  return <PrivacyPlaceholder text="该用户设置了隐私，您无法查看TA的主页" />;
}

// 检查是否可以查看动态
if (!profile.privacy.canViewMoments) {
  // 不显示动态Tab 或 显示隐私提示
  return <PrivacyHint text="TA设置了动态隐私，只有关注TA的人才能查看" />;
}
```

### 距离显示

- 根据双方位置计算距离
- 显示格式：
  - < 1km: "500m"
  - >= 1km: "1.2km"
  - > 100km: "100+km"
- 如果用户未开启定位：不显示距离

---

**使用后端服务:** UserService + ContentService (user模块 + content模块)
**最后更新:** 2025-11-14
