# 04-粉丝列表页面

## 一、页面概述

- **路由路径**: `/user/fans` 或 `/users/{userId}/fans`
- **页面功能**: 查看粉丝列表，支持搜索和关注操作
- **用户角色**: 已登录用户
- **页面类型**: 列表页面

## 二、页面结构

### 2.1 顶部导航栏

```
[←]  粉丝列表                        [🔍]
```
- 返回按钮：左侧箭头图标
- 标题："粉丝列表"（居中，18pt）
- 搜索按钮：右侧放大镜图标
- 高度：44px
- 底部分割线：1px 浅灰色

### 2.2 搜索栏（点击搜索按钮后展开）

```
┌────────────────────────────────────────┐
│  [🔍 搜索粉丝昵称___________________ ⊗] │
└────────────────────────────────────────┘
```

**搜索输入框:**
- 占位符："搜索粉丝昵称"
- 输入类型：`text`
- 实时搜索：输入后延迟500ms自动搜索
- 清空按钮：有内容时显示

### 2.3 粉丝列表

**列表项:**
```
┌────────────────────────────────────────┐
│  [头像] 昵称                    [关注]  │
│        简介文字...                      │
│        📍 广东省广州市  📏 175cm        │
└────────────────────────────────────────┘
```

**头像:**
- 圆形头像，48x48px
- 点击跳转到用户主页
- 右下角显示在线状态指示器

**用户信息:**
- 昵称：粗体，16pt
- 简介：常规字体，12pt，灰色
- 居住地、身高：图标 + 文字，12pt，灰色

**关注按钮:**
- **未关注**：紫色实心按钮，文字"关注"，宽度80px
- **已关注**：灰色边框按钮，文字"已关注"，宽度80px
- **互相关注**：紫色边框按钮，文字"互相关注"，宽度80px
- 高度：32px，圆角：16px

**分割线:**
- 每个列表项之间有1px浅灰色分割线

### 2.4 空状态

**无粉丝时:**
```
┌────────────────────────────────────────┐
│           📭                            │
│       还没有粉丝哦                      │
│    发布精彩内容，吸引更多关注！         │
└────────────────────────────────────────┘
```

**搜索无结果时:**
```
┌────────────────────────────────────────┐
│           🔍                            │
│       没有找到相关用户                  │
│      试试其他关键词吧                   │
└────────────────────────────────────────┘
```

### 2.5 加载更多

**上拉加载:**
- 滑动到底部自动加载下一页
- 显示"加载中..."
- 全部加载完显示"没有更多了"

---

## 三、接口列表

### 3.1 获取粉丝列表

**接口:** `GET /api/users/fans`

**触发时机:** 页面加载时、上拉加载更多

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  page: number;      // 页码，从1开始
  pageSize: number;  // 每页数量，默认20
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    fans: Array<{
      userId: string;
      nickname: string;
      avatar: string;
      bio?: string;
      residence?: string;
      height?: number;
      isOnline: boolean;
      followStatus: "none" | "following" | "mutual";
      followedAt: string;  // 关注我的时间
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

### 3.2 搜索粉丝

**接口:** `GET /api/users/fans/search`

**触发时机:** 搜索框输入内容后（防抖500ms）

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  keyword: string;   // 搜索关键词
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    fans: Array<{
      userId: string;
      nickname: string;
      avatar: string;
      bio?: string;
      residence?: string;
      height?: number;
      isOnline: boolean;
      followStatus: "none" | "following" | "mutual";
      followedAt: string;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

### 3.3 关注用户

**接口:** `POST /api/users/follow`

**触发时机:** 点击"关注"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  targetUserId: string;  // 要关注的用户ID
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "following" | "mutual";
  };
}
```

### 3.4 取消关注

**接口:** `DELETE /api/users/follow/{targetUserId}`

**触发时机:** 点击"已关注"或"互相关注"按钮

**请求头:**
```
Authorization: Bearer <token>
```

**路径参数:**
- `targetUserId`: 要取消关注的用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "none";
  };
}
```

---

## 四、数据流

### 页面加载流程
```
用户进入粉丝列表页面
  ↓
GET /api/users/fans (page=1)
  ↓
显示粉丝列表
  ├─ 有数据: 显示列表
  └─ 无数据: 显示空状态
```

### 搜索流程
```
用户点击搜索按钮
  ↓
展开搜索框，聚焦
  ↓
用户输入关键词
  ↓
防抖500ms
  ↓
GET /api/users/fans/search (keyword, page=1)
  ↓
显示搜索结果
  ├─ 有结果: 显示列表
  └─ 无结果: 显示"没有找到相关用户"
```

### 关注/取消关注流程
```
用户点击关注按钮
  ↓
检查当前关注状态
  ├─ none: POST /api/users/follow
  └─ following/mutual: DELETE /api/users/follow/{targetUserId}
  ↓
立即更新UI（乐观更新）
  ↓
成功: 保持UI状态
失败: 恢复UI状态，显示错误提示
```

### 分页加载流程
```
用户滑动到列表底部
  ↓
检查是否还有更多数据 (hasMore)
  ↓
如果有:
  - 调用接口加载下一页 (page = currentPage + 1)
  - 追加数据到列表末尾
如果没有:
  - 显示"没有更多了"
```

---

## 五、状态管理

```typescript
interface FansListPageState {
  // 列表数据
  fans: {
    data: FanUser[];
    page: number;
    total: number;
    hasMore: boolean;
    isLoading: boolean;
  };

  // 搜索状态
  search: {
    keyword: string;
    isSearching: boolean;
    isSearchMode: boolean;  // 是否处于搜索模式
    results: FanUser[];
    page: number;
    hasMore: boolean;
    isLoading: boolean;
  };

  // UI状态
  isRefreshing: boolean;
  error?: string;
}

interface FanUser {
  userId: string;
  nickname: string;
  avatar: string;
  bio?: string;
  residence?: string;
  height?: number;
  isOnline: boolean;
  followStatus: "none" | "following" | "mutual";
  followedAt: string;
  isFollowing?: boolean;  // 正在关注/取消关注
}
```

---

## 六、前端验证

### 搜索关键词验证
```typescript
const validateSearchKeyword = (keyword: string) => {
  // 去除首尾空格
  const trimmed = keyword.trim();

  // 最小长度检查
  if (trimmed.length === 0) {
    return { valid: false, error: '请输入搜索关键词' };
  }

  // 最大长度检查
  if (trimmed.length > 50) {
    return { valid: false, error: '搜索关键词不能超过50字符' };
  }

  return { valid: true, keyword: trimmed };
}
```

---

## 七、交互行为

### 7.1 页面加载

**进入页面:**
1. 显示加载状态
2. 调用粉丝列表接口
3. 成功：显示列表
4. 失败：显示错误提示和重试按钮

### 7.2 搜索交互

**点击搜索按钮:**
1. 展开搜索框
2. 自动聚焦到搜索输入框
3. 进入搜索模式

**输入搜索关键词:**
1. 实时显示输入内容
2. 防抖500ms后自动搜索
3. 显示搜索加载状态
4. 显示搜索结果

**清空搜索:**
1. 点击清空按钮（⊗）
2. 清空搜索框
3. 显示完整粉丝列表
4. 退出搜索模式

**返回操作（搜索模式）:**
1. 点击返回按钮
2. 如果在搜索模式：
   - 清空搜索
   - 退出搜索模式
   - 显示完整列表
3. 如果不在搜索模式：
   - 返回上一页

### 7.3 列表交互

**点击列表项（头像或昵称）:**
1. 跳转到用户主页
2. 路由: `/users/{userId}/profile`
3. 传递userId

**点击关注按钮:**
1. 根据当前状态执行操作
2. 立即更新按钮状态（乐观更新）
3. 调用接口
4. 成功：保持UI状态
5. 失败：恢复UI状态，显示Toast错误提示

**下拉刷新:**
1. 下拉列表顶部
2. 显示刷新图标和文字
3. 释放触发刷新
4. 重新加载第1页数据
5. 清除旧数据
6. 显示刷新成功提示

**上拉加载更多:**
1. 滑动到列表底部（距底部100px触发）
2. 检查hasMore状态
3. 如果hasMore = true:
   - 显示"加载中..."
   - 调用接口加载下一页
   - 追加数据到列表
4. 如果hasMore = false:
   - 显示"没有更多了"

### 7.4 关注状态管理

**关注状态变化:**
```
none (未关注) → following (已关注)
  - 点击"关注"按钮
  - 按钮变为"已关注"

following (已关注) → mutual (互相关注)
  - 对方也关注了我
  - 按钮变为"互相关注"
  - 按钮样式变为紫色边框

following/mutual → none
  - 点击"已关注"或"互相关注"按钮
  - 弹出确认对话框："确定取消关注吗？"
  - 确认后取消关注
  - 按钮变为"关注"
```

### 7.5 错误处理

**网络错误:**
1. 显示错误提示："网络异常，请稍后重试"
2. 显示重试按钮
3. 点击重试重新加载

**Token过期:**
1. 提示："登录已过期，请重新登录"
2. 跳转到登录页

---

## 八、测试要点

### 功能测试
- [ ] 粉丝列表正确加载
- [ ] 搜索功能正常
- [ ] 关注操作成功
- [ ] 取消关注成功
- [ ] 分页加载正常
- [ ] 下拉刷新正常
- [ ] 点击用户跳转正确

### 边界测试
- [ ] 空列表显示正确
- [ ] 搜索无结果显示正确
- [ ] 防抖机制有效
- [ ] 快速点击关注按钮
- [ ] 网络异常处理
- [ ] Token过期处理
- [ ] 分页到最后一页

### 性能测试
- [ ] 列表滚动流畅
- [ ] 搜索响应及时
- [ ] 图片懒加载正常
- [ ] 内存占用合理

### 用户体验测试
- [ ] 加载状态友好
- [ ] 错误提示清晰
- [ ] 搜索体验流畅
- [ ] 关注操作反馈及时
- [ ] 空状态引导明确

---

## 九、使用的后端服务

- **UserService** (用户服务)
  - `GET /api/users/fans` - 获取粉丝列表
  - `GET /api/users/fans/search` - 搜索粉丝
  - `POST /api/users/follow` - 关注用户
  - `DELETE /api/users/follow/{targetUserId}` - 取消关注

---

## 十、相关页面

- [01-个人主页页面](./01-个人主页页面.md) - 个人主页
- [03-他人主页页面](./03-他人主页页面.md) - 查看他人主页
- [05-关注列表页面](./05-关注列表页面.md) - 关注列表

---

## 十一、优化建议

### 性能优化

**列表虚拟滚动:**
- 当粉丝数量超过1000时，使用虚拟滚动
- 只渲染可见区域的列表项
- 提高滚动性能

**图片懒加载:**
- 头像图片使用懒加载
- 只加载可见区域的图片
- 滚动到时才加载

**防抖优化:**
- 搜索输入防抖500ms
- 避免频繁请求

### 用户体验优化

**乐观更新:**
- 关注/取消关注立即更新UI
- 不等待接口返回
- 失败时回滚

**骨架屏:**
- 首次加载显示骨架屏
- 提升加载体验

**下拉刷新:**
- 支持下拉刷新
- 更新最新数据

**搜索历史:**
- 记录搜索历史（可选）
- 快速搜索常用关键词

---

**使用后端服务:** UserService (user模块)
**最后更新:** 2025-11-14
