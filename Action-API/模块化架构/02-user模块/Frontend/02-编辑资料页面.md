# 02-编辑资料页面

## 一、页面概述

- **路由路径**: `/user/profile/edit`
- **页面功能**: 编辑个人资料，支持11个字段的实时保存
- **用户角色**: 已登录用户
- **页面类型**: 表单编辑页面

## 二、页面结构

### 2.1 顶部导航栏

```
[←]  编辑资料
```
- 返回按钮：左侧箭头图标
- 标题："编辑资料"（居中，18pt）
- 高度：44px
- 底部分割线：1px 浅灰色

### 2.2 主要内容区

#### 头像编辑区
```
┌────────────────────────────────────────┐
│             [头像]                      │
│          点击更换头像                   │
└────────────────────────────────────────┘
```

**头像显示:**
- 圆形头像，100x100px
- 居中显示
- 点击触发图片选择

**更换提示:**
- 字体大小：14pt
- 颜色：灰色(#999)
- 位置：头像下方8px

#### 资料表单区

```
┌────────────────────────────────────────┐
│  昵称                                   │
│  [当前昵称____________________ ✓]       │
│                                         │
│  性别                                   │
│  [○ 男  ○ 女  ○ 其他]                  │
│                                         │
│  生日                                   │
│  [1995-06-15_________________ 📅]       │
│                                         │
│  居住地                                 │
│  [广东省广州市_______________ 📍]       │
│                                         │
│  身高 (cm)                              │
│  [175_______________________ ✓]        │
│                                         │
│  体重 (kg)                              │
│  [65________________________ ✓]        │
│                                         │
│  职业                                   │
│  [软件工程师_________________ ✓]        │
│                                         │
│  微信号                                 │
│  [wechat123_________________ ✓]        │
│                                         │
│  个性签名                               │
│  [这是我的个性签名...                   │
│   ___________________________           │
│   ___________________________]          │
│  0/200                                  │
└────────────────────────────────────────┘
```

### 2.3 字段详细说明

#### 1. 昵称
- 输入框类型：`text`
- 占位符："请输入昵称"
- 长度限制：2-20字符
- 实时保存：失去焦点后自动保存
- 验证提示：右侧显示绿色✓或红色✗

#### 2. 性别
- 组件类型：单选按钮组
- 选项：男 / 女 / 其他
- 实时保存：选择后立即保存
- 显示方式：水平排列

#### 3. 生日
- 输入框类型：日期选择器
- 格式：YYYY-MM-DD
- 选择范围：1900-01-01 至今
- 实时保存：选择后立即保存
- 右侧图标：日历图标

#### 4. 居住地
- 输入框类型：地区选择器
- 选择方式：省/市/区三级联动
- 实时保存：选择后立即保存
- 右侧图标：定位图标

#### 5. 身高
- 输入框类型：`number`
- 占位符："请输入身高"
- 单位：cm
- 范围：100-250
- 实时保存：失去焦点后自动保存

#### 6. 体重
- 输入框类型：`number`
- 占位符："请输入体重"
- 单位：kg
- 范围：30-200
- 实时保存：失去焦点后自动保存

#### 7. 职业
- 输入框类型：`text`
- 占位符："请输入职业"
- 长度限制：1-30字符
- 实时保存：失去焦点后自动保存

#### 8. 微信号
- 输入框类型：`text`
- 占位符："请输入微信号"
- 长度限制：6-20字符
- 格式：字母、数字、下划线、减号
- 实时保存：失去焦点后自动保存

#### 9. 个性签名
- 输入框类型：`textarea`
- 占位符："写点什么介绍一下自己吧~"
- 长度限制：0-200字符
- 实时保存：失去焦点后自动保存
- 字数统计：右下角显示当前字数/200

---

## 三、接口列表

### 3.1 加载编辑页面数据

**接口:** `GET /api/user/profile/edit`

**触发时机:** 页面加载时

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    birthday?: string;        // YYYY-MM-DD
    residence?: string;       // "广东省广州市天河区"
    height?: number;          // 单位cm
    weight?: number;          // 单位kg
    occupation?: string;
    wechat?: string;
    bio?: string;
  };
}
```

### 3.2 上传头像

**接口:** `POST /api/user/avatar/upload`

**触发时机:** 用户选择图片后

**请求头:**
```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**请求参数:**
```typescript
{
  avatar: File;  // 图片文件
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    avatarUrl: string;  // 新头像URL
  };
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | "头像更新成功" |
| 400 | 文件格式错误 | "仅支持JPG、PNG格式" |
| 400 | 文件过大 | "图片大小不能超过5MB" |
| 401 | 未登录 | "请先登录" |
| 500 | 上传失败 | "上传失败，请稍后重试" |

### 3.3 更新昵称

**接口:** `PUT /api/user/profile/nickname`

**触发时机:** 昵称输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  nickname: string;  // 2-20字符
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 显示绿色✓ |
| 400 | 长度不符 | "昵称长度为2-20字符" |
| 400 | 包含敏感词 | "昵称包含敏感词" |
| 500 | 更新失败 | 显示红色✗ |

### 3.4 更新性别

**接口:** `PUT /api/user/profile/gender`

**触发时机:** 选择性别后

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  gender: "male" | "female" | "other";
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.5 更新生日

**接口:** `PUT /api/user/profile/birthday`

**触发时机:** 选择生日后

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  birthday: string;  // YYYY-MM-DD格式
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.6 更新居住地

**接口:** `PUT /api/user/profile/residence`

**触发时机:** 选择居住地后

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  residence: string;  // "广东省广州市天河区"
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.7 更新身高

**接口:** `PUT /api/user/profile/height`

**触发时机:** 身高输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  height: number;  // 单位cm，范围100-250
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.8 更新体重

**接口:** `PUT /api/user/profile/weight`

**触发时机:** 体重输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  weight: number;  // 单位kg，范围30-200
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.9 更新职业

**接口:** `PUT /api/user/profile/occupation`

**触发时机:** 职业输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  occupation: string;  // 1-30字符
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

### 3.10 更新微信号

**接口:** `PUT /api/user/profile/wechat`

**触发时机:** 微信号输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  wechat: string;  // 6-20字符，字母、数字、下划线、减号
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 显示绿色✓ |
| 400 | 格式错误 | "微信号格式不正确" |
| 500 | 更新失败 | 显示红色✗ |

### 3.11 更新个性签名

**接口:** `PUT /api/user/profile/bio`

**触发时机:** 个性签名输入框失去焦点

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  bio: string;  // 0-200字符
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null;
}
```

---

## 四、数据流

### 页面加载流程
```
用户进入编辑资料页面
  ↓
GET /api/user/profile/edit
  ↓
填充表单字段
  ↓
用户可以编辑任意字段
```

### 实时保存流程（文本字段）
```
用户输入内容
  ↓
输入框失去焦点
  ↓
前端验证格式
  ├─ 验证失败: 显示红色✗和错误提示
  └─ 验证成功:
      ↓
      调用对应字段的PUT接口
      ↓
      显示加载状态
      ↓
      成功: 显示绿色✓
      失败: 显示红色✗和错误提示
```

### 实时保存流程（选择字段）
```
用户选择选项（性别/生日/居住地）
  ↓
立即调用对应字段的PUT接口
  ↓
显示加载状态
  ↓
成功: 显示Toast "保存成功"
失败: 显示错误提示
```

### 头像上传流程
```
用户点击头像区域
  ↓
打开图片选择器
  ↓
用户选择图片
  ↓
前端验证:
  - 文件格式（JPG/PNG）
  - 文件大小（< 5MB）
  ↓
压缩图片（如果过大）
  ↓
POST /api/user/avatar/upload
  ↓
显示上传进度
  ↓
成功:
  - 更新头像显示
  - 显示Toast "头像更新成功"
  - 更新全局头像（如果有）
失败:
  - 显示错误提示
  - 恢复原头像
```

---

## 五、状态管理

```typescript
interface EditProfilePageState {
  // 表单数据
  formData: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    birthday?: string;
    residence?: string;
    height?: number;
    weight?: number;
    occupation?: string;
    wechat?: string;
    bio?: string;
  };

  // 字段保存状态
  fieldStatus: {
    nickname: 'idle' | 'saving' | 'success' | 'error';
    gender: 'idle' | 'saving' | 'success' | 'error';
    birthday: 'idle' | 'saving' | 'success' | 'error';
    residence: 'idle' | 'saving' | 'success' | 'error';
    height: 'idle' | 'saving' | 'success' | 'error';
    weight: 'idle' | 'saving' | 'success' | 'error';
    occupation: 'idle' | 'saving' | 'success' | 'error';
    wechat: 'idle' | 'saving' | 'success' | 'error';
    bio: 'idle' | 'saving' | 'success' | 'error';
  };

  // 字段错误信息
  fieldErrors: {
    nickname?: string;
    height?: string;
    weight?: string;
    occupation?: string;
    wechat?: string;
    bio?: string;
  };

  // 头像上传状态
  avatarUpload: {
    isUploading: boolean;
    progress: number;  // 0-100
    error?: string;
  };

  // 页面加载状态
  isLoading: boolean;
  error?: string;
}
```

---

## 六、前端验证

### 昵称验证
```typescript
const validateNickname = (nickname: string) => {
  if (nickname.length < 2 || nickname.length > 20) {
    return { valid: false, error: '昵称长度为2-20字符' };
  }

  // 检查特殊字符
  if (/[<>\"'&]/.test(nickname)) {
    return { valid: false, error: '昵称不能包含特殊字符' };
  }

  return { valid: true };
}
```

### 身高验证
```typescript
const validateHeight = (height: number) => {
  if (height < 100 || height > 250) {
    return { valid: false, error: '身高范围为100-250cm' };
  }

  return { valid: true };
}
```

### 体重验证
```typescript
const validateWeight = (weight: number) => {
  if (weight < 30 || weight > 200) {
    return { valid: false, error: '体重范围为30-200kg' };
  }

  return { valid: true };
}
```

### 微信号验证
```typescript
const validateWechat = (wechat: string) => {
  if (wechat.length < 6 || wechat.length > 20) {
    return { valid: false, error: '微信号长度为6-20字符' };
  }

  // 只允许字母、数字、下划线、减号
  if (!/^[a-zA-Z0-9_-]+$/.test(wechat)) {
    return { valid: false, error: '微信号只能包含字母、数字、下划线和减号' };
  }

  return { valid: true };
}
```

### 个性签名验证
```typescript
const validateBio = (bio: string) => {
  if (bio.length > 200) {
    return { valid: false, error: '个性签名不能超过200字符' };
  }

  return { valid: true };
}
```

### 头像验证
```typescript
const validateAvatar = (file: File) => {
  // 检查文件类型
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    return { valid: false, error: '仅支持JPG、PNG格式' };
  }

  // 检查文件大小（5MB）
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    return { valid: false, error: '图片大小不能超过5MB' };
  }

  return { valid: true };
}
```

---

## 七、交互行为

### 7.1 返回操作

**点击返回按钮:**
1. 检查是否有未保存的字段（保存状态为saving）
2. 如果有：
   - 弹出提示："正在保存，请稍候"
   - 等待保存完成后返回
3. 如果没有：
   - 直接返回上一页

### 7.2 头像编辑

**点击头像区域:**
1. 打开图片选择器
2. 支持相机拍摄或相册选择
3. 选择图片后：
   - 前端验证格式和大小
   - 验证通过：开始上传
   - 验证失败：显示错误提示

**上传进度:**
1. 显示上传进度条
2. 显示百分比（0-100%）
3. 上传期间禁用头像区域

**上传成功:**
1. 隐藏进度条
2. 更新头像显示
3. 显示Toast："头像更新成功"
4. 更新全局头像

**上传失败:**
1. 隐藏进度条
2. 显示错误提示
3. 恢复原头像
4. 允许重新上传

### 7.3 文本字段编辑

**聚焦输入框:**
1. 边框变为紫色
2. 隐藏状态图标（✓或✗）

**输入内容:**
1. 实时统计字数（个性签名）
2. 超过最大长度时阻止输入

**失去焦点:**
1. 检查内容是否改变
2. 如果未改变：不调用接口
3. 如果改变：
   - 前端验证
   - 验证通过：调用保存接口
   - 验证失败：显示错误提示

**保存中:**
1. 显示加载图标
2. 禁用输入框

**保存成功:**
1. 显示绿色✓（0.5秒后自动隐藏）
2. 启用输入框

**保存失败:**
1. 显示红色✗
2. 显示错误提示（输入框下方）
3. 启用输入框
4. 允许重新编辑

### 7.4 选择字段编辑

**性别选择:**
1. 点击选项立即切换
2. 显示保存加载状态
3. 保存成功：显示Toast
4. 保存失败：恢复原选项，显示错误

**生日选择:**
1. 点击打开日期选择器
2. 选择日期后：
   - 更新显示
   - 自动保存
3. 保存成功：显示Toast
4. 保存失败：恢复原日期，显示错误

**居住地选择:**
1. 点击打开地区选择器
2. 三级联动：省→市→区
3. 选择完成后：
   - 更新显示
   - 自动保存
4. 保存成功：显示Toast
5. 保存失败：恢复原地址，显示错误

### 7.5 防抖优化

**文本输入框:**
- 失去焦点后延迟300ms保存
- 避免快速切换导致多次请求

**选择器:**
- 选择后立即保存
- 不需要防抖

---

## 八、测试要点

### 功能测试
- [ ] 页面数据正确加载
- [ ] 头像上传成功
- [ ] 昵称实时保存
- [ ] 性别实时保存
- [ ] 生日实时保存
- [ ] 居住地实时保存
- [ ] 身高实时保存
- [ ] 体重实时保存
- [ ] 职业实时保存
- [ ] 微信号实时保存
- [ ] 个性签名实时保存

### 边界测试
- [ ] 昵称长度验证
- [ ] 身高范围验证
- [ ] 体重范围验证
- [ ] 微信号格式验证
- [ ] 个性签名字数限制
- [ ] 头像格式验证
- [ ] 头像大小验证
- [ ] 网络异常处理
- [ ] Token过期处理
- [ ] 快速切换字段

### 性能测试
- [ ] 防抖机制有效
- [ ] 图片压缩正常
- [ ] 上传进度准确
- [ ] 页面流畅无卡顿

### 用户体验测试
- [ ] 保存状态反馈及时
- [ ] 错误提示清晰
- [ ] 成功提示友好
- [ ] 返回操作安全
- [ ] 输入体验流畅

---

## 九、使用的后端服务

- **UserService** (用户服务)
  - `GET /api/user/profile/edit` - 加载编辑页面数据
  - `POST /api/user/avatar/upload` - 上传头像
  - `PUT /api/user/profile/nickname` - 更新昵称
  - `PUT /api/user/profile/gender` - 更新性别
  - `PUT /api/user/profile/birthday` - 更新生日
  - `PUT /api/user/profile/residence` - 更新居住地
  - `PUT /api/user/profile/height` - 更新身高
  - `PUT /api/user/profile/weight` - 更新体重
  - `PUT /api/user/profile/occupation` - 更新职业
  - `PUT /api/user/profile/wechat` - 更新微信号
  - `PUT /api/user/profile/bio` - 更新个性签名

---

## 十、相关页面

- [01-个人主页页面](./01-个人主页页面.md) - 个人主页
- [06-技能管理页面](./06-技能管理页面.md) - 管理技能

---

## 十一、实时保存说明

### 为什么使用实时保存？

1. **更好的用户体验**: 无需等待"保存"按钮，编辑完即保存
2. **避免数据丢失**: 每个字段独立保存，不会因为某一字段错误导致全部丢失
3. **即时反馈**: 用户立即知道保存状态（成功✓或失败✗）

### 实时保存策略

**文本输入字段（昵称、职业、微信号、个性签名、身高、体重）:**
- 触发时机：失去焦点
- 防抖延迟：300ms
- 状态反馈：✓或✗图标

**选择字段（性别、生日、居住地）:**
- 触发时机：选择完成
- 无防抖延迟
- 状态反馈：Toast提示

**头像:**
- 触发时机：选择图片后
- 显示进度：进度条 + 百分比
- 状态反馈：Toast提示

### 注意事项

1. **网络异常处理**: 保存失败时允许重新编辑和保存
2. **并发控制**: 同一字段的多次保存请求应取消前一次
3. **返回确认**: 有正在保存的字段时提示用户等待
4. **Token过期**: 自动跳转到登录页

---

**使用后端服务:** UserService (user模块)
**最后更新:** 2025-11-14
