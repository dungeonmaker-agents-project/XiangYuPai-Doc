# UserService - 用户服务接口文档

## 一、服务概述

### 1.1 服务职责

**UserService** 是平台的核心用户服务，负责：
- 用户资料管理（个人主页、编辑资料、查看他人）
- 社交关系管理（关注/粉丝、搜索、拉黑）
- 技能管理（创建、编辑、删除线上/线下技能）
- 技能展示和预约（技能详情、评价）
- 用户隐私控制
- 用户统计数据

### 1.2 技术栈

- **框架**: Spring Boot 3.x + Spring Cloud
- **缓存**: Redis 7.0+ (用户信息、关注关系、技能列表缓存)
- **数据库**: MySQL 8.0+ (用户资料、关注关系、技能数据)
- **文件存储**: OSS (头像、技能图片)

### 1.3 服务信息

- **服务名**: xypai-user
- **端口**: 8002
- **数据库**: user_db
- **API路径前缀**: `/api/user/*`, `/api/users/*`, `/api/skills/*`
- **RPC支持**: 可被远程调用

---

## 二、接口列表

### 2.1 对外API (共计50+个)

#### 个人主页相关 (5个)
1. `GET /api/user/profile/header` - 获取个人主页头部信息
2. `GET /api/user/profile/posts` - 获取动态列表
3. `GET /api/user/profile/favorites` - 获取收藏列表
4. `GET /api/user/profile/likes` - 获取点赞列表
5. `GET /api/user/profile/info` - 获取个人资料信息

#### 资料编辑相关 (12个)
6. `GET /api/user/profile/edit` - 加载编辑页面数据
7. `POST /api/user/avatar/upload` - 上传头像
8. `PUT /api/user/profile/nickname` - 更新昵称
9. `PUT /api/user/profile/gender` - 更新性别
10. `PUT /api/user/profile/birthday` - 更新生日
11. `PUT /api/user/profile/residence` - 更新居住地
12. `PUT /api/user/profile/height` - 更新身高
13. `PUT /api/user/profile/weight` - 更新体重
14. `PUT /api/user/profile/occupation` - 更新职业
15. `PUT /api/user/profile/wechat` - 更新微信号
16. `PUT /api/user/profile/bio` - 更新个性签名
17. `PUT /api/user/profile/batch` - 批量更新（可选）

#### 他人主页相关 (8个)
18. `GET /api/users/{userId}/profile` - 获取用户主页信息
19. `POST /api/users/{userId}/follow` - 关注用户
20. `DELETE /api/users/{userId}/follow` - 取消关注
21. `GET /api/users/{userId}/moments` - 获取用户动态列表
22. `GET /api/users/{userId}/skills` - 获取用户技能列表
23. `GET /api/users/{userId}/profile-detail` - 获取用户详细资料
24. `POST /api/users/{userId}/report` - 举报用户
25. `POST /api/users/{userId}/block` - 拉黑用户

#### 关注粉丝相关 (7个)
26. `GET /api/users/fans` - 获取粉丝列表
27. `GET /api/users/following` - 获取关注列表
28. `GET /api/users/fans/search` - 搜索粉丝
29. `GET /api/users/following/search` - 搜索关注列表
30. `POST /api/users/follow` - 关注用户
31. `DELETE /api/users/follow/{targetUserId}` - 取消关注
32. `GET /api/users/{userId}/follow-stats` - 获取关注统计

#### 技能管理相关 (12个)
33. `GET /api/user/skills` - 获取技能列表
34. `GET /api/skills/config` - 获取技能配置
35. `POST /api/user/skills/online` - 创建线上技能
36. `POST /api/user/skills/offline` - 创建线下技能
37. `POST /api/skills/images/upload` - 上传技能图片
38. `GET /api/user/skills/{skillId}` - 获取技能详情
39. `PUT /api/user/skills/online/{skillId}` - 更新线上技能
40. `PUT /api/user/skills/offline/{skillId}` - 更新线下技能
41. `DELETE /api/user/skills/{skillId}` - 删除技能
42. `PUT /api/user/skills/{skillId}/status` - 切换上下架状态
43. `GET /api/skills/available` - 获取可用技能列表
44. `GET /api/skills/{skillId}/booking-detail` - 获取技能预约详情
45. `GET /api/skills/{skillId}/reviews` - 获取技能评价列表

### 2.2 内部RPC接口 (3个)

1. `createUser()` - 创建新用户（供AuthService调用）
2. `getUserByPhone()` - 通过手机号查询用户（供AuthService调用）
3. `getUserInfo()` - 获取用户信息（供所有服务调用）

---

## 三、接口详细定义

### 3.1 个人主页相关接口

#### 3.1.1 获取个人主页头部信息

**接口:** `GET /api/user/profile/header`

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    bio?: string;
    residence?: string;
    isOnline: boolean;
    stats: {
      followingCount: number;
      fansCount: number;
      likesCount: number;
    };
  };
}
```

#### 3.1.2 获取动态列表

**接口:** `GET /api/user/profile/posts`

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    posts: Array<{
      postId: string;
      userId: string;
      nickname: string;
      avatar: string;
      content: string;
      images?: string[];
      video?: {
        url: string;
        coverUrl: string;
        duration: number;
      };
      createdAt: string;
      stats: {
        commentsCount: number;
        likesCount: number;
        favoritesCount: number;
      };
      isLiked: boolean;
      isFavorited: boolean;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

#### 3.1.3 获取收藏列表

**接口:** `GET /api/user/profile/favorites`

**请求参数:** 同上

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    favorites: Array<{
      favoriteId: string;
      post: Post;  // 同动态列表的Post结构
      favoritedAt: string;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

#### 3.1.4 获取点赞列表

**接口:** `GET /api/user/profile/likes`

**请求参数:** 同上

**响应数据:** 同收藏列表结构

#### 3.1.5 获取个人资料信息

**接口:** `GET /api/user/profile/info`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    birthday?: string;
    residence?: string;
    height?: number;
    weight?: number;
    occupation?: string;
    wechat?: string;
    bio?: string;
    skills?: Array<{
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      price: number;
      priceUnit: string;
      coverImage: string;
      isOnline: boolean;
    }>;
  };
}
```

---

### 3.2 资料编辑相关接口

#### 3.2.1 加载编辑页面数据

**接口:** `GET /api/user/profile/edit`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    birthday?: string;
    residence?: string;
    height?: number;
    weight?: number;
    occupation?: string;
    wechat?: string;
    bio?: string;
  };
}
```

#### 3.2.2 上传头像

**接口:** `POST /api/user/avatar/upload`

**请求头:**
```
Content-Type: multipart/form-data
```

**请求参数:**
```typescript
{
  avatar: File;  // 图片文件，最大5MB，支持JPG/PNG
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    avatarUrl: string;
  };
}
```

**错误码:**
- 400: 文件格式错误或文件过大
- 500: 上传失败

#### 3.2.3 更新昵称

**接口:** `PUT /api/user/profile/nickname`

**请求参数:**
```typescript
{
  nickname: string;  // 2-20字符
}
```

**响应:** 标准成功/失败响应

**错误码:**
- 400: 长度不符或包含敏感词

#### 3.2.4 更新性别

**接口:** `PUT /api/user/profile/gender`

**请求参数:**
```typescript
{
  gender: "male" | "female" | "other";
}
```

#### 3.2.5 更新生日

**接口:** `PUT /api/user/profile/birthday`

**请求参数:**
```typescript
{
  birthday: string;  // YYYY-MM-DD格式
}
```

#### 3.2.6 更新居住地

**接口:** `PUT /api/user/profile/residence`

**请求参数:**
```typescript
{
  residence: string;  // "广东省广州市天河区"
}
```

#### 3.2.7 更新身高

**接口:** `PUT /api/user/profile/height`

**请求参数:**
```typescript
{
  height: number;  // 100-250，单位cm
}
```

#### 3.2.8 更新体重

**接口:** `PUT /api/user/profile/weight`

**请求参数:**
```typescript
{
  weight: number;  // 30-200，单位kg
}
```

#### 3.2.9 更新职业

**接口:** `PUT /api/user/profile/occupation`

**请求参数:**
```typescript
{
  occupation: string;  // 1-30字符
}
```

#### 3.2.10 更新微信号

**接口:** `PUT /api/user/profile/wechat`

**请求参数:**
```typescript
{
  wechat: string;  // 6-20字符，字母/数字/下划线/减号
}
```

#### 3.2.11 更新个性签名

**接口:** `PUT /api/user/profile/bio`

**请求参数:**
```typescript
{
  bio: string;  // 0-200字符
}
```

---

### 3.3 他人主页相关接口

#### 3.3.1 获取用户主页信息

**接口:** `GET /api/users/{userId}/profile`

**路径参数:** `userId` - 用户ID

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    bio?: string;
    residence?: string;
    height?: number;
    distance?: number;    // 距离（米）
    isOnline: boolean;
    stats: {
      followingCount: number;
      fansCount: number;
      likesCount: number;
    };
    followStatus: "none" | "following" | "mutual";
    privacy: {
      canViewProfile: boolean;
      canViewMoments: boolean;
      canViewSkills: boolean;
    };
  };
}
```

**错误码:**
- 403: 被拉黑
- 404: 用户不存在

#### 3.3.2 关注用户

**接口:** `POST /api/users/{userId}/follow`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "following" | "mutual";
    fansCount: number;
  };
}
```

#### 3.3.3 取消关注

**接口:** `DELETE /api/users/{userId}/follow`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "none";
    fansCount: number;
  };
}
```

#### 3.3.4 获取用户动态列表

**接口:** `GET /api/users/{userId}/moments`

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    moments: Array<{
      momentId: string;
      userId: string;
      nickname: string;
      avatar: string;
      content: string;
      images?: string[];
      video?: VideoInfo;
      isPaid: boolean;
      price?: number;
      isUnlocked?: boolean;
      createdAt: string;
      stats: {
        commentsCount: number;
        likesCount: number;
        favoritesCount: number;
      };
      isLiked: boolean;
      isFavorited: boolean;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

**错误码:**
- 403: 无权查看（隐私设置）

#### 3.3.5 获取用户技能列表

**接口:** `GET /api/users/{userId}/skills`

**请求参数:** 同上

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skills: Array<{
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      coverImage: string;
      price: number;
      priceUnit: string;
      rating: number;
      reviewCount: number;
      isOnline: boolean;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

#### 3.3.6 获取用户详细资料

**接口:** `GET /api/users/{userId}/profile-detail`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    nickname: string;
    avatar: string;
    gender?: "male" | "female" | "other";
    age?: number;
    residence?: string;
    height?: number;
    weight?: number;
    occupation?: string;
    bio?: string;
  };
}
```

#### 3.3.7 举报用户

**接口:** `POST /api/users/{userId}/report`

**请求参数:**
```typescript
{
  reason: string;         // 举报原因
  description?: string;   // 详细描述
  evidence?: string[];    // 证据图片URL
}
```

#### 3.3.8 拉黑用户

**接口:** `POST /api/users/{userId}/block`

**响应:** 标准成功/失败响应

---

### 3.4 关注粉丝相关接口

#### 3.4.1 获取粉丝列表

**接口:** `GET /api/users/fans`

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    fans: Array<{
      userId: string;
      nickname: string;
      avatar: string;
      bio?: string;
      residence?: string;
      height?: number;
      isOnline: boolean;
      followStatus: "none" | "following" | "mutual";
      followedAt: string;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

#### 3.4.2 获取关注列表

**接口:** `GET /api/users/following`

**请求参数:** 同上

**响应数据:** 同粉丝列表结构

#### 3.4.3 搜索粉丝

**接口:** `GET /api/users/fans/search`

**请求参数:**
```typescript
{
  keyword: string;
  page: number;
  pageSize: number;
}
```

**响应数据:** 同粉丝列表结构

#### 3.4.4 搜索关注列表

**接口:** `GET /api/users/following/search`

**请求参数:** 同上

**响应数据:** 同关注列表结构

#### 3.4.5 关注用户

**接口:** `POST /api/users/follow`

**请求参数:**
```typescript
{
  targetUserId: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "following" | "mutual";
  };
}
```

#### 3.4.6 取消关注

**接口:** `DELETE /api/users/follow/{targetUserId}`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followStatus: "none";
  };
}
```

#### 3.4.7 获取关注统计

**接口:** `GET /api/users/{userId}/follow-stats`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    followingCount: number;
    fansCount: number;
    mutualCount: number;  // 互相关注数
  };
}
```

---

### 3.5 技能管理相关接口

#### 3.5.1 获取技能列表

**接口:** `GET /api/user/skills`

**请求参数:**
```typescript
{
  skillType?: "online" | "offline";
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skills: Array<{
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      coverImage: string;
      price: number;
      priceUnit: string;
      rating: number;
      reviewCount: number;
      isOnline: boolean;
      createdAt: string;
      gameName?: string;      // 线上技能
      gameRank?: string;      // 线上技能
      serviceType?: string;   // 线下技能
      location?: string;      // 线下技能
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

#### 3.5.2 获取技能配置

**接口:** `GET /api/skills/config`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    games: Array<{
      gameId: string;
      gameName: string;
      ranks: string[];
    }>;
    serviceTypes: Array<{
      typeId: string;
      typeName: string;
      icon: string;
    }>;
  };
}
```

#### 3.5.3 创建线上技能

**接口:** `POST /api/user/skills/online`

**请求参数:**
```typescript
{
  coverImage: string;
  gameName: string;
  gameRank: string;
  skillName: string;
  description: string;
  price: number;
  serviceHours: number;
  images: string[];
  promises: string[];
  isOnline: boolean;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skillId: string;
  };
}
```

#### 3.5.4 创建线下技能

**接口:** `POST /api/user/skills/offline`

**请求参数:**
```typescript
{
  coverImage: string;
  serviceType: string;
  skillName: string;
  description: string;
  price: number;
  location: {
    address: string;
    latitude: number;
    longitude: number;
  };
  availableTimes: Array<{
    dayOfWeek: number;
    startTime: string;
    endTime: string;
    enabled: boolean;
  }>;
  images: string[];
  promises: string[];
  isOnline: boolean;
}
```

**响应数据:** 同创建线上技能

#### 3.5.5 上传技能图片

**接口:** `POST /api/skills/images/upload`

**请求头:**
```
Content-Type: multipart/form-data
```

**请求参数:**
```typescript
{
  image: File;  // 最大5MB，支持JPG/PNG
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    imageUrl: string;
  };
}
```

#### 3.5.6 获取技能详情

**接口:** `GET /api/user/skills/{skillId}`

**响应数据:** 根据skillType返回完整技能信息

#### 3.5.7 更新线上技能

**接口:** `PUT /api/user/skills/online/{skillId}`

**请求参数:** 同创建线上技能

#### 3.5.8 更新线下技能

**接口:** `PUT /api/user/skills/offline/{skillId}`

**请求参数:** 同创建线下技能

#### 3.5.9 删除技能

**接口:** `DELETE /api/user/skills/{skillId}`

**响应:** 标准成功/失败响应

#### 3.5.10 切换上下架状态

**接口:** `PUT /api/user/skills/{skillId}/status`

**请求参数:**
```typescript
{
  isOnline: boolean;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    isOnline: boolean;
  };
}
```

#### 3.5.11 获取可用技能列表

**接口:** `GET /api/skills/available`

**请求参数:**
```typescript
{
  skillType?: "online" | "offline";
  page: number;
  pageSize: number;
}
```

**响应数据:** 同获取技能列表，仅返回isOnline=true的技能

#### 3.5.12 获取技能预约详情

**接口:** `GET /api/skills/{skillId}/booking-detail`

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    skill: {
      skillId: string;
      skillName: string;
      skillType: "online" | "offline";
      coverImage: string;
      images: string[];
      description: string;
      price: number;
      priceUnit: string;
      rating: number;
      reviewCount: number;
      serviceHours?: number;     // 线上技能
      location?: string;         // 线下技能
      availableTimes?: Array<{   // 线下技能
        dayOfWeek: number;
        startTime: string;
        endTime: string;
      }>;
    };
    provider: {
      userId: string;
      nickname: string;
      avatar: string;
      orderAcceptRate: number;
      avgResponseTime: number;
    };
    promises: string[];
  };
}
```

#### 3.5.13 获取技能评价列表

**接口:** `GET /api/skills/{skillId}/reviews`

**请求参数:**
```typescript
{
  page: number;
  pageSize: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    reviews: Array<{
      reviewId: string;
      user: {
        userId: string;
        nickname: string;
        avatar: string;
      };
      rating: number;
      content: string;
      images?: string[];
      createdAt: string;
    }>;
    total: number;
    hasMore: boolean;
  };
}
```

---

## 四、RPC接口（内部调用）

### 4.1 创建新用户

**方法:** `createUser(CreateUserRequest request)`

**调用方:** AuthService（验证码登录自动注册时）

**请求参数:**
```java
public class CreateUserRequest {
    private String phone;          // 手机号
    private String countryCode;    // 国家区号
    private String nickname;       // 初始昵称（可用手机号生成）
}
```

**返回数据:**
```java
public class CreateUserResponse {
    private Long userId;           // 新创建的用户ID
    private String nickname;       // 昵称
}
```

### 4.2 通过手机号查询用户

**方法:** `getUserByPhone(String phone, String countryCode)`

**调用方:** AuthService（登录验证时）

**返回数据:**
```java
public class UserInfo {
    private Long userId;
    private String phone;
    private String nickname;
    private String avatar;
    // ... 其他基本信息
}
```

### 4.3 获取用户信息

**方法:** `getUserInfo(Long userId)`

**调用方:** 所有需要用户信息的服务

**返回数据:** 同上

---

## 五、数据模型

### 5.1 用户表 (users)

```sql
CREATE TABLE users (
  user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号',
  country_code VARCHAR(10) NOT NULL DEFAULT '+86' COMMENT '国家区号',
  nickname VARCHAR(50) NOT NULL COMMENT '昵称',
  avatar VARCHAR(512) COMMENT '头像URL',
  gender VARCHAR(10) COMMENT 'male/female/other',
  birthday DATE COMMENT '生日',
  residence VARCHAR(100) COMMENT '居住地',
  height INT COMMENT '身高（cm）',
  weight INT COMMENT '体重（kg）',
  occupation VARCHAR(30) COMMENT '职业',
  wechat VARCHAR(20) COMMENT '微信号',
  bio VARCHAR(200) COMMENT '个性签名',
  is_online BOOLEAN DEFAULT FALSE COMMENT '是否在线',
  status VARCHAR(20) DEFAULT 'active' COMMENT 'active/banned/deleted',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_phone (phone, country_code),
  INDEX idx_nickname (nickname)
) ENGINE=InnoDB COMMENT='用户表';
```

### 5.2 用户关注关系表 (user_relations)

```sql
CREATE TABLE user_relations (
  relation_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '关注者ID',
  target_user_id BIGINT NOT NULL COMMENT '被关注者ID',
  status BOOLEAN DEFAULT TRUE COMMENT '关系状态',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_target (user_id, target_user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_target_user_id (target_user_id)
) ENGINE=InnoDB COMMENT='用户关注关系表';
```

### 5.3 用户统计表 (user_stats)

```sql
CREATE TABLE user_stats (
  stats_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID',
  following_count INT DEFAULT 0 COMMENT '关注数',
  fans_count INT DEFAULT 0 COMMENT '粉丝数',
  posts_count INT DEFAULT 0 COMMENT '动态数',
  likes_count INT DEFAULT 0 COMMENT '获赞数',
  skills_count INT DEFAULT 0 COMMENT '技能数',
  orders_count INT DEFAULT 0 COMMENT '接单数',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB COMMENT='用户统计表';
```

### 5.4 技能表 (skills)

```sql
CREATE TABLE skills (
  skill_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  skill_type VARCHAR(20) NOT NULL COMMENT 'online/offline',
  skill_name VARCHAR(50) NOT NULL COMMENT '技能名称',
  description VARCHAR(500) COMMENT '技能介绍',
  cover_image VARCHAR(512) COMMENT '封面图',
  price DECIMAL(10,2) NOT NULL COMMENT '价格',
  price_unit VARCHAR(10) NOT NULL COMMENT '价格单位：局/小时',
  rating DECIMAL(3,2) DEFAULT 0 COMMENT '评分',
  review_count INT DEFAULT 0 COMMENT '评价数',
  order_count INT DEFAULT 0 COMMENT '接单数',
  is_online BOOLEAN DEFAULT FALSE COMMENT '是否上架',

  -- 线上技能特有字段
  game_name VARCHAR(50) COMMENT '游戏名称',
  game_rank VARCHAR(30) COMMENT '游戏段位',
  service_hours DECIMAL(4,2) COMMENT '服务时长（小时/局）',

  -- 线下技能特有字段
  service_type VARCHAR(50) COMMENT '服务类型',
  location_address VARCHAR(200) COMMENT '服务地点',
  location_latitude DECIMAL(10,6) COMMENT '纬度',
  location_longitude DECIMAL(10,6) COMMENT '经度',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_skill_type (skill_type),
  INDEX idx_is_online (is_online)
) ENGINE=InnoDB COMMENT='技能表';
```

### 5.5 技能图片表 (skill_images)

```sql
CREATE TABLE skill_images (
  image_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  skill_id BIGINT NOT NULL COMMENT '技能ID',
  image_url VARCHAR(512) NOT NULL COMMENT '图片URL',
  sort_order INT DEFAULT 0 COMMENT '排序',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_skill_id (skill_id)
) ENGINE=InnoDB COMMENT='技能图片表';
```

### 5.6 技能承诺表 (skill_promises)

```sql
CREATE TABLE skill_promises (
  promise_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  skill_id BIGINT NOT NULL COMMENT '技能ID',
  promise_content VARCHAR(100) NOT NULL COMMENT '承诺内容',
  sort_order INT DEFAULT 0 COMMENT '排序',
  INDEX idx_skill_id (skill_id)
) ENGINE=InnoDB COMMENT='技能承诺表';
```

### 5.7 技能可用时间表 (skill_available_times)

```sql
CREATE TABLE skill_available_times (
  time_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  skill_id BIGINT NOT NULL COMMENT '技能ID（仅线下技能）',
  day_of_week INT NOT NULL COMMENT '星期几（0-6）',
  start_time TIME NOT NULL COMMENT '开始时间',
  end_time TIME NOT NULL COMMENT '结束时间',
  enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  INDEX idx_skill_id (skill_id)
) ENGINE=InnoDB COMMENT='技能可用时间表';
```

### 5.8 用户黑名单表 (user_blacklist)

```sql
CREATE TABLE user_blacklist (
  blacklist_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '拉黑者ID',
  blocked_user_id BIGINT NOT NULL COMMENT '被拉黑者ID',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_blocked (user_id, blocked_user_id),
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB COMMENT='用户黑名单表';
```

### 5.9 用户举报表 (user_reports)

```sql
CREATE TABLE user_reports (
  report_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  reporter_id BIGINT NOT NULL COMMENT '举报者ID',
  reported_user_id BIGINT NOT NULL COMMENT '被举报者ID',
  reason VARCHAR(100) NOT NULL COMMENT '举报原因',
  description VARCHAR(500) COMMENT '详细描述',
  evidence JSON COMMENT '证据图片URL数组',
  status VARCHAR(20) DEFAULT 'pending' COMMENT 'pending/processing/resolved',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_reporter_id (reporter_id),
  INDEX idx_reported_user_id (reported_user_id),
  INDEX idx_status (status)
) ENGINE=InnoDB COMMENT='用户举报表';
```

---

## 六、缓存策略

### 6.1 用户信息缓存

```
Key: user:info:{userId}
Value: 用户信息JSON
TTL: 10分钟
更新策略: 用户信息变更时清除
```

### 6.2 关注关系缓存

```
Key: user:follow:{userId}:{targetUserId}
Value: 关注状态（none/following/mutual）
TTL: 10分钟
更新策略: 关注/取消关注时清除
```

### 6.3 用户统计缓存

```
Key: user:stats:{userId}
Value: 统计信息JSON
TTL: 5分钟
更新策略: 统计变更时清除
```

### 6.4 技能列表缓存

```
Key: skills:user:{userId}:{skillType}
Value: 技能列表JSON
TTL: 10分钟
更新策略: 技能创建/编辑/删除时清除
```

---

## 七、依赖服务

### 7.1 调用的服务

- **AuthService**: 用户登录认证、Token验证
- **ContentService**: 获取用户动态、点赞收藏数据
- **OrderService**: 获取订单统计、评价数据

### 7.2 被调用的服务

- **AuthService**: 调用createUser、getUserByPhone RPC接口
- **所有服务**: 调用getUserInfo RPC接口获取用户信息

---

## 八、性能要求

### 8.1 QPS要求

- 获取用户信息: 1000 QPS
- 资料编辑: 100 QPS
- 关注/取消关注: 200 QPS
- 技能管理: 200 QPS

### 8.2 响应时间

- 获取用户信息: P95 < 100ms
- 资料编辑: P95 < 200ms
- 关注操作: P95 < 150ms
- 技能创建/编辑: P95 < 300ms

---

## 九、监控告警

### 9.1 关键指标

- 用户信息查询成功率: > 99.9%
- 缓存命中率: > 85%
- 关注操作成功率: > 99%
- 平均响应时间: < 150ms

### 9.2 告警规则

1. 用户查询失败率 > 0.1% → P1告警
2. 关注操作失败率 > 1% → P2告警
3. 缓存命中率 < 80% → P3告警
4. 响应时间 > 300ms → P2告警
5. 技能创建失败率 > 2% → P2告警

---

## 十、安全措施

### 10.1 数据安全

- 手机号加密存储
- 敏感信息（生日、居住地）脱敏显示
- 用户资料修改日志记录

### 10.2 业务安全

- 昵称敏感词过滤
- 举报记录保留和审核
- 拉黑关系双向隔离
- 技能审核机制

### 10.3 接口安全

- Token认证
- 频率限制（关注操作：10次/分钟）
- 参数验证
- SQL注入防护

---

## 十一、注意事项

### 11.1 开发注意事项

1. 关注关系使用唯一索引防止重复关注
2. 用户统计使用乐观锁保证并发安全
3. 技能图片最多9张，需要验证
4. 资料编辑每个字段独立更新，需要事务控制
5. 拉黑关系建立后双向隔离（不能查看主页、动态等）

### 11.2 性能优化

1. 用户信息高频访问，缓存命中率要求高
2. 技能列表支持分页和类型筛选
3. 关注关系支持批量查询
4. 统计更新采用异步队列

---

**服务端口**: 8002
**数据库**: user_db
**最后更新**: 2025-11-14
