# 16-订单详情页面

## 一、页面概述

### 页面信息
- **路由路径**: `/order/detail`
- **页面名称**: 订单详情
- **用户角色**: 登录用户
- **页面类型**: 详情页面

### 页面功能
订单详情页面展示订单的完整信息和当前状态。用户可以:
1. 查看订单状态
2. 查看服务提供者信息
3. 查看订单详细信息
4. 取消订单(待接单状态)
5. 联系服务者(已接单状态)
6. 评价服务(已完成状态)

### 进入方式
- 从支付成功页面点击"完成"按钮
- 从订单列表点击订单
- 从消息通知点击跳转

---

## 二、页面UI结构

### 2.1 顶部导航栏
```
[返回] | 订单详情 |
```

### 2.2 订单状态区
```
┌──────────────────────────┐
│   等待服务者接单          │
│   10分钟后未接单自动取消  │
└──────────────────────────┘
```

**状态说明:**
- pending: "等待服务者接单"
- accepted: "服务者已接单"
- in_progress: "服务进行中"
- completed: "服务已完成"
- cancelled: "订单已取消"
- refunded: "已退款"

### 2.3 服务提供者信息区
```
[头像]  昵称
        [在线状态]
```

### 2.4 订单信息区
```
服务名称      王者荣耀
数量          1局
单价          10金币/局
总价          10金币
订单编号      25060610042501
下单时间      2025-06-06 10:04:25
```

### 2.5 操作按钮区(根据状态变化)
```
待接单:   [取消订单]
已接单:   [联系服务者]
已完成:   [评价服务]
```

---

## 三、接口列表

### 3.1 页面加载时调用

#### 1. 查询订单状态
**接口:** `GET /api/order/status`

**调用时机:**
- 页面打开时
- 定时轮询(待接单状态)

**请求参数:**
```typescript
{
  orderId: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    status: 'pending' | 'accepted' | 'in_progress' | 'completed' | 'cancelled' | 'refunded';
    statusLabel: string;
    provider: {
      userId: number;
      nickname: string;
      avatar: string;
      isOnline: boolean;
    };
    service: {
      name: string;
      quantity: number;
      unitPrice: number;
    };
    amount: number;
    createdAt: string;
    acceptedAt?: string;
    completedAt?: string;
    cancelledAt?: string;
    autoCancel: {
      enabled: boolean;
      cancelAt?: string;
      remainingSeconds?: number;
    };
    actions: Array<{
      action: 'cancel' | 'contact' | 'rate' | 'refund';
      label: string;
      enabled: boolean;
    }>;
  }
}
```

---

### 3.2 用户操作触发

#### 2. 取消订单
**接口:** `POST /api/order/cancel`

**调用时机:**
- 点击"取消订单"按钮

**请求参数:**
```typescript
{
  orderId: string;
  reason?: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    status: 'cancelled';
    refundAmount: number;
    refundTime: string;
    balance: number;
  }
}
```

---

## 四、数据流

### 4.1 页面打开流程
```
1. 从支付成功页或订单列表进入
2. 调用GET /api/order/status
3. 显示Loading动画
4. 收到响应 → 渲染订单详情
5. 如果status='pending' → 启动定时轮询
```

### 4.2 状态轮询流程(待接单状态)
```
1. 每隔3-5秒调用GET /api/order/status
2. 检查status是否变化
3. 如果status变为'accepted' → 停止轮询
4. 如果status变为'cancelled' → 停止轮询
5. 更新倒计时显示
```

### 4.3 取消订单流程
```
1. 用户点击"取消订单"
2. 显示确认对话框
3. 用户确认
4. 调用POST /api/order/cancel
5. 取消成功:
   - 更新订单状态
   - 显示退款信息
   - 停止状态轮询
```

---

## 五、状态管理

### 5.1 页面级状态
```typescript
{
  orderId: string;
  orderData: Order | null;
  loading: boolean;
  polling: boolean;
  pollingTimer: number | null;
  error: string | null;
}
```

---

## 六、路由参数

### 6.1 进入参数
```typescript
{
  orderId: string;  // 订单ID(必填)
}
```

### 6.2 跳转目标

#### 点击联系服务者
```typescript
this.$router.push({
  path: '/chat',
  query: { userId: provider.userId }
});
```

#### 点击评价服务
```typescript
this.$router.push({
  path: '/order/review',
  query: { orderId: this.orderId }
});
```

---

## 七、错误处理

### 7.1 订单不存在
```
显示: "订单不存在"
操作: 返回订单列表
```

### 7.2 只能取消待接单订单
```
提示: "订单已被接单,无法取消"
操作: 隐藏"取消订单"按钮
```

### 7.3 取消失败
```
显示: "取消失败,请重试"
操作: 保持在当前页面
```

---

## 八、测试要点

### 8.1 页面加载测试
- [ ] 订单详情正常显示
- [ ] 不同状态显示正确
- [ ] 操作按钮根据状态变化

### 8.2 状态轮询测试
- [ ] 待接单状态启动轮询
- [ ] 接单后停止轮询
- [ ] 倒计时显示正确

### 8.3 取消功能测试
- [ ] 取消订单功能正常
- [ ] 退款信息正确显示

---

## 九、使用的后端服务

### OrderService
- `GET /api/order/status` - 查询订单状态
- `POST /api/order/cancel` - 取消订单

---

## 十、前端实现要点

### 组件结构
```
OrderDetail/
├── index.vue                  // 页面主组件
├── components/
│   ├── OrderStatus.vue        // 订单状态
│   ├── ProviderInfo.vue       // 服务者信息
│   ├── OrderInfo.vue          // 订单信息
│   └── ActionButtons.vue      // 操作按钮
└── hooks/
    ├── useOrderStatus.ts      // 订单状态管理
    └── usePolling.ts          // 轮询逻辑
```

### 关键逻辑
1. **状态轮询**: 待接单状态每3-5秒轮询一次
2. **倒计时**: 显示自动取消倒计时
3. **状态展示**: 根据不同状态显示不同UI
4. **操作按钮**: 根据状态和权限显示对应按钮

---

**文档版本**: v1.0
**最后更新**: 2025-01-XX
**维护者**: 前端团队
