# 14-支付页面

## 一、页面概述

### 页面信息
- **路由路径**: 无(弹窗形式)
- **页面名称**: 支付弹窗
- **用户角色**: 登录用户
- **页面类型**: 弹窗组件

### 页面功能
支付弹窗允许用户确认支付信息并完成支付。用户可以:
1. 查看支付金额
2. 选择支付方式
3. 查看账户余额
4. 输入支付密码(如需要)
5. 完成支付

### 进入方式
- 从确认订单页面提交订单后自动弹出
- 从发布组局页面发布后弹出(如需支付)
- 从报名活动后弹出(如需支付)

---

## 二、页面UI结构

### 2.1 支付弹窗
```
+----------------------------------+
|  确认支付                    [×] |
|                                  |
|  支付金额            10金币      |
|                                  |
|  💰 金币                     ✓  |
|     剩余: 100                    |
|                                  |
|  我同意支付以下所示的总金额      |
|  (含服务费)                      |
|                                  |
|  [立即支付]                      |
+----------------------------------+
```

**UI组件:**
- 标题: "确认支付"
- 关闭按钮: 右上角×
- 支付金额: 大号显示
- 支付方式: 金币(显示余额)
- 同意条款: 复选框或默认同意
- 支付按钮: 紫色渐变全宽按钮

### 2.2 支付密码输入弹窗
```
+----------------------------------+
|  请输入支付密码              [×] |
|                                  |
|  付款10金币                      |
|                                  |
|  [○] [○] [○] [○] [○] [○]       |
|                                  |
|  [1] [2] [3]                     |
|  [4] [5] [6]                     |
|  [7] [8] [9]                     |
|      [0] [⌫]                     |
+----------------------------------+
```

**UI组件:**
- 标题: "请输入支付密码"
- 提示文字: "付款XX金币"
- 密码框: 6个圆点/方框
- 数字键盘: 3x4网格

---

## 三、接口列表

### 3.1 用户操作触发

#### 1. 执行支付
**接口:** `POST /api/payment/pay`

**调用时机:**
- 点击"立即支付"按钮

**请求参数:**
```typescript
{
  orderId: string;
  orderNo: string;
  paymentMethod: 'balance' | 'alipay' | 'wechat';
  amount: number;
  paymentPassword?: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    paymentStatus: 'success' | 'pending' | 'require_password' | 'failed';
    requirePassword?: boolean;
    balance?: number;
    failureReason?: string;
  }
}
```

---

#### 2. 验证支付密码
**接口:** `POST /api/payment/verify`

**调用时机:**
- 输入6位密码后自动提交

**请求参数:**
```typescript
{
  orderId: string;
  orderNo: string;
  paymentPassword: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    paymentStatus: 'success' | 'failed';
    balance?: number;
    failureReason?: string;
  }
}
```

---

## 四、数据流

### 4.1 支付弹窗显示流程
```
1. 订单创建成功
2. 显示支付弹窗
3. 显示支付金额和余额
4. 判断余额是否充足
```

### 4.2 支付流程
```
1. 用户点击"立即支付"
2. 调用POST /api/payment/pay
3. 显示Loading动画
4. 如果paymentStatus='require_password':
   - 关闭支付弹窗
   - 显示密码输入弹窗
5. 如果paymentStatus='success':
   - 关闭支付弹窗
   - 跳转支付成功页
6. 如果paymentStatus='failed':
   - 显示错误提示
   - 根据原因处理(余额不足/其他)
```

### 4.3 密码输入流程
```
1. 用户输入密码
2. 密码框显示圆点
3. 输入6位后自动提交
4. 调用POST /api/payment/verify
5. 验证成功 → 跳转支付成功页
6. 验证失败 → 清空密码,显示错误提示
```

---

## 五、状态管理

### 5.1 组件状态
```typescript
{
  orderId: string;
  orderNo: string;
  amount: number;
  userBalance: number;
  paymentPassword: string;
  showPasswordInput: boolean;
  paying: boolean;
  error: string | null;
}
```

---

## 六、错误处理

### 6.1 余额不足
```
显示: "余额不足,请先充值"
操作: 提供充值入口
```

### 6.2 支付密码错误
```
显示: "密码错误,请重新输入"
操作: 清空密码输入,允许重试
```

### 6.3 支付密码锁定
```
显示: "密码错误次数过多,请稍后再试"
操作: 禁用支付功能30分钟
```

### 6.4 订单已失效
```
显示: "订单已失效,请重新下单"
操作: 返回服务详情页
```

---

## 七、使用的后端服务

### PaymentService
- `POST /api/payment/pay` - 执行支付
- `POST /api/payment/verify` - 验证支付密码

---

## 八、前端实现要点

### 组件结构
```
PaymentModal/
├── PaymentConfirm.vue         // 支付确认弹窗
└── PasswordInput.vue          // 密码输入弹窗
```

### 关键逻辑
1. **余额判断**: 显示余额,判断是否充足
2. **密码输入**: 6位数字,自动提交
3. **错误处理**: 区分不同错误类型
4. **状态管理**: 支付状态实时更新

---

**文档版本**: v1.0
**最后更新**: 2025-01-XX
**维护者**: 前端团队
