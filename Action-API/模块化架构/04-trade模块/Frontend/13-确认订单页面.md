# 13-确认订单页面

## 一、页面概述

### 页面信息
- **路由路径**: `/order/preview`
- **页面名称**: 确认订单
- **用户角色**: 登录用户
- **页面类型**: 表单页面

### 页面功能
确认订单页面允许用户确认订单信息并提交。用户可以:
1. 查看服务提供者信息
2. 查看服务详情
3. 调整购买数量
4. 查看总价
5. 提交订单并支付

### 进入方式
- 从服务详情页点击"下单"按钮

---

## 二、页面UI结构

### 2.1 顶部导航栏
```
[返回] | 确认订单 |
```

### 2.2 服务提供者信息卡片
```
[服务图片]  昵称 ♂ 19
            [实名认证] [大神]
            微信区 荣耀王者 巅峰1800+
```

### 2.3 订单信息区
```
购买         王者荣耀
价格         10金币/局
场次         [○-] 1 [○+]
```

### 2.4 总价显示
```
共计:        10 金币
```

### 2.5 底部支付按钮
```
[立即支付]
```

---

## 三、接口列表

### 3.1 页面加载时调用

#### 1. 订单预览
**接口:** `GET /api/order/preview`

**请求参数:**
```typescript
{
  serviceId: number;
  quantity?: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    provider: {
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      tags: string[];
      skillInfo: {gameArea?: string; rank?: string; rankDisplay?: string};
    };
    service: {serviceId: number; name: string; icon?: string};
    price: {unitPrice: number; unit: string; displayText: string};
    quantityOptions: {min: number; max: number; default: number};
    preview: {quantity: number; subtotal: number; serviceFee: number; total: number};
    userBalance: number;
  }
}
```

---

### 3.2 用户操作触发

#### 2. 调整订单数量(可选)
**接口:** `POST /api/order/preview/update`

**请求参数:**
```typescript
{
  serviceId: number;
  quantity: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    quantity: number;
    subtotal: number;
    serviceFee: number;
    total: number;
  }
}
```

---

#### 3. 提交订单
**接口:** `POST /api/order/create`

**请求参数:**
```typescript
{
  serviceId: number;
  quantity: number;
  totalAmount: number;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    amount: number;
    needPayment: boolean;
    paymentInfo?: {
      amount: number;
      currency: 'coin';
      userBalance: number;
      sufficientBalance: boolean;
    };
  }
}
```

---

## 四、数据流

### 4.1 页面打开流程
```
1. 从服务详情点击"下单"
2. 调用GET /api/order/preview
3. 显示Loading动画
4. 收到响应 → 渲染订单信息
```

### 4.2 调整数量流程
```
1. 用户点击+/-按钮
2. 更新数量显示
3. (可选)调用POST /api/order/preview/update
4. 实时更新总价
```

### 4.3 提交订单流程
```
1. 用户点击"立即支付"
2. 调用POST /api/order/create
3. 显示Loading动画
4. 订单创建成功 → 显示支付弹窗
5. 订单创建失败 → 显示错误提示
```

---

## 五、状态管理

### 5.1 页面级状态
```typescript
{
  serviceId: number;
  quantity: number;
  unitPrice: number;
  total: number;
  userBalance: number;
  submitting: boolean;
}
```

---

## 六、路由参数

### 进入参数
```typescript
{
  serviceId: number;  // 服务ID(必填)
}
```

### 跳转目标

#### 提交订单成功后
```
显示支付弹窗(组件内部弹窗,不跳转)
```

---

## 七、错误处理

### 7.1 服务不可用
```
显示: "该服务暂时不可用"
操作: 返回服务详情页
```

### 7.2 数量超限
```
提示: "数量已达上限"
操作: +按钮置灰
```

---

## 八、使用的后端服务

### OrderService
- `GET /api/order/preview` - 订单预览
- `POST /api/order/preview/update` - 更新订单预览
- `POST /api/order/create` - 创建订单

---

**文档版本**: v1.0
**最后更新**: 2025-01-XX
**维护者**: 前端团队
