# PaymentService - 支付服务接口文档

## 1. 服务概述

### 1.1 服务职责
PaymentService是平台的支付中心,负责:
- 订单支付执行(技能服务订单)
- 活动发布支付
- 活动报名支付
- 支付密码验证
- 支付方式管理
- 余额查询
- 支付为可被远程调用的RPC服务

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **支付渠道**: 内部余额 / 支付宝 / 微信支付
- **缓存**: Redis 7.0+ (支付状态缓存)
- **数据库**: MySQL 8.0+ (支付记录/账户)
- **消息队列**: RocketMQ (支付成功通知)

### 1.3 服务信息
- **服务名**: xypai-payment
- **端口**: 9411
- **数据库**: xypai_payment
- **RPC支持**: 可被远程调用

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 执行支付 | POST | `/api/payment/pay` | 执行订单支付 | 需登录 |
| 验证支付密码 | POST | `/api/payment/verify` | 验证支付密码 | 需登录 |
| 获取支付方式 | GET | `/api/payment/methods` | 获取可用支付方式 | 需登录 |
| 查询余额 | GET | `/api/payment/balance` | 查询用户余额 | 需登录 |

### 2.2 内部RPC (Feign)

| 接口名称 | 方法 | 路径 | 描述 | 调用方 |
|---------|------|------|------|--------|
| 活动发布支付 | POST | `/feign/payment/activity/publish` | 活动发布支付 | ActivityService |
| 活动报名支付 | POST | `/feign/payment/activity/register` | 活动报名支付 | ActivityService |
| 订单支付 | POST | `/feign/payment/order/pay` | 订单支付 | OrderService |
| 扣减余额 | POST | `/feign/payment/balance/deduct` | 扣减用户余额 | 所有服务 |
| 增加余额 | POST | `/feign/payment/balance/add` | 增加用户余额 | 所有服务 |

---

## 3. 接口详细定义

### 3.1 执行支付 (订单)

#### 接口定义
```
POST /api/payment/pay
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface ExecutePaymentRequest {
  orderId: string;
  orderNo: string;
  paymentMethod: 'balance' | 'alipay' | 'wechat';
  amount: number;
  paymentPassword?: string;     // 余额支付需要
}
```

#### 响应数据
```typescript
interface ExecutePaymentResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    paymentStatus: 'success' | 'pending' | 'require_password' | 'failed';
    requirePassword?: boolean;
    balance?: number;           // 支付后余额
    failureReason?: string;
  };
}
```

#### 业务规则
1. 余额支付需要支付密码
2. 验证余额是否充足
3. 支付成功后:
   - 扣减用户余额
   - 记录支付流水
   - 通知订单服务更新状态
4. 支付超时时间: 5分钟

---

### 3.2 验证支付密码

#### 接口定义
```
POST /api/payment/verify
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface VerifyPaymentPasswordRequest {
  orderId: string;
  orderNo: string;
  paymentPassword: string;      // 6位数字
}
```

#### 响应数据
```typescript
interface VerifyPaymentPasswordResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    paymentStatus: 'success' | 'failed';
    balance?: number;
    failureReason?: string;
  };
}
```

#### 业务规则
1. paymentPassword必须为6位数字
2. 密码错误限制: 5次错误锁定30分钟
3. 验证成功立即扣款
4. 失败返回错误原因

---

### 3.3 获取支付方式

#### 接口定义
```
GET /api/payment/methods
Authorization: Bearer {token}
```

#### 响应数据
```typescript
interface GetPaymentMethodsResponse {
  code: number;
  message: string;
  data: {
    methods: Array<{
      type: 'balance' | 'alipay' | 'wechat';
      name: string;
      icon: string;
      enabled: boolean;
      requirePassword: boolean;
      balance?: number;         // 余额支付显示余额
    }>;
  };
}
```

---

### 3.4 查询余额

#### 接口定义
```
GET /api/payment/balance
Authorization: Bearer {token}
```

#### 响应数据
```typescript
interface GetBalanceResponse {
  code: number;
  message: string;
  data: {
    balance: number;
    frozenBalance: number;      // 冻结金额
    availableBalance: number;   // 可用余额
  };
}
```

---

### 3.5 活动发布支付 (RPC)

#### 接口定义
```
POST /feign/payment/activity/publish
Content-Type: application/json
```

#### 请求参数
```typescript
interface ActivityPublishPaymentRequest {
  activityId: number;
  userId: number;
  paymentMethod: 'balance' | 'alipay' | 'wechat';
  amount: number;               // 平台费用
  deposit: number;              // 保证金
}
```

#### 响应数据
```typescript
interface ActivityPublishPaymentResponse {
  code: number;
  message: string;
  data: {
    paymentId: string;
    paymentStatus: 'success' | 'pending' | 'failed';
    balance?: number;
  };
}
```

#### 业务规则
1. 平台费用直接扣除
2. 保证金冻结,活动结束后退还
3. 支付失败活动发布失败

---

### 3.6 活动报名支付 (RPC)

#### 接口定义
```
POST /feign/payment/activity/register
Content-Type: application/json
```

#### 请求参数
```typescript
interface ActivityRegisterPaymentRequest {
  activityId: number;
  registrationId: number;
  userId: number;
  paymentMethod: 'balance';
  amount: number;
}
```

#### 响应数据
```typescript
interface ActivityRegisterPaymentResponse {
  code: number;
  message: string;
  data: {
    paymentId: string;
    paymentStatus: 'success' | 'pending' | 'failed';
    balance?: number;
  };
}
```

---

### 3.7 订单支付 (RPC)

#### 接口定义
```
POST /feign/payment/order/pay
Content-Type: application/json
```

#### 请求参数
```typescript
interface OrderPaymentRequest {
  orderId: string;
  orderNo: string;
  userId: number;
  providerId: number;
  paymentMethod: 'balance' | 'alipay' | 'wechat';
  amount: number;
  serviceFee: number;
}
```

#### 响应数据
```typescript
interface OrderPaymentResponse {
  code: number;
  message: string;
  data: {
    paymentId: string;
    paymentStatus: 'success' | 'pending' | 'failed';
    balance?: number;
  };
}
```

#### 业务规则
1. 订单金额 = 服务费 + 平台服务费
2. 支付成功后通知订单服务
3. 金额分配:
   - 服务费进入服务提供者账户(冻结)
   - 平台服务费进入平台账户

---

### 3.8 扣减余额 (RPC)

#### 接口定义
```
POST /feign/payment/balance/deduct
Content-Type: application/json
```

#### 请求参数
```typescript
interface DeductBalanceRequest {
  userId: number;
  amount: number;
  reason: string;
  referenceId?: string;         // 关联ID(订单号/活动ID)
  referenceType?: string;       // 关联类型
}
```

#### 响应数据
```typescript
interface DeductBalanceResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    balance: number;            // 扣减后余额
  };
}
```

---

### 3.9 增加余额 (RPC)

#### 接口定义
```
POST /feign/payment/balance/add
Content-Type: application/json
```

#### 请求参数
```typescript
interface AddBalanceRequest {
  userId: number;
  amount: number;
  reason: string;
  referenceId?: string;
  referenceType?: string;
}
```

#### 响应数据
```typescript
interface AddBalanceResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    balance: number;
  };
}
```

---

## 4. 数据模型

### 4.1 用户账户表 (user_account)

```sql
CREATE TABLE user_account (
  id BIGINT PRIMARY KEY,
  user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID',
  balance DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '余额',
  frozen_balance DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '冻结金额',
  total_income DECIMAL(15,2) DEFAULT 0 COMMENT '累计收入',
  total_expense DECIMAL(15,2) DEFAULT 0 COMMENT '累计支出',
  payment_password_hash VARCHAR(255) COMMENT '支付密码哈希',
  password_error_count INT DEFAULT 0 COMMENT '密码错误次数',
  password_locked_until DATETIME COMMENT '密码锁定至',
  version INT DEFAULT 0 COMMENT '乐观锁版本号',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB COMMENT='用户账户表';
```

### 4.2 支付记录表 (payment_record)

```sql
CREATE TABLE payment_record (
  id BIGINT PRIMARY KEY,
  payment_no VARCHAR(50) UNIQUE NOT NULL COMMENT '支付流水号',
  user_id BIGINT NOT NULL COMMENT '付款用户ID',
  payee_id BIGINT COMMENT '收款用户ID',
  payment_method VARCHAR(20) NOT NULL COMMENT '支付方式',
  payment_type VARCHAR(50) NOT NULL COMMENT '支付类型: order/activity_publish/activity_register',
  reference_id VARCHAR(50) COMMENT '关联ID',
  reference_type VARCHAR(50) COMMENT '关联类型',
  amount DECIMAL(15,2) NOT NULL COMMENT '支付金额',
  service_fee DECIMAL(15,2) DEFAULT 0 COMMENT '服务费',
  status VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT 'pending/success/failed/refunded',
  payment_time DATETIME COMMENT '支付成功时间',
  refund_amount DECIMAL(15,2) COMMENT '退款金额',
  refund_time DATETIME COMMENT '退款时间',
  remark VARCHAR(255),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_payment_no (payment_no),
  INDEX idx_user_id (user_id),
  INDEX idx_payee_id (payee_id),
  INDEX idx_reference (reference_id, reference_type),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='支付记录表';
```

### 4.3 账户流水表 (account_transaction)

```sql
CREATE TABLE account_transaction (
  id BIGINT PRIMARY KEY,
  transaction_no VARCHAR(50) UNIQUE NOT NULL COMMENT '交易流水号',
  user_id BIGINT NOT NULL COMMENT '用户ID',
  transaction_type VARCHAR(50) NOT NULL COMMENT '交易类型: income/expense/freeze/unfreeze',
  amount DECIMAL(15,2) NOT NULL COMMENT '交易金额',
  balance_before DECIMAL(15,2) NOT NULL COMMENT '交易前余额',
  balance_after DECIMAL(15,2) NOT NULL COMMENT '交易后余额',
  payment_no VARCHAR(50) COMMENT '关联支付流水号',
  reference_id VARCHAR(50),
  reference_type VARCHAR(50),
  remark VARCHAR(255),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_transaction_no (transaction_no),
  INDEX idx_user_id (user_id),
  INDEX idx_payment_no (payment_no),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='账户流水表'
PARTITION BY RANGE (YEAR(created_at)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p2026 VALUES LESS THAN (2027)
);
```

---

## 5. 依赖服务

### 5.1 调用的外部服务
- **支付宝**: 第三方支付
- **微信支付**: 第三方支付

### 5.2 被调用的服务
- **ActivityService**: 活动发布/报名支付
- **OrderService**: 订单支付

---

## 6. 性能要求

### 6.1 QPS要求
- 执行支付: 200 QPS
- 查询余额: 500 QPS
- 余额扣减(RPC): 300 QPS

### 6.2 响应时间
- 余额支付: P95 < 300ms
- 第三方支付: P95 < 1s
- 余额查询: P95 < 50ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 用户余额缓存
```
Key: payment:balance:{userId}
Value: 余额数值
TTL: 5分钟
更新策略: 余额变动时更新
```

#### 支付密码错误次数
```
Key: payment:pwd:error:{userId}
Value: 错误次数
TTL: 30分钟
```

---

## 8. 监控告警

### 8.1 关键指标
- **支付成功率**: > 99%
- **账户余额一致性**: 100%
- **平均支付时间**: < 500ms
- **退款处理时间**: < 1分钟

### 8.2 告警规则
1. 支付失败率 > 1% - P0
2. 账户余额不一致 - P0
3. 支付超时 > 5s - P1
4. 退款失败 - P1

---

## 9. 安全措施

### 9.1 支付安全
1. 支付密码加密存储(BCrypt)
2. 密码错误限制(5次锁定30分钟)
3. 支付金额二次验证
4. 幂等性保证(防止重复支付)
5. 账户余额乐观锁(version字段)

### 9.2 数据安全
1. 所有金额字段使用DECIMAL类型
2. 账户流水永久保存
3. 支付记录定期归档
4. 敏感数据加密传输
