# OrderService - 订单服务接口文档

## 1. 服务概述

### 1.1 服务职责
OrderService是平台的订单管理服务,负责:
- 订单预览与价格计算
- 订单创建
- 订单详情查询
- 订单状态查询与更新
- 订单取消

**注意**: 支付相关API已移至PaymentService

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **缓存**: Redis 7.0+ (订单缓存/状态缓存)
- **数据库**: MySQL 8.0+ (订单/订单项)
- **消息队列**: RocketMQ (订单状态变更通知)

### 1.3 服务信息
- **服务名**: xypai-order
- **端口**: 9410
- **数据库**: xypai_order

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 订单预览 | GET | `/api/order/preview` | 预览订单价格 | 需登录 |
| 更新订单预览 | POST | `/api/order/preview/update` | 更新数量重新计算 | 需登录 |
| 创建订单 | POST | `/api/order/create` | 创建订单 | 需登录 |
| 获取订单详情 | GET | `/api/order/detail` | 获取订单详情 | 需登录 |
| 查询订单状态 | GET | `/api/order/status` | 查询订单状态 | 需登录 |
| 取消订单 | POST | `/api/order/cancel` | 取消订单 | 需登录 |

### 2.2 内部RPC (Feign)

| 接口名称 | 方法 | 路径 | 描述 | 调用方 |
|---------|------|------|------|--------|
| 更新订单状态 | POST | `/feign/order/status/update` | 更新订单状态 | PaymentService |
| 批量查询订单 | POST | `/feign/order/batch` | 批量查询订单 | UserService |

---

## 3. 接口详细定义

### 3.1 订单预览

#### 接口定义
```
GET /api/order/preview?serviceId=123&quantity=1
Authorization: Bearer {token}
```

#### 请求参数
```typescript
interface OrderPreviewRequest {
  serviceId: number;
  quantity?: number;            // 数量(默认1)
}
```

#### 响应数据
```typescript
interface OrderPreviewResponse {
  code: number;
  message: string;
  data: {
    provider: {
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      tags: string[];
      skillInfo: {
        gameArea?: string;
        rank?: string;
        rankDisplay?: string;
      };
    };
    service: {
      serviceId: number;
      name: string;
      icon?: string;
    };
    price: {
      unitPrice: number;
      unit: string;
      displayText: string;
    };
    quantityOptions: {
      min: number;
      max: number;
      default: number;
    };
    preview: {
      quantity: number;
      subtotal: number;          // 小计
      serviceFee: number;        // 服务费
      total: number;             // 总计
    };
    userBalance: number;
  };
}
```

#### 业务规则
1. 验证服务是否可用
2. 计算价格: 小计 + 服务费
3. 服务费率通常5-10%
4. 返回用户余额供前端判断

---

### 3.2 更新订单预览

#### 接口定义
```
POST /api/order/preview/update
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface UpdateOrderPreviewRequest {
  serviceId: number;
  quantity: number;             // 新的数量
}
```

#### 响应数据
```typescript
interface UpdateOrderPreviewResponse {
  code: number;
  message: string;
  data: {
    quantity: number;
    subtotal: number;
    serviceFee: number;
    total: number;
  };
}
```

#### 业务规则
1. quantity必须在min-max范围内
2. 实时计算价格
3. 不创建订单,仅返回预览

---

### 3.3 创建订单

#### 接口定义
```
POST /api/order/create
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface CreateOrderRequest {
  serviceId: number;
  quantity: number;
  totalAmount: number;          // 总金额(用于验证)
}
```

#### 响应数据
```typescript
interface CreateOrderResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    amount: number;
    needPayment: boolean;
    paymentInfo?: {
      amount: number;
      currency: 'coin';
      userBalance: number;
      sufficientBalance: boolean;
    };
  };
}
```

#### 业务规则
1. 验证服务可用性
2. 验证价格是否正确
3. 创建订单记录(状态:待支付)
4. 锁定库存(如适用)
5. 订单号生成规则: yyyyMMddHHmmss + 4位随机数

---

### 3.4 获取订单详情

#### 接口定义
```
GET /api/order/detail?orderId=123456
Authorization: Bearer {token}
```

#### 请求参数
```typescript
interface GetOrderDetailRequest {
  orderId: string;
}
```

#### 响应数据
```typescript
interface GetOrderDetailResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    status: 'pending' | 'accepted' | 'in_progress' | 'completed' | 'cancelled';
    amount: number;
    createdAt: string;
    autoCancelTime?: string;
    provider: {
      userId: number;
      nickname: string;
      avatar: string;
    };
    service: {
      name: string;
      quantity: number;
    };
  };
}
```

---

### 3.5 查询订单状态

#### 接口定义
```
GET /api/order/status?orderId=123456
Authorization: Bearer {token}
```

#### 请求参数
```typescript
interface GetOrderStatusRequest {
  orderId: string;
}
```

#### 响应数据
```typescript
interface GetOrderStatusResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    orderNo: string;
    status: 'pending' | 'accepted' | 'in_progress' | 'completed' | 'cancelled' | 'refunded';
    statusLabel: string;
    provider: {
      userId: number;
      nickname: string;
      avatar: string;
      isOnline: boolean;
    };
    service: {
      name: string;
      quantity: number;
      unitPrice: number;
    };
    amount: number;
    createdAt: string;
    acceptedAt?: string;
    completedAt?: string;
    cancelledAt?: string;
    autoCancel: {
      enabled: boolean;
      cancelAt?: string;
      remainingSeconds?: number;
    };
    actions: Array<{
      action: 'cancel' | 'contact' | 'rate' | 'refund';
      label: string;
      enabled: boolean;
    }>;
  };
}
```

#### 业务规则
1. 订单状态流转:
   - pending(待接单) → accepted(已接单)
   - accepted → in_progress(进行中)
   - in_progress → completed(已完成)
   - pending/accepted → cancelled(已取消)
2. 10分钟未接单自动取消

---

### 3.6 取消订单

#### 接口定义
```
POST /api/order/cancel
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface CancelOrderRequest {
  orderId: string;
  reason?: string;
}
```

#### 响应数据
```typescript
interface CancelOrderResponse {
  code: number;
  message: string;
  data: {
    orderId: string;
    status: 'cancelled';
    refundAmount: number;
    refundTime: string;
    balance: number;
  };
}
```

#### 业务规则
1. 只能取消pending状态的订单
2. 已接单不能取消
3. 取消后全额退款
4. 释放库存(如适用)

---

## 4. 数据模型

### 4.1 订单表 (order)

```sql
CREATE TABLE `order` (
  id BIGINT PRIMARY KEY,
  order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单编号',
  user_id BIGINT NOT NULL COMMENT '下单用户ID',
  provider_id BIGINT NOT NULL COMMENT '服务提供者ID',
  service_id BIGINT NOT NULL COMMENT '服务ID',
  order_type VARCHAR(20) NOT NULL COMMENT '订单类型: service/activity',
  quantity INT NOT NULL COMMENT '数量',
  unit_price DECIMAL(10,2) NOT NULL COMMENT '单价',
  subtotal DECIMAL(10,2) NOT NULL COMMENT '小计',
  service_fee DECIMAL(10,2) NOT NULL COMMENT '服务费',
  total_amount DECIMAL(10,2) NOT NULL COMMENT '总金额',
  status VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '订单状态',
  payment_status VARCHAR(20) COMMENT '支付状态',
  payment_method VARCHAR(20) COMMENT '支付方式',
  payment_time DATETIME COMMENT '支付时间',
  accepted_time DATETIME COMMENT '接单时间',
  completed_time DATETIME COMMENT '完成时间',
  cancelled_time DATETIME COMMENT '取消时间',
  cancel_reason VARCHAR(255) COMMENT '取消原因',
  auto_cancel_time DATETIME COMMENT '自动取消时间',
  refund_amount DECIMAL(10,2) COMMENT '退款金额',
  refund_time DATETIME COMMENT '退款时间',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_provider_id (provider_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='订单表';
```

### 4.2 订单统计表 (order_stats)

```sql
CREATE TABLE order_stats (
  id BIGINT PRIMARY KEY,
  stat_date DATE NOT NULL COMMENT '统计日期',
  total_orders INT DEFAULT 0,
  completed_orders INT DEFAULT 0,
  cancelled_orders INT DEFAULT 0,
  total_amount DECIMAL(15,2) DEFAULT 0,
  total_service_fee DECIMAL(15,2) DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_stat_date (stat_date)
) ENGINE=InnoDB COMMENT='订单统计表';
```

---

## 5. 依赖服务

### 5.1 调用的服务
- **ServiceService**: 获取服务信息
- **UserService**: 获取用户信息
- **PaymentService**: 执行支付(RPC)

### 5.2 被调用的服务
- **PaymentService**: 支付成功后更新订单状态

---

## 6. 性能要求

### 6.1 QPS要求
- 订单预览: 200 QPS
- 创建订单: 100 QPS
- 查询订单: 300 QPS

### 6.2 响应时间
- 订单预览: P95 < 200ms
- 创建订单: P95 < 300ms
- 查询订单: P95 < 100ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 订单详情缓存
```
Key: order:detail:{orderId}
Value: 订单详情JSON
TTL: 10分钟
更新策略: 状态变更时清除
```

---

## 8. 监控告警

### 8.1 关键指标
- **订单创建成功率**: > 98%
- **订单完成率**: > 80%
- **平均接单时间**: < 5分钟
- **自动取消率**: < 10%

### 8.2 告警规则
1. 订单创建失败率 > 2% - P1
2. 订单完成率 < 70% - P2
3. 自动取消率 > 15% - P3
