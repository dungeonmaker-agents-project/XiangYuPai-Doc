# ActivityService - 活动服务接口文档

## 1. 服务概述

### 1.1 服务职责
ActivityService是平台的组局中心服务,负责:
- 活动列表查询与筛选
- 活动详情获取
- 活动发布与配置
- 活动报名管理
- 报名审核(组织者)
- 活动分享

**注意**: 支付相关API已移至PaymentService

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **缓存**: Redis 7.0+ (活动列表/详情缓存)
- **数据库**: MySQL 8.0+ with SPATIAL INDEX
- **消息队列**: RocketMQ (报名通知/审核通知)

### 1.3 服务信息
- **服务名**: xypai-activity
- **端口**: 9408
- **数据库**: xypai_activity

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 获取活动列表 | GET | `/api/activity/list` | 获取组局列表 | 公开 |
| 获取发布配置 | GET | `/api/activity/publish/config` | 获取发布配置 | 需登录 |
| 发布活动 | POST | `/api/activity/publish` | 发布组局 | 需登录 |
| 获取活动详情 | GET | `/api/activity/detail` | 获取活动详情 | 公开 |
| 报名参加 | POST | `/api/activity/register` | 报名活动 | 需登录 |
| 审核报名 | POST | `/api/activity/registration/approve` | 审核报名 | 需登录 |
| 取消报名 | POST | `/api/activity/register/cancel` | 取消报名 | 需登录 |
| 分享活动 | POST | `/api/activity/share` | 生成分享链接 | 公开 |

---

## 3. 接口详细定义

### 3.1 获取活动列表

#### 接口定义
```
GET /api/activity/list?pageNum=1&pageSize=10
```

#### 请求参数
```typescript
interface GetActivityListRequest {
  pageNum: number;
  pageSize: number;
  sortBy?: string;              // 'smart' | 'latest' | 'popular'
  filters?: {
    gender?: 'all' | 'male' | 'female';
    memberCount?: string;
    activityType?: string[];    // 探店/私影/台球等
    cityCode?: string;
    districtCode?: string;
  };
}
```

#### 响应数据
```typescript
interface GetActivityListResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    filters: {
      sortOptions: Array<{value: string; label: string}>;
      genderOptions: Array<{value: string; label: string}>;
      memberOptions: Array<{value: string; label: string}>;
      activityTypes: Array<{
        value: string;
        label: string;
        icon: string;
      }>;
    };
    list: Array<{
      activityId: number;
      organizer: {
        userId: number;
        avatar: string;
        nickname: string;
      };
      title?: string;
      description?: string;
      activityType: {
        type: string;
        label: string;
        icon: string;
      };
      tags: Array<{
        text: string;
        type: 'feature' | 'price';
        color?: string;
      }>;
      price: {
        amount: number;
        unit: 'per_person' | 'per_hour';
        displayText: string;
      };
      schedule: {
        startTime: string;
        displayText: string;
      };
      location: {
        address: string;
        district?: string;
        coordinates?: {latitude: number; longitude: number};
      };
      participants: {
        registered: number;
        limit: number;
        displayText: string;
      };
      status: 'open' | 'full' | 'closed';
      registrationDeadline: string;
    }>;
  };
}
```

#### 业务规则
1. 支持多维度筛选
2. 智能排序考虑距离/时间/热度
3. 仅展示未开始且未满员的活动
4. 结果缓存5分钟

---

### 3.2 获取发布配置

#### 接口定义
```
GET /api/activity/publish/config
Authorization: Bearer {token}
```

#### 响应数据
```typescript
interface GetPublishConfigResponse {
  code: number;
  message: string;
  data: {
    activityTypes: Array<{
      value: string;
      label: string;
      icon: string;
    }>;
    priceUnit: {
      options: Array<{value: string; label: string}>;
    };
    memberCountOptions: Array<{value: number; label: string}>;
    platformFee: {
      rate: number;
      description: string;
    };
    depositRules: {
      depositAmount: number;
      description: string;
    };
  };
}
```

---

### 3.3 发布活动

#### 接口定义
```
POST /api/activity/publish
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface PublishActivityRequest {
  activityType: string;
  title: string;                // 1-50字符
  content: string;              // 0-200字符
  images?: string[];            // 最多9张
  schedule: {
    startTime: string;
    endTime?: string;
  };
  location: {
    address: string;
    coordinates?: {latitude: number; longitude: number};
  };
  price: {
    amount: number;
    unit: 'per_person' | 'per_hour';
  };
  memberLimit: number;          // 2-100人
  registrationDeadline: string;
}
```

#### 响应数据
```typescript
interface PublishActivityResponse {
  code: number;
  message: string;
  data: {
    activityId: number;
    needPayment: boolean;       // 是否需要支付平台费
    paymentInfo?: {
      amount: number;
      platformFee: number;
      deposit: number;
    };
  };
}
```

#### 业务规则
1. title: 1-50字符
2. content: 0-200字符
3. startTime必须晚于当前时间
4. registrationDeadline必须早于startTime
5. memberLimit: 2-100人
6. 发布成功后可能需要支付平台费

---

### 3.4 获取活动详情

#### 接口定义
```
GET /api/activity/detail?activityId=123
```

#### 请求参数
```typescript
interface GetActivityDetailRequest {
  activityId: number;
}
```

#### 响应数据
```typescript
interface GetActivityDetailResponse {
  code: number;
  message: string;
  data: {
    activityId: number;
    status: 'open' | 'full' | 'closed' | 'cancelled';
    organizer: {
      userId: number;
      avatar: string;
      nickname: string;
      tags?: string[];
      isVerified: boolean;
    };
    activityType: {type: string; label: string; icon: string};
    title?: string;
    description: string;
    images?: string[];
    bannerImage?: string;
    schedule: {
      startTime: string;
      endTime?: string;
      displayText: string;
    };
    location: {
      address: string;
      district?: string;
      coordinates?: {latitude: number; longitude: number};
    };
    price: {
      amount: number;
      unit: string;
      displayText: string;
    };
    participants: {
      registered: number;
      limit: number;
      displayText: string;
      list: Array<{
        userId: number;
        avatar: string;
        nickname: string;
        status: 'pending' | 'approved' | 'rejected';
        statusLabel: string;
      }>;
      waitingText?: string;
    };
    registrationDeadline: string;
    userStatus?: {
      isOrganizer: boolean;
      hasRegistered: boolean;
      registrationStatus?: 'pending' | 'approved' | 'rejected';
      canRegister: boolean;
    };
  };
}
```

---

### 3.5 报名参加

#### 接口定义
```
POST /api/activity/register
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface RegisterActivityRequest {
  activityId: number;
  message?: string;             // 报名留言(可选)
}
```

#### 响应数据
```typescript
interface RegisterActivityResponse {
  code: number;
  message: string;
  data: {
    registrationId: number;
    status: 'pending' | 'approved';
    needPayment: boolean;
    paymentInfo?: {
      amount: number;
      description: string;
    };
    approvalRequired: boolean;
  };
}
```

#### 业务规则
1. 不能报名自己组织的活动
2. 活动状态必须为'open'
3. 未超过报名截止时间
4. 未达到人数上限
5. 可能需要组织者审核

---

### 3.6 审核报名

#### 接口定义
```
POST /api/activity/registration/approve
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface ApproveRegistrationRequest {
  activityId: number;
  registrationId: number;
  action: 'approve' | 'reject';
  reason?: string;              // 拒绝原因(如action='reject')
}
```

#### 响应数据
```typescript
interface ApproveRegistrationResponse {
  code: number;
  message: string;
  data: {
    registrationId: number;
    status: 'approved' | 'rejected';
    success: boolean;
  };
}
```

#### 业务规则
1. 只有组织者可以审核
2. 只能审核'pending'状态的报名
3. 审核决定不可撤销
4. 审核后发送通知给报名用户

---

### 3.7 取消报名

#### 接口定义
```
POST /api/activity/register/cancel
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface CancelRegistrationRequest {
  activityId: number;
  registrationId: number;
}
```

#### 响应数据
```typescript
interface CancelRegistrationResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    refundAmount?: number;
    cancelPolicy: string;
  };
}
```

---

### 3.8 分享活动

#### 接口定义
```
POST /api/activity/share
Content-Type: application/json
```

#### 请求参数
```typescript
interface ShareActivityRequest {
  activityId: number;
  shareType: 'link' | 'image' | 'miniprogram';
}
```

#### 响应数据
```typescript
interface ShareActivityResponse {
  code: number;
  message: string;
  data: {
    shareUrl: string;
    shareImage?: string;
    shareText: string;
    qrCode?: string;
  };
}
```

---

## 4. 数据模型

### 4.1 活动表 (activity)

```sql
CREATE TABLE activity (
  id BIGINT PRIMARY KEY,
  organizer_id BIGINT NOT NULL COMMENT '组织者ID',
  activity_type VARCHAR(50) NOT NULL COMMENT '活动类型',
  title VARCHAR(100),
  description VARCHAR(500),
  images JSON COMMENT '活动图片数组',
  banner_image VARCHAR(512),
  start_time DATETIME NOT NULL,
  end_time DATETIME,
  location_address VARCHAR(255) NOT NULL,
  location_point POINT COMMENT '位置坐标',
  city_code VARCHAR(10),
  district_code VARCHAR(20),
  price_amount DECIMAL(10,2) NOT NULL,
  price_unit VARCHAR(20) NOT NULL,
  member_limit INT NOT NULL,
  registered_count INT DEFAULT 0,
  registration_deadline DATETIME NOT NULL,
  status VARCHAR(20) DEFAULT 'open' COMMENT 'open/full/closed/cancelled',
  platform_fee DECIMAL(10,2),
  deposit_amount DECIMAL(10,2),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_organizer (organizer_id),
  INDEX idx_activity_type (activity_type),
  INDEX idx_start_time (start_time),
  INDEX idx_status (status),
  SPATIAL INDEX idx_location (location_point)
) ENGINE=InnoDB COMMENT='活动表';
```

### 4.2 活动报名表 (activity_registration)

```sql
CREATE TABLE activity_registration (
  id BIGINT PRIMARY KEY,
  activity_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  message VARCHAR(255),
  status VARCHAR(20) DEFAULT 'pending' COMMENT 'pending/approved/rejected/cancelled',
  payment_status VARCHAR(20) COMMENT '支付状态',
  payment_amount DECIMAL(10,2),
  approval_time DATETIME,
  reject_reason VARCHAR(255),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_activity_user (activity_id, user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
) ENGINE=InnoDB COMMENT='活动报名表';
```

---

## 5. 依赖服务

### 5.1 调用的服务
- **UserService**: 获取用户信息
- **PaymentService**: 发布/报名支付(RPC)
- **LocationService**: 距离计算
- **CommonService**: 图片上传

### 5.2 被调用的服务
- 无

---

## 6. 性能要求

### 6.1 QPS要求
- 活动列表: 200 QPS
- 活动详情: 300 QPS
- 发布活动: 20 QPS
- 报名活动: 50 QPS

### 6.2 响应时间
- 活动列表: P95 < 200ms
- 活动详情: P95 < 150ms
- 发布/报名: P95 < 300ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 活动列表缓存
```
Key: activity:list:{city}:{filters}:{page}
Value: 活动列表JSON
TTL: 5分钟
```

#### 活动详情缓存
```
Key: activity:detail:{activityId}
Value: 活动详情JSON
TTL: 10分钟
更新策略: 报名/取消时清除
```

---

## 8. 监控告警

### 8.1 关键指标
- **发布成功率**: > 95%
- **报名成功率**: > 98%
- **活动成团率**: > 70%
- **平均响应时间**: < 200ms

### 8.2 告警规则
1. 发布失败率 > 5% - P2
2. 报名失败率 > 2% - P2
3. 活动成团率 < 50% - P3
