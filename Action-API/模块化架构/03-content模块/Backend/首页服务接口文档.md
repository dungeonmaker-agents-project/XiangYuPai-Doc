# HomeService - 首页服务接口文档

## 1. 服务概述

### 1.1 服务职责
HomeService是平台的内容发现服务,负责首页核心功能:
- Feed流内容推荐与加载
- Tab配置管理(线上/线下/推荐等)
- 筛选功能(年龄/性别/技能/价格/位置等)
- 筛选条件应用与结果返回
- 限时专享列表
- 专家推荐

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **推荐算法**: 基于用户行为的协同过滤
- **缓存**: Redis 7.0+ (热门内容/配置缓存)
- **数据库**: MySQL 8.0+ (Feed流/筛选配置)
- **搜索**: Elasticsearch 8.x (内容检索)

### 1.3 服务信息
- **服务名**: xypai-home
- **端口**: 9402
- **数据库**: xypai_content

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 首页初始化 | GET | `/api/home/init` | 获取首页初始数据 | 需登录 |
| 明日专家推荐 | GET | `/api/home/experts` | 获取专家推荐列表 | 公开 |
| 你什么名模块 | GET | `/api/home/topic-banner` | 获取话题Banner | 公开 |
| 内容Feed流 | GET | `/api/home/feed` | 获取Feed流内容 | 公开 |
| 获取筛选配置 | GET | `/api/home/filter/config` | 获取筛选配置 | 公开 |
| 应用筛选条件 | POST | `/api/home/filter/apply` | 应用筛选并返回结果 | 公开 |
| 获取筛选结果 | GET | `/api/home/filter/results` | 分页获取筛选结果 | 公开 |
| 限时专享列表 | GET | `/api/home/limited-time/list` | 获取限时专享用户列表 | 公开 |

### 2.2 内部RPC (Feign)

| 接口名称 | 方法 | 路径 | 描述 | 调用方 |
|---------|------|------|------|--------|
| 批量获取内容 | POST | `/feign/home/feed/batch` | 批量获取内容详情 | ContentService |
| 更新推荐权重 | POST | `/feign/home/recommend/weight` | 更新推荐权重 | UserService |

---

## 3. 接口详细定义

### 3.1 首页初始化

#### 接口定义
```
GET /api/home/init
Authorization: Bearer {token}
```

#### 请求参数
```typescript
// 无参数,从token获取用户ID
```

#### 响应数据
```typescript
interface HomeInitResponse {
  code: number;
  message: string;
  data: {
    userInfo: {
      userId: number;
      avatar: string;
      unreadCount: number;      // 未读消息数
    };
    banner: {
      imageUrl: string;
      linkType?: 'webview' | 'native';
      linkUrl?: string;
    };
    quickEntries: Array<{
      icon: string;
      title: string;
      linkUrl: string;
    }>;
    giftItems: Array<{
      icon: string;
      name?: string;
    }>;
  };
}
```

#### 业务规则
1. 需要用户登录
2. Banner根据用户画像动态推荐
3. 快捷入口支持配置化管理
4. 未读消息数实时从消息服务获取

---

### 3.2 内容Feed流

#### 接口定义
```
GET /api/home/feed?pageNum=1&pageSize=10
```

#### 请求参数
```typescript
interface FeedRequest {
  pageNum: number;              // 页码,从1开始
  pageSize: number;             // 每页数量,建议10
  type?: 'online' | 'offline' | 'recommend';  // 类型(可选)
}
```

#### 响应数据
```typescript
interface FeedResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      postId: number;
      author: {
        userId: number;
        avatar: string;
        nickname: string;
        tags?: string[];
      };
      description: string;
      thumbnails: string[];     // 最多3张缩略图
      mediaType: 'image' | 'video';
      location?: string;
      additionalInfo?: string;
      stats: {
        likes: number;
        comments: number;
        views: number;
      };
      publishedAt: string;
    }>;
  };
}
```

#### 业务规则
1. 推荐算法:
   - 新用户: 热门内容 + 随机推荐
   - 老用户: 基于行为的个性化推荐
2. 内容去重: 7天内不重复推荐
3. 内容审核: 仅展示已审核通过的内容
4. 分页限制: pageSize范围5-20

---

### 3.3 获取筛选配置

#### 接口定义
```
GET /api/home/filter/config?type=online
```

#### 请求参数
```typescript
interface FilterConfigRequest {
  type: 'online' | 'offline';   // 线上或线下
}
```

#### 响应数据
```typescript
interface FilterConfigResponse {
  code: number;
  message: string;
  data: {
    ageRange: {
      min: number;              // 最小年龄(如18)
      max: number | null;       // 最大年龄(null=不限)
    };
    genderOptions: Array<{
      value: string;            // 'all' | 'male' | 'female'
      label: string;
    }>;
    statusOptions: Array<{
      value: string;            // 'online' | 'active_3d' | 'active_7d'
      label: string;
    }>;
    skillOptions: Array<{
      value: string;
      label: string;
      category?: string;
    }>;
    priceOptions?: Array<{      // 仅线上模式
      value: string;
      label: string;
      min: number;
      max: number | null;
    }>;
    positionOptions?: Array<{   // 仅线上模式
      value: string;
      label: string;
    }>;
    tagOptions: Array<{
      value: string;
      label: string;
      highlighted?: boolean;
    }>;
  };
}
```

#### 业务规则
1. 配置分线上/线下两种模式
2. 线上模式包含价格和位置筛选
3. 配置缓存30分钟
4. 支持动态配置更新

---

### 3.4 应用筛选条件

#### 接口定义
```
POST /api/home/filter/apply
Content-Type: application/json
```

#### 请求参数
```typescript
interface ApplyFilterRequest {
  type: 'online' | 'offline';
  filters: {
    age?: {
      min: number;
      max: number | null;
    };
    gender?: 'all' | 'male' | 'female';
    status?: 'online' | 'active_3d' | 'active_7d';
    skills?: string[];
    priceRange?: string[];
    positions?: string[];
    tags?: string[];
  };
  pageNum: number;              // 固定为1
  pageSize: number;
}
```

#### 响应数据
```typescript
interface ApplyFilterResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      userId: number;
      avatar: string;
      nickname: string;
      age: number;
      gender: 'male' | 'female';
      status: 'online' | 'offline';
      isOnline: boolean;
      skills: Array<{
        name: string;
        level?: string;
      }>;
      price?: number;
      position?: string;
      tags: string[];
      distance?: number;
      location?: string;
    }>;
    appliedFilters: {
      count: number;
      summary: string[];
    };
  };
}
```

#### 业务规则
1. 多条件组合使用AND逻辑
2. 多选项(技能/价格/位置)使用OR逻辑
3. 年龄范围: min≥18, max≥min或null
4. 结果按匹配度排序
5. 应用筛选后pageNum重置为1

---

### 3.5 限时专享列表

#### 接口定义
```
GET /api/home/limited-time/list
```

#### 请求参数
```typescript
interface LimitedTimeListRequest {
  cityCode?: string;
  districtCode?: string;
  pageNum: number;
  pageSize: number;
  sortBy?: string;              // 'recommend' | 'price_asc' | 'price_desc'
  gender?: 'all' | 'male' | 'female';
  language?: string;
}
```

#### 响应数据
```typescript
interface LimitedTimeListResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    filters: {
      sortOptions: Array<{value: string; label: string}>;
      genderOptions: Array<{value: string; label: string}>;
      languageOptions: Array<{value: string; label: string}>;
    };
    list: Array<{
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      distance: number;
      tags: Array<{
        text: string;
        type: 'feature' | 'price' | 'skill';
        color?: string;
      }>;
      description: string;
      price: {
        amount: number;
        unit: 'per_order' | 'per_hour' | 'per_game';
        displayText: string;
      };
      promotionTag?: string;
      isOnline: boolean;
      skillLevel?: string;
    }>;
  };
}
```

#### 业务规则
1. 限时专享用户由运营配置
2. 基于城市/区域显示
3. 距离基于用户GPS位置计算
4. 默认按智能推荐排序
5. 支持价格升序/降序排序

---

## 4. 数据模型

### 4.1 Feed流配置表 (feed_config)

```sql
CREATE TABLE feed_config (
  id BIGINT PRIMARY KEY,
  config_type VARCHAR(50) NOT NULL COMMENT '配置类型: banner/quick_entry/expert',
  config_data JSON NOT NULL COMMENT '配置数据',
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  start_time DATETIME,
  end_time DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_config_type (config_type),
  INDEX idx_status_time (status, start_time, end_time)
) ENGINE=InnoDB COMMENT='Feed流配置表';
```

### 4.2 筛选配置表 (filter_config)

```sql
CREATE TABLE filter_config (
  id BIGINT PRIMARY KEY,
  filter_type VARCHAR(50) NOT NULL COMMENT '筛选类型: online/offline',
  filter_category VARCHAR(50) NOT NULL COMMENT '筛选分类: skill/price/position/tag',
  config_data JSON NOT NULL COMMENT '配置数据',
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_type_category (filter_type, filter_category),
  INDEX idx_status (status)
) ENGINE=InnoDB COMMENT='筛选配置表';
```

### 4.3 限时专享配置表 (limited_time_config)

```sql
CREATE TABLE limited_time_config (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  promotion_type VARCHAR(50) COMMENT '促销类型',
  original_price DECIMAL(10,2),
  promotion_price DECIMAL(10,2),
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_time (start_time, end_time),
  INDEX idx_status (status)
) ENGINE=InnoDB COMMENT='限时专享配置表';
```

---

## 5. 依赖服务

### 5.1 调用的服务
- **UserService**: 获取用户信息、关注状态
- **ContentService**: 获取内容详情
- **LocationService**: 距离计算、城市区域信息
- **Auth Service**: 用户认证

### 5.2 被调用的服务
- **SearchService**: 搜索时调用Feed推荐
- **UserService**: 获取推荐用户

---

## 6. 性能要求

### 6.1 QPS要求
- Feed流: 2000 QPS
- 筛选配置: 500 QPS
- 筛选应用: 300 QPS
- 限时专享: 200 QPS

### 6.2 响应时间
- Feed流: P95 < 200ms, P99 < 300ms
- 筛选应用: P95 < 300ms, P99 < 500ms
- 配置读取: P95 < 50ms, P99 < 100ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### Feed流缓存
```
Key: home:feed:{userId}:{type}:{page}
Value: Feed内容列表JSON
TTL: 5分钟
更新策略: 新内容发布时清除相关缓存
```

#### 筛选配置缓存
```
Key: home:filter:config:{type}
Value: 筛选配置JSON
TTL: 30分钟
更新策略: 配置修改时主动清除
```

#### 限时专享缓存
```
Key: home:limited:{city}:{page}
Value: 限时专享列表JSON
TTL: 10分钟
更新策略: 配置变更时清除
```

---

## 8. 监控告警

### 8.1 关键指标
- **Feed加载成功率**: > 99.5%
- **平均响应时间**: < 200ms
- **缓存命中率**: > 80%
- **推荐点击率**: > 5%

### 8.2 告警规则
1. Feed加载失败率 > 0.5% - P1
2. 响应时间 > 500ms - P2
3. 缓存命中率 < 70% - P3
4. 推荐效果下降 > 20% - P3
