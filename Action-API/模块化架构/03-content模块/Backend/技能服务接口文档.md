# ServiceService - 技能服务接口文档

## 1. 服务概述

### 1.1 服务职责
ServiceService是平台的技能服务管理模块,负责:
- 服务列表查询与筛选
- 服务详情获取
- 评价列表查询
- 评价提交

**注意**: 订单相关API已移至OrderService

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **缓存**: Redis 7.0+ (服务列表/详情缓存)
- **数据库**: MySQL 8.0+ with SPATIAL INDEX
- **搜索**: Elasticsearch 8.x (服务检索)

### 1.3 服务信息
- **服务名**: xypai-service
- **端口**: 9409
- **数据库**: xypai_service

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 获取服务列表 | GET | `/api/service/list` | 获取技能服务列表 | 公开 |
| 获取服务详情 | GET | `/api/service/detail` | 获取服务详情 | 公开 |
| 获取评价列表 | GET | `/api/service/reviews` | 获取全部评价 | 公开 |
| 提交评价 | POST | `/api/service/review/submit` | 提交服务评价 | 需登录 |

---

## 3. 接口详细定义

### 3.1 获取服务列表

#### 接口定义
```
GET /api/service/list?skillType=王者荣耀&pageNum=1&pageSize=10
```

#### 请求参数
```typescript
interface GetServiceListRequest {
  skillType: string;            // 技能类型(必填)
  pageNum: number;
  pageSize: number;
  sortBy?: string;              // 'smart' | 'latest' | 'popular'
  filters?: {
    status?: 'online' | 'active_3d' | 'active_7d';
    gender?: 'all' | 'male' | 'female';
    gameArea?: string;          // 游戏大区
    rank?: string[];            // 段位(多选)
    priceRange?: string[];      // 价格范围(多选)
    position?: string[];        // 位置/角色(多选)
    tags?: string[];            // 标签(多选)
    location?: 'same_city';
    cityCode?: string;
  };
}
```

#### 响应数据
```typescript
interface GetServiceListResponse {
  code: number;
  message: string;
  data: {
    skillType: {type: string; label: string; icon?: string};
    tabs: Array<{value: string; label: string; count?: number}>;
    filters: {
      sortOptions: Array<{value: string; label: string}>;
      genderOptions: Array<{value: string; label: string}>;
      statusOptions: Array<{value: string; label: string}>;
      gameAreas?: Array<{value: string; label: string}>;
      ranks?: Array<{value: string; label: string}>;
      priceRanges?: Array<{
        value: string;
        label: string;
        min: number;
        max: number | null;
      }>;
      positions?: Array<{value: string; label: string}>;
      tags?: Array<{value: string; label: string}>;
    };
    total: number;
    hasMore: boolean;
    list: Array<{
      serviceId: number;
      provider: {
        userId: number;
        avatar: string;
        nickname: string;
        gender: 'male' | 'female';
        age?: number;
        isOnline: boolean;
        isVerified: boolean;
      };
      skillInfo: {
        skillType: string;
        gameArea?: string;
        rank?: string;
        rankScore?: number;
        position?: string[];
      };
      tags: Array<{
        text: string;
        type: 'feature' | 'price' | 'skill' | 'badge';
        color?: string;
      }>;
      description: string;
      price: {
        amount: number;
        unit: 'per_game' | 'per_hour' | 'per_order';
        displayText: string;
      };
      distance?: number;
      stats: {
        orders: number;
        rating: number;
        reviewCount: number;
      };
    }>;
  };
}
```

#### 业务规则
1. skillType必填
2. 支持多维度筛选
3. 智能排序考虑评分/接单数/距离
4. 在线用户优先展示
5. pageSize范围5-20

---

### 3.2 获取服务详情

#### 接口定义
```
GET /api/service/detail?serviceId=123
```

#### 请求参数
```typescript
interface GetServiceDetailRequest {
  serviceId: number;
  userId?: number;              // 服务提供者ID(可选)
}
```

#### 响应数据
```typescript
interface GetServiceDetailResponse {
  code: number;
  message: string;
  data: {
    serviceId: number;
    provider: {
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      isOnline: boolean;
      isVerified: boolean;
      verifiedLabel?: string;
      level?: number;
    };
    bannerImage?: string;
    images?: string[];
    skillInfo: {
      skillType: string;
      skillLabel: string;
      gameArea?: string;
      rank?: string;
      rankScore?: number;
      rankDisplay?: string;
      position?: string[];
      voiceType?: string;
    };
    tags: Array<{text: string; type: string; color?: string}>;
    description: string;
    price: {
      amount: number;
      unit: 'per_game' | 'per_hour' | 'per_order';
      displayText: string;
    };
    schedule?: {available: string};
    location?: {
      address: string;
      district?: string;
      distance?: number;
    };
    stats: {
      orders: number;
      rating: number;
      reviewCount: number;
    };
    reviews: {
      total: number;
      summary: {
        excellent: number;
        positive: number;
        negative: number;
      };
      tags: Array<{text: string; count: number}>;
      recent: Array<{
        reviewId: number;
        reviewer: {userId: number; avatar: string; nickname: string};
        rating: number;
        content: string;
        images?: string[];
        createdAt: string;
        reply?: string;
      }>;
    };
    availability: {
      isAvailable: boolean;
      reason?: string;
    };
  };
}
```

#### 业务规则
1. 返回完整的服务信息
2. 包含最近2-3条评价
3. 实时计算可用性
4. 详情缓存10分钟

---

### 3.3 获取评价列表

#### 接口定义
```
GET /api/service/reviews?serviceId=123&pageNum=1&pageSize=20
```

#### 请求参数
```typescript
interface GetReviewsRequest {
  serviceId: number;
  pageNum: number;
  pageSize: number;
  filterBy?: 'all' | 'excellent' | 'positive' | 'negative';
}
```

#### 响应数据
```typescript
interface GetReviewsResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    summary: {
      averageRating: number;
      excellent: number;
      positive: number;
      negative: number;
    };
    tags: Array<{text: string; count: number}>;
    list: Array<{
      reviewId: number;
      reviewer: {userId: number; avatar: string; nickname: string};
      rating: number;
      content: string;
      images?: string[];
      createdAt: string;
      reply?: {content: string; createdAt: string};
    }>;
  };
}
```

#### 业务规则
1. 支持按评价类型筛选
2. 按时间倒序排列
3. 评价可包含图片(最多9张)
4. 服务者可回复评价

---

### 3.4 提交评价

#### 接口定义
```
POST /api/service/review/submit
Authorization: Bearer {token}
Content-Type: application/json
```

#### 请求参数
```typescript
interface SubmitReviewRequest {
  orderId: string;              // 订单ID
  serviceId: number;
  rating: number;               // 1-5星
  content: string;              // 评价内容
  images?: string[];            // 评价图片(最多9张)
  tags?: string[];              // 评价标签
}
```

#### 响应数据
```typescript
interface SubmitReviewResponse {
  code: number;
  message: string;
  data: {
    reviewId: number;
    success: boolean;
  };
}
```

#### 业务规则
1. 只能评价已完成的订单
2. 每个订单只能评价一次
3. rating: 1-5星
4. content: 0-500字符
5. 评价后不可修改

---

## 4. 数据模型

### 4.1 服务表 (service)

```sql
CREATE TABLE service (
  id BIGINT PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT '服务提供者ID',
  skill_type VARCHAR(50) NOT NULL COMMENT '技能类型',
  game_area VARCHAR(50) COMMENT '游戏大区',
  rank_level VARCHAR(50) COMMENT '段位',
  rank_score INT COMMENT '段位分数',
  positions JSON COMMENT '擅长位置数组',
  voice_type VARCHAR(50) COMMENT '声音类型',
  description VARCHAR(500),
  images JSON COMMENT '服务图片数组',
  banner_image VARCHAR(512),
  price_amount DECIMAL(10,2) NOT NULL,
  price_unit VARCHAR(20) NOT NULL,
  tags JSON COMMENT '服务标签数组',
  schedule VARCHAR(255) COMMENT '服务时间',
  location_address VARCHAR(255),
  location_point POINT,
  status VARCHAR(20) DEFAULT 'available' COMMENT 'available/unavailable/offline',
  total_orders INT DEFAULT 0,
  rating_score DECIMAL(3,2) DEFAULT 5.0,
  review_count INT DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_provider (provider_id),
  INDEX idx_skill_type (skill_type),
  INDEX idx_status (status),
  INDEX idx_rating (rating_score),
  SPATIAL INDEX idx_location (location_point)
) ENGINE=InnoDB COMMENT='服务表';
```

### 4.2 服务评价表 (service_review)

```sql
CREATE TABLE service_review (
  id BIGINT PRIMARY KEY,
  service_id BIGINT NOT NULL,
  order_id VARCHAR(50) NOT NULL,
  reviewer_id BIGINT NOT NULL,
  provider_id BIGINT NOT NULL,
  rating INT NOT NULL COMMENT '评分1-5',
  content VARCHAR(500),
  images JSON COMMENT '评价图片数组',
  tags JSON COMMENT '评价标签数组',
  reply_content VARCHAR(500) COMMENT '服务者回复',
  reply_time DATETIME,
  status TINYINT DEFAULT 1 COMMENT '状态:1正常 0已删除',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_order_id (order_id),
  INDEX idx_service_id (service_id),
  INDEX idx_reviewer_id (reviewer_id),
  INDEX idx_provider_id (provider_id),
  INDEX idx_rating (rating),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='服务评价表';
```

### 4.3 评价统计表 (service_review_stats)

```sql
CREATE TABLE service_review_stats (
  id BIGINT PRIMARY KEY,
  service_id BIGINT UNIQUE NOT NULL,
  total_reviews INT DEFAULT 0,
  total_rating INT DEFAULT 0,
  average_rating DECIMAL(3,2) DEFAULT 5.0,
  excellent_count INT DEFAULT 0 COMMENT '好评数(5星)',
  positive_count INT DEFAULT 0 COMMENT '中评数(3-4星)',
  negative_count INT DEFAULT 0 COMMENT '差评数(1-2星)',
  tag_summary JSON COMMENT '标签统计JSON',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_service_id (service_id),
  INDEX idx_average_rating (average_rating)
) ENGINE=InnoDB COMMENT='评价统计表';
```

---

## 5. 依赖服务

### 5.1 调用的服务
- **UserService**: 获取用户信息
- **LocationService**: 距离计算
- **OrderService**: 验证订单状态

### 5.2 被调用的服务
- **OrderService**: 下单时查询服务详情

---

## 6. 性能要求

### 6.1 QPS要求
- 服务列表: 500 QPS
- 服务详情: 300 QPS
- 评价列表: 200 QPS
- 提交评价: 50 QPS

### 6.2 响应时间
- 服务列表: P95 < 200ms
- 服务详情: P95 < 150ms
- 评价列表: P95 < 200ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 服务列表缓存
```
Key: service:list:{skillType}:{filters}:{page}
Value: 服务列表JSON
TTL: 5分钟
```

#### 服务详情缓存
```
Key: service:detail:{serviceId}
Value: 服务详情JSON
TTL: 10分钟
更新策略: 评价提交时清除
```

---

## 8. 监控告警

### 8.1 关键指标
- **服务列表加载成功率**: > 99.5%
- **平均评分**: > 4.5星
- **差评率**: < 5%
- **平均响应时间**: < 200ms

### 8.2 告警规则
1. 列表加载失败率 > 0.5% - P1
2. 平均评分 < 4.0星 - P3
3. 差评率 > 10% - P3
