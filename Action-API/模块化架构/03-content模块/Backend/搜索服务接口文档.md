# SearchService - 搜索服务接口文档

## 1. 服务概述

### 1.1 服务职责
SearchService是平台的搜索引擎服务,负责:
- 搜索初始化与历史管理
- 搜索建议(实时补全)
- 综合搜索执行(全部/用户/下单/话题)
- 4个Tab结果接口
- 搜索历史管理

### 1.2 技术栈
- **框架**: Spring Boot 3.2.0 + Spring Cloud 2023.0.3
- **搜索引擎**: Elasticsearch 8.x
- **分词**: IK Analyzer
- **缓存**: Redis 7.0+ (热搜/历史缓存)
- **数据库**: MySQL 8.0+ (搜索日志)

### 1.3 服务信息
- **服务名**: xypai-search
- **端口**: 9407
- **数据库**: xypai_search

---

## 2. 接口列表

### 2.1 对外API (HTTP)

| 接口名称 | 方法 | 路径 | 描述 | 权限 |
|---------|------|------|------|------|
| 搜索初始化 | GET | `/api/search/init` | 获取历史和热搜 | 需登录 |
| 搜索建议 | GET | `/api/search/suggest` | 实时搜索建议 | 公开 |
| 执行搜索 | POST | `/api/search/search` | 执行综合搜索 | 公开 |
| 全部Tab结果 | GET | `/api/search/all` | 获取全部搜索结果 | 公开 |
| 用户Tab结果 | GET | `/api/search/users` | 搜索用户 | 公开 |
| 下单Tab结果 | GET | `/api/search/orders` | 搜索可下单用户 | 公开 |
| 话题Tab结果 | GET | `/api/search/topics` | 搜索话题 | 公开 |
| 删除搜索历史 | DELETE | `/api/search/history` | 删除历史记录 | 需登录 |

---

## 3. 接口详细定义

### 3.1 搜索初始化

#### 接口定义
```
GET /api/search/init
Authorization: Bearer {token}
```

#### 响应数据
```typescript
interface SearchInitResponse {
  code: number;
  message: string;
  data: {
    searchHistory: Array<{
      keyword: string;
      searchTime: string;
      type?: string;
    }>;
    hotKeywords: Array<{
      keyword: string;
      rank?: number;
      isHot?: boolean;
    }>;
    placeholder: string;
  };
}
```

#### 业务规则
1. 搜索历史最多显示10条
2. 按时间倒序排列
3. 热搜词实时更新
4. 历史记录缓存1天

---

### 3.2 搜索建议

#### 接口定义
```
GET /api/search/suggest?keyword=王者&limit=10
```

#### 请求参数
```typescript
interface SearchSuggestRequest {
  keyword: string;              // 关键词,至少1个字符
  limit?: number;               // 建议数量(默认10)
}
```

#### 响应数据
```typescript
interface SearchSuggestResponse {
  code: number;
  message: string;
  data: {
    suggestions: Array<{
      text: string;
      type: 'user' | 'topic' | 'keyword';
      highlight?: string;
      icon?: string;
      extra?: string;
    }>;
  };
}
```

#### 业务规则
1. 使用Elasticsearch completion suggester
2. 支持拼音搜索
3. 防抖300ms
4. keyword长度1-50字符

---

### 3.3 执行搜索

#### 接口定义
```
POST /api/search/search
Content-Type: application/json
```

#### 请求参数
```typescript
interface ExecuteSearchRequest {
  keyword: string;
  type: 'all' | 'user' | 'order' | 'topic';
  pageNum: number;
  pageSize: number;
  filters?: {
    cityCode?: string;
    districtCode?: string;
    gender?: 'all' | 'male' | 'female';
    sortBy?: string;
  };
}
```

#### 响应数据
```typescript
interface ExecuteSearchResponse {
  code: number;
  message: string;
  data: {
    keyword: string;
    total: number;
    hasMore: boolean;
    tabs: Array<{
      type: string;
      label: string;
      count: number;
    }>;
    results: any;               // 根据type不同
  };
}
```

#### 业务规则
1. 自动保存搜索历史
2. 支持模糊匹配
3. 支持分词搜索
4. 关键词高亮显示

---

### 3.4 全部Tab结果

#### 接口定义
```
GET /api/search/all?keyword=王者&pageNum=1&pageSize=20
```

#### 请求参数
```typescript
interface SearchAllRequest {
  keyword: string;
  pageNum: number;
  pageSize: number;
}
```

#### 响应数据
```typescript
interface SearchAllResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      itemType: 'post' | 'video' | 'user';
      itemId: number;
      post?: {
        postId: number;
        title?: string;
        description: string;
        thumbnail: string;
        mediaType: 'image' | 'video';
        isVideo: boolean;
        author: {
          userId: number;
          avatar: string;
          nickname: string;
        };
        stats: {
          likes: number;
          comments?: number;
          views?: number;
        };
      };
      user?: {
        userId: number;
        avatar: string;
        nickname: string;
        signature?: string;
        isVerified: boolean;
      };
    }>;
  };
}
```

#### 业务规则
1. 混合内容(帖子+视频+用户)
2. 综合排序(相关度+热度+时间)
3. 瀑布流展示

---

### 3.5 用户Tab结果

#### 接口定义
```
GET /api/search/users?keyword=昵称&pageNum=1&pageSize=15
```

#### 请求参数
```typescript
interface SearchUsersRequest {
  keyword: string;
  pageNum: number;
  pageSize: number;
  gender?: 'all' | 'male' | 'female';
}
```

#### 响应数据
```typescript
interface SearchUsersResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      userId: number;
      avatar: string;
      nickname: string;
      age?: number;
      gender: 'male' | 'female';
      signature?: string;
      isVerified: boolean;
      verifiedLabel?: string;
      relationStatus: 'none' | 'following' | 'followed' | 'mutual';
      tags?: string[];
      stats?: {
        followers?: number;
        posts?: number;
      };
    }>;
  };
}
```

#### 业务规则
1. 搜索昵称和个性签名
2. 实名认证用户优先
3. 支持性别筛选

---

### 3.6 下单Tab结果

#### 接口定义
```
GET /api/search/orders?keyword=王者&pageNum=1&pageSize=10
```

#### 请求参数
```typescript
interface SearchOrdersRequest {
  keyword: string;
  pageNum: number;
  pageSize: number;
  filters?: {
    cityCode?: string;
    districtCode?: string;
    gender?: string;
    priceRange?: string[];
    sortBy?: string;
  };
}
```

#### 响应数据
```typescript
interface SearchOrdersResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      userId: number;
      avatar: string;
      nickname: string;
      gender: 'male' | 'female';
      age?: number;
      distance: number;
      tags: Array<{
        text: string;
        type: 'feature' | 'price' | 'skill';
        color?: string;
      }>;
      description: string;
      price: {
        amount: number;
        unit: 'per_order' | 'per_hour' | 'per_game';
        displayText: string;
      };
      isOnline: boolean;
      skills?: Array<{name: string; level?: string}>;
      stats?: {
        orders?: number;
        rating?: number;
      };
    }>;
  };
}
```

#### 业务规则
1. 搜索技能服务提供者
2. 按相关度+评分+距离排序
3. 支持价格区间筛选

---

### 3.7 话题Tab结果

#### 接口定义
```
GET /api/search/topics?keyword=王者&pageNum=1&pageSize=10
```

#### 请求参数
```typescript
interface SearchTopicsRequest {
  keyword: string;
  pageNum: number;
  pageSize: number;
  sortBy?: 'relevance' | 'hot' | 'new';
}
```

#### 响应数据
```typescript
interface SearchTopicsResponse {
  code: number;
  message: string;
  data: {
    total: number;
    hasMore: boolean;
    list: Array<{
      topicId: number;
      topicName: string;
      icon?: string;
      description: string;
      isHot: boolean;
      hotLabel?: string;
      stats: {
        posts: number;
        views?: number;
        followers?: number;
      };
      category?: string;
    }>;
  };
}
```

#### 业务规则
1. 搜索话题名称和描述
2. 热门话题优先
3. 按相关度排序

---

### 3.8 删除搜索历史

#### 接口定义
```
DELETE /api/search/history
Content-Type: application/json
```

#### 请求参数
```typescript
interface DeleteHistoryRequest {
  keyword?: string;             // 删除指定关键词
  clearAll?: boolean;           // 清空所有历史
}
```

#### 响应数据
```typescript
interface DeleteHistoryResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
  };
}
```

---

## 4. 数据模型

### 4.1 搜索历史表 (search_history)

```sql
CREATE TABLE search_history (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  keyword VARCHAR(100) NOT NULL COMMENT '搜索关键词',
  normalized_keyword VARCHAR(100) COMMENT '归一化关键词',
  search_type VARCHAR(20) COMMENT '搜索类型',
  result_count INT DEFAULT 0 COMMENT '结果数量',
  click_position INT COMMENT '点击位置',
  has_click TINYINT DEFAULT 0 COMMENT '是否有点击',
  search_time DATETIME NOT NULL COMMENT '搜索时间',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_keyword (user_id, keyword),
  INDEX idx_search_time (search_time),
  INDEX idx_normalized_keyword (normalized_keyword)
) ENGINE=InnoDB COMMENT='搜索历史表'
PARTITION BY RANGE (YEAR(search_time)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p2026 VALUES LESS THAN (2027)
);
```

### 4.2 热搜表 (hot_search)

```sql
CREATE TABLE hot_search (
  id BIGINT PRIMARY KEY,
  keyword VARCHAR(100) UNIQUE NOT NULL,
  search_count INT DEFAULT 0 COMMENT '搜索次数',
  trend_score DECIMAL(10,2) COMMENT '趋势分数',
  ranking INT COMMENT '排名',
  prev_ranking INT COMMENT '前一天排名',
  is_rising TINYINT DEFAULT 0 COMMENT '是否上升',
  category VARCHAR(50),
  start_time DATETIME COMMENT '上榜时间',
  last_update DATETIME,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_ranking (ranking),
  INDEX idx_search_count (search_count),
  INDEX idx_trend_score (trend_score)
) ENGINE=InnoDB COMMENT='热搜表';
```

---

## 5. 依赖服务

### 5.1 调用的服务
- **UserService**: 获取用户信息
- **ContentService**: 获取内容信息
- **ServiceService**: 获取服务信息

### 5.2 被调用的服务
- 无(搜索服务独立)

---

## 6. 性能要求

### 6.1 QPS要求
- 搜索建议: 500 QPS
- 搜索执行: 300 QPS
- 搜索结果: 500 QPS

### 6.2 响应时间
- 搜索建议: P95 < 100ms
- 搜索执行: P95 < 300ms
- 搜索结果: P95 < 200ms

---

## 7. 缓存策略

### 7.1 Redis缓存

#### 热搜缓存
```
Key: search:hot:keywords
Value: 热搜列表JSON
TTL: 1小时
```

#### 搜索历史缓存
```
Key: search:history:{userId}
Value: 历史列表JSON
TTL: 1天
```

---

## 8. 监控告警

### 8.1 关键指标
- **搜索成功率**: > 99%
- **平均响应时间**: < 200ms
- **ES集群健康**: Green
- **搜索无结果率**: < 20%

### 8.2 告警规则
1. 搜索失败率 > 1% - P1
2. ES集群Yellow - P2
3. 响应时间 > 500ms - P2
