# 发现主页页面

## 概述

发现主页是用户浏览内容的核心页面,提供三种内容流(关注/热门/同城)供用户选择。用户可以在此页面浏览动态、查看视频、点赞收藏、关注用户等。页面支持下拉刷新、上拉加载更多,提供流畅的内容浏览体验。

**主要功能:**
- 三个Tab切换(关注/热门/同城)
- 动态流列表展示(瀑布流布局)
- 互动功能(点赞、收藏、分享、评论)
- 用户关注/取关
- 内容跳转(详情页、用户主页、话题详情)

**前置条件:**
- 热门Tab: 无需登录即可查看
- 关注Tab: 需要登录状态
- 同城Tab: 需要位置权限

---

## 页面结构

### 顶部导航栏

**布局:**
```
┌─────────────────────────────────────┐
│  关注    热门    同城          🔍   │
└─────────────────────────────────────┘
```

**组件:**
- Tab切换器(关注/热门/同城)
- 搜索/发布按钮(右上角)

**样式:**
- 高度: 56px
- 背景: 白色 (#FFFFFF)
- 底部分割线: 1px 浅灰色 (#F0F0F0)
- Tab选中状态: 紫色文字 + 下划线指示器
- Tab未选中: 深灰色文字

### 内容区域

**动态卡片布局:**
```
┌─────────────────────────────────────┐
│ [头像] 昵称 [标签] [关注]           │
│                                     │
│ 动态文字内容...                     │
│                                     │
│ [图片1] [图片2]                     │
│ [图片3]                             │
│                                     │
│ #话题标签#                          │
│                                     │
│ 📍 地点名称 · 500m                  │
│                                     │
│ ♡ 123  💬 45  ⤴ 12  ⭐             │
│                                     │
│ 5分钟前                             │
└─────────────────────────────────────┘
```

**卡片元素:**
1. 用户信息区
   - 头像(40x40px, 圆形)
   - 昵称(16pt, 加粗)
   - 认证标签(实名认证/大神认证/VIP)
   - 关注按钮(60x28px)

2. 内容区
   - 文字内容(最多3行, 超出显示"展开")
   - 媒体展示(图片网格/视频)
   - 话题标签(紫色, 可点击)
   - 地理位置(灰色, 显示距离)

3. 互动栏
   - 点赞图标+数量
   - 评论图标+数量
   - 分享图标+数量
   - 收藏图标

4. 时间显示
   - 相对时间("刚刚"/"5分钟前"/"2小时前")

### 加载状态

**首屏加载:**
- 显示3-5个骨架屏卡片
- 骨架屏动画: 渐变闪烁效果

**下拉刷新:**
- 下拉距离超过80px显示"释放刷新"
- 刷新中显示旋转动画

**上拉加载:**
- 显示"加载中..."文字+旋转图标
- 没有更多数据显示"没有更多了"

**空状态:**
- 关注Tab: "暂无关注的人,去发现更多精彩内容"
- 热门Tab: "暂无内容"
- 同城Tab: "附近暂无动态"

---

## 接口列表

### 1. 获取动态列表

**接口:** `GET /api/v1/content/feed/{tabType}`

**路径参数:**
- `tabType`: 'follow' | 'hot' | 'local' (关注/热门/同城)

**查询参数:**
```typescript
{
  page: number;        // 页码,从1开始
  pageSize: number;    // 每页数量,默认20

  // 同城Tab专用参数
  latitude?: number;   // 用户当前纬度(同城Tab必传)
  longitude?: number;  // 用户当前经度(同城Tab必传)
  radius?: number;     // 搜索半径(km),默认5km
}
```

**触发时机:**
- 页面初始化时
- 切换Tab时
- 下拉刷新时
- 上拉加载更多时

**后端服务:** ContentService (xypai-content)

---

### 2. 点赞/取消点赞

**接口:** `POST /api/v1/interaction/like`

**请求参数:**
```typescript
{
  targetType: 'feed';      // 固定值: feed
  targetId: string;        // 动态ID
  action: 'like' | 'unlike' // like=点赞, unlike=取消点赞
}
```

**触发时机:**
- 用户点击点赞图标(爱心)
- 再次点击取消点赞

**后端服务:** ContentService (xypai-content)

---

### 3. 收藏/取消收藏

**接口:** `POST /api/v1/interaction/collect`

**请求参数:**
```typescript
{
  targetType: 'feed';            // 固定值: feed
  targetId: string;              // 动态ID
  action: 'collect' | 'uncollect' // collect=收藏, uncollect=取消收藏
}
```

**触发时机:**
- 用户点击收藏图标(星星)
- 再次点击取消收藏

**后端服务:** ContentService (xypai-content)

---

### 4. 分享动态

**接口:** `POST /api/v1/interaction/share`

**请求参数:**
```typescript
{
  targetType: 'feed';      // 固定值: feed
  targetId: string;        // 动态ID
  shareChannel: string;    // 分享渠道
  // 可选值: 'wechat' | 'moments' | 'qq' | 'qzone' | 'weibo' | 'copy_link'
}
```

**触发时机:**
- 用户选择分享渠道后

**后端服务:** ContentService (xypai-content)

---

### 5. 关注/取关用户

**接口:** `POST /api/v1/user/follow`

**请求参数:**
```typescript
{
  targetUserId: string;         // 目标用户ID
  action: 'follow' | 'unfollow' // follow=关注, unfollow=取关
}
```

**触发时机:**
- 用户点击"关注"按钮
- 用户点击"已关注"按钮

**后端服务:** UserService (xypai-user) - RPC调用

---

## 数据流

### 页面初始化流程

```
1. 用户进入发现主页
   ↓
2. 检查默认Tab(热门)
   ↓
3. 调用获取动态列表接口
   GET /api/v1/content/feed/hot?page=1&pageSize=20
   ↓
4. ContentService处理请求
   - 从数据库查询热门动态
   - 调用UserService.getUserInfo()获取用户信息(RPC)
   - 组装Feed数据
   ↓
5. 返回动态列表
   {
     code: 200,
     data: {
       list: Feed[],
       total: number,
       hasMore: boolean
     }
   }
   ↓
6. 前端渲染动态卡片
   - 显示用户信息
   - 渲染媒体内容
   - 显示互动数据
```

### Tab切换流程

```
1. 用户点击Tab(关注/同城)
   ↓
2. 关注Tab: 检查登录状态
   - 未登录: 显示登录提示
   - 已登录: 继续下一步
   ↓
3. 同城Tab: 检查位置权限
   - 未授权: 显示授权提示
   - 已授权: 获取当前位置
   ↓
4. Tab指示器动画(200ms)
   ↓
5. 检查缓存数据
   - 有缓存: 直接显示
   - 无缓存: 显示骨架屏
   ↓
6. 调用对应Tab接口
   - 关注: GET /api/v1/content/feed/follow
   - 同城: GET /api/v1/content/feed/local?latitude=x&longitude=y
   ↓
7. 渲染新数据
```

### 点赞交互流程(乐观更新)

```
1. 用户点击点赞图标
   ↓
2. 检查登录状态
   - 未登录: 弹出登录提示,终止流程
   - 已登录: 继续
   ↓
3. 乐观更新UI
   - 立即切换图标: 空心 → 实心红色
   - 立即更新点赞数: +1
   - 播放点赞动画(心跳效果)
   ↓
4. 调用点赞接口(异步)
   POST /api/v1/interaction/like
   {
     targetType: 'feed',
     targetId: 'xxx',
     action: 'like'
   }
   ↓
5. ContentService处理
   - 验证用户登录状态
   - 检查是否已点赞
   - 更新点赞记录
   - 更新点赞计数
   ↓
6. 返回结果
   成功: {
     code: 200,
     data: {
       success: true,
       likeCount: 124,
       isLiked: true
     }
   }
   ↓
7. 前端处理响应
   - 成功: 保持乐观更新的UI状态
   - 失败: 回滚UI状态
     * 图标: 实心红色 → 空心
     * 点赞数: -1
     * 显示错误Toast
```

### 下拉刷新流程

```
1. 用户在列表顶部下拉
   ↓
2. 下拉距离超过阈值(80px)
   - 显示"释放刷新"提示
   ↓
3. 用户释放手指
   - 显示刷新动画
   ↓
4. 调用当前Tab的第1页接口
   GET /api/v1/content/feed/{tabType}?page=1&pageSize=20
   ↓
5. 成功后
   - 清空现有列表
   - 显示新数据
   - 收起刷新动画
   - 显示"刷新成功"Toast
   ↓
6. 失败后
   - 保留现有数据
   - 收起刷新动画
   - 显示错误Toast
```

### 上拉加载更多流程

```
1. 用户滚动到列表底部
   - 距离底部200px时自动触发
   ↓
2. 检查加载状态
   - 正在加载: 忽略
   - hasMore=false: 显示"没有更多了"
   - 可以加载: 继续
   ↓
3. 显示"加载中..."提示
   ↓
4. 调用下一页接口
   GET /api/v1/content/feed/{tabType}?page=2&pageSize=20
   ↓
5. 成功后
   - 追加新数据到列表末尾
   - 隐藏加载提示
   - 更新hasMore状态
   ↓
6. 失败后
   - 显示"加载失败,点击重试"
   - 点击后重新加载
```

---

## 状态管理

### 页面状态定义

```typescript
interface DiscoveryMainPageState {
  // UI状态
  activeTab: 'follow' | 'hot' | 'local';
  loading: boolean;
  refreshing: boolean;
  error: Error | null;

  // 数据状态
  feedData: {
    followFeeds: Feed[];
    hotFeeds: Feed[];
    localFeeds: Feed[];
    hasMore: {
      follow: boolean;
      hot: boolean;
      local: boolean;
    };
    page: {
      follow: number;
      hot: number;
      local: number;
    };
  };

  // 用户位置(同城Tab使用)
  userLocation: {
    latitude: number;
    longitude: number;
  } | null;
}
```

### 初始状态

```typescript
const initialState: DiscoveryMainPageState = {
  activeTab: 'hot',
  loading: false,
  refreshing: false,
  error: null,

  feedData: {
    followFeeds: [],
    hotFeeds: [],
    localFeeds: [],
    hasMore: {
      follow: true,
      hot: true,
      local: true,
    },
    page: {
      follow: 1,
      hot: 1,
      local: 1,
    },
  },

  userLocation: null,
};
```

### 状态更新

**切换Tab:**
```typescript
const handleTabChange = (tab: 'follow' | 'hot' | 'local') => {
  setState({
    ...state,
    activeTab: tab
  });

  // 如果该Tab无数据,加载数据
  if (state.feedData[`${tab}Feeds`].length === 0) {
    loadFeedData(tab);
  }
};
```

**加载动态数据:**
```typescript
const loadFeedData = async (tab: string, page: number = 1) => {
  setState({ ...state, loading: true });

  try {
    const response = await getFeedList(tab, page);

    if (response.code === 200) {
      setState({
        ...state,
        loading: false,
        feedData: {
          ...state.feedData,
          [`${tab}Feeds`]: page === 1
            ? response.data.list
            : [...state.feedData[`${tab}Feeds`], ...response.data.list],
          hasMore: {
            ...state.feedData.hasMore,
            [tab]: response.data.hasMore
          },
          page: {
            ...state.feedData.page,
            [tab]: page
          }
        }
      });
    }
  } catch (error) {
    setState({
      ...state,
      loading: false,
      error: error
    });
  }
};
```

**乐观更新点赞状态:**
```typescript
const handleLike = async (feedId: string, currentIsLiked: boolean) => {
  // 1. 乐观更新UI
  const newIsLiked = !currentIsLiked;
  updateFeedInList(feedId, {
    isLiked: newIsLiked,
    likeCount: currentIsLiked ? -1 : +1
  });

  // 2. 调用接口
  try {
    const response = await likeContent('feed', feedId, newIsLiked ? 'like' : 'unlike');

    if (response.code !== 200) {
      // 失败: 回滚UI
      updateFeedInList(feedId, {
        isLiked: currentIsLiked,
        likeCount: currentIsLiked ? +1 : -1
      });
      showToast(response.message);
    }
  } catch (error) {
    // 异常: 回滚UI
    updateFeedInList(feedId, {
      isLiked: currentIsLiked,
      likeCount: currentIsLiked ? +1 : -1
    });
    showToast('网络异常,请重试');
  }
};
```

---

## 前端验证

### Tab切换验证

```typescript
// 关注Tab需要登录
const canViewFollowTab = () => {
  if (!isLoggedIn) {
    showLoginPrompt({
      title: '请先登录',
      message: '登录后可以查看关注的内容',
      confirmText: '立即登录',
      cancelText: '取消'
    });
    return false;
  }
  return true;
};

// 同城Tab需要位置权限
const canViewLocalTab = async () => {
  const hasPermission = await checkLocationPermission();
  if (!hasPermission) {
    showLocationPermissionPrompt({
      title: '需要位置权限',
      message: '开启位置权限后可以查看同城内容',
      confirmText: '去设置',
      cancelText: '取消'
    });
    return false;
  }
  return true;
};
```

### 互动操作验证

```typescript
// 点赞/收藏/关注需要登录
const canInteract = () => {
  if (!isLoggedIn) {
    showLoginPrompt({
      title: '请先登录',
      message: '登录后可以进行互动操作',
      confirmText: '立即登录',
      cancelText: '取消'
    });
    return false;
  }
  return true;
};
```

### 位置获取验证

```typescript
const getCurrentLocation = async () => {
  try {
    const location = await getLocation();
    return {
      latitude: location.coords.latitude,
      longitude: location.coords.longitude,
    };
  } catch (error) {
    if (error.code === 'PERMISSION_DENIED') {
      showLocationPermissionPrompt();
    } else {
      showErrorToast('位置获取失败,请重试');
    }
    return null;
  }
};
```

---

## 交互行为

### 1. Tab切换

**触发:** 点击Tab标签

**行为:**
1. Tab指示器滑动到选中位置(动画200ms)
2. 文字颜色和粗细变化
3. 关注Tab: 检查登录状态
4. 同城Tab: 检查位置权限并获取位置
5. 切换内容区域:
   - 有缓存数据: 直接显示
   - 无缓存数据: 显示骨架屏,调用接口
6. 更新URL路由参数(可选)

**防抖:**
- 切换动画进行中禁止再次切换

---

### 2. 下拉刷新

**触发:** 在列表顶部下拉

**行为:**
1. 下拉距离超过80px显示"释放刷新"提示
2. 释放后触发刷新
3. 显示刷新动画
4. 调用当前Tab的第1页接口
5. 成功后:
   - 清空现有列表
   - 显示新数据
   - 收起刷新动画
   - 显示"刷新成功"Toast
6. 失败后:
   - 保留现有数据
   - 收起刷新动画
   - 显示错误Toast

---

### 3. 上拉加载更多

**触发:** 滚动到列表底部

**行为:**
1. 距离底部200px时自动触发
2. 显示"加载中..."提示
3. 调用当前Tab的下一页接口
4. 成功后:
   - 追加新数据到列表末尾
   - 隐藏加载提示
5. 失败后:
   - 显示"加载失败,点击重试"
   - 点击后重新加载
6. 没有更多数据(hasMore=false):
   - 显示"没有更多了"
   - 禁止继续加载

**防重复加载:**
- 使用loading标志位控制
- 加载中时不触发新的加载请求

---

### 4. 点赞交互

**触发:** 点击爱心图标

**乐观更新流程:**
1. 检查登录状态(未登录弹出登录提示)
2. 立即切换图标状态(空心 ↔ 实心红色)
3. 立即更新点赞数(+1 或 -1)
4. 播放点赞动画:
   - 图标放大1.2倍(100ms)
   - 恢复原大小(100ms)
   - 粒子扩散效果(可选)
5. 调用点赞接口
6. 接口成功: 保持UI状态
7. 接口失败:
   - 回滚图标状态
   - 回滚点赞数
   - 显示错误Toast

**防抖:**
- 1秒内只允许一次接口调用
- 但UI立即响应

---

### 5. 收藏交互

**触发:** 点击收藏图标

**行为:** (同点赞交互)
1. 检查登录状态
2. 乐观更新UI(空心 ↔ 实心金色)
3. 播放收藏动画
4. 调用接口
5. 失败时回滚

---

### 6. 分享交互

**触发:** 点击分享图标

**行为:**
1. 打开底部分享面板(从底部滑入,动画300ms)
2. 显示分享选项网格:
   ```
   [微信好友] [朋友圈]  [QQ好友]
   [新浪微博] [复制链接] [取消]
   ```
3. 点击某个分享方式:
   - 调用分享接口获取链接
   - 调用对应平台SDK分享
   - 或复制链接到剪贴板
4. 分享成功:
   - 更新分享数(+1)
   - 显示"分享成功"Toast
   - 关闭分享面板
5. 分享失败:
   - 显示"分享失败"Toast
   - 关闭分享面板

---

### 7. 评论交互

**触发:** 点击评论图标

**行为:**
1. 跳转到动态详情页
2. 传递feedId参数
3. 详情页自动聚焦评论输入框

---

### 8. 关注交互

**触发:** 点击关注/已关注按钮

**行为:**
1. 检查登录状态
2. 未登录: 弹出登录提示
3. 已登录:
   - 乐观更新按钮状态("关注" ↔ "已关注")
   - 调用关注接口(RPC到UserService)
   - 成功: 显示"关注成功"Toast
   - 失败: 回滚按钮状态,显示错误Toast
4. 如果在关注Tab且取消关注:
   - 可选择从列表移除该动态

---

### 9. 图片预览

**触发:** 点击图片

**行为:**
1. 打开全屏图片查看器
2. 显示当前图片
3. 支持左右滑动查看其他图片
4. 支持双击放大/缩小
5. 支持双指缩放
6. 显示图片序号(如: 1/3)
7. 提供下载/保存按钮(可选)
8. 点击空白区域或返回按钮关闭

---

### 10. 视频播放

**触发:** 点击视频封面

**行为:**
1. 在卡片内播放(小窗模式):
   - 显示播放控件
   - 自动播放
   - 其他视频自动暂停
2. 或跳转到全屏播放页面:
   - 显示完整播放控件
   - 支持清晰度切换
   - 支持播放速度调节

---

## 测试要点

### 功能测试
- [ ] Tab切换功能正常
- [ ] 关注Tab登录验证
- [ ] 同城Tab位置权限验证
- [ ] 首屏数据加载正常
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多正常
- [ ] 点赞/取消点赞功能正常
- [ ] 收藏/取消收藏功能正常
- [ ] 分享功能正常
- [ ] 关注/取关功能正常
- [ ] 评论跳转正常
- [ ] 用户主页跳转正常
- [ ] 话题详情跳转正常
- [ ] 动态详情跳转正常

### 边界测试
- [ ] 网络异常处理
- [ ] 数据为空处理
- [ ] 加载失败重试
- [ ] 互动操作失败回滚
- [ ] 快速切换Tab
- [ ] 快速重复点赞/收藏
- [ ] 滚动到底部边界
- [ ] 位置获取失败处理

### 性能测试
- [ ] 大列表滚动流畅性
- [ ] 图片加载性能
- [ ] 内存占用控制
- [ ] 动画流畅度
- [ ] Tab切换响应速度

### 兼容性测试
- [ ] iOS系统 (13+)
- [ ] Android系统 (8+)
- [ ] 不同屏幕尺寸
- [ ] 横屏模式
- [ ] 深色模式(可选)

---

## 使用的后端服务

### ContentService (xypai-content, port 8003)

**调用的接口:**
1. `GET /api/v1/content/feed/{tabType}` - 获取动态列表
2. `POST /api/v1/interaction/like` - 点赞/取消点赞
3. `POST /api/v1/interaction/collect` - 收藏/取消收藏
4. `POST /api/v1/interaction/share` - 分享动态

**RPC调用:**
- ContentService内部调用UserService.getUserInfo()获取用户信息

---

### UserService (xypai-user, port 8002)

**调用的接口:**
1. `POST /api/v1/user/follow` - 关注/取关用户

**RPC提供:**
- UserService.getUserInfo(userId) - 供ContentService调用

---

## 相关页面

### 前置页面
- 无(发现主页为应用核心入口之一)

### 后续页面
1. **动态详情页面** (`03-动态详情页面.md`)
   - 跳转方式: 点击动态卡片
   - 传递参数: feedId

2. **发布动态页面** (`02-发布动态页面.md`)
   - 跳转方式: 点击右上角发布按钮
   - 传递参数: 无

3. **用户主页页面** (在02-user模块)
   - 跳转方式: 点击用户头像/昵称
   - 传递参数: userId

4. **话题详情页面** (待创建)
   - 跳转方式: 点击话题标签
   - 传递参数: topicName

5. **登录页面** (在01-auth模块)
   - 跳转方式: 未登录时点击需登录操作
   - 传递参数: 无

---

## TypeScript类型定义

```typescript
// Feed数据结构
interface Feed {
  id: string;
  userId: string;
  type: number;              // 1=动态,2=活动,3=技能
  typeDesc: string;
  title?: string;
  summary?: string;
  content: string;
  coverImage?: string;

  userInfo: {
    id: string;
    nickname: string;
    avatar: string;
    gender?: 'male' | 'female';
    age?: number;
    isFollowed: boolean;
    isRealVerified?: boolean;
    isGodVerified?: boolean;
    isVip?: boolean;
    isPopular?: boolean;
  };

  mediaList: Array<{
    id: string;
    type: 'image' | 'video';
    url: string;
    thumbnailUrl?: string;
    width: number;
    height: number;
    duration?: number;
  }>;

  topicList: Array<{
    name: string;
    description?: string;
    participantCount: number;
    postCount: number;
  }>;

  locationName?: string;
  locationAddress?: string;
  longitude?: number;
  latitude?: number;
  distance?: number;
  cityId?: number;

  likeCount: number;
  commentCount: number;
  shareCount: number;
  collectCount: number;
  viewCount: number;

  isLiked: boolean;
  isCollected: boolean;

  createdAt: number;
  updatedAt: number;
}

// 动态列表响应
interface FeedListResponse {
  code: number;
  message: string;
  data: {
    list: Feed[];
    total: number;
    hasMore: boolean;
  } | null;
}

// 互动响应
interface InteractionResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    likeCount?: number;
    collectCount?: number;
    shareCount?: number;
    isLiked?: boolean;
    isCollected?: boolean;
  } | null;
}

// 关注响应
interface FollowResponse {
  code: number;
  message: string;
  data: {
    success: boolean;
    isFollowed: boolean;
    followerCount: number;
    followingCount: number;
  } | null;
}
```
