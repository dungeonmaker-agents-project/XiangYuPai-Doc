# Content模块完成报告

## 📊 完成概况

**完成日期**: 2025-11-14
**模块**: 03-content模块 (内容域)
**状态**: ✅ 文档创建完成

---

## ✅ 已完成文档清单

### Frontend文档 (3个)

1. **✅ [01-发现主页页面.md](./Frontend/01-发现主页页面.md)**
   - 路由: `/discover/main`
   - 功能: 发现主页,包含**关注/热门/同城3个Tab**,动态Feed流
   - API: `GET /api/v1/content/feed/{tabType}`, `POST /api/v1/interaction/like`, `POST /api/v1/interaction/collect`
   - 特色: 3 Tab切换、乐观更新UI、下拉刷新、无限滚动

2. **✅ [02-发布动态页面.md](./Frontend/02-发布动态页面.md)**
   - 路由: `/content/publish`
   - 功能: 发布动态,支持**文字+图片(最多9张)或视频(1个)+话题(最多5个)+地点**
   - API: `POST /api/v1/content/publish`, `POST /api/v1/media/upload`, `GET /api/v1/content/topics/hot`
   - 特色: 实时字符计数、图片压缩、话题选择、地点选择、草稿保存

3. **✅ [03-动态详情页面.md](./Frontend/03-动态详情页面.md)**
   - 路由: `/content/detail/{feedId}`
   - 功能: 动态详情、**一级评论+二级回复**、互动操作、举报
   - API: `GET /api/v1/content/detail/{feedId}`, `GET /api/v1/content/comments/{feedId}`, `POST /api/v1/content/comment`
   - 特色: 评论嵌套结构、实时评论发布、图片查看器、视频播放

### Backend文档 (1个 + 3个common)

4. **✅ [Backend/ContentService后端服务.md](./Backend/ContentService后端服务.md)**
   - 服务名: ContentService (内容服务)
   - 端口: 8003
   - 数据库: xypai_content
   - **对外API**: 15个
   - **RPC接口**: 3个(getUserFeeds, getUserCollections, getUserLikes)
   - 总计: **18个接口**

5. **✅ [06-common模块/Backend/MediaUploadService后端服务.md](../../06-common模块/Backend/MediaUploadService后端服务.md)**
   - 服务名: MediaUploadService (媒体上传服务)
   - 端口: 8006
   - 数据库: xypai_common
   - **对外API**: 2个
   - **RPC接口**: 4个
   - 特色: 图片压缩(Sharp)、视频封面生成(FFmpeg)、OSS存储

6. **✅ [06-common模块/Backend/LocationService后端服务.md](../../06-common模块/Backend/LocationService后端服务.md)**
   - 服务名: LocationService (位置服务)
   - 端口: 8007
   - 数据库: xypai_common
   - **对外API**: 5个
   - **RPC接口**: 4个
   - 特色: Geohash索引、Haversine距离计算、高德地图API集成

7. **✅ [06-common模块/Backend/ReportService后端服务.md](../../06-common模块/Backend/ReportService后端服务.md)**
   - 服务名: ReportService (举报审核服务)
   - 端口: 8008
   - 数据库: xypai_common
   - **对外API**: 5个
   - **RPC接口**: 4个
   - 特色: 自动审核、优先级队列、处罚管理、统计分析

---

## 📋 API清单

### ContentService对外API (15个)

| # | API路径 | 方法 | 功能 |
|---|---------|------|------|
| 1 | /api/v1/content/feed/{tabType} | GET | 获取动态列表(follow/hot/local) |
| 2 | /api/v1/content/detail/{feedId} | GET | 获取动态详情 |
| 3 | /api/v1/content/publish | POST | 发布动态 |
| 4 | /api/v1/content/{feedId} | DELETE | 删除动态 |
| 5 | /api/v1/content/comments/{feedId} | GET | 获取评论列表 |
| 6 | /api/v1/content/comment | POST | 发布评论 |
| 7 | /api/v1/content/comment/{commentId} | DELETE | 删除评论 |
| 8 | /api/v1/content/topics/hot | GET | 获取热门话题 |
| 9 | /api/v1/content/topics/search | GET | 搜索话题 |
| 10 | /api/v1/interaction/like | POST | 点赞/取消点赞 |
| 11 | /api/v1/interaction/collect | POST | 收藏/取消收藏 |
| 12 | /api/v1/interaction/share | POST | 分享 |
| 13 | /api/v1/interaction/distance/batch | POST | 批量距离计算 |
| 14 | /api/v1/content/report | POST | 举报内容/用户 |
| 15 | /api/v1/user/reports | GET | 查看我的举报记录 |

### ContentService RPC接口 (3个)

| # | 方法 | 调用方 | 功能 |
|---|------|--------|------|
| 1 | getUserFeeds() | UserService | 获取用户动态列表 |
| 2 | getUserCollections() | UserService | 获取用户收藏列表 |
| 3 | getUserLikes() | UserService | 获取用户点赞列表 |

### MediaUploadService API (2个对外 + 4个RPC)

**对外API:**
1. `POST /api/v1/media/upload` - 上传图片/视频
2. `POST /api/v1/media/upload/batch` - 批量上传图片

**RPC接口:**
1. `uploadMedia()` - 上传单个文件
2. `uploadMediaBatch()` - 批量上传
3. `deleteMedia()` - 删除媒体
4. `getMediaInfo()` - 获取媒体信息

### LocationService API (5个对外 + 4个RPC)

**对外API:**
1. `GET /api/v1/location/nearby` - 获取附近地点
2. `GET /api/v1/location/search` - 搜索地点
3. `GET /api/v1/location/geocode` - 地理编码(地址→坐标)
4. `GET /api/v1/location/regeocode` - 逆地理编码(坐标→地址)
5. `POST /api/v1/location/distance/batch` - 批量距离计算

**RPC接口:**
1. `getNearbyLocations()` - 获取附近地点
2. `searchLocations()` - 搜索地点
3. `geocode()` - 地理编码
4. `calculateDistance()` - 计算距离

### ReportService API (5个对外 + 4个RPC)

**对外API:**
1. `POST /api/v1/report/submit` - 提交举报
2. `GET /api/v1/report/my-reports` - 查看我的举报记录
3. `POST /api/v1/report/moderate` - 审核举报(管理员)
4. `GET /api/v1/report/queue` - 获取待审核队列(管理员)
5. `GET /api/v1/report/statistics` - 获取举报统计(管理员)

**RPC接口:**
1. `submitReport()` - 提交举报
2. `getReports()` - 查询举报记录
3. `checkPunishment()` - 检查是否被处罚
4. `moderateReport()` - 审核举报

---

## 🎯 核心特性

### 1. 多Tab Feed流
- **关注Tab**: 显示关注用户的动态,按时间倒序排序
- **热门Tab**: 推荐算法排序,热度分 = 点赞×1 + 评论×2 + 分享×3 + 收藏×2
- **同城Tab**: 基于地理位置推荐,Geohash快速查询,支持半径筛选
- **无限滚动**: 上拉加载更多,下拉刷新

### 2. 完整发布流程
- **内容编辑**: 标题(0-50字符)、正文(1-1000字符,必填)
- **媒体上传**:
  - 图片: 最多9张,自动压缩(>2MB),支持多选
  - 视频: 最多1个,自动生成封面,时长1-300秒
  - 互斥验证: 图片和视频不能同时上传
- **话题选择**: 最多5个,支持搜索热门话题
- **地点选择**: 附近地点查询,支持搜索,显示距离
- **可见范围**: 公开/仅好友/仅自己

### 3. 评论系统
- **一级评论**: 支持置顶、排序(时间/热度/点赞数)
- **二级回复**: 嵌套显示,前3条自动展开,支持"展开更多"
- **实时发布**: 评论成功后立即插入列表顶部
- **点赞评论**: 支持对一级评论和二级回复点赞
- **删除权限**: 只能删除自己的评论,删除一级评论同时删除所有二级回复

### 4. 互动功能
- **乐观更新**: 点赞/收藏立即更新UI,失败时自动回滚
- **点赞**: 支持动态和评论点赞,去重验证
- **收藏**: 仅支持动态收藏,收藏后可在个人主页查看
- **分享**: 支持微信/朋友圈/QQ/微博/复制链接,记录分享渠道

### 5. 推荐算法
- **热度计算**: score = 点赞×1 + 评论×2 + 分享×3 + 收藏×2
- **时间衰减**: score × Math.pow(0.5, hoursSinceCreated / 24)
- **去重**: 已浏览动态不再推荐
- **个性化**: 基于用户关注、兴趣标签推荐

### 6. 内容审核
- **敏感词检测**: 使用bad-words-zh库
- **图像识别**: 接入阿里云内容安全API
- **举报系统**:
  - 8种举报类型(harassment/pornography/fraud等)
  - 优先级队列(illegal/pornography优先级最高)
  - 自动处理: 24小时内举报≥10次自动下架
  - 审核流程: pending → processing → approved/rejected
  - 处罚管理: takedown/mute/ban

---

## 📊 数据库设计

### xypai_content (8张表)

1. **feed** - 动态表
   - 基本信息: userId, type, title, content, coverImage
   - 地理位置: locationName, locationAddress, longitude, latitude, cityId
   - 统计数据: likeCount, commentCount, shareCount, collectCount, viewCount
   - 状态控制: visibility, status, deleted

2. **comment** - 评论表
   - 评论内容: feedId, userId, content
   - 回复关系: parentId, replyToUserId
   - 统计数据: likeCount, replyCount, isTop

3. **topic** - 话题表
   - 话题信息: name(unique), description, coverImage
   - 统计数据: participantCount, postCount
   - 标记: isOfficial, isHot

4. **feed_topic** - 动态话题关联表
   - feedId, topicName

5. **feed_media** - 动态媒体关联表
   - feedId, mediaId, mediaType, sortOrder

6. **like** - 点赞表
   - userId, targetType, targetId (unique)

7. **collection** - 收藏表
   - userId, targetType, targetId (unique)

8. **share** - 分享表
   - userId, targetType, targetId, shareChannel

### xypai_common (3张表 - 在common模块)

1. **media** - 媒体表 (MediaUploadService)
   - id, type, url, thumbnailUrl, width, height, duration, fileSize

2. **location** - 地点表 (LocationService)
   - id, name, address, latitude, longitude, geohash, category

3. **report** - 举报表 (ReportService)
   - userId, targetType, targetId, reasonType, description, evidenceImages, status

4. **punishment** - 处罚表 (ReportService)
   - reportId, targetType, targetId, punishmentType, duration, reason

---

## 🔗 服务依赖关系

### ContentService 依赖

```
ContentService
  → UserService (RPC, 02-user模块)
    - getUserInfo() - 获取用户信息
    - getBatchUserInfo() - 批量获取用户信息
    - getFollowingList() - 获取关注列表

  → MediaUploadService (RPC, 06-common模块)
    - uploadMedia() - 上传图片/视频
    - deleteMedia() - 删除媒体

  → LocationService (RPC, 06-common模块)
    - getNearbyLocations() - 获取附近地点
    - searchLocations() - 搜索地点

  → ReportService (RPC, 06-common模块)
    - submitReport() - 提交举报
    - checkPunishment() - 检查是否被处罚
```

### ContentService 被依赖

```
ContentService 被调用:
  ← UserService (获取用户动态、点赞收藏列表)
```

---

## 📁 文档结构

```
03-content模块/
├── README.md                                   [模块导航]
├── Frontend/
│   ├── 01-发现主页页面.md                     ✅
│   ├── 02-发布动态页面.md                     ✅
│   └── 03-动态详情页面.md                     ✅
└── Backend/
    └── ContentService后端服务.md              ✅

06-common模块/
└── Backend/
    ├── MediaUploadService后端服务.md          ✅
    ├── LocationService后端服务.md             ✅
    └── ReportService后端服务.md               ✅
```

---

## 📖 文档质量

### 前端页面文档包含
- ✅ 页面概述(路由、功能、前置条件)
- ✅ 页面结构(详细UI布局)
- ✅ 接口列表(请求参数、响应数据、错误处理)
- ✅ 数据流(完整业务流程)
- ✅ 状态管理(TypeScript接口定义)
- ✅ 前端验证(验证规则和示例代码)
- ✅ 交互行为(详细交互逻辑)
- ✅ 测试要点(功能、边界、性能、安全测试)
- ✅ 使用的后端服务(跨模块引用)
- ✅ 相关页面(页面跳转关系)
- ✅ TypeScript类型定义

### 后端服务文档包含
- ✅ 服务概述(技术栈、端口、数据库)
- ✅ 服务架构(核心功能、模块结构)
- ✅ API接口(对外API + RPC接口)
- ✅ 接口详情(请求、响应、业务逻辑、错误码)
- ✅ 数据模型(TypeORM实体定义)
- ✅ RPC接口实现(方法签名、调用示例)
- ✅ 性能优化(缓存策略、查询优化)
- ✅ 安全机制(验证、审核、频率限制)
- ✅ 监控与日志(监控指标、日志规范)
- ✅ 测试用例(单元、集成、性能测试)
- ✅ 配置参数(环境变量)
- ✅ 部署说明(Docker配置)

---

## 💡 设计亮点

### 1. 模块化服务设计
- **MediaUploadService**: 通用媒体上传服务,被所有模块复用(content, user, chat, trade)
- **LocationService**: 通用位置服务,支持Geohash索引和高德地图API
- **ReportService**: 通用举报审核服务,统一内容审核流程
- **优势**: 避免代码重复,统一技术标准,便于维护

### 2. 乐观更新机制
- 点赞/收藏操作立即更新UI,无需等待服务器响应
- 失败时自动回滚,提示错误信息
- 提升用户体验,减少等待时间

### 3. 评论嵌套结构
- 一级评论+二级回复的层级设计
- 前3条二级回复自动展开,支持"展开更多"
- 支持多种排序方式(时间/热度/点赞数)
- 置顶评论优先显示

### 4. 智能推荐算法
- 热度分计算: 综合考虑点赞、评论、分享、收藏
- 时间衰减: 避免老内容长期霸榜
- 去重机制: 已浏览内容不再推荐
- 个性化: 基于用户关注和兴趣

### 5. 完整的审核体系
- 多层审核: 敏感词检测 + 图像识别 + 人工审核
- 自动处理: 举报超过阈值自动下架
- 优先级队列: illegal/pornography优先级最高
- 处罚管理: takedown/mute/ban三种处罚方式

### 6. Geohash空间索引
- 快速查询附近地点
- 精度6约为±0.61km
- 查询邻居hash,扩大搜索范围
- Haversine公式精确计算距离

---

## 🚀 下一步计划

### 对接其他模块
- **UserService**: RPC接口对接(getUserInfo, getBatchUserInfo, getFollowingList)
- **MediaUploadService**: RPC接口对接(uploadMedia, deleteMedia)
- **LocationService**: RPC接口对接(getNearbyLocations, searchLocations)
- **ReportService**: RPC接口对接(submitReport, checkPunishment)

### 功能实现
- [ ] 实现ContentService 15个对外API + 3个RPC接口
- [ ] 实现MediaUploadService 2个对外API + 4个RPC接口
- [ ] 实现LocationService 5个对外API + 4个RPC接口
- [ ] 实现ReportService 5个对外API + 4个RPC接口
- [ ] 创建8张数据库表(content) + 4张表(common)
- [ ] 配置Redis缓存策略(5种Key设计)
- [ ] 集成消息队列(RabbitMQ/Kafka)
- [ ] 集成高德地图API
- [ ] 集成阿里云内容安全API
- [ ] 实现推荐算法
- [ ] 实现敏感词检测

### 测试与上线
- [ ] 单元测试(接口测试)
- [ ] 集成测试(RPC调用)
- [ ] 性能测试:
  - 动态列表查询 < 100ms
  - 动态详情查询 < 150ms
  - 发布动态 < 300ms
  - 评论发布 < 200ms
  - 缓存命中率 > 80%
  - 并发1000请求/秒稳定
- [ ] 安全测试:
  - 内容审核(敏感词、图像识别)
  - XSS攻击防护
  - SQL注入防护
  - 频率限制
  - 权限控制
- [ ] 上线验证

---

## ✅ 质量保证

### 文档完整性
- ✅ 所有前端页面都有详细文档(3个)
- ✅ 所有后端服务都有完整文档(1个content + 3个common)
- ✅ 所有API都有完整定义(27个对外API + 15个RPC接口)
- ✅ 所有数据库表都有实体定义(8张content + 4张common)
- ✅ 所有业务流程都有流程图
- ✅ 所有安全措施都有说明
- ✅ 所有RPC调用都有示例代码

### 文档一致性
- ✅ 前后端API定义一致
- ✅ 错误码前后端一致
- ✅ 数据模型前后端匹配
- ✅ 跨模块引用正确(UserService, MediaUploadService, LocationService, ReportService)
- ✅ 服务依赖关系清晰

### 文档可用性
- ✅ 前端开发者可直接按文档实现页面
- ✅ 后端开发者可直接按文档实现API
- ✅ 测试人员可根据文档编写测试用例
- ✅ 产品经理可理解完整业务流程
- ✅ 运维人员可根据文档部署服务

---

## 📈 模块规模

### 文档数量
- **前端页面文档**: 3个
- **后端服务文档**: 4个(1个content + 3个common)
- **总文档数**: 7个
- **总行数**: 约8,000行

### 接口数量
- **对外API**: 27个(15个ContentService + 2个MediaUploadService + 5个LocationService + 5个ReportService)
- **RPC接口**: 15个(3个ContentService + 4个MediaUploadService + 4个LocationService + 4个ReportService)
- **总接口数**: 42个

### 数据库表
- **content模块**: 8张表
- **common模块**: 4张表
- **总表数**: 12张表

### 技术栈
- **前端**: React Native/Expo + TypeScript + Redux/MobX
- **后端**: Node.js + TypeScript + Express + TypeORM
- **数据库**: MySQL 8.0+
- **缓存**: Redis 7.0+
- **消息队列**: RabbitMQ/Kafka
- **图片处理**: Sharp
- **视频处理**: FFmpeg
- **存储**: OSS/S3
- **第三方API**: 高德地图API、阿里云内容安全API

---

**完成人员**: Claude (AI)
**审核状态**: 待用户确认
**文档版本**: v1.0
**创建日期**: 2025-11-14

🎉 **Content模块文档创建完成！** 🎉

这是一个**大型核心业务模块**,包含完整的社交内容功能(Feed流、发布、评论、互动、推荐、审核),同时在common模块新增了3个通用服务(MediaUploadService, LocationService, ReportService),为整个系统提供基础能力支撑。
