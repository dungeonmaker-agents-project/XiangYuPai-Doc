# 03-通知页面

## 页面概述

### 功能描述
通知页面是用户查看各类通知的中心页面,包含赞和收藏、评论、粉丝、系统通知四种通知类型。用户可以查看通知详情、标记已读、清除通知等。

### 路由信息
- **路由路径**: `/message/notification/:type`
- **页面类型**: 列表页面
- **前置条件**: 需要用户登录
- **传入参数**:
  - `type`: 通知类型 - `likes` | `comments` | `followers` | `system`

### 主要功能
1. **通知列表展示** - 显示对应类型的通知列表
2. **通知分类** - 4种通知类型各自独立展示
3. **未读标记** - 显示未读通知数量和未读状态
4. **自动标记已读** - 进入页面自动标记所有通知为已读
5. **下拉刷新** - 支持下拉刷新通知列表
6. **上拉加载** - 支持上拉加载更多通知
7. **点击跳转** - 点击通知跳转到对应的内容或用户主页
8. **清除通知** - 支持清除所有已读通知

---

## 页面结构

### 布局层级
```
通知页面
├── 顶部导航栏
│   ├── 返回按钮
│   ├── 标题(根据type显示不同标题)
│   └── 清除按钮(清除已读通知)
├── 通知列表区
│   ├── 通知项1
│   ├── 通知项2
│   └── ...
└── 空状态提示
    └── 暂无通知
```

### 视觉设计

#### 顶部导航栏
- 高度:56px
- 背景:白色 (#ffffff)
- 底部分割线:1px浅灰色 (#f0f0f0)

**返回按钮:**
- 位置:左上角
- 图标:左箭头
- 尺寸:24x24px
- 点击区域:44x44px
- 颜色:深灰色 (#333)

**标题:**
- 位置:居中
- 字体大小:20pt
- 字体粗细:加粗
- 颜色:深灰色 (#1a1a1a)
- 内容:
  - `likes`: "赞和收藏"
  - `comments`: "评论"
  - `followers`: "新增粉丝"
  - `system`: "系统通知"

**清除按钮:**
- 位置:右上角
- 文字:"清除"
- 字体大小:15pt
- 颜色:浅灰色 (#999)
- 点击:清除所有已读通知

#### 通知列表区

**通知项布局(通用):**
- 高度:自适应(最小80px)
- 左右边距:16px
- 底部分割线:1px浅灰色 (#f5f5f5)
- 背景:
  - 未读:浅紫色 (#f5f3ff)
  - 已读:白色 (#ffffff)

---

### 1. 赞和收藏通知(type=likes)

**通知项结构:**
```
[头像] [用户名] 赞了你的动态/收藏了你的动态    [未读点]
       [内容预览:动态文字或图片]              [时间]
```

**布局:**
- **左侧头像**:
  - 尺寸:48x48px
  - 圆形
  - 左边距:16px
  - 可点击跳转用户主页

- **中间内容区**:
  - 左边距:12px(距离头像)
  - 右边距:60px(为时间留空间)

  **第一行:**
  - 用户名:
    - 字体大小:16pt
    - 字体粗细:中等加粗
    - 颜色:深灰色 (#1a1a1a)
    - 最大宽度:50%
  - 动作文字:
    - 字体大小:16pt
    - 颜色:浅灰色 (#666)
    - 内容:"赞了你的动态" 或 "收藏了你的动态"

  **第二行:**
  - 内容预览:
    - 字体大小:14pt
    - 颜色:浅灰色 (#999)
    - 最多显示2行
    - 超长显示省略号
    - 距离第一行:4px

- **右上角时间**:
  - 字体大小:12pt
  - 颜色:浅灰色 (#999)
  - 位置:右对齐
  - 右边距:16px
  - 格式:
    - 1分钟内:"刚刚"
    - 1小时内:"X分钟前"
    - 今天:"HH:MM"
    - 昨天:"昨天"
    - 更早:"MM-DD"

- **未读点**:
  - 位置:右侧,时间下方
  - 尺寸:8x8px圆形
  - 颜色:红色 (#ef4444)
  - 显示条件:未读

- **内容缩略图**(如果动态包含图片):
  - 位置:内容预览右侧
  - 尺寸:60x60px
  - 圆角:4px

**点击行为:**
- 点击整个通知项:跳转到动态详情页
- 点击头像:跳转到用户主页

---

### 2. 评论通知(type=comments)

**通知项结构:**
```
[头像] [用户名] 评论了你的动态/回复了你的评论    [未读点]
       [评论内容]                              [时间]
       [原内容预览]
```

**布局:**
- **左侧头像**:同上

- **中间内容区**:
  **第一行:**
  - 用户名 + 动作文字
  - 动作文字:"评论了你的动态" 或 "回复了你的评论"

  **第二行(评论内容):**
  - 字体大小:15pt
  - 颜色:深灰色 (#1a1a1a)
  - 最多显示2行
  - 背景:浅灰色 (#f5f5f5)
  - 圆角:4px
  - 内边距:8px 12px
  - 距离第一行:8px

  **第三行(原内容预览):**
  - 字体大小:14pt
  - 颜色:浅灰色 (#999)
  - 最多显示1行
  - 前缀:"你的动态:" 或 "你的评论:"
  - 距离第二行:4px

- **右上角时间和未读点**:同上

**点击行为:**
- 点击整个通知项:跳转到动态详情页,定位到该评论
- 点击头像:跳转到用户主页

---

### 3. 新增粉丝通知(type=followers)

**通知项结构:**
```
[头像] [用户名] 关注了你                     [未读点]
       [个性签名]                           [时间]
                                          [回关按钮]
```

**布局:**
- **左侧头像**:同上

- **中间内容区**:
  **第一行:**
  - 用户名 + "关注了你"

  **第二行(个性签名):**
  - 字体大小:14pt
  - 颜色:浅灰色 (#999)
  - 最多显示1行
  - 距离第一行:4px

- **右上角时间和未读点**:同上

- **回关按钮**:
  - 位置:右下角
  - 尺寸:自适应
  - 内边距:6px 16px
  - 圆角:16px
  - 未关注状态:
    - 文字:"回关"
    - 背景:紫色 (#9333ea)
    - 文字颜色:白色
  - 已关注状态:
    - 文字:"已关注"
    - 背景:浅灰色 (#f5f5f5)
    - 文字颜色:深灰色 (#666)
    - 边框:1px浅灰色 (#e0e0e0)

**点击行为:**
- 点击整个通知项:跳转到用户主页
- 点击回关按钮:关注/取消关注该用户

---

### 4. 系统通知(type=system)

**通知项结构:**
```
[图标] [标题]                               [未读点]
       [内容]                               [时间]
```

**布局:**
- **左侧图标**:
  - 尺寸:48x48px
  - 圆形
  - 背景:根据通知类型
    - 公告:紫色 (#9333ea)
    - 活动:橙色 (#f97316)
    - 提醒:蓝色 (#3b82f6)
    - 警告:红色 (#ef4444)
  - 图标:白色,24x24px

- **中间内容区**:
  **第一行(标题):**
  - 字体大小:16pt
  - 字体粗细:中等加粗
  - 颜色:深灰色 (#1a1a1a)
  - 最多显示1行

  **第二行(内容):**
  - 字体大小:14pt
  - 颜色:浅灰色 (#666)
  - 最多显示2行
  - 距离第一行:4px

- **右上角时间和未读点**:同上

**点击行为:**
- 根据通知类型跳转:
  - 公告:跳转到公告详情页
  - 活动:跳转到活动详情页
  - 提醒:跳转到相关功能页
  - 警告:跳转到账号安全页

---

### 空状态
```
[空状态图标]
暂无通知
```
- 图标:灰色铃铛图标
- 文字:"暂无通知"
- 字体大小:16pt
- 颜色:浅灰色 (#999)
- 位置:垂直居中

---

## 接口列表

### 接口1:获取通知列表
**接口:** `GET /api/notification/list/{type}`

**触发时机:** 进入通知页面时 / 下拉刷新 / 上拉加载

**请求参数:**
```typescript
{
  type: string;             // 通知类型:likes/comments/followers/system (路径参数)
  page: number;             // 页码,从1开始
  pageSize: number;         // 每页数量,默认20
  lastNotificationId?: string; // 最后一条通知ID,用于分页
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    type: string;           // 通知类型
    total: number;          // 通知总数
    unreadCount: number;    // 未读数
    hasMore: boolean;       // 是否有更多通知
    list: Array<{
      notificationId: string;   // 通知ID
      type: string;             // 通知类型
      senderId: string;         // 发送者ID(系统通知为null)
      senderInfo?: {            // 发送者信息
        userId: string;
        nickname: string;
        avatar: string;
        signature?: string;     // 个性签名(粉丝通知)
        isFollowing?: boolean;  // 是否已关注(粉丝通知)
      };
      actionType: string;       // 动作类型:like/collect/comment/reply/follow/system
      targetType: string;       // 目标类型:feed/comment/user
      targetId: string;         // 目标ID
      targetContent?: string;   // 目标内容预览
      targetThumbnail?: string; // 目标缩略图(动态图片)
      content?: string;         // 通知内容(评论内容/系统通知内容)
      title?: string;           // 标题(系统通知)
      isRead: boolean;          // 是否已读
      createdAt: string;        // 创建时间,ISO格式
    }>;
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证通知类型(likes/comments/followers/system)
3. 查询通知列表,按时间倒序
4. 分页返回数据
5. 同时返回未读数统计

**错误码:**
- 200:成功
- 400:参数错误(type不正确)
- 401:未登录

---

### 接口2:标记通知已读
**接口:** `PUT /api/notification/read/{type}`

**触发时机:** 进入通知页面时

**请求参数:**
```typescript
{
  type: string;             // 通知类型 (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    type: string;
    readCount: number;      // 标记为已读的通知数
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 查询该类型所有未读通知
3. 批量更新为已读
4. 返回标记数量

**错误码:**
- 200:成功
- 401:未登录
- 404:通知类型不存在

---

### 接口3:清除已读通知
**接口:** `DELETE /api/notification/clear/{type}`

**触发时机:** 用户点击右上角"清除"按钮后确认

**请求参数:**
```typescript
{
  type: string;             // 通知类型 (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    type: string;
    clearCount: number;     // 清除的通知数
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 查询该类型所有已读通知
3. 批量软删除
4. 返回清除数量

**错误码:**
- 200:成功
- 401:未登录

---

### 接口4:关注/取消关注用户(粉丝通知页专用)
**接口:** `POST /api/user/follow`

**触发时机:** 用户点击粉丝通知的"回关"按钮

**请求参数:**
```typescript
{
  targetUserId: string;     // 目标用户ID
  action: string;           // 动作:follow/unfollow
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    userId: string;
    targetUserId: string;
    isFollowing: boolean;   // 当前关注状态
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 检查是否已关注
3. action=follow:
   - 未关注:创建关注关系
   - 已关注:返回错误
4. action=unfollow:
   - 已关注:删除关注关系
   - 未关注:返回错误
5. 更新用户关注数和粉丝数
6. 发送通知(如果是关注)

**错误码:**
- 200:成功
- 400:不能关注自己 / 重复关注
- 401:未登录
- 404:用户不存在

---

### 接口5:获取通知未读数(所有类型)
**接口:** `GET /api/notification/unread-count`

**触发时机:** 应用启动时 / 从通知页返回消息主页时

**请求参数:**
```typescript
// 无需参数,从token中获取用户ID
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    likes: number;          // 赞和收藏未读数
    comments: number;       // 评论未读数
    followers: number;      // 粉丝未读数
    system: number;         // 系统通知未读数
    total: number;          // 总未读数
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 分别统计4种类型的未读数
3. 计算总未读数
4. 返回统计结果

**错误码:**
- 200:成功
- 401:未登录

---

## 数据流

### 页面加载流程

```
用户从消息主页点击通知分类Tab
  ↓
1. 传递参数:type(likes/comments/followers/system)
  ↓
2. 跳转到通知页面:/message/notification/:type
  ↓
3. 显示骨架屏
  ↓
4. 并行调用接口:
   - 接口1:获取通知列表
   - 接口2:标记通知已读
  ↓
NotificationService
  1. 查询通知列表(最近20条)
  2. 批量标记未读通知为已读
  3. 返回通知数据和未读数
  ↓
客户端
  1. 渲染通知列表
  2. 隐藏骨架屏
  3. 更新消息主页的未读角标(清零)
```

**失败处理:**
- 显示错误提示:"加载失败,点击重试"
- 提供重试按钮

### 点击通知流程

#### 赞和收藏通知
```
用户点击通知项
  ↓
1. 获取目标动态ID(targetId)
  ↓
2. 跳转到动态详情页
   路由:/content/detail/:feedId
  ↓
动态详情页加载
```

#### 评论通知
```
用户点击通知项
  ↓
1. 获取目标动态ID和评论ID
  ↓
2. 跳转到动态详情页,并传递commentId
   路由:/content/detail/:feedId?commentId=xxx
  ↓
动态详情页加载,自动滚动到该评论
```

#### 粉丝通知
```
用户点击通知项(非按钮区域)
  ↓
1. 获取用户ID(senderId)
  ↓
2. 跳转到用户主页
   路由:/user/profile/:userId
  ↓
用户主页加载

用户点击"回关"按钮
  ↓
1. 调用接口4:关注用户
   POST /api/user/follow
  ↓
UserService
  1. 创建关注关系
  2. 更新关注数和粉丝数
  3. 发送通知
  ↓
客户端
  成功:
    - 按钮文字变为"已关注"
    - 按钮样式变为灰色
    - 显示提示:"关注成功"

  失败:
    - 显示错误提示
```

#### 系统通知
```
用户点击通知项
  ↓
1. 根据通知类型(title或content中的标识)判断跳转目标
  ↓
2. 跳转到对应页面:
   - 公告:公告详情页
   - 活动:活动详情页
   - 提醒:相关功能页
   - 警告:账号安全页
```

### 下拉刷新流程

```
用户下拉列表
  ↓
1. 显示下拉刷新动画
  ↓
2. 调用接口1:获取通知列表(page=1)
  ↓
3. 调用接口2:标记通知已读
  ↓
NotificationService
  1. 查询最新通知
  2. 标记为已读
  ↓
客户端
  1. 替换当前列表
  2. 隐藏刷新动画
  3. 显示提示:"刷新成功"
  4. 更新未读数
```

### 上拉加载更多流程

```
用户滚动到列表底部
  ↓
1. 检查hasMore标志
  ↓
2. hasMore为true时:
   - 显示加载动画
   - 调用接口1(page递增,传入lastNotificationId)
  ↓
NotificationService
  1. 查询更早的通知
  2. 返回通知列表
  ↓
客户端
  1. 追加新数据到列表末尾
  2. 隐藏加载动画
  ↓
3. hasMore为false时:
   - 显示提示:"没有更多通知了"
```

### 清除通知流程

```
用户点击右上角"清除"按钮
  ↓
1. 弹出确认对话框:"确定清除所有已读通知吗?"
   - 按钮1:"取消" - 关闭对话框
   - 按钮2:"确定" - 继续
  ↓
2. 调用接口3:清除已读通知
   DELETE /api/notification/clear/{type}
  ↓
NotificationService
  1. 查询所有已读通知
  2. 批量软删除
  3. 返回清除数量
  ↓
客户端
  成功:
    - 从列表中移除所有已读通知
    - 显示提示:"已清除X条通知"
    - 如果列表为空,显示空状态

  失败:
    - 显示错误提示:"清除失败,请稍后重试"
```

---

## 状态管理

### 页面状态接口

```typescript
interface NotificationPageState {
  // 加载状态
  loading: boolean;
  refreshing: boolean;
  loadingMore: boolean;

  // 通知类型
  type: 'likes' | 'comments' | 'followers' | 'system';

  // 通知列表数据
  notificationData: {
    list: Notification[];
    total: number;
    unreadCount: number;
    hasMore: boolean;
    page: number;
    pageSize: number;
  };

  // UI状态
  showClearConfirm: boolean;
}

interface Notification {
  notificationId: string;
  type: string;
  senderId: string | null;
  senderInfo?: {
    userId: string;
    nickname: string;
    avatar: string;
    signature?: string;
    isFollowing?: boolean;
  };
  actionType: string;       // like/collect/comment/reply/follow/system
  targetType: string;       // feed/comment/user
  targetId: string;
  targetContent?: string;
  targetThumbnail?: string;
  content?: string;
  title?: string;
  isRead: boolean;
  createdAt: string;
}
```

### 状态管理Hook

```typescript
const useNotificationPage = (type: string) => {
  // 状态定义
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);
  const [notificationData, setNotificationData] = useState({
    list: [],
    total: 0,
    unreadCount: 0,
    hasMore: false,
    page: 1,
    pageSize: 20
  });
  const [showClearConfirm, setShowClearConfirm] = useState(false);

  // 初始化加载
  useEffect(() => {
    loadNotifications();
    markNotificationsAsRead();
  }, [type]);

  // 加载通知列表
  const loadNotifications = async (page = 1) => {
    setLoading(page === 1);
    try {
      const response = await fetch(
        `/api/notification/list/${type}?page=${page}&pageSize=20`
      );
      const result = await response.json();

      if (result.code === 200) {
        if (page === 1) {
          // 首次加载或刷新
          setNotificationData({
            list: result.data.list,
            total: result.data.total,
            unreadCount: result.data.unreadCount,
            hasMore: result.data.hasMore,
            page: 1,
            pageSize: 20
          });
        } else {
          // 加载更多
          setNotificationData(prev => ({
            ...prev,
            list: [...prev.list, ...result.data.list],
            hasMore: result.data.hasMore,
            page
          }));
        }
      }
    } catch (error) {
      console.error('加载通知失败:', error);
    } finally {
      setLoading(false);
      setRefreshing(false);
      setLoadingMore(false);
    }
  };

  // 标记通知已读
  const markNotificationsAsRead = async () => {
    try {
      await fetch(`/api/notification/read/${type}`, {
        method: 'PUT'
      });

      // 更新未读数
      setNotificationData(prev => ({
        ...prev,
        unreadCount: 0,
        list: prev.list.map(item => ({
          ...item,
          isRead: true
        }))
      }));
    } catch (error) {
      console.error('标记已读失败:', error);
    }
  };

  // 下拉刷新
  const handleRefresh = async () => {
    setRefreshing(true);
    await loadNotifications(1);
    await markNotificationsAsRead();
  };

  // 加载更多
  const handleLoadMore = async () => {
    if (loadingMore || !notificationData.hasMore) return;

    setLoadingMore(true);
    await loadNotifications(notificationData.page + 1);
  };

  // 点击通知
  const handleNotificationClick = (notification: Notification) => {
    switch (notification.actionType) {
      case 'like':
      case 'collect':
      case 'comment':
      case 'reply':
        // 跳转到动态详情页
        navigation.navigate('ContentDetail', {
          feedId: notification.targetId,
          commentId: notification.actionType === 'comment' || notification.actionType === 'reply'
            ? notification.targetId
            : undefined
        });
        break;

      case 'follow':
        // 跳转到用户主页
        navigation.navigate('UserProfile', {
          userId: notification.senderId
        });
        break;

      case 'system':
        // 根据系统通知类型跳转
        handleSystemNotificationClick(notification);
        break;
    }
  };

  // 关注/取消关注
  const handleFollow = async (userId: string, isFollowing: boolean) => {
    try {
      const response = await fetch('/api/user/follow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetUserId: userId,
          action: isFollowing ? 'unfollow' : 'follow'
        })
      });

      const result = await response.json();

      if (result.code === 200) {
        // 更新列表中的关注状态
        setNotificationData(prev => ({
          ...prev,
          list: prev.list.map(item =>
            item.senderId === userId && item.senderInfo
              ? {
                  ...item,
                  senderInfo: {
                    ...item.senderInfo,
                    isFollowing: !isFollowing
                  }
                }
              : item
          )
        }));

        showToast(isFollowing ? '已取消关注' : '关注成功');
      }
    } catch (error) {
      console.error('关注操作失败:', error);
      showToast('操作失败,请稍后重试');
    }
  };

  // 清除已读通知
  const handleClearRead = async () => {
    try {
      const response = await fetch(`/api/notification/clear/${type}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.code === 200) {
        // 从列表中移除已读通知
        setNotificationData(prev => ({
          ...prev,
          list: prev.list.filter(item => !item.isRead),
          total: prev.total - result.data.clearCount
        }));

        showToast(`已清除${result.data.clearCount}条通知`);
        setShowClearConfirm(false);
      }
    } catch (error) {
      console.error('清除通知失败:', error);
      showToast('清除失败,请稍后重试');
    }
  };

  return {
    loading,
    refreshing,
    loadingMore,
    type,
    notificationData,
    showClearConfirm,
    // 方法
    handleRefresh,
    handleLoadMore,
    handleNotificationClick,
    handleFollow,
    handleClearRead,
    setShowClearConfirm,
  };
};
```

---

## 前端验证

### 通知类型验证

```typescript
const validateNotificationType = (type: string) => {
  const validTypes = ['likes', 'comments', 'followers', 'system'];

  if (!validTypes.includes(type)) {
    return { valid: false, error: '无效的通知类型' };
  }

  return { valid: true };
};
```

### 分页参数验证

```typescript
const validatePaginationParams = (page: number, pageSize: number) => {
  if (page < 1) {
    return { valid: false, error: '页码必须大于等于1' };
  }

  if (pageSize < 10 || pageSize > 50) {
    return { valid: false, error: '每页数量必须在10-50之间' };
  }

  return { valid: true };
};
```

### 时间格式化

```typescript
const formatNotificationTime = (timestamp: string): string => {
  const now = new Date();
  const notificationTime = new Date(timestamp);
  const diff = now.getTime() - notificationTime.getTime();

  // 1分钟内
  if (diff < 60 * 1000) {
    return '刚刚';
  }

  // 1小时内
  if (diff < 60 * 60 * 1000) {
    const minutes = Math.floor(diff / (60 * 1000));
    return `${minutes}分钟前`;
  }

  // 今天
  if (now.toDateString() === notificationTime.toDateString()) {
    const hours = notificationTime.getHours().toString().padStart(2, '0');
    const minutes = notificationTime.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // 昨天
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (yesterday.toDateString() === notificationTime.toDateString()) {
    return '昨天';
  }

  // 更早
  const month = (notificationTime.getMonth() + 1).toString().padStart(2, '0');
  const day = notificationTime.getDate().toString().padStart(2, '0');
  return `${month}-${day}`;
};
```

---

## 交互行为

### 1. 页面加载

**进入通知页面时:**
1. 显示骨架屏或加载动画
2. 并行调用以下接口:
   - 接口1:获取通知列表
   - 接口2:标记通知已读
3. 加载完成后隐藏骨架屏
4. 渲染通知列表
5. 更新消息主页的未读角标

**加载失败:**
- 显示错误提示:"加载失败,点击重试"
- 提供重试按钮

### 2. 下拉刷新

**操作步骤:**
1. 用户下拉列表
2. 显示下拉刷新动画
3. 重新调用接口1和接口2(page=1)
4. 替换当前数据
5. 隐藏刷新动画
6. 显示提示:"刷新成功"

### 3. 上拉加载更多

**操作步骤:**
1. 用户滚动到列表底部
2. 检查hasMore标志
3. hasMore为true时:
   - 显示加载动画
   - 调用接口1(page递增,传入lastNotificationId)
   - 追加新数据到列表末尾
   - 隐藏加载动画
4. hasMore为false时:
   - 显示提示:"没有更多通知了"

### 4. 点击通知

**赞和收藏通知:**
- 点击通知项:跳转到动态详情页
- 点击头像:跳转到用户主页

**评论通知:**
- 点击通知项:跳转到动态详情页,定位到该评论
- 点击头像:跳转到用户主页

**粉丝通知:**
- 点击通知项(非按钮):跳转到用户主页
- 点击"回关"按钮:关注/取消关注

**系统通知:**
- 点击通知项:根据类型跳转到对应页面

### 5. 关注操作(粉丝通知)

**操作步骤:**
1. 用户点击"回关"按钮
2. 按钮变为loading状态
3. 调用接口4:关注用户
4. 成功:
   - 按钮文字变为"已关注"
   - 按钮样式变为灰色
   - 显示提示:"关注成功"
5. 失败:
   - 恢复原状态
   - 显示错误提示

### 6. 清除已读通知

**操作步骤:**
1. 用户点击右上角"清除"按钮
2. 弹出确认对话框:"确定清除所有已读通知吗?"
3. 用户点击"确定"
4. 调用接口3:清除已读通知
5. 成功:
   - 从列表中移除所有已读通知
   - 显示提示:"已清除X条通知"
   - 如果列表为空,显示空状态
6. 失败:
   - 显示错误提示:"清除失败,请稍后重试"

---

## 测试要点

### 功能测试
- [ ] 通知列表加载正常(4种类型)
- [ ] 未读通知显示正确
- [ ] 自动标记已读功能正常
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多功能正常
- [ ] 点击通知跳转正确
- [ ] 关注/取消关注功能正常(粉丝通知)
- [ ] 清除已读通知功能正常
- [ ] 时间格式化正确
- [ ] 空状态显示正确

### 边界测试
- [ ] 空通知列表显示
- [ ] 网络异常处理
- [ ] 快速重复点击
- [ ] 长文本内容显示省略号
- [ ] 通知类型验证
- [ ] 无权限处理

### 兼容性测试
- [ ] iOS系统(13+)
- [ ] Android系统(8+)
- [ ] 不同屏幕尺寸
- [ ] 深色模式适配

### 性能测试
- [ ] 列表渲染流畅度
- [ ] 下拉刷新响应速度
- [ ] 上拉加载响应速度
- [ ] 内存占用合理

---

## 使用的后端服务

### NotificationService (06-common模块)
**服务端口:** 8009
**调用接口:**
1. `GET /api/notification/list/{type}` - 获取通知列表
2. `PUT /api/notification/read/{type}` - 标记通知已读
3. `DELETE /api/notification/clear/{type}` - 清除已读通知
4. `GET /api/notification/unread-count` - 获取未读数

### UserService (02-user模块)
**服务端口:** 8002
**调用接口:**
1. `POST /api/user/follow` - 关注/取消关注用户(粉丝通知专用)

**RPC调用:**
- 无直接RPC调用

---

## 相关页面

### 同模块页面
- **01-消息主页页面** - 点击返回按钮返回
  - 路由:`/message/main`
  - 关系:父页面,从Tab进入通知页面

### 其他模块页面
- **动态详情页** - 点击通知跳转(赞和收藏、评论通知)
  - 传递参数:feedId, commentId(评论通知)
  - 所属模块:03-content模块
  - 路由:`/content/detail/:feedId`

- **用户主页** - 点击通知跳转(粉丝通知)或点击头像
  - 传递参数:userId
  - 所属模块:02-user模块
  - 路由:`/user/profile/:userId`

---

## 样式规范

### 颜色系统
```css
/* 主色调 */
--primary-purple: #9333ea;

/* 文字颜色 */
--text-primary: #1a1a1a;
--text-secondary: #666666;
--text-tertiary: #999999;

/* 背景色 */
--bg-white: #ffffff;
--bg-unread: #f5f3ff;      /* 未读通知背景 */
--bg-gray: #f5f5f5;

/* 状态颜色 */
--unread-dot: #ef4444;     /* 未读点 */
--online: #10b981;         /* 在线 */
```

### 通知项样式
```css
/* 通知项 */
.notification-item {
  min-height: 80px;
  padding: 12px 16px;
  background: var(--bg-white);
  border-bottom: 1px solid #f5f5f5;
}

.notification-item.unread {
  background: var(--bg-unread);
}

/* 未读点 */
.unread-dot {
  width: 8px;
  height: 8px;
  background: var(--unread-dot);
  border-radius: 50%;
}
```

---

## 性能优化

### 列表优化
- 使用FlatList虚拟滚动
- 设置keyExtractor为notificationId
- 使用React.memo优化通知项组件
- 头像图片懒加载

### 缓存策略
- 通知列表缓存5分钟
- 未读数缓存3分钟
- 下拉刷新清除缓存

### 接口优化
- 并行请求通知列表和标记已读
- 防抖处理下拉刷新(间隔1秒)
- 接口取消(页面离开时取消未完成请求)

---

## 异常处理

| 场景 | 前端处理方式 |
|-----|------------|
| 通知类型错误(400) | 显示:"无效的通知类型",返回消息主页 |
| 未登录(401) | 跳转登录页 |
| 网络错误 | 显示:"网络异常,请检查网络设置" + 重试按钮 |
| 服务器错误(500) | 显示:"操作失败,请稍后重试" |
| 关注失败 | 显示具体错误信息(不能关注自己/用户不存在等) |

---

**文档版本:** v1.0
**创建日期:** 2025-11-14
**所属模块:** 05-chat模块
**维护团队:** 消息团队
