# 02-聊天页面

## 页面概述

### 功能描述
聊天页面是用户进行一对一私信对话的核心页面,支持文字、图片、语音、视频等多种消息类型的发送和接收。页面提供实时消息推送、消息已读状态、撤回消息等功能。

### 路由信息
- **路由路径**: `/message/chat/:conversationId`
- **页面类型**: 详情页面
- **前置条件**: 需要用户登录
- **传入参数**:
  - `conversationId`: 会话ID
  - `userId`: 对方用户ID
  - `nickname`: 对方昵称
  - `avatar`: 对方头像URL

### 主要功能
1. **消息展示** - 显示历史消息记录,支持文字、图片、语音、视频
2. **实时通信** - WebSocket实时接收新消息
3. **消息发送** - 支持发送文字、图片、语音、视频消息
4. **消息状态** - 显示消息发送状态(发送中/已送达/已读)和时间
5. **加载历史** - 上拉加载更多历史消息
6. **消息撤回** - 2分钟内可撤回已发送消息
7. **消息删除** - 删除本地消息记录
8. **输入状态** - 显示对方正在输入状态
9. **在线状态** - 显示对方在线/离线状态
10. **消息提醒** - 自动标记消息为已读

---

## 页面结构

### 布局层级
```
聊天页面
├── 顶部导航栏
│   ├── 返回按钮
│   ├── 用户信息
│   │   ├── 头像(可点击查看主页)
│   │   ├── 昵称
│   │   └── 在线状态
│   └── 更多按钮(举报、删除会话)
├── 消息列表区
│   ├── 时间分割线
│   ├── 对方消息气泡(左侧)
│   │   ├── 头像
│   │   ├── 消息内容
│   │   └── 时间戳
│   ├── 我的消息气泡(右侧)
│   │   ├── 消息内容
│   │   ├── 已读/未读状态
│   │   ├── 时间戳
│   │   └── 头像
│   └── 系统提示(撤回、时间等)
└── 底部输入栏
    ├── 语音按钮
    ├── 文本输入框
    ├── 表情按钮
    ├── 更多按钮
    │   ├── 图片
    │   ├── 拍照
    │   ├── 视频
    │   └── 文件
    └── 发送按钮
```

### 视觉设计

#### 顶部导航栏
- 高度:56px
- 背景:白色 (#ffffff)
- 底部分割线:1px浅灰色 (#f0f0f0)

**返回按钮:**
- 位置:左上角
- 图标:左箭头
- 尺寸:24x24px
- 点击区域:44x44px
- 颜色:深灰色 (#333)

**用户信息区:**
- 位置:居中
- 头像:
  - 尺寸:36x36px
  - 圆形
  - 可点击
- 昵称:
  - 字体大小:18pt
  - 字体粗细:加粗
  - 颜色:深灰色 (#1a1a1a)
- 在线状态:
  - 字体大小:12pt
  - 颜色:浅灰色 (#999)
  - 在线显示:"在线" - 绿色 (#10b981)
  - 离线显示:"离线" - 灰色 (#999)

**更多按钮:**
- 位置:右上角
- 图标:三点图标
- 尺寸:24x24px
- 点击区域:44x44px

#### 消息列表区
- 背景:#f5f5f5
- 左右边距:12px
- 消息间距:8px

**时间分割线:**
- 字体大小:12pt
- 颜色:浅灰色 (#999)
- 背景:半透明白色 rgba(255,255,255,0.8)
- 圆角:12px
- 内边距:4px 12px
- 位置:水平居中
- 显示逻辑:消息时间间隔>5分钟时显示

**对方消息气泡(左侧):**
```
[头像]  [消息气泡]
        [时间]
```
- 头像:
  - 尺寸:40x40px
  - 圆形
  - 左边距:12px
- 消息气泡:
  - 背景:白色 (#ffffff)
  - 圆角:8px(右上/右下/左下), 2px(左上)
  - 内边距:12px
  - 最大宽度:70%屏幕宽度
  - 阴影:0 1px 2px rgba(0,0,0,0.1)
- 文字消息:
  - 字体大小:16pt
  - 颜色:深灰色 (#1a1a1a)
  - 行高:1.5
- 时间戳:
  - 字体大小:11pt
  - 颜色:浅灰色 (#999)
  - 位置:气泡下方,左对齐

**我的消息气泡(右侧):**
```
          [消息气泡]  [头像]
    [已读] [时间]
```
- 头像:
  - 尺寸:40x40px
  - 圆形
  - 右边距:12px
- 消息气泡:
  - 背景:紫色 (#9333ea)
  - 圆角:8px(左上/左下/右下), 2px(右上)
  - 内边距:12px
  - 最大宽度:70%屏幕宽度
- 文字消息:
  - 字体大小:16pt
  - 颜色:白色 (#ffffff)
  - 行高:1.5
- 发送状态:
  - 发送中:loading动画
  - 已送达:单勾图标,灰色
  - 已读:双勾图标,蓝色
  - 失败:红色感叹号,可点击重发
- 时间戳:
  - 字体大小:11pt
  - 颜色:浅灰色 (#999)
  - 位置:气泡下方,右对齐

**图片消息:**
- 尺寸:最大200x200px
- 圆角:8px
- 点击:全屏查看
- 长按:保存图片、转发、删除

**语音消息:**
- 显示:波形图标 + 时长
- 播放:点击播放,再次点击暂停
- 未读:红点标记
- 最大时长:60秒

**视频消息:**
- 显示:封面图 + 播放按钮 + 时长
- 尺寸:最大200x150px
- 点击:全屏播放
- 最大时长:60秒

**系统提示:**
- 字体大小:13pt
- 颜色:浅灰色 (#999)
- 位置:水平居中
- 背景:无
- 示例:"你撤回了一条消息"、"对方撤回了一条消息"

#### 底部输入栏
- 高度:自适应(最小56px)
- 背景:白色 (#ffffff)
- 顶部分割线:1px浅灰色 (#f0f0f0)
- 左右边距:12px

**语音按钮:**
- 图标:麦克风
- 尺寸:24x24px
- 点击:切换为文本输入/语音输入

**文本输入框:**
- 最小高度:36px
- 最大高度:100px
- 圆角:18px
- 背景:#f5f5f5
- 内边距:8px 12px
- 字体大小:16pt
- 颜色:深灰色 (#1a1a1a)
- 占位符:"说点什么..."
- 占位符颜色:#c0c0c0
- 自动扩展高度

**表情按钮:**
- 图标:笑脸
- 尺寸:24x24px
- 点击:打开表情面板

**更多按钮:**
- 图标:加号
- 尺寸:24x24px
- 点击:打开更多面板

**发送按钮:**
- 文字:"发送"
- 字体大小:15pt
- 颜色:白色
- 背景:紫色 (#9333ea)
- 圆角:18px
- 内边距:8px 20px
- 禁用状态:灰色背景 (#c0c0c0)
- 显示条件:输入框有内容时

**表情面板:**
- 高度:220px
- 背景:白色
- 表情大小:32x32px
- 网格布局:7列
- 常用表情 + 最近使用

**更多面板:**
- 高度:200px
- 背景:白色
- 功能图标:
  - 图片:相册图标
  - 拍照:相机图标
  - 视频:视频图标
  - 文件:文件图标
- 每个功能:
  - 图标尺寸:48x48px
  - 背景:浅灰色 (#f5f5f5)
  - 圆角:12px
  - 标题:12pt,灰色

**输入状态提示:**
- 位置:导航栏昵称下方
- 文字:"正在输入..."
- 字体大小:12pt
- 颜色:浅灰色 (#999)
- 动画:三点跳动动画

---

## 接口列表

### 接口1:获取聊天记录
**接口:** `GET /api/message/chat/{conversationId}`

**触发时机:** 进入聊天页面时 / 上拉加载更多

**请求参数:**
```typescript
{
  conversationId: string;   // 会话ID (路径参数)
  page: number;             // 页码,从1开始
  pageSize: number;         // 每页数量,默认20
  lastMessageId?: string;   // 最后一条消息ID,用于分页
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    conversationId: string;     // 会话ID
    userId: string;             // 对方用户ID
    userInfo: {
      userId: string;
      nickname: string;
      avatar: string;
      isOnline: boolean;        // 是否在线
    };
    messages: Array<{
      messageId: string;        // 消息ID
      conversationId: string;   // 会话ID
      senderId: string;         // 发送者ID
      receiverId: string;       // 接收者ID
      messageType: string;      // 消息类型: text/image/voice/video
      content: string;          // 消息内容
      mediaUrl?: string;        // 媒体URL(图片/语音/视频)
      thumbnailUrl?: string;    // 缩略图URL
      duration?: number;        // 时长(语音/视频,秒)
      status: number;           // 状态: 0=发送中,1=已送达,2=已读,3=失败
      isRecalled: boolean;      // 是否已撤回
      createdAt: string;        // 发送时间,ISO格式
    }>;
    total: number;              // 消息总数
    hasMore: boolean;           // 是否有更多消息
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证会话权限(用户必须是会话参与者之一)
3. 查询会话信息和对方用户信息
4. 查询消息列表,按时间倒序(最新在前)
5. 分页返回消息数据
6. 标记消息为已读(更新消息状态为2)

**错误码:**
- 200:成功
- 400:参数错误
- 401:未登录
- 403:无权限访问该会话
- 404:会话不存在

---

### 接口2:发送消息
**接口:** `POST /api/message/send`

**触发时机:** 用户点击发送按钮 / 选择媒体后

**请求参数:**
```typescript
{
  conversationId: string;   // 会话ID
  receiverId: string;       // 接收者用户ID
  messageType: string;      // 消息类型: text/image/voice/video
  content?: string;         // 消息内容(文字消息必填,1-500字符)
  mediaUrl?: string;        // 媒体URL(图片/语音/视频)
  thumbnailUrl?: string;    // 缩略图URL(视频消息)
  duration?: number;        // 时长(语音/视频,秒)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    messageId: string;        // 消息ID
    conversationId: string;   // 会话ID
    senderId: string;         // 发送者ID
    receiverId: string;       // 接收者ID
    messageType: string;      // 消息类型
    content: string;          // 消息内容
    mediaUrl?: string;        // 媒体URL
    thumbnailUrl?: string;    // 缩略图URL
    duration?: number;        // 时长
    status: number;           // 状态: 1=已送达
    createdAt: string;        // 发送时间,ISO格式
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证消息类型和内容
   - 文字消息:content必填,1-500字符
   - 图片消息:mediaUrl必填,支持jpg/png/gif
   - 语音消息:mediaUrl必填,duration必填(1-60秒)
   - 视频消息:mediaUrl和thumbnailUrl必填,duration必填(1-60秒)
3. 检查对方是否拉黑当前用户
4. 创建消息记录,状态设为1(已送达)
5. 更新会话的最后消息和时间
6. 通过WebSocket推送消息给接收者
7. 如果接收者离线,创建离线消息通知
8. 返回消息详情

**错误码:**
- 200:成功
- 400:参数错误(内容为空、超长等)
- 401:未登录
- 403:对方已拉黑你
- 404:接收者不存在
- 500:发送失败

---

### 接口3:标记消息已读
**接口:** `PUT /api/message/read/{conversationId}`

**触发时机:** 进入聊天页面时 / 收到新消息时(页面在前台)

**请求参数:**
```typescript
{
  conversationId: string;   // 会话ID (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    conversationId: string;
    readCount: number;        // 标记为已读的消息数
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证会话权限
3. 查询该会话中所有状态为1(已送达)且接收者为当前用户的消息
4. 批量更新消息状态为2(已读)
5. 通过WebSocket通知发送者消息已读
6. 返回标记数量

**错误码:**
- 200:成功
- 401:未登录
- 403:无权限
- 404:会话不存在

---

### 接口4:撤回消息
**接口:** `POST /api/message/recall/{messageId}`

**触发时机:** 用户长按自己的消息,点击"撤回"

**请求参数:**
```typescript
{
  messageId: string;        // 消息ID (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    messageId: string;
    isRecalled: boolean;      // true
    recalledAt: string;       // 撤回时间,ISO格式
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 查询消息,验证消息存在
3. 验证权限:只能撤回自己发送的消息
4. 验证时间:只能撤回2分钟内的消息
5. 更新消息的isRecalled字段为true
6. 通过WebSocket通知接收者消息已撤回
7. 返回撤回结果

**错误码:**
- 200:成功
- 400:超过2分钟,无法撤回
- 401:未登录
- 403:无权限撤回该消息
- 404:消息不存在

---

### 接口5:删除消息
**接口:** `DELETE /api/message/{messageId}`

**触发时机:** 用户长按消息,点击"删除"

**请求参数:**
```typescript
{
  messageId: string;        // 消息ID (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 查询消息,验证消息存在
3. 验证权限:只能删除与自己相关的消息(发送者或接收者)
4. 软删除消息(仅对当前用户隐藏)
5. 返回删除成功

**错误码:**
- 200:成功
- 401:未登录
- 403:无权限删除该消息
- 404:消息不存在

---

### 接口6:上传媒体文件
**接口:** `POST /api/message/upload`

**触发时机:** 用户选择图片/拍照/录音/录视频后

**请求参数:**
```typescript
FormData:
  file: File;               // 文件对象
  type: string;             // 文件类型: image/voice/video
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    mediaUrl: string;         // 媒体URL
    thumbnailUrl?: string;    // 缩略图URL(视频)
    width?: number;           // 宽度(图片/视频)
    height?: number;          // 高度(图片/视频)
    duration?: number;        // 时长(语音/视频,秒)
    fileSize: number;         // 文件大小,字节
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证文件类型和大小
   - 图片:jpg/png/gif,最大10MB
   - 语音:mp3/wav/m4a,最大2MB,时长1-60秒
   - 视频:mp4/mov,最大50MB,时长1-60秒
3. 上传文件到OSS/S3
4. 图片:生成缩略图(如果>2MB)
5. 视频:自动生成封面图(首帧)
6. 返回媒体URL和元数据

**错误码:**
- 200:成功
- 400:文件类型不支持 / 文件过大
- 401:未登录
- 500:上传失败

---

## 数据流

### 页面加载流程

```
用户进入聊天页面(从会话列表点击会话)
  ↓
1. 显示骨架屏
  ↓
2. 调用接口1:获取聊天记录
   GET /api/message/chat/{conversationId}?page=1&pageSize=20
  ↓
ChatService
  1. 验证用户登录和会话权限
  2. 查询会话信息和对方用户信息
  3. 查询消息列表(最近20条,按时间倒序)
  4. 自动标记消息为已读
  ↓
客户端
  1. 渲染消息列表(倒序显示,最新在底部)
  2. 滚动到底部
  3. 建立WebSocket连接
  4. 隐藏骨架屏
  ↓
4. 调用接口3:标记消息已读
   PUT /api/message/read/{conversationId}
  ↓
ChatService
  1. 批量更新未读消息为已读
  2. 通过WebSocket通知对方
```

**失败处理:**
- 会话不存在:提示"会话不存在",返回消息主页
- 无权限:提示"无权限访问",返回消息主页
- 网络错误:显示"加载失败,点击重试"

### 发送文字消息流程

```
用户输入文字,点击发送
  ↓
1. 前端验证(1-500字符)
  ↓
2. 创建临时消息对象
   - messageId: 临时ID
   - content: 用户输入
   - status: 0(发送中)
   - createdAt: 当前时间
  ↓
3. 立即插入消息列表(乐观更新)
  ↓
4. 调用接口2:发送消息
   POST /api/message/send
  ↓
ChatService
  1. 验证用户登录和参数
  2. 检查对方是否拉黑
  3. 创建消息记录
  4. 更新会话最后消息
  5. 通过WebSocket推送给接收者
  ↓
客户端
  成功:
    - 用服务端返回的messageId替换临时ID
    - 更新消息状态为1(已送达)
    - 显示送达标记(单勾)

  失败:
    - 更新消息状态为3(失败)
    - 显示红色感叹号
    - 点击可重新发送
```

### 发送图片消息流程

```
用户点击图片按钮,选择图片
  ↓
1. 前端验证(文件类型、大小)
  ↓
2. 显示图片预览
  ↓
3. 调用接口6:上传媒体文件
   POST /api/message/upload
  ↓
MediaUploadService
  1. 验证文件
  2. 上传到OSS
  3. 生成缩略图(如果需要)
  4. 返回mediaUrl
  ↓
客户端获得mediaUrl
  ↓
4. 创建临时消息对象
   - messageType: 'image'
   - mediaUrl: 返回的URL
   - status: 0(发送中)
  ↓
5. 插入消息列表(显示上传进度)
  ↓
6. 调用接口2:发送消息
   POST /api/message/send
  ↓
ChatService
  1. 创建图片消息记录
  2. 通过WebSocket推送给接收者
  ↓
客户端
  成功: 更新消息状态为1(已送达)
  失败: 显示失败标记
```

### 接收实时消息流程

```
WebSocket收到新消息事件
  ↓
1. 解析消息数据
  ↓
2. 判断消息所属会话
  ↓
3. 如果是当前会话:
   - 插入消息到列表末尾
   - 滚动到底部
   - 调用接口3:标记消息已读
   - 播放消息提示音(可选)
   - 通过WebSocket发送已读回执
  ↓
4. 如果不是当前会话:
   - 更新会话列表未读数
   - 显示系统通知栏(iOS/Android)
   - 播放提示音
```

### 撤回消息流程

```
用户长按自己的消息
  ↓
1. 弹出操作菜单:"撤回"、"删除"、"取消"
  ↓
2. 用户点击"撤回"
  ↓
3. 检查消息时间:
   - <2分钟: 允许撤回
   - ≥2分钟: 提示"超过2分钟,无法撤回"
  ↓
4. 调用接口4:撤回消息
   POST /api/message/recall/{messageId}
  ↓
ChatService
  1. 验证权限和时间
  2. 更新消息isRecalled=true
  3. 通过WebSocket通知接收者
  ↓
客户端
  成功:
    - 替换消息为系统提示:"你撤回了一条消息"
    - 对方收到:"对方撤回了一条消息"

  失败:
    - 显示错误提示
```

### 上拉加载更多流程

```
用户滚动到列表顶部
  ↓
1. 检查是否还有更多消息(hasMore)
  ↓
2. 如果hasMore=true:
   - 显示加载动画
   - 记录当前滚动位置
   - 调用接口1,page递增
   - 传入lastMessageId(最早的消息ID)
  ↓
ChatService
  1. 查询更早的消息(按时间倒序)
  2. 返回20条消息
  ↓
客户端
  1. 将新消息插入列表顶部
  2. 恢复滚动位置(避免跳动)
  3. 隐藏加载动画
  ↓
3. 如果hasMore=false:
   - 显示"没有更多消息了"
```

---

## 状态管理

### 页面状态接口

```typescript
interface ChatPageState {
  // 加载状态
  loading: boolean;
  loadingMore: boolean;
  uploading: boolean;

  // 会话信息
  conversationInfo: {
    conversationId: string;
    userId: string;
    userInfo: {
      userId: string;
      nickname: string;
      avatar: string;
      isOnline: boolean;
    };
  };

  // 消息列表数据
  messageData: {
    list: Message[];
    total: number;
    hasMore: boolean;
    page: number;
    pageSize: number;
  };

  // 输入状态
  inputText: string;
  showEmojiPanel: boolean;
  showMorePanel: boolean;
  inputMode: 'text' | 'voice';  // 文字输入/语音输入

  // 对方状态
  isTyping: boolean;            // 对方是否正在输入
  typingTimeout: number | null; // 输入状态超时定时器

  // UI状态
  showActionSheet: boolean;     // 显示操作菜单
  selectedMessageId: string | null; // 选中的消息ID
}

interface Message {
  messageId: string;
  conversationId: string;
  senderId: string;
  receiverId: string;
  messageType: 'text' | 'image' | 'voice' | 'video';
  content: string;
  mediaUrl?: string;
  thumbnailUrl?: string;
  duration?: number;
  status: number;               // 0=发送中,1=已送达,2=已读,3=失败
  isRecalled: boolean;
  createdAt: string;
  isMine: boolean;              // 是否是我发送的
  isTemp?: boolean;             // 是否是临时消息(乐观更新)
}
```

### 状态管理Hook

```typescript
const useChatPage = (conversationId: string, userId: string) => {
  // 状态定义
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [conversationInfo, setConversationInfo] = useState(null);
  const [messageData, setMessageData] = useState({
    list: [],
    total: 0,
    hasMore: false,
    page: 1,
    pageSize: 20
  });
  const [inputText, setInputText] = useState('');
  const [showEmojiPanel, setShowEmojiPanel] = useState(false);
  const [showMorePanel, setShowMorePanel] = useState(false);
  const [inputMode, setInputMode] = useState<'text' | 'voice'>('text');
  const [isTyping, setIsTyping] = useState(false);
  const [typingTimeout, setTypingTimeout] = useState<number | null>(null);

  // WebSocket连接
  const [ws, setWs] = useState<WebSocket | null>(null);

  // 初始化加载
  useEffect(() => {
    loadChatHistory();
    connectWebSocket();
    markMessagesAsRead();

    return () => {
      ws?.close();
    };
  }, [conversationId]);

  // 加载聊天记录
  const loadChatHistory = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/message/chat/${conversationId}?page=1&pageSize=20`
      );
      const result = await response.json();

      if (result.code === 200) {
        setConversationInfo({
          conversationId: result.data.conversationId,
          userId: result.data.userId,
          userInfo: result.data.userInfo
        });

        setMessageData({
          list: result.data.messages.reverse(), // 倒序显示
          total: result.data.total,
          hasMore: result.data.hasMore,
          page: 1,
          pageSize: 20
        });
      }
    } catch (error) {
      console.error('加载聊天记录失败:', error);
    } finally {
      setLoading(false);
    }
  };

  // 建立WebSocket连接
  const connectWebSocket = () => {
    const websocket = new WebSocket('ws://your-server.com/ws');

    websocket.onopen = () => {
      console.log('WebSocket连接成功');
      // 发送认证信息
      websocket.send(JSON.stringify({
        type: 'auth',
        token: getAuthToken()
      }));
    };

    websocket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      handleWebSocketMessage(data);
    };

    websocket.onerror = (error) => {
      console.error('WebSocket错误:', error);
    };

    websocket.onclose = () => {
      console.log('WebSocket连接关闭');
      // 重连逻辑
      setTimeout(connectWebSocket, 3000);
    };

    setWs(websocket);
  };

  // 处理WebSocket消息
  const handleWebSocketMessage = (data: any) => {
    switch (data.type) {
      case 'new_message':
        // 收到新消息
        if (data.conversationId === conversationId) {
          addMessage(data.message);
          markMessagesAsRead();
        }
        break;

      case 'message_read':
        // 消息已读回执
        updateMessageStatus(data.messageId, 2);
        break;

      case 'message_recalled':
        // 消息被撤回
        handleMessageRecalled(data.messageId);
        break;

      case 'typing':
        // 对方正在输入
        if (data.userId === userId) {
          setIsTyping(true);
          // 3秒后清除输入状态
          if (typingTimeout) clearTimeout(typingTimeout);
          const timeout = setTimeout(() => setIsTyping(false), 3000);
          setTypingTimeout(timeout);
        }
        break;

      case 'online_status':
        // 在线状态变化
        if (data.userId === userId) {
          setConversationInfo(prev => ({
            ...prev,
            userInfo: {
              ...prev.userInfo,
              isOnline: data.isOnline
            }
          }));
        }
        break;
    }
  };

  // 发送文字消息
  const sendTextMessage = async () => {
    if (!inputText.trim()) return;

    const tempMessage: Message = {
      messageId: `temp_${Date.now()}`,
      conversationId,
      senderId: getCurrentUserId(),
      receiverId: userId,
      messageType: 'text',
      content: inputText,
      status: 0,
      isRecalled: false,
      createdAt: new Date().toISOString(),
      isMine: true,
      isTemp: true
    };

    // 乐观更新:立即添加到列表
    addMessage(tempMessage);
    setInputText('');

    try {
      const response = await fetch('/api/message/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conversationId,
          receiverId: userId,
          messageType: 'text',
          content: tempMessage.content
        })
      });

      const result = await response.json();

      if (result.code === 200) {
        // 成功:替换临时消息
        updateTempMessage(tempMessage.messageId, {
          messageId: result.data.messageId,
          status: 1,
          isTemp: false
        });
      } else {
        // 失败:标记为失败
        updateMessageStatus(tempMessage.messageId, 3);
      }
    } catch (error) {
      console.error('发送消息失败:', error);
      updateMessageStatus(tempMessage.messageId, 3);
    }
  };

  // 其他方法...
  return {
    loading,
    loadingMore,
    uploading,
    conversationInfo,
    messageData,
    inputText,
    showEmojiPanel,
    showMorePanel,
    inputMode,
    isTyping,
    // 方法
    setInputText,
    sendTextMessage,
    sendImageMessage,
    sendVoiceMessage,
    sendVideoMessage,
    recallMessage,
    deleteMessage,
    loadMoreMessages,
    markMessagesAsRead,
    toggleEmojiPanel,
    toggleMorePanel,
    toggleInputMode,
    handleLongPress,
  };
};
```

---

## 前端验证

### 文字消息验证

```typescript
const validateTextMessage = (content: string) => {
  if (!content || !content.trim()) {
    return { valid: false, error: '消息不能为空' };
  }

  if (content.length > 500) {
    return { valid: false, error: '消息不能超过500字符' };
  }

  return { valid: true };
};
```

### 图片文件验证

```typescript
const validateImageFile = (file: File) => {
  const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
  if (!validTypes.includes(file.type)) {
    return { valid: false, error: '只支持JPG、PNG、GIF格式' };
  }

  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    return { valid: false, error: '图片大小不能超过10MB' };
  }

  return { valid: true };
};
```

### 语音文件验证

```typescript
const validateVoiceFile = (file: File, duration: number) => {
  const validTypes = ['audio/mp3', 'audio/wav', 'audio/m4a'];
  if (!validTypes.includes(file.type)) {
    return { valid: false, error: '只支持MP3、WAV、M4A格式' };
  }

  const maxSize = 2 * 1024 * 1024; // 2MB
  if (file.size > maxSize) {
    return { valid: false, error: '语音文件不能超过2MB' };
  }

  if (duration < 1 || duration > 60) {
    return { valid: false, error: '语音时长必须在1-60秒之间' };
  }

  return { valid: true };
};
```

### 视频文件验证

```typescript
const validateVideoFile = (file: File, duration: number) => {
  const validTypes = ['video/mp4', 'video/quicktime'];
  if (!validTypes.includes(file.type)) {
    return { valid: false, error: '只支持MP4、MOV格式' };
  }

  const maxSize = 50 * 1024 * 1024; // 50MB
  if (file.size > maxSize) {
    return { valid: false, error: '视频文件不能超过50MB' };
  }

  if (duration < 1 || duration > 60) {
    return { valid: false, error: '视频时长必须在1-60秒之间' };
  }

  return { valid: true };
};
```

---

## 交互行为

### 1. 页面加载

**进入聊天页面时:**
1. 显示骨架屏
2. 调用接口1:获取聊天记录
3. 调用接口3:标记消息已读
4. 建立WebSocket连接
5. 渲染消息列表
6. 滚动到底部
7. 隐藏骨架屏

**加载失败:**
- 显示错误提示:"加载失败,点击重试"
- 提供重试按钮

### 2. 发送文字消息

**操作步骤:**
1. 用户在输入框输入文字
2. 发送按钮变为可用状态(紫色)
3. 用户点击发送按钮
4. 立即在列表底部显示消息(发送中状态)
5. 清空输入框
6. 调用接口2发送消息
7. 成功:显示送达标记(单勾)
8. 对方阅读后:显示已读标记(双勾,蓝色)
9. 失败:显示红色感叹号,可点击重发

### 3. 发送图片消息

**操作步骤:**
1. 用户点击更多按钮,选择"图片"
2. 打开系统相册选择器
3. 用户选择图片
4. 显示图片预览,确认发送
5. 显示上传进度
6. 上传完成后,立即在列表显示图片消息
7. 发送消息
8. 成功/失败处理同文字消息

### 4. 发送语音消息

**操作步骤:**
1. 用户点击麦克风按钮切换到语音模式
2. 长按录音按钮开始录音
3. 显示录音时长和波形动画
4. 松手结束录音
5. 上滑取消录音
6. 录音完成自动上传并发送
7. 显示语音消息(波形图标+时长)

### 5. 发送视频消息

**操作步骤:**
1. 用户点击更多按钮,选择"视频"
2. 打开系统相册选择器
3. 用户选择视频
4. 显示视频预览(封面+时长)
5. 确认发送,显示上传进度
6. 上传完成后发送消息
7. 显示视频消息(封面+播放按钮+时长)

### 6. 撤回消息

**操作步骤:**
1. 用户长按自己的消息
2. 弹出操作菜单:"撤回"、"删除"、"取消"
3. 用户点击"撤回"
4. 检查时间:
   - <2分钟:调用接口4撤回
   - ≥2分钟:提示"超过2分钟,无法撤回"
5. 成功:消息替换为"你撤回了一条消息"
6. 对方收到:"XXX撤回了一条消息"

### 7. 删除消息

**操作步骤:**
1. 用户长按消息
2. 弹出操作菜单:"撤回"、"删除"、"取消"
3. 用户点击"删除"
4. 弹出确认对话框:"确定删除这条消息吗?"
5. 用户确认
6. 调用接口5删除消息
7. 成功:从列表移除该消息

### 8. 查看图片

**操作步骤:**
1. 用户点击图片消息
2. 全屏显示图片
3. 支持缩放、拖动
4. 长按:弹出"保存图片"、"转发"、"取消"
5. 左右滑动:查看上一张/下一张图片

### 9. 播放语音

**操作步骤:**
1. 用户点击语音消息
2. 播放语音,波形动画
3. 显示播放进度
4. 再次点击:暂停播放
5. 播放完成:自动停止

### 10. 播放视频

**操作步骤:**
1. 用户点击视频消息
2. 全屏播放视频
3. 显示播放控制条
4. 支持暂停/继续、进度拖动、音量调节
5. 点击返回:关闭播放器

### 11. 上拉加载更多

**操作步骤:**
1. 用户滚动到列表顶部
2. 检查hasMore标志
3. 如果hasMore=true:
   - 显示加载动画
   - 调用接口1,page递增
   - 新消息插入列表顶部
   - 恢复滚动位置
4. 如果hasMore=false:
   - 显示"没有更多消息了"

### 12. 输入状态提示

**本地:**
1. 用户开始输入
2. 通过WebSocket发送"typing"事件
3. 每3秒发送一次(如果仍在输入)
4. 停止输入3秒后停止发送

**对方:**
1. 收到"typing"事件
2. 显示"正在输入..."(三点跳动动画)
3. 3秒后自动隐藏

---

## 测试要点

### 功能测试
- [ ] 聊天记录加载正常
- [ ] 文字消息发送成功
- [ ] 图片消息发送成功
- [ ] 语音消息录制和发送成功
- [ ] 视频消息发送成功
- [ ] 消息已读状态更新正确
- [ ] 消息撤回功能正常
- [ ] 消息删除功能正常
- [ ] 实时消息接收正常
- [ ] 上拉加载更多正常
- [ ] 输入状态提示正常
- [ ] 在线状态显示正确

### 边界测试
- [ ] 空消息验证
- [ ] 超长消息验证(>500字符)
- [ ] 图片文件类型验证
- [ ] 图片大小验证(>10MB)
- [ ] 语音时长验证(>60秒)
- [ ] 视频大小验证(>50MB)
- [ ] 撤回超时验证(>2分钟)
- [ ] 会话不存在处理
- [ ] 网络异常处理
- [ ] WebSocket断线重连
- [ ] Token过期处理

### 性能测试
- [ ] 消息列表渲染流畅(>1000条消息)
- [ ] 图片上传响应速度
- [ ] 视频上传响应速度
- [ ] WebSocket消息延迟<500ms
- [ ] 内存占用合理
- [ ] 长时间聊天不卡顿

### 安全测试
- [ ] XSS攻击防护
- [ ] 文件类型验证
- [ ] 文件大小限制
- [ ] 权限验证(只能查看自己的会话)
- [ ] 消息加密传输(HTTPS/WSS)

### 兼容性测试
- [ ] iOS系统(13+)
- [ ] Android系统(8+)
- [ ] 不同屏幕尺寸
- [ ] 深色模式适配
- [ ] 横屏显示

---

## 使用的后端服务

### ChatService (05-chat模块)
**服务端口:** 8005
**调用接口:**
1. `GET /api/message/chat/{conversationId}` - 获取聊天记录
2. `POST /api/message/send` - 发送消息
3. `PUT /api/message/read/{conversationId}` - 标记消息已读
4. `POST /api/message/recall/{messageId}` - 撤回消息
5. `DELETE /api/message/{messageId}` - 删除消息
6. `POST /api/message/upload` - 上传媒体文件

**WebSocket连接:**
- 路径: `ws://your-server.com:8005/ws`
- 事件:new_message, message_read, message_recalled, typing, online_status

**RPC调用:**
- 无直接RPC调用

---

## 相关页面

### 同模块页面
- **01-消息主页页面** - 点击返回按钮返回
  - 路由:`/message/main`
  - 关系:父页面

### 其他模块页面
- **用户主页** - 点击头像跳转
  - 传递参数:userId
  - 所属模块:02-user模块
  - 路由:`/user/profile/:userId`

- **举报页面** - 点击更多→举报
  - 传递参数:targetType=user, targetId=userId
  - 所属模块:06-common模块
  - 路由:`/report/submit`

---

## 样式规范

### 颜色系统
```css
/* 主色调 */
--primary-purple: #9333ea;
--primary-blue: #3b82f6;

/* 文字颜色 */
--text-primary: #1a1a1a;
--text-secondary: #666666;
--text-tertiary: #999999;

/* 消息气泡背景 */
--bubble-mine: #9333ea;      /* 我的消息 */
--bubble-other: #ffffff;     /* 对方消息 */
--bubble-system: #f5f5f5;    /* 系统提示 */

/* 状态颜色 */
--success: #10b981;          /* 已送达 */
--read: #3b82f6;             /* 已读 */
--error: #ef4444;            /* 失败 */
--online: #10b981;           /* 在线 */
--offline: #999999;          /* 离线 */
```

### 消息气泡样式
```css
/* 对方消息气泡 */
.message-bubble-other {
  background: var(--bubble-other);
  border-radius: 8px 8px 8px 2px;
  padding: 12px;
  max-width: 70%;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 我的消息气泡 */
.message-bubble-mine {
  background: var(--bubble-mine);
  border-radius: 8px 8px 2px 8px;
  padding: 12px;
  max-width: 70%;
  color: white;
}

/* 系统提示 */
.message-system {
  text-align: center;
  color: var(--text-tertiary);
  font-size: 13pt;
  padding: 8px 0;
}
```

---

## 性能优化

### 消息列表优化
- 使用FlatList虚拟滚动
- 设置keyExtractor为messageId
- 使用React.memo优化消息气泡组件
- 图片懒加载
- 限制渲染区域(只渲染可见消息±10条)

### WebSocket优化
- 心跳检测(每30秒ping一次)
- 自动重连机制(指数退避算法)
- 消息队列(离线时缓存,上线后批量发送)
- 去重处理(防止重复消息)

### 媒体文件优化
- 图片压缩(上传前压缩到合适尺寸)
- 缩略图预加载
- 视频封面缓存
- CDN加速

### 缓存策略
- 聊天记录缓存10分钟
- 媒体URL缓存1小时
- 用户信息缓存30分钟

---

## 异常处理

| 场景 | 前端处理方式 |
|-----|------------|
| 会话不存在(404) | 显示:"会话不存在",返回消息主页 |
| 无权限(403) | 显示:"无权限访问",返回消息主页 |
| 对方已拉黑 | 显示:"对方已将你拉黑,无法发送消息" |
| 消息发送失败 | 显示红色感叹号,可点击重发 |
| 上传文件失败 | 显示:"上传失败,请稍后重试" |
| 撤回超时 | 显示:"超过2分钟,无法撤回" |
| WebSocket断开 | 自动重连,显示"连接已断开" |
| 网络异常 | 显示:"网络异常,请检查网络设置" |
| Token过期(401) | 跳转登录页 |
| 服务器错误(500) | 显示:"操作失败,请稍后重试" |

---

**文档版本:** v1.0
**创建日期:** 2025-11-14
**所属模块:** 05-chat模块
**维护团队:** 消息团队
