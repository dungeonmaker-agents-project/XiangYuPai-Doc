# 01-消息主页页面

## 页面概述

### 功能描述
消息主页是用户查看所有消息和通知的中心页面,包含会话列表和消息分类功能。用户可以查看私信对话、赞和收藏通知、评论通知、粉丝通知和系统通知。

### 路由信息
- **路由路径**: `/message/main`
- **页面类型**: Tab主页面
- **前置条件**: 需要用户登录

### 主要功能
1. **会话列表展示** - 显示最近的私信会话,包含最后一条消息预览和未读数
2. **消息分类Tab** - 4个通知分类:赞和收藏、评论、粉丝、系统通知
3. **未读角标** - 实时显示各分类的未读消息数
4. **下拉刷新** - 支持下拉刷新会话列表
5. **上拉加载** - 支持上拉加载更多会话
6. **清除功能** - 支持清除所有消息通知
7. **会话管理** - 左滑删除会话(iOS)或长按删除(Android)

---

## 页面结构

### 布局层级
```
消息主页
├── 顶部导航栏
│   ├── 标题:"消息"
│   └── 清除按钮(右上角垃圾桶图标)
├── 消息分类Tab区
│   ├── 赞和收藏(未读角标)
│   ├── 评论(未读角标)
│   ├── 粉丝(未读角标)
│   └── 系统通知(未读角标)
├── 会话列表区
│   ├── 会话项1
│   ├── 会话项2
│   └── ...
└── 底部Tab栏
    ├── 首页
    ├── 发现
    ├── 消息(当前选中)
    └── 我的
```

### 视觉设计

#### 顶部导航栏
- 高度:56px
- 背景:白色 (#ffffff)
- 标题:"消息"
  - 字体大小:20pt
  - 字体粗细:加粗
  - 颜色:深灰色 (#1a1a1a)
  - 位置:居中
- 清除按钮:垃圾桶图标
  - 尺寸:24x24px
  - 点击区域:44x44px
  - 颜色:深灰色 (#666)
  - 位置:右上角

#### 消息分类Tab区
- 高度:80px
- 间距:左右边距24px
- 4个分类均分宽度,每个占25%

**分类项结构:**
1. 图标
   - 尺寸:48x48px
   - 圆角:8px
   - 背景色:
     - 赞和收藏:粉红色 (#fce7f3)
     - 评论:蓝色 (#dbeafe)
     - 粉丝:橙色 (#fed7aa)
     - 系统通知:紫色 (#e9d5ff)

2. 标题文字
   - 字体大小:14pt
   - 颜色:深灰色 (#333)
   - 位置:图标下方8px
   - 对齐:居中

3. 未读角标
   - 位置:图标右上角
   - 背景:红色 (#ef4444)
   - 文字:白色,12pt
   - 尺寸:
     - 1位数:18x18px圆形
     - 2位数:自动扩展宽度
     - 超过99显示"99+"
   - 显示条件:未读数 > 0

#### 会话列表区

**会话项布局:**
- 高度:88px
- 左右边距:20px
- 底部分割线:1px浅灰色 (#f5f5f5)

**会话项结构:**
1. **左侧头像**
   - 尺寸:56x56px
   - 圆形
   - 在线状态角标:
     - 位置:右下角
     - 尺寸:12x12px
     - 颜色:绿色 (#10b981)
     - 边框:2px白色

2. **中间内容区**
   - 左边距:12px(距离头像)
   - 右边距:60px(为时间留空间)

   **第一行:**
   - 昵称
     - 字体大小:16pt
     - 字体粗细:中等加粗
     - 颜色:深灰色 (#1a1a1a)
     - 最大宽度:60%
     - 超长显示省略号

   **第二行:**
   - 最后消息内容
     - 字体大小:14pt
     - 颜色:浅灰色 (#999)
     - 最多显示1行
     - 超长显示省略号
     - 距离第一行:4px

3. **右上角时间**
   - 字体大小:12pt
   - 颜色:浅灰色 (#999)
   - 位置:右对齐
   - 右边距:20px
   - 格式:
     - 1小时内:"X分钟前"
     - 今天:"HH:MM"
     - 昨天:"昨天"
     - 更早:"MM-DD"

4. **未读角标**
   - 位置:右侧,消息内容同一行
   - 背景:红色 (#ef4444)
   - 文字:白色,12pt
   - 尺寸:
     - 1位数:18x18px圆形
     - 2位数:自动扩展
   - 显示条件:未读数 > 0
   - 右边距:20px

**空状态:**
```
[空状态图标]
暂无消息
```
- 图标:灰色消息图标
- 文字:"暂无消息"
- 字体大小:16pt
- 颜色:浅灰色 (#999)
- 位置:垂直居中

#### 底部Tab栏
- 高度:56px + 安全区域
- 背景:白色
- 顶部分割线:1px浅灰色
- 当前选中:"消息"
  - 图标:紫色 (#9333ea)
  - 文字:紫色,加粗
- 未选中:
  - 图标:灰色 (#999)
  - 文字:灰色

---

## 接口列表

### 接口1:获取消息分类未读数
**接口:** `GET /api/message/unread-count`

**触发时机:** 进入消息页面时 / 应用恢复前台时

**请求参数:**
```typescript
// 无需参数,从token中获取用户ID
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功,其他=失败
  message: string;        // 提示信息
  data: {
    likes: number;        // 赞和收藏未读数
    comments: number;     // 评论未读数
    followers: number;    // 粉丝未读数
    system: number;       // 系统通知未读数
    total: number;        // 总未读数
  }
}
```

**业务逻辑:**
1. 从token中解析当前用户ID
2. 查询用户各类通知的未读数
3. 计算总未读数并返回

**错误码:**
- 200:成功
- 401:未登录

---

### 接口2:获取会话列表
**接口:** `GET /api/message/conversations`

**触发时机:** 进入消息页面时 / 下拉刷新 / 上拉加载

**请求参数:**
```typescript
{
  page: number;           // 页码,从1开始
  pageSize: number;       // 每页数量,默认20
  lastMessageId?: string; // 最后一条消息ID,用于分页加载
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    total: number;        // 会话总数
    hasMore: boolean;     // 是否有更多数据
    list: Array<{
      conversationId: string;   // 会话ID
      userId: string;           // 对方用户ID
      nickname: string;         // 对方昵称
      avatar: string;           // 对方头像URL
      lastMessage: string;      // 最后一条消息内容
      lastMessageTime: string;  // 最后消息时间,ISO格式
      unreadCount: number;      // 未读消息数
      isOnline: boolean;        // 对方是否在线
    }>;
  }
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 查询用户的会话列表
3. 按最后消息时间倒序排序
4. 分页返回数据

**错误码:**
- 200:成功
- 400:参数错误
- 401:未登录

---

### 接口3:删除会话
**接口:** `DELETE /api/message/conversation/{conversationId}`

**触发时机:** 用户左滑会话点击删除 / 长按会话选择删除

**请求参数:**
```typescript
{
  conversationId: string; // 会话ID (路径参数)
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 验证会话属于当前用户
3. 软删除会话记录
4. 返回删除成功

**错误码:**
- 200:成功
- 403:无权限访问该会话
- 404:会话不存在

---

### 接口4:清除所有消息通知
**接口:** `POST /api/message/clear-all`

**触发时机:** 用户点击右上角清除按钮后确认

**请求参数:**
```typescript
// 无需参数,从token中获取用户ID
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证用户登录状态
2. 批量软删除用户的所有会话
3. 清除所有未读标记
4. 返回清除成功

**错误码:**
- 200:成功
- 401:未登录
- 500:操作失败

---

## 数据流

### 页面加载流程

```
用户进入消息页面
  ↓
1. 显示骨架屏或加载动画
  ↓
2. 并行调用接口
  ├── 接口1:获取未读数 → 更新Tab角标
  └── 接口2:获取会话列表 → 显示会话列表
  ↓
3. 加载完成,隐藏骨架屏
  ↓
4. 渲染完整页面
```

**失败处理:**
- 显示错误提示:"加载失败,点击重试"
- 提供重试按钮

### 点击分类Tab流程

```
用户点击通知分类Tab (赞和收藏/评论/粉丝/系统通知)
  ↓
1. 跳转到对应的通知子页面
  ↓
2. 传递参数:notificationType
  ↓
3. 通知页面加载(详见通知页面文档)
  ↓
4. 自动标记为已读
  ↓
5. 清除该分类的未读角标
```

### 点击会话流程

```
用户点击会话项
  ↓
1. 跳转到聊天页面
  ↓
2. 传递参数:
   - conversationId
   - userId
   - nickname
   - avatar
  ↓
3. 聊天页面加载(详见聊天页面文档)
  ↓
4. 自动标记会话已读
  ↓
5. 清除该会话的未读角标
```

### 删除会话流程

```
用户左滑会话(iOS) / 长按会话(Android)
  ↓
1. 显示"删除"按钮(iOS) / 弹出操作菜单(Android)
  ↓
2. 用户点击删除
  ↓
3. 弹出确认对话框:"确定删除该会话吗?"
  ├── 取消 → 关闭对话框
  └── 确定 → 继续
      ↓
4. 调用接口3:删除会话
  ↓
5. 成功后
   - 从列表中移除该会话
   - 显示提示:"删除成功"
  ↓
6. 失败后
   - 显示错误提示:"删除失败,请稍后重试"
```

### 清除所有消息流程

```
用户点击右上角清除按钮
  ↓
1. 弹出确认对话框:"确定清除所有的消息通知吗?"
  ├── 取消 → 关闭对话框
  └── 确定 → 继续
      ↓
2. 调用接口4:清除所有消息通知
  ↓
3. 成功后
   - 清空会话列表
   - 清空所有未读角标
   - 显示空状态:"暂无消息"
   - 显示提示:"清除成功"
  ↓
4. 失败后
   - 显示错误提示:"清除失败,请稍后重试"
```

---

## 状态管理

### 页面状态接口

```typescript
interface MessageMainPageState {
  // 加载状态
  loading: boolean;
  refreshing: boolean;
  loadingMore: boolean;

  // 未读数数据
  unreadCount: {
    likes: number;
    comments: number;
    followers: number;
    system: number;
    total: number;
  };

  // 会话列表数据
  conversationData: {
    list: Conversation[];
    total: number;
    hasMore: boolean;
    page: number;
    pageSize: number;
  };

  // UI状态
  showClearConfirm: boolean;
  swipingConversationId: string | null; // iOS左滑状态
}

interface Conversation {
  conversationId: string;
  userId: string;
  nickname: string;
  avatar: string;
  lastMessage: string;
  lastMessageTime: string;
  unreadCount: number;
  isOnline: boolean;
}
```

### 状态管理Hook

```typescript
const useMessageMainPage = () => {
  // 状态定义
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);
  const [unreadCount, setUnreadCount] = useState({
    likes: 0,
    comments: 0,
    followers: 0,
    system: 0,
    total: 0
  });
  const [conversationData, setConversationData] = useState({
    list: [],
    total: 0,
    hasMore: false,
    page: 1,
    pageSize: 20
  });
  const [showClearConfirm, setShowClearConfirm] = useState(false);
  const [swipingConversationId, setSwipingConversationId] = useState<string | null>(null);

  // 初始化加载
  useEffect(() => {
    loadInitialData();
  }, []);

  // 加载初始数据
  const loadInitialData = async () => {
    setLoading(true);
    try {
      await Promise.all([
        fetchUnreadCount(),
        fetchConversations(1)
      ]);
    } catch (error) {
      console.error('加载失败:', error);
    } finally {
      setLoading(false);
    }
  };

  // 其他方法...
  return {
    loading,
    refreshing,
    loadingMore,
    unreadCount,
    conversationData,
    showClearConfirm,
    swipingConversationId,
    // 方法
    handleRefresh,
    handleLoadMore,
    handleConversationClick,
    handleConversationDelete,
    handleClearAll,
    handleTabClick,
  };
};
```

---

## 前端验证

### 分页参数验证

```typescript
const validatePaginationParams = (page: number, pageSize: number) => {
  if (page < 1) {
    return { valid: false, error: '页码必须大于等于1' };
  }

  if (pageSize < 10 || pageSize > 50) {
    return { valid: false, error: '每页数量必须在10-50之间' };
  }

  return { valid: true };
};
```

### 时间格式化

```typescript
const formatMessageTime = (timestamp: string): string => {
  const now = new Date();
  const messageTime = new Date(timestamp);
  const diff = now.getTime() - messageTime.getTime();

  // 1小时内
  if (diff < 60 * 60 * 1000) {
    const minutes = Math.floor(diff / (60 * 1000));
    return `${minutes}分钟前`;
  }

  // 今天
  if (now.toDateString() === messageTime.toDateString()) {
    const hours = messageTime.getHours().toString().padStart(2, '0');
    const minutes = messageTime.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // 昨天
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (yesterday.toDateString() === messageTime.toDateString()) {
    return '昨天';
  }

  // 更早
  const month = (messageTime.getMonth() + 1).toString().padStart(2, '0');
  const day = messageTime.getDate().toString().padStart(2, '0');
  return `${month}-${day}`;
};
```

---

## 交互行为

### 1. 页面加载

**进入消息页面时:**
1. 显示骨架屏或加载动画
2. 并行调用以下接口:
   - 接口1:获取未读数 → 更新Tab角标
   - 接口2:获取会话列表 → 显示会话列表
3. 加载完成后隐藏骨架屏

**加载失败:**
- 显示错误提示:"加载失败,点击重试"
- 提供重试按钮

### 2. 下拉刷新

**操作步骤:**
1. 用户下拉列表
2. 显示下拉刷新动画
3. 重新调用接口1和接口2(page=1)
4. 替换当前数据
5. 隐藏刷新动画
6. 显示提示:"刷新成功"

### 3. 上拉加载更多

**操作步骤:**
1. 用户滚动到列表底部
2. 检查hasMore标志
3. hasMore为true时:
   - 显示加载动画
   - 调用接口2(page递增,传入lastMessageId)
   - 追加新数据到列表末尾
   - 隐藏加载动画
4. hasMore为false时:
   - 显示提示:"没有更多会话了"

### 4. 点击通知分类Tab

**操作步骤:**
1. 用户点击分类Tab(赞和收藏/评论/粉丝/系统通知)
2. 跳转到对应的通知子页面
3. 传递参数:notificationType
4. 通知页面自动标记为已读
5. 清除该分类的未读角标

### 5. 点击会话

**操作步骤:**
1. 用户点击会话项
2. 跳转到聊天页面
3. 传递参数:conversationId, userId, nickname, avatar
4. 聊天页面自动标记会话已读
5. 清除该会话的未读角标

### 6. 左滑删除会话(iOS)

**操作步骤:**
1. 用户左滑会话项
2. 显示"删除"按钮(红色背景)
3. 用户点击删除按钮
4. 弹出确认对话框:"确定删除该会话吗?"
   - 按钮1:"取消" - 关闭对话框
   - 按钮2:"确定" - 调用接口3删除会话
5. 成功后从列表移除该会话
6. 显示提示:"删除成功"

### 7. 长按删除会话(Android)

**操作步骤:**
1. 用户长按会话项
2. 弹出操作菜单:
   - "删除会话"
   - "取消"
3. 用户点击"删除会话"
4. 后续流程同iOS左滑删除

### 8. 清除所有消息

**操作步骤:**
1. 用户点击右上角清除按钮
2. 弹出确认对话框:"确定清除所有的消息通知吗?"
   - 按钮1:"取消" - 关闭对话框
   - 按钮2:"确定" - 调用接口4清除所有消息
3. 成功后:
   - 清空会话列表
   - 清空所有未读角标
   - 显示空状态:"暂无消息"
   - 显示提示:"清除成功"

---

## 测试要点

### 功能测试
- [ ] 未读数显示准确
- [ ] 会话列表加载正常
- [ ] 分类Tab切换正常
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多功能正常
- [ ] 删除会话功能正常
- [ ] 清除所有消息功能正常
- [ ] 时间格式化正确
- [ ] 在线状态显示正确
- [ ] 未读角标显示正确

### 边界测试
- [ ] 空会话列表显示
- [ ] 网络异常处理
- [ ] 快速重复点击
- [ ] 长文本消息显示省略号
- [ ] 超长时间格式化
- [ ] 未读数超过99显示"99+"

### 兼容性测试
- [ ] iOS系统(13+)
- [ ] Android系统(8+)
- [ ] 不同屏幕尺寸
- [ ] 深色模式适配

### 性能测试
- [ ] 列表渲染流畅度
- [ ] 下拉刷新响应速度
- [ ] 上拉加载响应速度
- [ ] 内存占用合理

---

## 使用的后端服务

### ChatService (05-chat模块)
**服务端口:** 8005
**调用接口:**
1. `GET /api/message/unread-count` - 获取未读数
2. `GET /api/message/conversations` - 获取会话列表
3. `DELETE /api/message/conversation/{conversationId}` - 删除会话
4. `POST /api/message/clear-all` - 清除所有消息

**RPC调用:**
- 无直接RPC调用

---

## 相关页面

### 同模块页面
- **02-聊天页面** - 点击会话后跳转
  - 传递参数:conversationId, userId, nickname, avatar
  - 路由:`/message/chat/:conversationId`

- **03-通知页面** - 点击分类Tab后跳转
  - 传递参数:notificationType
  - 路由:`/message/notification/:type`
  - 类型:likes, comments, followers, system

### 其他模块页面
- **用户主页** - 点击会话头像跳转
  - 传递参数:userId
  - 所属模块:02-user模块

- **个人主页** - 底部Tab切换
  - 所属模块:02-user模块

---

## 样式规范

### 颜色系统
```css
/* 主色调 */
--primary-purple: #9333ea;
--primary-blue: #3b82f6;

/* 文字颜色 */
--text-primary: #1a1a1a;
--text-secondary: #666666;
--text-tertiary: #999999;

/* 背景色 */
--bg-white: #ffffff;
--bg-gray: #f5f5f5;
--bg-like: #fce7f3;
--bg-comment: #dbeafe;
--bg-follower: #fed7aa;
--bg-system: #e9d5ff;

/* 状态颜色 */
--success: #10b981;
--error: #ef4444;
--online: #10b981;
```

### 会话项样式
```css
.conversation-item {
  height: 88px;
  padding: 0 20px;
  background: var(--bg-white);
  border-bottom: 1px solid #f5f5f5;
  display: flex;
  align-items: center;
}

.conversation-item.unread {
  background: #fafafa;
}
```

### 未读角标样式
```css
.unread-badge {
  min-width: 18px;
  height: 18px;
  background: var(--error);
  color: white;
  font-size: 12pt;
  border-radius: 9px;
  padding: 0 6px;
  display: flex;
  align-items: center;
  justify-content: center;
}
```

---

## 性能优化

### 列表优化
- 使用FlatList虚拟滚动
- 设置keyExtractor为conversationId
- 使用React.memo优化会话项组件
- 图片懒加载(头像)

### 缓存策略
- 会话列表缓存5分钟
- 未读数缓存3分钟
- 下拉刷新清除缓存

### 接口优化
- 并行请求未读数和会话列表
- 防抖处理下拉刷新(间隔1秒)
- 接口取消(页面离开时取消未完成请求)

---

## 异常处理

| 场景 | 前端处理方式 |
|-----|------------|
| 权限不足(403) | 显示:"无权限访问",返回上一页 |
| 会话不存在(404) | 显示:"会话不存在或已删除" |
| 参数错误(400) | 显示:"请求参数错误" |
| 网络错误 | 显示:"网络异常,请检查网络设置" + 重试按钮 |
| 未登录(401) | 跳转登录页 |
| 服务器错误(500) | 显示:"操作失败,请稍后重试" |

---

**文档版本:** v1.0
**创建日期:** 2025-11-14
**所属模块:** 05-chat模块
**维护团队:** 消息团队
