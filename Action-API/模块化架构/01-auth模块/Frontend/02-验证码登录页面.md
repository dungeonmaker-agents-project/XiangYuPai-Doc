# 02-验证码登录页面

## 一、页面概述

- **路由路径**: `/auth/login/sms`
- **页面功能**: 用户使用手机号+验证码登录，未注册用户自动注册
- **用户角色**: 未登录用户
- **页面类型**: 认证页面

## 二、页面结构

### 2.1 顶部状态栏
- 系统状态栏（时间、信号、电池）
- 背景：白色/浅色

### 2.2 欢迎区域
```
您好！
欢迎使用探店
```
- **主标题**: "您好！"
  - 字体加粗，32-36pt
  - 颜色：#1a1a1a

- **副标题**: "欢迎使用探店"
  - 常规字体，32-36pt
  - 颜色：#1a1a1a

### 2.3 表单区域

#### 手机号输入
```
[+86 ▼]  [请输入手机号_________________ ⊗]
```

**国家区号选择器:**
- 默认值：`+86`
- 宽度：80px，高度：48px
- 支持国家同密码登录页

**手机号输入框:**
- 占位符："请输入手机号"
- 输入类型：`tel`
- 最大长度：11位（+86）
- 清空按钮：有内容时显示

#### 获取验证码按钮
```
┌──────────────────────────────────────┐
│          获取验证码                   │
└──────────────────────────────────────┘
```

**初始状态:**
- 文字："获取验证码"
- 背景：紫色到蓝色渐变
- 启用条件：手机号格式正确

**倒计时状态:**
- 文字："59秒后重新获取验证码" (59→58→...→1)
- 背景：浅灰色(#e5e5e5)
- 文字颜色：灰色(#999)
- 禁用状态

#### 验证码输入区
```
[3] [6] [1] [2] [3] [4]
```

**6个独立输入框:**
- 数量：6个
- 每个宽度：48px，高度：56px
- 间距：12px
- 圆角：8px
- 边框：1px 浅灰色(#e5e5e5)
- 聚焦边框：2px 紫色(#9333ea)
- 字体大小：24pt
- 输入类型：`tel`（数字键盘）
- 每个输入框限制1位数字

**自动聚焦逻辑:**
- 输入数字后自动跳到下一个输入框
- 删除数字后自动跳回上一个输入框
- 第6个输入框输入完成后：
  - 自动收起键盘
  - 自动提交验证码登录

#### 辅助链接
```
密码登陆
```
- 文字："密码登陆"
- 颜色：紫色(#9333ea)
- 功能：跳转到密码登录页面

### 2.4 底部提示与协议

**自动注册提示:**
```
未注册手机号验证后自动创建账号
```
- 字体大小：12pt
- 颜色：浅灰色(#999)

**用户协议:**
```
登陆即表明同意《探店用户协议》和《隐私政策》
```

## 三、接口列表

### 3.1 页面加载时调用

无初始化接口

### 3.2 用户操作触发

#### 1. 发送验证码

**接口:** `POST /api/auth/sms/send`

**触发时机:** 用户点击"获取验证码"按钮

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号，例如："+86"
  phoneNumber: string;      // 手机号，例如："13147046323"
  purpose: "LOGIN"          // 固定值，表示用于登录
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;        // 提示信息
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | "验证码已发送" |
| 400 | 参数错误 | "请检查输入信息" |
| 429 | 发送频繁 | "发送过于频繁，请稍后再试" |
| 500 | 服务器错误 | "发送失败，请稍后重试" |

#### 2. 验证码登录

**接口:** `POST /api/auth/login/sms`

**触发时机:** 用户输入完第6位验证码后自动触发

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号
  phoneNumber: string;      // 手机号
  verificationCode: string; // 6位验证码
  agreeToTerms: boolean;    // 用户协议勾选状态，必须为true
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;        // 提示信息
  data: {
    token: string;        // 登录凭证
    userId: string;       // 用户ID
    nickname: string;     // 用户昵称
    avatar?: string;      // 用户头像
    isNewUser: boolean;   // 是否新注册用户
  } | null
}
```

**特殊说明:** 未注册手机号验证后自动创建账号

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | 跳转到对应页面 |
| 400 | 参数错误 | "请检查输入信息" |
| 401 | 验证码错误 | "验证码错误，请重新输入" |
| 401 | 验证码过期 | "验证码已过期，请重新获取" |
| 500 | 服务器错误 | "登录失败，请稍后重试" |

## 四、数据流

```
用户输入手机号
  ↓
点击"获取验证码"
  ↓
POST /api/auth/sms/send
  ↓
60秒倒计时 + 验证码输入框自动聚焦
  ↓
用户输入6位验证码
  ↓
输入完成自动提交
  ↓
POST /api/auth/login/sms
  ↓
成功: 保存token → 检查isNewUser
  ├─ 新用户: 跳转到完善资料页面
  └─ 老用户: 跳转到主页
失败: 清空验证码 → 显示错误提示
```

## 五、状态管理

```typescript
interface SmsLoginPageState {
  countryCode: string;        // 国家区号，默认："+86"
  phoneNumber: string;        // 手机号
  verificationCode: string;   // 验证码（6位）
  countdown: number;          // 倒计时秒数 (0-60)
  isSubmitting: boolean;      // 是否正在提交
  errors: {
    phoneNumber?: string;     // 手机号错误信息
    verificationCode?: string; // 验证码错误信息
  };
}
```

## 六、前端验证

### 手机号验证
```typescript
const isValidPhoneNumber = (phone: string, countryCode: string) => {
  if (countryCode === '+86') {
    return /^1[3-9]\d{9}$/.test(phone);
  }
  return phone.length >= 8 && phone.length <= 15;
}
```

### 验证码验证
```typescript
const isValidVerificationCode = (code: string) => {
  return /^\d{6}$/.test(code); // 必须是6位数字
}
```

### 发送验证码条件
```typescript
const canSendCode = () => {
  const phoneValid = phoneNumber && isValidPhoneNumber(phoneNumber, countryCode);
  const notInCountdown = countdown === 0; // 倒计时结束

  return phoneValid && notInCountdown;
}
```

## 七、交互行为

### 7.1 手机号输入
- 实时验证格式
- 只允许输入数字
- 有内容时显示清空按钮
- 格式正确后启用"获取验证码"按钮

### 7.2 获取验证码
1. 验证手机号格式
2. 调用发送接口
3. 成功后：
   - 显示Toast："验证码已发送"
   - 按钮文字变为："59秒后重新获取验证码"
   - 开始60秒倒计时
   - 验证码输入框自动聚焦到第1个
4. 失败后：显示错误提示，按钮保持可点击

### 7.3 倒计时管理
```typescript
let countdownTimer: NodeJS.Timeout | null = null;

const startCountdown = () => {
  countdown = 60;

  countdownTimer = setInterval(() => {
    countdown -= 1;

    if (countdown <= 0) {
      clearInterval(countdownTimer!);
      countdownTimer = null;
    }
  }, 1000);
};

// 页面卸载时清理
onUnmount(() => {
  if (countdownTimer) {
    clearInterval(countdownTimer);
  }
});
```

### 7.4 验证码输入
1. 自动聚焦到第1个输入框
2. 输入数字后自动跳到下一个
3. 按删除键自动跳回上一个
4. 输入完第6位后：
   - 自动收起键盘
   - 自动触发验证码登录

### 7.5 自动提交登录
1. 显示加载状态（验证码输入框禁用）
2. 调用登录接口
3. 成功：
   - 保存token和用户信息
   - 检查`isNewUser`标记
   - 新用户 → 跳转到完善资料页面
   - 老用户 → 跳转到主页
4. 失败：
   - 清空验证码输入框
   - 聚焦到第1个输入框
   - 显示错误提示

### 7.6 页面跳转
- **点击"密码登陆"**: 跳转到 `/auth/login/password`
- **点击用户协议**: 打开协议页面(WebView)

## 八、测试要点

### 功能测试
- [ ] 手机号输入验证正确
- [ ] 获取验证码接口调用成功
- [ ] 倒计时显示准确
- [ ] 验证码输入自动跳转正常
- [ ] 输入完成自动提交
- [ ] 登录成功跳转正确
- [ ] 新用户自动注册
- [ ] 错误提示显示正确

### 边界测试
- [ ] 手机号输入超长字符
- [ ] 验证码输入非数字
- [ ] 快速重复点击获取验证码
- [ ] 倒计时期间尝试发送
- [ ] 验证码过期处理
- [ ] 网络异常处理

### 用户体验测试
- [ ] 自动跳转输入框流畅
- [ ] 倒计时数字更新平滑
- [ ] 验证码错误清空流畅

## 九、使用的后端服务

- **AuthService** (认证服务)
  - `POST /api/auth/sms/send` - 发送验证码
  - `POST /api/auth/login/sms` - 验证码登录

## 十、特殊功能

### 自动注册新用户
**说明:** 未注册的手机号验证成功后自动创建账号

**流程:**
1. 用户输入未注册手机号
2. 获取并输入验证码
3. 验证成功后：
   - 后端自动创建账号
   - 返回 `isNewUser: true`
4. 前端根据标记跳转：
   - 新用户 → 完善资料页面 `/user/profile/edit`
   - 老用户 → 主页 `/home`

### 验证码有效期
- 有效期：5-10分钟（后端控制）
- 过期提示："验证码已过期，请重新获取"
- 自动清空输入框

### 发送频率限制
- 限制：60秒内只能发送一次
- 前端倒计时控制
- 后端也会做频率限制（429错误）

---

**使用后端服务:** AuthService (auth模块)
**相关页面:** [01-密码登录页面](./01-密码登录页面.md), [03-忘记密码页面](./03-忘记密码页面.md)
**跳转页面:** 完善资料页面 (user模块)
**最后更新:** 2025-11-14
