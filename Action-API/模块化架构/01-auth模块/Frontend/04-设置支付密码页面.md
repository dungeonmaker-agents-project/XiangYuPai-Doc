# 04-设置支付密码页面

## 一、页面概述

- **路由路径**: `/auth/payment-password/set` 或 `/auth/payment-password/update`
- **页面功能**: 设置或修改支付密码（6位数字）
- **用户角色**: 已登录用户
- **页面类型**: 安全设置页面

## 二、页面结构

### 2.1 顶部导航栏
```
[←]  设置支付密码
```
- 返回按钮：左侧箭头图标
- 标题："设置支付密码" 或 "修改支付密码"
- 高度：44px
- 底部分割线：1px 浅灰色

### 2.2 主要内容区

**标题文字:**
```
设置支付密码
```
- 字体加粗，28pt
- 颜色：#1a1a1a
- 距离导航栏32px

**副标题:**
```
用于订单支付、余额提现等操作
```
- 常规字体，14pt
- 颜色：#666

### 2.3 支付密码输入区

#### 第一步：输入新密码
```
[●] [●] [●] [●] [●] [●]
```

**6个独立输入框:**
- 数量：6个（6位数字密码）
- 每个宽度：48px，高度：56px
- 间距：12px
- 圆角：8px
- 边框：1px 浅灰色(#e5e5e5)
- 聚焦边框：2px 紫色(#9333ea)
- 显示：圆点(●)，不显示明文
- 字体大小：24pt
- 输入类型：`tel`（数字键盘）
- 每个输入框限制1位数字

**提示文字:**
```
请输入6位数字支付密码
```
- 字体大小：14pt
- 颜色：灰色(#999)
- 位置：输入框下方16px

**自动聚焦逻辑:**
- 输入数字后自动跳到下一个输入框
- 删除数字后自动跳回上一个输入框
- 第6个输入框输入完成后：
  - 自动进入第二步（确认密码）

#### 第二步：确认密码
```
[●] [●] [●] [●] [●] [●]
```

**确认密码输入区:**
- 样式同第一步
- 提示文字："请再次输入支付密码"

**自动验证逻辑:**
- 输入完第6位后自动对比两次密码
- 一致：自动提交
- 不一致：显示错误提示，清空第二步，聚焦到第二步第1位

### 2.4 密码要求提示
```
密码要求：
• 必须为6位数字
• 不可与登录密码相同
• 不建议使用连续数字（如123456）
• 不建议使用重复数字（如111111）
```
- 字体大小：12pt
- 颜色：浅灰色(#999)
- 位置：确认密码输入区下方24px

### 2.5 确认按钮（可选，自动提交时不显示）
```
┌──────────────────────────────────────┐
│              确认                     │
└──────────────────────────────────────┘
```

**样式:**
- 宽度：100%，高度：52px，圆角：26px
- 背景渐变（启用）：#b794f6 → #a5b4fc
- 背景浅灰色（禁用）

**启用条件:**
- 两次密码输入完成
- 两次密码一致
- 密码符合格式要求

---

## 三、接口列表

### 3.1 设置支付密码（新用户）

**接口:** `POST /api/auth/payment-password/set`

**触发时机:** 用户第一次设置支付密码

**请求参数:**
```typescript
{
  paymentPassword: string;  // 6位数字支付密码
  confirmPassword: string;  // 确认密码
}
```

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;        // 提示信息
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 设置成功 | "支付密码设置成功" |
| 400 | 参数错误 | "密码格式不正确" |
| 400 | 两次密码不一致 | "两次输入的密码不一致" |
| 401 | 未登录 | "请先登录" |
| 409 | 已设置过 | "支付密码已存在，请使用修改功能" |
| 500 | 服务器错误 | "设置失败，请稍后重试" |

### 3.2 修改支付密码（已有支付密码）

**接口:** `POST /api/auth/payment-password/update`

**触发时机:** 用户修改已有支付密码

**请求参数:**
```typescript
{
  oldPaymentPassword: string;  // 原支付密码（6位）
  newPaymentPassword: string;  // 新支付密码（6位）
  confirmPassword: string;     // 确认新密码
}
```

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 修改成功 | "支付密码修改成功" |
| 400 | 参数错误 | "密码格式不正确" |
| 400 | 两次密码不一致 | "两次输入的密码不一致" |
| 401 | 原密码错误 | "原支付密码错误" |
| 401 | 未登录 | "请先登录" |
| 500 | 服务器错误 | "修改失败，请稍后重试" |

### 3.3 验证支付密码（支付时调用）

**接口:** `POST /api/auth/payment-password/verify`

**触发时机:** 执行支付操作时验证密码

**请求参数:**
```typescript
{
  paymentPassword: string;  // 6位数字支付密码
}
```

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    verified: boolean;  // 是否验证通过
  }
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 验证成功 | 继续支付流程 |
| 401 | 密码错误 | "支付密码错误" |
| 401 | 未设置支付密码 | "请先设置支付密码" |
| 429 | 错误次数过多 | "密码错误次数过多，已锁定30分钟" |

---

## 四、数据流

### 设置支付密码流程（新用户）
```
用户进入设置页面
  ↓
输入6位数字密码（第一次）
  ↓
自动进入确认密码步骤
  ↓
输入6位数字密码（第二次）
  ↓
自动对比两次密码
  ├─ 一致: POST /api/auth/payment-password/set
  └─ 不一致: 显示错误，清空第二步
  ↓
成功: 显示"设置成功" → 返回上一页
失败: 显示错误提示
```

### 修改支付密码流程（已有密码）
```
用户进入修改页面
  ↓
输入原支付密码（6位）
  ↓
输入新支付密码（6位）
  ↓
确认新支付密码（6位）
  ↓
POST /api/auth/payment-password/update
  ↓
成功: 显示"修改成功" → 返回上一页
失败: 显示错误提示
```

---

## 五、状态管理

```typescript
interface PaymentPasswordPageState {
  mode: 'set' | 'update';       // 设置或修改模式
  step: 1 | 2 | 3;              // 当前步骤（修改模式3步，设置模式2步）

  // 设置模式
  password: string;             // 第一次输入的密码
  confirmPassword: string;      // 第二次输入的密码

  // 修改模式
  oldPassword: string;          // 原密码
  newPassword: string;          // 新密码
  confirmNewPassword: string;   // 确认新密码

  isSubmitting: boolean;        // 是否正在提交
  error?: string;               // 错误信息
}
```

---

## 六、前端验证

### 支付密码验证
```typescript
const isValidPaymentPassword = (password: string) => {
  // 必须是6位数字
  if (!/^\d{6}$/.test(password)) {
    return { valid: false, error: '支付密码必须为6位数字' };
  }

  // 不建议连续数字
  if (/012345|123456|234567|345678|456789|567890|654321|543210/.test(password)) {
    return { valid: false, error: '不建议使用连续数字', warning: true };
  }

  // 不建议重复数字
  if (/^(\d)\1{5}$/.test(password)) {
    return { valid: false, error: '不建议使用重复数字', warning: true };
  }

  return { valid: true };
}
```

### 两次密码对比
```typescript
const passwordsMatch = (password: string, confirmPassword: string) => {
  return password === confirmPassword;
}
```

---

## 七、交互行为

### 7.1 设置模式（新用户）

**第一步：输入密码**
1. 自动聚焦到第1个输入框
2. 输入数字后自动跳到下一个
3. 删除数字后自动跳回上一个
4. 输入完第6位后：
   - 验证密码格式
   - 格式正确：自动进入第二步
   - 格式错误：显示提示（警告级别可继续）

**第二步：确认密码**
1. 自动聚焦到第1个输入框
2. 输入完第6位后：
   - 自动对比两次密码
   - 一致：自动提交接口
   - 不一致：显示错误，清空第二步，重新输入

**提交成功:**
1. 显示Toast："支付密码设置成功"
2. 延迟1秒后返回上一页

**提交失败:**
1. 显示错误提示
2. 清空所有输入框
3. 聚焦到第1步第1个输入框

### 7.2 修改模式（已有密码）

**第一步：输入原密码**
1. 输入完成后自动进入第二步

**第二步：输入新密码**
1. 输入完成后自动进入第三步

**第三步：确认新密码**
1. 输入完成后：
   - 对比新密码是否一致
   - 一致：自动提交接口
   - 不一致：显示错误，清空第三步

### 7.3 返回操作
- 点击返回按钮
- 如果已输入内容：弹出确认对话框
  - "取消"：继续停留
  - "确定"：返回上一页

---

## 八、测试要点

### 功能测试
- [ ] 支付密码输入自动跳转正常
- [ ] 两次密码对比准确
- [ ] 设置接口调用成功
- [ ] 修改接口调用成功
- [ ] 成功提示显示正确
- [ ] 错误提示显示正确

### 边界测试
- [ ] 输入非数字处理
- [ ] 连续数字警告提示
- [ ] 重复数字警告提示
- [ ] 两次密码不一致处理
- [ ] 原密码错误处理
- [ ] 网络异常处理

### 安全测试
- [ ] 密码输入显示圆点
- [ ] 密码不记录到历史记录
- [ ] Token验证正常
- [ ] 错误次数限制

---

## 九、使用的后端服务

- **AuthService** (认证服务)
  - `POST /api/auth/payment-password/set` - 设置支付密码
  - `POST /api/auth/payment-password/update` - 修改支付密码
  - `POST /api/auth/payment-password/verify` - 验证支付密码（支付时调用）

---

## 十、使用场景

### 场景1：首次设置支付密码
**触发时机:**
- 新用户完成注册后
- 首次进行支付操作时
- 在个人设置中主动设置

**流程:**
1. 进入设置页面（`/auth/payment-password/set`）
2. 输入6位数字密码
3. 确认密码
4. 自动提交
5. 设置成功 → 返回

### 场景2：修改支付密码
**触发时机:**
- 在个人设置中选择"修改支付密码"
- 忘记支付密码后重新设置

**流程:**
1. 进入修改页面（`/auth/payment-password/update`）
2. 输入原支付密码
3. 输入新支付密码
4. 确认新密码
5. 自动提交
6. 修改成功 → 返回

### 场景3：支付时验证
**触发时机:**
- 订单支付时（14-支付页面）
- 余额提现时
- 其他涉及资金操作时

**调用方式:**
```typescript
// 在支付页面调用
const verifyPaymentPassword = async (password: string) => {
  const response = await fetch('/api/auth/payment-password/verify', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ paymentPassword: password })
  });

  const result = await response.json();
  return result.data.verified; // true or false
}
```

---

## 十一、安全建议

### 密码安全
- 使用BCrypt加密存储
- 密码单独存储，与登录密码分开
- 错误次数限制（5次错误锁定30分钟）

### 前端安全
- 输入框自动清空剪贴板
- 禁用自动填充
- 密码不记录到浏览器历史

### 找回支付密码
如果用户忘记支付密码，应提供以下方式：
1. 通过手机验证码重置
2. 通过身份证认证重置
3. 联系客服人工重置

---

**使用后端服务:** AuthService (auth模块)
**相关页面:** [14-支付页面](../../04-trade模块/Frontend/14-支付页面.md) (trade模块)
**最后更新:** 2025-11-14
