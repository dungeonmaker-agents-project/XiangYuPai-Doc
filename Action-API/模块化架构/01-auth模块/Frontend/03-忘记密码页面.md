# 03-忘记密码页面

## 一、页面概述

- **路由路径**: `/auth/forgot-password`
- **页面功能**: 通过手机号验证码重置密码（3步流程）
- **用户角色**: 未登录用户（已注册）
- **页面类型**: 认证页面

## 二、流程概览

```
页面1：输入手机号 → 获取验证码
  ↓
页面2：验证码输入 → 验证验证码
  ↓
页面3：设置新密码 → 重置密码完成
  ↓
返回登录页
```

---

## 三、页面1：输入手机号

### 3.1 页面结构

#### 顶部导航栏
```
[←]  忘记密码
```
- 返回按钮：左侧箭头图标
- 标题："忘记密码"（居中，18pt）
- 高度：44px
- 底部分割线：1px 浅灰色

#### 主要内容区

**标题文字:**
```
忘记密码
```
- 字体加粗，28pt
- 颜色：#1a1a1a
- 距离导航栏32px

**副标题:**
```
请输入注册时的手机号
```
- 常规字体，14pt
- 颜色：#666
- 距离标题8px

#### 手机号输入区
```
[+86 ▼]  [请输入手机号_________________ ⊗]
```
- 国家区号选择器：默认 `+86`
- 手机号输入框：`tel` 类型，11位
- 清空按钮：有内容时显示

#### 获取短信验证码按钮
```
┌──────────────────────────────────────┐
│        获取短信验证码                 │
└──────────────────────────────────────┘
```

**样式:**
- 宽度：100%（左右边距24px）
- 高度：52px，圆角：26px
- 背景渐变（启用）：#b794f6 → #a5b4fc
- 背景浅灰色（禁用）

**状态:**
- 启用：手机号格式正确
- 禁用：手机号未输入或格式错误
- 倒计时："59秒后重新获取验证码"

### 3.2 接口调用

#### 发送验证码

**接口:** `POST /api/auth/sms/send`

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号，例如："+86"
  phoneNumber: string;      // 手机号
  purpose: "RESET_PASSWORD" // 固定值，表示用于重置密码
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | "验证码已发送" |
| 404 | 用户不存在 | "该手机号未注册" |
| 429 | 发送频繁 | "发送过于频繁，请稍后再试" |
| 500 | 服务器错误 | "发送失败，请稍后重试" |

### 3.3 交互行为

**返回操作:**
- 点击左上角返回按钮
- 返回到登录页面

**获取短信验证码:**
1. 验证手机号格式
2. 调用发送接口
3. 成功：
   - 显示Toast："验证码已发送"
   - 按钮进入倒计时状态
   - 开始60秒倒计时
   - **跳转到验证码输入页**（页面2）
   - 传递数据：countryCode, phoneNumber
4. 失败：显示错误提示，保持在当前页面

---

## 四、页面2：验证码输入

### 4.1 页面结构

#### 顶部导航栏
```
[←]  验证码验证
```
- 返回按钮：返回到输入手机号页面（页面1）
- 标题："验证码验证"

#### 提示信息
```
验证码已发送至 131 4704 6323
```
- 字体大小：14pt
- 颜色：灰色(#999)
- 显示完整手机号（带空格分隔）
- 格式：`131 4704 6323`

#### 验证码输入区
```
[3] [6] [1] [2] [3] [4]
```

**6个独立输入框:**
- 宽度：48px，高度：56px
- 间距：12px，圆角：8px
- 自动聚焦第一个输入框
- 输入后自动跳到下一个
- 删除后自动跳回上一个
- 输入完第6位自动提交

#### 重新发送
```
没收到验证码？ 重新发送
```
- "重新发送"为可点击链接
- 链接颜色：紫色(#9333ea)
- 有60秒倒计时限制

### 4.2 接口调用

#### 验证验证码

**接口:** `POST /api/auth/password/reset/verify`

**请求参数:**
```typescript
{
  countryCode: string;       // 国家区号
  phoneNumber: string;       // 手机号
  verificationCode: string;  // 6位验证码
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | "验证成功" |
| 401 | 验证码错误 | "验证码错误，请重新输入" |
| 401 | 验证码过期 | "验证码已过期，请重新获取" |
| 500 | 服务器错误 | "验证失败，请稍后重试" |

### 4.3 交互行为

**返回操作:**
- 点击返回按钮
- 返回到输入手机号页面（页面1）
- 保留手机号输入，清除验证码

**验证码输入:**
1. 页面加载后自动聚焦第一个输入框
2. 只允许数字，每个输入框1位
3. 输入后自动跳到下一个
4. 删除后自动跳回上一个
5. 输入完第6位后：
   - 自动收起键盘
   - 自动调用验证接口
   - 显示加载状态

**验证成功:**
1. 显示Toast："验证成功"
2. **跳转到设置新密码页**（页面3）
3. 传递数据：countryCode, phoneNumber, verificationCode

**验证失败:**
1. 显示Toast："验证码错误，请重新输入"
2. 清空所有输入框
3. 聚焦到第一个输入框

**重新发送:**
1. 检查倒计时状态
2. 倒计时中：显示"请59秒后重试"
3. 倒计时结束：允许重新发送
4. 调用发送接口（同页面1）
5. 成功：开始新的60秒倒计时

---

## 五、页面3：设置新密码

### 5.1 页面结构

#### 顶部导航栏
```
[←]  设置新密码
```
- 返回按钮：返回到验证码输入页（页面2）
- 标题："设置新密码"

#### 主要内容区

**标题文字:**
```
设置新密码
```
- 字体加粗，28pt
- 颜色：#1a1a1a

**副标题:**
```
请设置6-20位字符的新密码
```
- 常规字体，14pt
- 颜色：#666

#### 新密码输入区
```
[●●●●●●●●_________________________________ 👁]
```

**新密码输入框:**
- 占位符："请输入新密码"
- 输入类型：`password`（可切换为`text`）
- 长度限制：6-20位
- 显示/隐藏按钮

**密码要求提示:**
```
密码要求：
• 6-20位字符
• 不可纯数字（至少包含一个字母或符号）
```
- 字体大小：12pt
- 颜色：浅灰色(#999)

#### 确认按钮
```
┌──────────────────────────────────────┐
│              确认                     │
└──────────────────────────────────────┘
```

**样式:**
- 宽度：100%，高度：52px，圆角：26px
- 背景渐变（启用）：#b794f6 → #a5b4fc
- 背景浅灰色（禁用）

**状态:**
- 启用：密码格式正确
- 禁用：密码未输入或格式错误
- 加载："确认中..." + 加载图标

### 5.2 接口调用

#### 设置新密码

**接口:** `POST /api/auth/password/reset/confirm`

**请求参数:**
```typescript
{
  countryCode: string;       // 国家区号
  phoneNumber: string;       // 手机号
  verificationCode: string;  // 6位验证码（从上一步保存）
  newPassword: string;       // 新密码，6-20位字符
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;
  data: null
}
```

**错误处理:**
| 状态码 | 说明 | 前端提示 |
|-------|------|---------|
| 200 | 成功 | "密码重置成功" |
| 400 | 参数错误 | "密码格式不正确" |
| 401 | 验证码过期 | "验证码已过期，请重新获取" |
| 500 | 服务器错误 | "重置失败，请稍后重试" |

### 5.3 交互行为

**返回操作:**
- 点击返回按钮
- 弹出确认对话框："确定要放弃重置密码吗？"
  - "取消"：关闭对话框
  - "确定"：返回验证码输入页（页面2）

**密码输入:**
- 实时计算长度
- 达到20位停止输入
- 显示/隐藏切换：点击眼睛图标
- 失去焦点时验证格式

**提交新密码:**
1. 验证密码格式
2. 按钮进入加载状态
3. 禁用密码输入框和返回按钮
4. 调用重置接口

**成功响应:**
1. 显示Toast："密码重置成功"（2-3秒）
2. 延迟2-3秒后跳转到登录页
3. 清除所有临时数据
4. 可选：自动填充手机号到登录页

**失败响应:**
1. 恢复按钮和输入框状态
2. 显示错误提示
3. 允许重新输入或返回

---

## 六、数据传递

### 跨页面数据流
```
页面1 → 页面2:
  - countryCode
  - phoneNumber

页面2 → 页面3:
  - countryCode
  - phoneNumber
  - verificationCode

页面3 → 登录页:
  - phoneNumber (可选自动填充)
```

### 数据管理方案

**推荐方案：状态管理**
```typescript
interface ResetPasswordState {
  countryCode: string;
  phoneNumber: string;
  verificationCode: string;
  currentStep: 1 | 2 | 3; // 当前步骤
}
```

**完成后清除:**
```typescript
// 重置密码成功后
sessionStorage.removeItem('resetPasswordData');
```

---

## 七、前端验证

### 手机号验证
```typescript
const isValidPhoneNumber = (phone: string, countryCode: string) => {
  if (countryCode === '+86') {
    return /^1[3-9]\d{9}$/.test(phone);
  }
  return phone.length >= 8 && phone.length <= 15;
}
```

### 验证码验证
```typescript
const isValidVerificationCode = (code: string) => {
  return /^\d{6}$/.test(code);
}
```

### 新密码验证
```typescript
const isValidNewPassword = (password: string) => {
  // 长度检查
  if (password.length < 6 || password.length > 20) {
    return { valid: false, error: '密码长度为6-20位字符' };
  }

  // 不可纯数字
  if (/^\d+$/.test(password)) {
    return { valid: false, error: '密码不能为纯数字' };
  }

  return { valid: true };
}
```

### 手机号格式化
```typescript
const formatPhoneNumber = (phone: string) => {
  if (phone.length === 11) {
    // 显示完整手机号，添加空格分隔
    return `${phone.slice(0, 3)} ${phone.slice(3, 7)} ${phone.slice(7)}`;
  }
  return phone;
}
// 示例：13147046323 → 131 4704 6323
```

---

## 八、测试要点

### 功能测试
- [ ] 页面1：手机号输入和验证正常
- [ ] 页面1：获取验证码成功并跳转
- [ ] 页面1：倒计时显示准确
- [ ] 页面2：验证码输入自动跳转
- [ ] 页面2：验证码自动提交
- [ ] 页面2：重新发送功能正常
- [ ] 页面3：密码显示/隐藏切换
- [ ] 页面3：密码验证准确
- [ ] 页面3：提交成功并返回登录页
- [ ] 数据在三个页面间正确传递

### 边界测试
- [ ] 未注册手机号处理（404错误）
- [ ] 验证码错误处理
- [ ] 验证码过期处理
- [ ] 网络异常处理
- [ ] 快速重复点击按钮
- [ ] 返回时数据保留/清除

### 用户体验测试
- [ ] 页面过渡动画流畅
- [ ] 返回确认对话框友好
- [ ] 成功提示清晰可见
- [ ] 错误提示准确具体

---

## 九、使用的后端服务

- **AuthService** (认证服务)
  - `POST /api/auth/sms/send` - 发送验证码（purpose: RESET_PASSWORD）
  - `POST /api/auth/password/reset/verify` - 验证验证码
  - `POST /api/auth/password/reset/confirm` - 设置新密码

---

**使用后端服务:** AuthService (auth模块)
**相关页面:** [01-密码登录页面](./01-密码登录页面.md), [02-验证码登录页面](./02-验证码登录页面.md)
**最后更新:** 2025-11-14
