# 认证服务接口文档 (AuthService)

## 一、服务概述

- **服务名称**: AuthService (认证服务)
- **服务职责**: 用户认证、授权、Token管理、支付密码管理
- **技术栈**: Spring Boot 3.x + Spring Security + JWT
- **端口**: 8001
- **数据库**: `auth_db`
- **缓存**: Redis (Token、验证码、黑名单)

## 二、接口列表

### 2.1 对外API (11个)

#### 登录相关 (2个)
1. `POST /api/auth/login/password` - 密码登录
2. `POST /api/auth/login/sms` - 验证码登录（含自动注册）

#### 验证码相关 (1个)
3. `POST /api/auth/sms/send` - 发送短信验证码

#### 密码重置相关 (2个)
4. `POST /api/auth/password/reset/verify` - 验证重置密码验证码
5. `POST /api/auth/password/reset/confirm` - 确认重置密码

#### 支付密码相关 (3个)
6. `POST /api/auth/payment-password/set` - 设置支付密码
7. `POST /api/auth/payment-password/update` - 修改支付密码
8. `POST /api/auth/payment-password/verify` - 验证支付密码

#### Token管理 (2个)
9. `POST /api/auth/token/refresh` - 刷新Token
10. `POST /api/auth/logout` - 登出

#### 检查接口 (1个)
11. `POST /api/auth/check/phone` - 检查手机号是否已注册

### 2.2 内部RPC (2个)

1. `validateToken()` - 验证Token有效性（供API Gateway调用）
2. `verifyPaymentPasswordRPC()` - 验证支付密码（供PaymentService调用）

---

## 三、接口详情

### 3.1 密码登录

**接口:** `POST /api/auth/login/password`

**功能:** 使用手机号+密码登录

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号，例如："+86"
  phoneNumber: string;      // 手机号，例如："13147046323"
  password: string;         // 密码，6-20位字符
  agreeToTerms: boolean;    // 用户协议勾选状态，必须为true
}
```

**响应数据:**
```typescript
{
  code: number;           // 200=成功，其他=失败
  message: string;
  data: {
    token: string;        // 访问Token (有效期2小时)
    refreshToken: string; // 刷新Token (有效期7天)
    userId: string;       // 用户ID
    nickname: string;     // 用户昵称
    avatar?: string;      // 用户头像
  } | null
}
```

**业务逻辑:**
1. 验证手机号格式
2. 查询用户是否存在（联合查询auth_db和user_db）
3. 验证密码（BCrypt对比）
4. 检查账号状态（是否禁用）
5. 生成Access Token和Refresh Token (JWT)
6. 记录登录日志
7. 返回Token和用户信息

**错误码:**
- 200: 登录成功
- 400: 参数错误
- 401: 手机号或密码错误
- 403: 账号已被禁用
- 500: 服务器错误

---

### 3.2 验证码登录

**接口:** `POST /api/auth/login/sms`

**功能:** 使用手机号+验证码登录，未注册用户自动创建账号

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号
  phoneNumber: string;      // 手机号
  verificationCode: string; // 6位验证码
  agreeToTerms: boolean;    // 用户协议勾选状态
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    token: string;
    refreshToken: string;
    userId: string;
    nickname: string;
    avatar?: string;
    isNewUser: boolean;   // 是否新注册用户（前端据此跳转）
  } | null
}
```

**业务逻辑:**
1. 验证手机号格式
2. 验证验证码（从Redis读取并对比）
3. 查询用户是否存在
4. **如果不存在：**
   - 调用UserService.createUser() [RPC]
   - 创建auth_db中的凭证记录
   - 设置isNewUser = true
5. **如果存在：**
   - 设置isNewUser = false
6. 生成Token
7. 清除已使用的验证码
8. 记录登录日志
9. 返回Token和用户信息

**错误码:**
- 200: 登录成功
- 400: 参数错误
- 401: 验证码错误或已过期
- 500: 服务器错误

---

### 3.3 发送短信验证码

**接口:** `POST /api/auth/sms/send`

**功能:** 发送短信验证码（登录或重置密码）

**请求参数:**
```typescript
{
  countryCode: string;      // 国家区号
  phoneNumber: string;      // 手机号
  purpose: "LOGIN" | "RESET_PASSWORD"  // 用途
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证手机号格式
2. **如果purpose = RESET_PASSWORD:**
   - 检查手机号是否已注册
   - 未注册返回404错误
3. 检查发送频率限制（Redis，60秒内只能发送一次）
4. 生成6位随机数字验证码
5. 调用阿里云短信服务发送
6. 将验证码存入Redis，TTL 5分钟
7. 记录发送次数（1小时内最多5次）

**错误码:**
- 200: 发送成功
- 404: 手机号未注册（仅RESET_PASSWORD时）
- 429: 发送过于频繁
- 500: 发送失败

**Redis存储:**
```
Key: sms:code:{purpose}:{phoneNumber}
Value: "361234"
TTL: 300秒 (5分钟)

Key: sms:count:{phoneNumber}
Value: 3 (发送次数)
TTL: 3600秒 (1小时)
```

---

### 3.4 验证重置密码验证码

**接口:** `POST /api/auth/password/reset/verify`

**功能:** 验证重置密码流程中的验证码

**请求参数:**
```typescript
{
  countryCode: string;
  phoneNumber: string;
  verificationCode: string;  // 6位验证码
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证手机号格式
2. 从Redis读取验证码
3. 对比验证码是否正确
4. **验证通过后不删除验证码**（留到确认重置时删除）
5. 标记验证码已验证通过（Redis）

**错误码:**
- 200: 验证成功
- 401: 验证码错误或已过期
- 500: 验证失败

---

### 3.5 确认重置密码

**接口:** `POST /api/auth/password/reset/confirm`

**功能:** 设置新密码并完成重置

**请求参数:**
```typescript
{
  countryCode: string;
  phoneNumber: string;
  verificationCode: string;  // 6位验证码（验证凭证）
  newPassword: string;       // 新密码，6-20位字符
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 验证新密码格式（6-20位，不可纯数字）
2. 从Redis验证验证码是否已验证通过
3. 查询用户凭证记录
4. 使用BCrypt加密新密码
5. 更新password_hash字段
6. 清除Redis中的验证码
7. 记录密码修改日志

**错误码:**
- 200: 重置成功
- 400: 密码格式不正确
- 401: 验证码错误或已过期
- 500: 重置失败

---

### 3.6 设置支付密码

**接口:** `POST /api/auth/payment-password/set`

**功能:** 首次设置支付密码（6位数字）

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  paymentPassword: string;  // 6位数字支付密码
  confirmPassword: string;  // 确认密码
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 从Token解析userId
2. 验证密码格式（必须6位数字）
3. 验证两次密码是否一致
4. 检查用户是否已设置过支付密码
5. 使用BCrypt加密密码
6. 保存payment_password_hash字段
7. 记录设置日志

**错误码:**
- 200: 设置成功
- 400: 密码格式不正确或两次密码不一致
- 401: 未登录或Token无效
- 409: 支付密码已存在
- 500: 设置失败

---

### 3.7 修改支付密码

**接口:** `POST /api/auth/payment-password/update`

**功能:** 修改已有支付密码

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  oldPaymentPassword: string;  // 原支付密码
  newPaymentPassword: string;  // 新支付密码
  confirmPassword: string;     // 确认新密码
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 从Token解析userId
2. 验证新密码格式
3. 验证两次新密码是否一致
4. 验证原密码是否正确（BCrypt对比）
5. 使用BCrypt加密新密码
6. 更新payment_password_hash字段
7. 记录修改日志

**错误码:**
- 200: 修改成功
- 400: 密码格式不正确
- 401: 原支付密码错误或未登录
- 500: 修改失败

---

### 3.8 验证支付密码

**接口:** `POST /api/auth/payment-password/verify`

**功能:** 支付时验证支付密码是否正确

**请求头:**
```
Authorization: Bearer <token>
```

**请求参数:**
```typescript
{
  paymentPassword: string;  // 6位数字支付密码
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    verified: boolean;  // 是否验证通过
  }
}
```

**业务逻辑:**
1. 从Token解析userId
2. 查询用户支付密码哈希
3. 使用BCrypt验证密码
4. 检查错误次数（Redis）
5. **密码错误:**
   - 错误次数+1
   - 5次错误后锁定30分钟
6. **密码正确:**
   - 清除错误次数
   - 返回verified = true

**错误码:**
- 200: 验证成功（data.verified = true/false）
- 401: 未设置支付密码或Token无效
- 429: 密码错误次数过多，已锁定

**安全机制:**
```
Key: payment_pwd:error:{userId}
Value: 3 (错误次数)
TTL: 1800秒 (30分钟)

错误5次后:
Key: payment_pwd:lock:{userId}
Value: "locked"
TTL: 1800秒 (30分钟)
```

---

### 3.9 刷新Token

**接口:** `POST /api/auth/token/refresh`

**功能:** 使用Refresh Token获取新的Access Token

**请求参数:**
```typescript
{
  refreshToken: string;  // 刷新Token
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    token: string;        // 新的Access Token
    refreshToken: string; // 新的Refresh Token
  } | null
}
```

**业务逻辑:**
1. 验证Refresh Token签名和有效期
2. 检查Token是否在黑名单中
3. 解析Token获取userId
4. 生成新的Access Token（有效期2小时）
5. 生成新的Refresh Token（有效期7天）
6. 返回新Token

**错误码:**
- 200: 刷新成功
- 401: Refresh Token无效或已过期
- 500: 刷新失败

---

### 3.10 登出

**接口:** `POST /api/auth/logout`

**功能:** 用户登出，Token加入黑名单

**请求头:**
```
Authorization: Bearer <token>
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: null
}
```

**业务逻辑:**
1. 从请求头获取Access Token
2. 解析Token获取过期时间
3. 将Token加入黑名单（Redis）
4. 记录登出日志

**错误码:**
- 200: 登出成功
- 401: Token无效

**Token黑名单:**
```
Key: token:blacklist:{token}
Value: "1"
TTL: Token剩余有效时间
```

---

### 3.11 检查手机号是否已注册

**接口:** `POST /api/auth/check/phone`

**功能:** 检查手机号是否已注册

**请求参数:**
```typescript
{
  countryCode: string;
  phoneNumber: string;
}
```

**响应数据:**
```typescript
{
  code: number;
  message: string;
  data: {
    isRegistered: boolean;  // 是否已注册
  }
}
```

**业务逻辑:**
1. 验证手机号格式
2. 查询auth_db.user_credentials表
3. 返回是否存在记录

**错误码:**
- 200: 查询成功

---

## 四、RPC接口（内部调用）

### 4.1 验证Token有效性

**方法:** `validateToken(String token)`

**调用方:** API Gateway (所有需要认证的请求)

**功能:** 验证Token是否有效

**输入参数:**
- `token`: Access Token字符串

**返回数据:**
```java
public class TokenValidationResult {
    private Boolean valid;        // 是否有效
    private Long userId;          // 用户ID
    private String errorMessage;  // 错误信息
}
```

**验证逻辑:**
1. 验证Token签名（HMAC-SHA256）
2. 验证Token是否过期
3. 检查Token是否在黑名单中
4. 解析Token获取userId
5. 返回验证结果

---

### 4.2 验证支付密码(RPC)

**方法:** `verifyPaymentPasswordRPC(Long userId, String paymentPassword)`

**调用方:** PaymentService (执行支付时)

**功能:** 验证用户支付密码是否正确

**输入参数:**
- `userId`: 用户ID
- `paymentPassword`: 支付密码（明文）

**返回数据:**
```java
public class PaymentPasswordVerificationResult {
    private Boolean verified;     // 是否正确
    private Integer errorCount;   // 错误次数
    private Boolean isLocked;     // 是否已锁定
}
```

**验证逻辑:**
1. 查询用户支付密码哈希
2. BCrypt验证密码
3. 更新错误次数
4. 返回验证结果

---

## 五、数据模型

### 5.1 用户凭证表 (user_credentials)

```sql
CREATE TABLE user_credentials (
  user_id BIGINT PRIMARY KEY COMMENT '用户ID（与user_db的users表关联）',
  phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号',
  country_code VARCHAR(10) NOT NULL DEFAULT '+86' COMMENT '国家区号',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值（BCrypt）',
  payment_password_hash VARCHAR(255) COMMENT '支付密码哈希值（BCrypt）',
  salt VARCHAR(64) NOT NULL COMMENT '密码盐值',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_phone (phone, country_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户凭证表';
```

### 5.2 Token表 (tokens)

```sql
CREATE TABLE tokens (
  token_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  access_token VARCHAR(500) NOT NULL COMMENT '访问Token',
  refresh_token VARCHAR(500) NOT NULL COMMENT '刷新Token',
  access_token_expires_at DATETIME NOT NULL COMMENT 'Access Token过期时间',
  refresh_token_expires_at DATETIME NOT NULL COMMENT 'Refresh Token过期时间',
  device_id VARCHAR(100) COMMENT '设备ID',
  device_type VARCHAR(20) COMMENT '设备类型（ios/android/web）',
  ip_address VARCHAR(50) COMMENT 'IP地址',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  revoked_at DATETIME COMMENT '撤销时间（登出时设置）',
  INDEX idx_user_id (user_id),
  INDEX idx_access_token (access_token(255)),
  INDEX idx_refresh_token (refresh_token(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Token表';
```

### 5.3 登录日志表 (login_logs)

```sql
CREATE TABLE login_logs (
  log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT COMMENT '用户ID',
  login_type VARCHAR(20) NOT NULL COMMENT '登录方式（password/sms/wechat/qq）',
  phone VARCHAR(20) COMMENT '登录手机号',
  ip_address VARCHAR(50) COMMENT 'IP地址',
  device_type VARCHAR(20) COMMENT '设备类型',
  device_info VARCHAR(200) COMMENT '设备信息',
  location VARCHAR(100) COMMENT '登录地点',
  status VARCHAR(20) NOT NULL COMMENT '状态（success/failed）',
  error_message VARCHAR(255) COMMENT '错误信息',
  login_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_login_time (login_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

---

## 六、JWT Token设计

### Token结构

**Access Token (有效期2小时):**
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": "123456",
    "phone": "13147046323",
    "iat": 1699876543,
    "exp": 1699883743,
    "type": "access"
  },
  "signature": "..."
}
```

**Refresh Token (有效期7天):**
```json
{
  "payload": {
    "userId": "123456",
    "iat": 1699876543,
    "exp": 1700481343,
    "type": "refresh"
  }
}
```

### Token密钥
- 密钥存储：环境变量或配置中心
- 算法：HMAC-SHA256
- 密钥长度：256位

---

## 七、缓存策略

### 验证码缓存
```
Key: sms:code:{purpose}:{phoneNumber}
Value: "361234"
TTL: 300秒

Key: sms:count:{phoneNumber}
Value: 3
TTL: 3600秒
```

### Token黑名单
```
Key: token:blacklist:{token}
Value: "1"
TTL: Token剩余有效时间
```

### 支付密码错误计数
```
Key: payment_pwd:error:{userId}
Value: 3
TTL: 1800秒

Key: payment_pwd:lock:{userId}
Value: "locked"
TTL: 1800秒
```

---

## 八、安全措施

### 密码安全
- BCrypt加密（强度12）
- 密码哈希单独存储
- 登录密码与支付密码分开

### Token安全
- JWT签名验证
- Token黑名单机制
- 刷新Token轮换

### 防暴力破解
- 验证码60秒限制
- 验证码1小时最多5次
- 支付密码5次错误锁定30分钟
- 登录失败记录

### 接口安全
- HTTPS强制
- 请求签名验证
- 限流保护
- IP黑名单

---

## 九、监控告警

### 关键指标
- 登录成功率
- Token验证失败率
- 验证码发送量
- 支付密码错误率

### 告警规则
- 登录成功率 < 90% → P2告警
- Token验证失败率 > 5% → P1告警
- 验证码1分钟发送量 > 100 → P2告警
- 支付密码错误率 > 10% → P2告警
- 检测到异常登录 → 通知用户

---

## 十、依赖服务

### 调用的服务
- **UserService** (user模块)
  - `createUser()` - 验证码登录时创建新用户
  - `getUserByPhone()` - 登录时查询用户信息

### 第三方服务
- **阿里云短信服务** - 发送验证码
- **Redis** - 缓存和Session管理

### 被调用
- **API Gateway** - 调用validateToken验证所有请求
- **PaymentService** - 调用verifyPaymentPasswordRPC验证支付密码

---

**服务端口**: 8001
**数据库**: auth_db
**缓存**: Redis
**最后更新**: 2025-11-14
