# 技能服务列表页 - 接口设计文档

> 版本: v2.0 | 更新日期: 2025-12-05
> 对应页面: GamePlayerListPage (王者荣耀陪玩列表页 → 通用服务列表页)
> 严格参考: xypai_user.sql v1.0.8

---

## 一、数据库表结构对照

### 1.1 核心表映射

| 表名 | 用途 | 对应UI区域 |
|------|------|-----------|
| `users` | 用户基础信息 | PlayerItem.basicInfo |
| `skills` | 技能信息 | PlayerItem.skillData + gameTagData + priceData |
| `user_stats` | 用户统计 | 可选：订单数/粉丝数 |
| `skill_images` | 技能展示图 | PlayerItem.avatarData |

### 1.2 关键字段对照 (SQL → API)

```
users 表:
├── user_id          → provider.userId
├── nickname         → provider.nickname
├── avatar           → provider.avatar
├── gender           → provider.gender
├── birthday         → 计算 age
├── is_online        → provider.isOnline
├── is_real_verified → provider.isVerified (实名认证)
├── is_god_verified  → provider.isExpert (大神认证)
├── latitude/longitude → 距离计算

skills 表:
├── skill_id         → skillId (服务ID)
├── user_id          → 关联用户
├── skill_name       → skillName
├── game_name        → skillInfo.skillType (如"王者荣耀")
├── game_rank        → skillInfo.rank (如"荣耀王者")
├── peak_score       → skillInfo.peakScore (如 2680)
├── server           → skillInfo.gameArea (如"微信区")
├── price            → price.amount
├── price_unit       → price.unit
├── description      → description
├── is_online        → 是否上架 (必须=1)
├── rating           → stats.rating
├── review_count     → stats.reviewCount
├── order_count      → stats.orders
```

---

## 二、接口设计

### 2.1 技能服务列表接口

**接口路径**: `GET /api/skill/list`

**触发时机**: 页面初始化 / 下拉刷新 / 上拉加载 / 筛选切换

#### 请求参数

| 参数 | 类型 | 必填 | 默认值 | 说明 | SQL字段 |
|------|------|------|--------|------|---------|
| `skillType` | String | ✅ | - | 技能类型 | `skills.game_name` |
| `pageNum` | Integer | ❌ | 1 | 页码 | OFFSET 计算 |
| `pageSize` | Integer | ❌ | 20 | 每页数量 | LIMIT |
| `sortBy` | String | ❌ | smart | 排序方式 | ORDER BY |
| `gender` | String | ❌ | all | 性别筛选 | `users.gender` |
| `status` | String | ❌ | all | 状态筛选 | `users.is_online` |
| `gameArea` | String | ❌ | - | 大区筛选 | `skills.server` |
| `ranks` | String[] | ❌ | - | 段位筛选(多选) | `skills.game_rank` |
| `priceRange` | String | ❌ | - | 价格区间 | `skills.price` |
| `positions` | String[] | ❌ | - | 位置筛选(多选) | 扩展字段 |
| `tags` | String[] | ❌ | - | 标签筛选(多选) | 扩展字段 |
| `cityCode` | String | ❌ | - | 同城筛选 | `users.location_code` |
| `latitude` | Double | ❌ | - | 纬度(距离计算) | - |
| `longitude` | Double | ❌ | - | 经度(距离计算) | - |

**sortBy 可选值**:
- `smart`: 智能排序 (is_online DESC, order_count DESC, rating DESC)
- `newest`: 最新 (skills.created_at DESC)
- `recent`: 最近活跃 (users.last_login_at DESC)
- `popular`: 人气 (order_count DESC, review_count DESC)

**priceRange 可选值**:
- `4-9`: 4-9元
- `10-19`: 10-19元
- `20+`: 20元以上

#### 响应数据

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "skillType": {
      "type": "王者荣耀",
      "label": "王者荣耀",
      "icon": "https://cdn.example.com/icons/wzry.png"
    },
    "tabs": [
      { "value": "all", "label": "全部", "count": 156 },
      { "value": "online", "label": "在线", "count": 42 }
    ],
    "filters": {
      "sortOptions": [
        { "value": "smart", "label": "智能排序" },
        { "value": "newest", "label": "最新" },
        { "value": "recent", "label": "最近" },
        { "value": "popular", "label": "人气" }
      ],
      "genderOptions": [
        { "value": "all", "label": "不限性别" },
        { "value": "female", "label": "只看女生" },
        { "value": "male", "label": "只看男生" }
      ],
      "statusOptions": [
        { "value": "all", "label": "全部" },
        { "value": "online", "label": "在线" }
      ],
      "gameAreas": [
        { "value": "QQ区", "label": "QQ区" },
        { "value": "微信区", "label": "微信区" }
      ],
      "ranks": [
        { "value": "尊贵铂金", "label": "尊贵铂金" },
        { "value": "永恒钻石", "label": "永恒钻石" },
        { "value": "至尊星耀", "label": "至尊星耀" },
        { "value": "最强王者", "label": "最强王者" },
        { "value": "荣耀王者", "label": "荣耀王者" }
      ],
      "priceRanges": [
        { "value": "4-9", "label": "4-9币", "min": 4, "max": 9 },
        { "value": "10-19", "label": "10-19币", "min": 10, "max": 19 },
        { "value": "20+", "label": "20币以上", "min": 20, "max": null }
      ],
      "positions": [
        { "value": "打野", "label": "打野" },
        { "value": "上路", "label": "上路" },
        { "value": "中路", "label": "中路" },
        { "value": "下路", "label": "下路" },
        { "value": "辅助", "label": "辅助" },
        { "value": "全能", "label": "全能" }
      ],
      "tags": [
        { "value": "荣耀王者", "label": "荣耀王者" },
        { "value": "大神认证", "label": "大神认证" },
        { "value": "巅峰赛", "label": "巅峰赛" },
        { "value": "带粉上分", "label": "带粉上分" }
      ]
    },
    "list": [
      {
        "skillId": 1,
        "description": "王者荣耀王者段位，可带上分、娱乐局",
        "provider": {
          "userId": 1,
          "nickname": "王者大神",
          "avatar": "https://cdn.example.com/avatar/1.png",
          "gender": "male",
          "age": 28,
          "isOnline": true,
          "isVerified": true,
          "isExpert": true
        },
        "skillInfo": {
          "skillType": "王者荣耀",
          "gameArea": "微信区",
          "rank": "荣耀王者",
          "peakScore": 2680,
          "position": null
        },
        "tags": [
          { "text": "实名认证", "type": "verified", "color": "#10B981" },
          { "text": "大神", "type": "expert", "color": "#FF6B00" }
        ],
        "price": {
          "amount": 30.00,
          "unit": "局",
          "displayText": "30金币/局"
        },
        "stats": {
          "orders": 45,
          "rating": 4.85,
          "reviewCount": 120
        },
        "distance": 3200,
        "distanceDisplay": "3.2km"
      }
    ],
    "total": 156,
    "hasMore": true
  }
}
```

#### 响应字段说明

| 字段路径 | 类型 | SQL来源 | 说明 |
|----------|------|---------|------|
| `list[].skillId` | Long | `skills.skill_id` | 技能服务ID |
| `list[].description` | String | `skills.description` | 技能介绍 |
| `list[].provider.userId` | Long | `users.user_id` | 用户ID |
| `list[].provider.nickname` | String | `users.nickname` | 昵称 |
| `list[].provider.avatar` | String | `users.avatar` | 头像URL |
| `list[].provider.gender` | String | `users.gender` | 性别 |
| `list[].provider.age` | Integer | 计算:`YEAR(NOW())-YEAR(birthday)` | 年龄 |
| `list[].provider.isOnline` | Boolean | `users.is_online` | 是否在线 |
| `list[].provider.isVerified` | Boolean | `users.is_real_verified` | 实名认证 |
| `list[].provider.isExpert` | Boolean | `users.is_god_verified` | 大神认证 |
| `list[].skillInfo.skillType` | String | `skills.game_name` | 游戏名称 |
| `list[].skillInfo.gameArea` | String | `skills.server` | 大区 |
| `list[].skillInfo.rank` | String | `skills.game_rank` | 段位 |
| `list[].skillInfo.peakScore` | Integer | `skills.peak_score` | 巅峰分 |
| `list[].price.amount` | BigDecimal | `skills.price` | 价格 |
| `list[].price.unit` | String | `skills.price_unit` | 价格单位 |
| `list[].stats.orders` | Integer | `skills.order_count` | 订单数 |
| `list[].stats.rating` | BigDecimal | `skills.rating` | 评分 |
| `list[].stats.reviewCount` | Integer | `skills.review_count` | 评价数 |
| `list[].distance` | Integer | 计算:ST_Distance_Sphere | 距离(米) |

---

## 三、核心SQL查询

### 3.1 列表查询SQL

```sql
SELECT
    -- 技能基础信息 (skills表)
    s.skill_id,
    s.description,
    s.game_name,
    s.game_rank,
    s.peak_score,
    s.server,
    s.price,
    s.price_unit,
    s.rating,
    s.review_count,
    s.order_count,

    -- 用户信息 (users表)
    u.user_id,
    u.nickname,
    u.avatar,
    u.gender,
    TIMESTAMPDIFF(YEAR, u.birthday, CURDATE()) AS age,
    u.is_online,
    u.is_real_verified,
    u.is_god_verified,

    -- 距离计算
    ROUND(
        ST_Distance_Sphere(
            POINT(u.longitude, u.latitude),
            POINT(#{longitude}, #{latitude})
        )
    ) AS distance

FROM skills s
INNER JOIN users u ON s.user_id = u.user_id

WHERE s.deleted = 0
  AND u.deleted = 0
  AND s.is_online = 1                              -- 必须上架
  AND s.game_name = #{skillType}                   -- 技能类型筛选

  -- 性别筛选
  <if test="gender != null and gender != 'all'">
  AND u.gender = #{gender}
  </if>

  -- 在线状态筛选
  <if test="status == 'online'">
  AND u.is_online = 1
  </if>

  -- 大区筛选
  <if test="gameArea != null">
  AND s.server = #{gameArea}
  </if>

  -- 段位筛选(多选)
  <if test="ranks != null and ranks.size() > 0">
  AND s.game_rank IN
    <foreach collection="ranks" item="rank" open="(" separator="," close=")">
      #{rank}
    </foreach>
  </if>

  -- 价格区间筛选
  <choose>
    <when test="priceRange == '4-9'">
      AND s.price BETWEEN 4 AND 9
    </when>
    <when test="priceRange == '10-19'">
      AND s.price BETWEEN 10 AND 19
    </when>
    <when test="priceRange == '20+'">
      AND s.price >= 20
    </when>
  </choose>

  -- 同城筛选
  <if test="cityCode != null">
  AND u.location_code = #{cityCode}
  </if>

-- 排序
<choose>
  <when test="sortBy == 'smart'">
    ORDER BY u.is_online DESC, s.order_count DESC, s.rating DESC
  </when>
  <when test="sortBy == 'newest'">
    ORDER BY s.created_at DESC
  </when>
  <when test="sortBy == 'recent'">
    ORDER BY u.last_login_at DESC
  </when>
  <when test="sortBy == 'popular'">
    ORDER BY s.order_count DESC, s.review_count DESC
  </when>
  <otherwise>
    ORDER BY u.is_online DESC, s.order_count DESC
  </otherwise>
</choose>

LIMIT #{pageSize} OFFSET #{offset}
```

### 3.2 统计SQL

```sql
-- Tab统计：全部数量
SELECT COUNT(*) AS total
FROM skills s
INNER JOIN users u ON s.user_id = u.user_id
WHERE s.deleted = 0 AND u.deleted = 0
  AND s.is_online = 1
  AND s.game_name = #{skillType};

-- Tab统计：在线数量
SELECT COUNT(*) AS online_count
FROM skills s
INNER JOIN users u ON s.user_id = u.user_id
WHERE s.deleted = 0 AND u.deleted = 0
  AND s.is_online = 1
  AND s.game_name = #{skillType}
  AND u.is_online = 1;
```

---

## 四、前端导航入口

### 4.1 导航流程

```
FunctionGridArea 点击功能
        │
        ▼
useHomeNavigation.handleFunctionPress(functionId)
        │
        ▼ 映射
skillTypeMap = {
  '1': '王者荣耀',
  '2': '英雄联盟',
  '3': '和平精英',
  '4': '荒野乱斗',
  '5': '探店',
  '6': '私影',
  '7': '台球',
  '8': 'K歌',
  '9': '喝酒',
  '10': '按摩'
}
        │
        ▼
router.push({
  pathname: '/(tabs)/homepage/game-player-list',
  params: { skillType: '王者荣耀' }
})
        │
        ▼
GamePlayerListPage 接收 skillType
        │
        ▼
bffApi.getSkillList({ skillType, pageNum: 1, pageSize: 20 })
        │
        ▼
点击玩家卡片
        │
        ▼
router.push({
  pathname: '/service/detail/[serviceId]',
  params: { serviceId: skillId, serviceType: 'online' }
})
```

### 4.2 前端接口调用

```typescript
// src/features/Homepage/ServiceFlow/GamePlayerListPage/api.ts

interface SkillListParams {
  skillType: string;           // 必填：技能类型
  pageNum?: number;            // 页码，默认1
  pageSize?: number;           // 每页数量，默认20
  sortBy?: 'smart' | 'newest' | 'recent' | 'popular';
  gender?: 'all' | 'male' | 'female';
  status?: 'all' | 'online';
  gameArea?: string;           // QQ区 | 微信区
  ranks?: string[];            // 段位多选
  priceRange?: string;         // 4-9 | 10-19 | 20+
  positions?: string[];        // 位置多选
  tags?: string[];             // 标签多选
  cityCode?: string;           // 同城
  latitude?: number;
  longitude?: number;
}

// 调用示例
const response = await bffApi.getSkillList({
  skillType: '王者荣耀',
  pageNum: 1,
  pageSize: 20,
  sortBy: 'smart',
  gender: 'all'
});
```

---

## 五、后端DTO/VO设计

### 5.1 请求DTO

```java
// SkillListQueryDTO.java
@Data
@Builder
public class SkillListQueryDTO {
    @NotBlank(message = "技能类型不能为空")
    private String skillType;

    private Integer pageNum = 1;
    private Integer pageSize = 20;

    private String sortBy = "smart";
    private String gender = "all";
    private String status = "all";
    private String gameArea;
    private List<String> ranks;
    private String priceRange;
    private List<String> positions;
    private List<String> tags;
    private String cityCode;

    private Double latitude;
    private Double longitude;
}
```

### 5.2 响应VO

```java
// SkillCardVO.java - 列表卡片
@Data
public class SkillCardVO {
    private Long skillId;
    private String description;
    private ProviderVO provider;
    private SkillInfoVO skillInfo;
    private List<TagVO> tags;
    private PriceVO price;
    private StatsVO stats;
    private Integer distance;
    private String distanceDisplay;

    @Data
    public static class ProviderVO {
        private Long userId;
        private String nickname;
        private String avatar;
        private String gender;
        private Integer age;
        private Boolean isOnline;
        private Boolean isVerified;
        private Boolean isExpert;
    }

    @Data
    public static class SkillInfoVO {
        private String skillType;
        private String gameArea;
        private String rank;
        private Integer peakScore;
        private String position;
    }

    @Data
    public static class TagVO {
        private String text;
        private String type;
        private String color;
    }

    @Data
    public static class PriceVO {
        private BigDecimal amount;
        private String unit;
        private String displayText;
    }

    @Data
    public static class StatsVO {
        private Integer orders;
        private BigDecimal rating;
        private Integer reviewCount;
    }
}
```

---

## 六、接口变更说明

### 6.1 路径变更

| 旧接口 | 新接口 | 说明 |
|--------|--------|------|
| `/api/service/list` | `/api/skill/list` | 统一使用skill命名 |
| `/api/service/detail` | `/api/skill/detail` | 保持一致 |

### 6.2 参数变更

| 旧参数 | 新参数 | 说明 |
|--------|--------|------|
| `serviceType` | `skillType` | 对应 skills.game_name |
| 无 | `ranks` | 新增多选段位筛选 |
| 无 | `positions` | 新增多选位置筛选 |

### 6.3 响应变更

| 旧字段 | 新字段 | 说明 |
|--------|--------|------|
| `serviceId` | `skillId` | 对应 skills.skill_id |
| `skillInfo.rankScore` | `skillInfo.peakScore` | 对应 skills.peak_score |

---

## 七、数据库索引建议

```sql
-- skills表索引优化
ALTER TABLE skills ADD INDEX idx_game_name_online (game_name, is_online);
ALTER TABLE skills ADD INDEX idx_server (server);
ALTER TABLE skills ADD INDEX idx_game_rank (game_rank);
ALTER TABLE skills ADD INDEX idx_price (price);
ALTER TABLE skills ADD INDEX idx_order_count (order_count);

-- users表索引优化
ALTER TABLE users ADD INDEX idx_is_online (is_online);
ALTER TABLE users ADD INDEX idx_gender (gender);
```

---

*文档版本: v2.0*
*创建时间: 2025-12-05*
*基于: xypai_user.sql v1.0.8*
